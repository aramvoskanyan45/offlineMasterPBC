<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Проектное управление</title>
  <link rel="stylesheet" href="img/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/fundament.css">
  <link rel="stylesheet" href="styles/bottom.css">
  <link rel="stylesheet" href="styles/wall.css">
  <link rel="stylesheet" href="styles/roof.css">
  <link rel="stylesheet" href="styles/inst-hat-pipes.css">
  <link rel="stylesheet" href="styles/insp-hat-pipes.css">
  <script src="xlsx.full.min.js"></script>
  
  <style>


  .pulsing-title {
  display: inline-block;
  color: #1e88e5;
  font-weight: bold;
  vertical-align: middle;
}

/* Стиль для каждой буквы-спана */
.pulsing-title span {
  display: inline-block;
  transition: transform 0.3s;
  white-space: pre; /* Чтобы пробелы не исчезали */
}

/* Анимация прыжка */
@keyframes letterJump {
  0%, 20%, 100% { transform: translateY(0); }
  10% { transform: translateY(-10px); } /* Буква подпрыгивает вверх */
}

.pulsing-title span.animate {
  animation: letterJump 2s ease-in-out;
}
    :root {
      --primary-blue: #1e88e5;
      --light-blue: #e3f2fd;
      --dark-blue: #1565c0;
      --accent-blue: #42a5f5;
      --secondary-blue: #e6f0f7;
      --light-blue-bg: #f0f7ff;
      --accent-blue-dark: #007acc;
      --white: #ffffff;
      --light-gray: #f5f5f5;
      --medium-gray: #e0e0e0;
      --dark-gray: #424242;
      --text-color: #333;
      --border-color: #b0c4de;
      --light-border: #d0e3ff;
      --danger-red: #d9534f;
      --success-green: #4caf50;
      --success-green-alt: #5cb85c;
      --warning-orange: #ff9800;
      --warning-orange-alt: #f0ad4e;
      --default-gray: #ccc;
      --reset-orange: #e67e22;
      --shadow-light: 0 4px 12px rgba(30, 136, 229, 0.08);
      --shadow-medium: 0 6px 20px rgba(30, 136, 229, 0.12);
      --error: #f44336;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    html {
      height: 100%;
      overscroll-behavior: none;
    }

    body {
      background-color: var(--light-blue);
      color: var(--dark-gray);
      min-height: 100vh;
      height: 100%;
      transition: all 0.3s ease;
      overscroll-behavior: none;
      touch-action: pan-y;
    }

    /* Основной контейнер */
    .container-hero {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Шапка */
.container-hero .header {
  background-color: var(--white);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  box-shadow: 0 4px 12px rgba(30, 136, 229, 0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center; /* ЦЕНТРИРУЕТ заголовок по горизонтали */
}

.container-hero .header h1 {
  color: var(--dark-blue);
  font-size: 28px;
  display: flex;
  align-items: center;
  justify-content: center; /* ЦЕНТРИРУЕТ текст и иконку внутри h1 */
  gap: 10px;
  margin: 0;
  width: 100%;
}

.container-hero .header h1 i {
  color: var(--primary-blue);
}

   

  
    /* Основной контейнер для модулей */
    .container-hero .container-module {
      width: 100%;
      max-width: 800px;
      background-color: var(--white);
      border-radius: 10px;
      box-shadow: var(--shadow-medium);
      overflow: hidden;
      border: 1px solid var(--border-color);
      display: none;
      margin: 20px auto;
    }

    .container-hero .container-module.active {
      display: block;
    }

    .settlement-results-inner{
      overflow-x: auto;
    }

    /* Основной контент */
    .container-hero .main-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 25px;
    }

    /* Секция проектов */
    .container-hero .projects-section {
      background-color: var(--white);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(30, 136, 229, 0.1);
    }

    .container-hero .section-title {
      color: var(--dark-blue);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-blue);
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Форма добавления проекта */
    .container-hero .add-project-form {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      justify-content: space-between;
      align-items: center;
      /* flex-wrap: wrap; */
    }

    .container-hero .add-project-form .form-input {
      flex-grow: 1;
      padding: 12px 15px;
      border: 2px solid var(--medium-gray);
      border-radius: 8px;
      font-size: 16px;
      min-width: 200px;
      transition: all 0.3s;
    }

    .container-hero .add-project-form .form-input:focus {
      outline: none;
      border-color: var(--primary-blue);
    }

    .container-hero .btn {
      max-width: 300px;
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .container-hero .btn-primary {
      background-color: var(--primary-blue);
      color: var(--white);
    }

    .container-hero .btn-primary:hover {
      background-color: var(--dark-blue);
    }

    .container-hero .btn-secondary {
      background-color: var(--light-gray);
      color: var(--dark-gray);
    }

    .container-hero .btn-secondary:hover {
      background-color: var(--medium-gray);
    }

    .container-hero .btn-danger {
      background-color: var(--error);
      color: var(--white);
    }

    .container-hero .btn-danger:hover {
      background-color: #d32f2f;
    }

    /* Список проектов */
    .container-hero .projects-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }

    .container-hero .project-card {
      background-color: var(--light-blue);
      border-radius: 10px;
      padding: 20px;
      border-left: 5px solid var(--accent-blue);
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .container-hero .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(30, 136, 229, 0.15);
    }

    .container-hero .project-card.active {
      border-left-color: var(--success-green);
      background-color: rgba(76, 175, 80, 0.05);
    }

    .container-hero .project-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .container-hero .project-name {
      font-weight: 600;
      font-size: 18px;
      color: var(--dark-blue);
    }

    .container-hero .project-date {
      font-size: 14px;
      color: var(--dark-gray);
    }

    .container-hero .project-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .container-hero .project-actions .btn {
      padding: 8px 12px;
      font-size: 14px;
      flex-grow: 1;
    }

    /* Список модулей */
    .container-hero .modules-section {
      background-color: var(--white);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(30, 136, 229, 0.1);
      /* display: none; */
    }

    .container-hero .modules-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .module-card {
      background-color: var(--light-gray);
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 15px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .module-card:hover {
      background-color: var(--light-blue);
      border-color: var(--accent-blue);
      transform: translateY(-3px);
    }

    .module-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--primary-blue);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .module-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--dark-blue);
    }

    .module-status {
      font-size: 14px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }

    .module-status.completed {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success-green);
    }

    .module-status.pending {
      background-color: rgba(255, 152, 0, 0.1);
      color: var(--warning-orange);
    }

    .check-button {
      display: none !important;
    }

    /* Уведомления */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: var(--white);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }

    .container-hero .notification.success {
      background-color: var(--success-green);
    }

    .notification.error {
      background-color: var(--error);
    }

    .notification.info {
      display: none;
      background-color: var(--primary-blue);
    }

    .hidden {
      display: none;
    }

    .access-gate-modal {
      position: fixed;
      inset: 0;
      background: rgba(10, 20, 30, 0.82);
      z-index: 20000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(2px);
    }

    .access-gate-modal.hidden {
      display: none;
    }

    .access-gate-box {
      width: 100%;
      max-width: 420px;
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      text-align: center;
    }

    .access-gate-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--dark-blue);
      margin-bottom: 6px;
    }

    .access-gate-subtitle {
      font-size: 13px;
      color: #555;
      margin-bottom: 16px;
    }

    .access-gate-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .access-gate-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .access-gate-button {
      background: var(--primary-blue);
      color: var(--white);
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .access-gate-status {
      font-size: 12px;
      margin-top: 10px;
      min-height: 16px;
      color: var(--error);
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 319px) {
      .container-hero {
        padding: 8px;
      }

      .container-hero .header {
        padding: 12px;
      }

      .container-hero .header h1 {
        font-size: 20px;
      }

      .container-hero .section-title {
        font-size: 16px;
      }

      .container-hero .projects-section,
      .container-hero .modules-section {
        padding: 15px;
      }

      .container-hero .projects-list,
      .container-hero .modules-list {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .container-hero .project-card {
        padding: 12px;
      }

      .container-hero .add-project-form {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .container-hero .add-project-form .form-input {
        min-width: auto;
        padding: 10px 12px;
        font-size: 14px;
      }

      .container-hero .btn {
        padding: 10px 15px;
        font-size: 14px;
        max-width: 100%;
      }

      .container-hero .project-actions {
        flex-direction: column;
        gap: 8px;
      }

      .container-hero .project-actions .btn {
        width: 100%;
        padding: 6px 10px;
        font-size: 13px;
      }

      .container-hero .notification {
        left: 8px;
        right: 8px;
        bottom: 8px;
        font-size: 13px;
        padding: 12px 15px;
      }

      .container-hero .container-module {
        width: 90%;
        margin: 12px auto;
        padding: 6px;
      }

      .module-card {
        padding: 12px;
      }

      .module-icon {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }

      .module-name {
        font-size: 14px;
      }

      .module-status {
        font-size: 12px;
        padding: 3px 8px;
      }
    }

    @media (min-width: 320px) and (max-width: 479px) {
      .notification {
        top: 10px;
        height: 50px;
      }

      .container-hero {
        padding: 10px;
      }

      .container-hero .header {
        padding: 15px;
      }

      .container-hero .header h1 {
        font-size: 22px;
      }

      .container-hero .section-title {
        font-size: 20px;
      }

      .container-hero .projects-section,
      .container-hero .modules-section {
        padding: 20px;
      }

      .container-hero .projects-list,
      .container-hero .modules-list {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .container-hero .project-card {
        padding: 15px;
      }

      .container-hero .add-project-form {
        flex-direction: column;
        align-items: stretch;
      }

      .container-hero .add-project-form .form-input {
        min-width: auto;
      }

      .container-hero .btn {
        max-width: 100%;
      }

      .container-hero .project-actions {
        flex-direction: column;
      }

      .container-hero .project-actions .btn {
        width: 100%;
      }

      .container-hero .notification {
        left: 10px;
        right: 10px;
        bottom: 10px;
        font-size: 14px;
      }

      .container-hero .container-module {
        width: 95%;
        margin: 15px auto;
        padding: 8px;
      }

      .module-card {
        padding: 15px;
      }

      .module-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .module-name {
        font-size: 15px;
      }
    }

    @media (min-width: 480px) and (max-width: 767px) {
      .container-hero {
        padding: 15px;
      }

      .container-hero .header h1 {
        font-size: 24px;
      }

      .container-hero .projects-list,
      .container-hero .modules-list {
        grid-template-columns: repeat(2, 1fr);
      }

      .container-hero .add-project-form {
        flex-direction: column;
        align-items: stretch;
      }

      .container-hero .add-project-form .form-input,
      .container-hero .add-project-form .btn {
        width: 100%;
      }

      .container-hero .project-actions {
        flex-direction: column;
      }

      .container-hero .notification {
        left: 15px;
        right: 15px;
        bottom: 15px;
      }

      .container-hero .container-module {
        width: 95%;
        margin: 20px auto;
        padding: 10px;
      }
    }

    @media (min-width: 768px) and (max-width: 1023px) {
      .container-hero {
        padding: 20px;
      }

      .container-hero .projects-list,
      .container-hero .modules-list {
        grid-template-columns: repeat(2, 1fr);
      }

      .container-hero .container-module {
        width: 90%;
        max-width: 900px;
      }
    }

    @media (min-width: 1024px) and (max-width: 1279px) {

      .container-hero .projects-list,
      .container-hero .modules-list {
        grid-template-columns: repeat(3, 1fr);
      }

      .container-hero .container-module {
        width: 85%;
        max-width: 800px;
      }
    }

    @media (min-width: 1280px) {

      .container-hero .projects-list,
      .container-hero .modules-list {
        grid-template-columns: repeat(4, 1fr);
      }

      .container-hero .container-module {
        max-width: 800px;
      }
    }

    /* Элементы загрузки */
    .container-hero .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--white);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Пустой список */
    .container-hero .empty-list {
      text-align: center;
      padding: 40px 20px;
      color: var(--dark-gray);
      font-size: 18px;
      grid-column: 1 / -1;
    }

    .container-hero .empty-list i {
      font-size: 48px;
      color: var(--medium-gray);
      margin-bottom: 15px;
    }
  </style>
  <style>



    #app-fundamet {
      width: 100%;
      max-width: 1200px;
      margin: 20px auto;
      background-color: var(--white);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      border: 1px solid var(--border-color);
      display: none;
      /* visibility: hidden; */
    }

    #app-fundamet.active {
      display: block;
    }

    #app-fundamet .container-module.fundament-screen-container {
      display: block;
    }

    #app-fundamet .app-header {
      color: var(--white);
      background-color: var(--primary-blue);
      padding: 20px 25px;
      text-align: center;
    }

    #app-fundamet .app-header h1 {
      margin: 0;
      font-size: 1.5em;
    }

    #app-fundamet .app-header p {
      margin: 5px 0 0;
      font-size: 0.9em;
      opacity: 0.9;
    }

    #app-fundamet .app-screen {
      padding: 25px;
    }

    #app-fundamet .hidden {
      display: none;
    }

    #app-fundamet button {
      display: block;
      width: 100%;
      padding: 15px;
      font-size: 1em;
      font-weight: 600;
      color: var(--white);
      background-color: var(--primary-blue);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      transition: background-color 0.2s;
    }

    #app-fundamet button:hover {
      background-color: #004a80;
    }

    #app-fundamet button.secondary {
      background-color: var(--white);
      color: var(--primary-blue);
      border: 2px solid var(--primary-blue);
    }

    #app-fundamet button.secondary:hover {
      background-color: #f5faff;
    }

    #app-fundamet button.action-btn {
      background-color: var(--warning-orange);
      color: white;
      margin-top: 10px;
    }

    #app-fundamet button.action-btn:hover {
      background-color: #ec971f;
    }

    #app-fundamet button.export-excel {
      background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
      color: var(--white);
      border: none;
      box-shadow: var(--shadow-light);
      transition: all 0.3s ease;
    }

    .export-excel{
      background-color: var(--success-green);
      color: var(--white);
    }

    #app-fundamet button.export-excel:hover {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }

    #app-fundamet .excel-icon {
      display: inline-block;
      margin-right: 8px;
      font-weight: bold;
    }

    #app-fundamet .form-group {
      margin-bottom: 20px;
    }

    #app-fundamet .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary-blue);
    }

    #app-fundamet .radio-group label {
      display: inline-block;
      margin-right: 15px;
      font-weight: normal;
      color: var(--text-color);
    }

    #app-fundamet .form-group input,
    #app-fundamet .form-group select {
      width: 100%;
      padding: 12px;
      font-size: 1em;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-sizing: border-box;
    }

    /* Стили для красивых инпутов в модуле осадки */
    #app-fundamet .styled-input-wrapper input {
      border: 2px solid #b0c4de;
      transition: border-color 0.3s;
    }

    #app-fundamet .styled-input-wrapper input:focus {
      border-color: var(--primary-blue);
      outline: none;
      box-shadow: 0 0 5px rgba(0, 90, 156, 0.2);
    }

    /* Красивые рамки для ввода значений точек в центре основания */
    #app-fundamet .center-point-input-wrapper {
      border: 2px solid #005a9c;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f8fbff;
    }

    #app-fundamet .center-point-input-wrapper label {
      color: #005a9c;
      font-weight: 600;
      margin-bottom: 8px;
    }

    #app-fundamet .center-point-input-wrapper input {
      border: 1px solid #b0c4de;
      border-radius: 6px;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
    }

    #app-fundamet .center-point-input-wrapper input:focus {
      border-color: #005a9c;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 90, 156, 0.3);
    }

    #app-fundamet .module-item-wrapper {
      display: flex;
      align-items: stretch;
      margin-bottom: 15px;
    }

    #app-fundamet .module-item-wrapper .list-button {
      flex-grow: 1;
      margin-top: 0;
      transition: background-color 0.2s, color 0.2s;
      border-radius: 10px;
    }

    #app-fundamet .module-item-wrapper .list-button.completed {
      background-color: var(--success-green);
      color: var(--white);
      border: 1px solid var(--success-green);
    }

    #app-fundamet button.back-button {
      background-color: #f0f5fa;
      border-color: #b0c4de;
      color: #555;
      margin-top: 25px;
    }

    #app-fundamet button.back-button:hover {
      background-color: #e6f0f7;
    }

    #app-fundamet .project-row {
      display: flex;
      align-items: center;
      margin-top: 15px;
    }

    #app-fundamet .project-row .list-button {
      flex-grow: 1;
      margin-top: 0;
    }

    #app-fundamet .delete-button {
      background-color: #fceded;
      color: var(--danger-red);
      border: 1px solid #f7d3d2;
      padding: 15px;
      min-width: 50px;
      width: auto;
      margin-top: 0;
      margin-left: 10px;
      font-weight: 700;
    }

    #app-fundamet .delete-button:hover {
      background-color: var(--danger-red);
      color: var(--white);
    }

    /* Таблицы */
    #app-fundamet .results-container table {
      overflow-x: auto;
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9em;
      min-width: 640px;
    }

    #app-fundamet .results-container th,
    #app-fundamet .results-container td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    #app-fundamet .results-container th {
      background-color: #f2f2f2;
      font-weight: 600;
    }

    /* Специальные стили для таблицы центра основания */
    #app-fundamet .center-results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9em;
    }

    #app-fundamet .center-results-table th,
    #app-fundamet .center-results-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    #app-fundamet .center-results-table th {
      background-color: #f2f2f2;
      font-weight: 600;
    }

    #app-fundamet .center-results-table .out-of-tolerance {
      background-color: #fceded;
    }

    #app-fundamet .center-results-table .center-row {
      background-color: #f0f8ff;
      font-weight: bold;
    }

    /* Изменения стилей для Annular Elevation */
    #app-fundamet .results-container .out-of-tolerance {
      background-color: #fceded;
      color: var(--text-color);
      font-weight: 700;
    }

    /* Стиль для инлайн-выделения недопуска */
    #app-fundamet .out-of-tolerance-val {
      color: var(--danger-red);
      font-weight: 700;
    }

    /* Красное выделение для "не более" */
    #app-fundamet .not-more-red {
      color: var(--text-color);
      font-weight: 700;
    }

    #app-fundamet .results-container .ok {
      background-color: transparent;
      color: var(--text-color);
      font-weight: normal;
    }



    /* Оставляем общий скролл, но для осадки переносим его на таблицу,
       чтобы заголовок h3 не прокручивался */
    #settlement-results-container {
      overflow-x: visible;
    }

    .settlement-results-table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .settlement-results-table-container table {
      width: max-content;
      min-width: 100%;
    }

    #app-fundamet .comparison-col {
      background-color: #eef6fc;
      color: var(--primary-blue);
      font-weight: 600;
    }

    #app-fundamet .tolerance-note {
      font-size: 0.9em;
      margin-top: 20px;
      padding: 15px;
      border: 1px dashed var(--primary-blue);
      background-color: var(--secondary-blue);
      border-radius: 5px;
      margin-bottom: 20px;
    }

    #app-fundamet .tolerance-summary {
      font-weight: 700;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    #app-fundamet .tolerance-summary.ok {
      background-color: #eafbea;
      color: var(--success-green);
      border: 1px solid var(--success-green);
    }

    #app-fundamet .tolerance-summary.error {
      background-color: #fceded;
      color: var(--danger-red);
      border: 1px solid var(--danger-red);
    }

    #app-fundamet .inline-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    #app-fundamet .inline-input-group>div {
      flex: 1;
    }

    #app-fundamet .history-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
      background: #fff8e1;
      border: 1px solid #ffe0b2;
      border-radius: 5px;
    }

    #app-fundamet .history-controls button {
      margin-top: 0;
      font-size: 0.9em;
      padding: 10px;
    }

    /* Tabs for Settlement Module */
    #app-fundamet .tabs-container {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      margin-top: 20px;
    }

    #app-fundamet .tab-button {
      flex: 1;
      padding: 12px 5px;
      border: 2px solid #ccc;
      background-color: #f9f9f9;
      color: #777;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s;
      margin-top: 0;
      font-size: 0.9em;
    }

    #app-fundamet .tab-button.active {
      background-color: var(--success-green);
      color: white;
      border-color: var(--success-green);
      box-shadow: 0 4px 6px rgba(92, 184, 92, 0.3);
    }

    #app-fundamet .input-section {
      display: none;
    }

    #app-fundamet .input-section.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    /* Стили для формы выбора истории */
    #app-fundamet .history-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    #app-fundamet .history-selector label {
      margin-bottom: 0;
    }

    #app-fundamet .history-selector select {
      flex-grow: 1;
      padding: 8px;
    }

    #app-fundamet .history-selector button {
      width: auto;
      margin: 0;
      padding: 8px 12px;
      font-size: 0.9em;
      background-color: var(--primary-blue);
    }

    /* Стиль для ввода даты в модулях */
    #app-fundamet .module-date-input {
      margin-top: 10px;
      padding: 8px;
      border: 1px solid #b0c4de;
      border-radius: 5px;
      width: 200px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive design for fundament module */

    /* Very small screens (phones under 320px) */
    @media (max-width: 319px) {
      #app-fundamet {
        margin: 10px auto;
        border-radius: 8px;
      }

      #app-fundamet .app-header {
        padding: 15px;
      }

      #app-fundamet .app-header h1 {
        font-size: 1.3em;
      }

      #app-fundamet .app-screen {
        padding: 15px;
      }

      #app-fundamet button {
        padding: 12px;
        font-size: 0.9em;
      }

      #app-fundamet .form-group {
        margin-bottom: 15px;
      }

      #app-fundamet .form-group input,
      #app-fundamet .form-group select {
        padding: 10px;
        font-size: 0.9em;
      }

      #app-fundamet .center-point-input-wrapper {
        padding: 10px;
        margin-bottom: 10px;
      }

      #app-fundamet .module-item-wrapper {
        flex-direction: column;
        margin-bottom: 10px;
      }

      #app-fundamet .module-item-wrapper .list-button {
        border-radius: 8px;
      }

      #app-fundamet .check-button {
        padding: 10px;
        margin-top: 5px;
        margin-left: 0;
      }

      #app-fundamet .project-row {
        flex-direction: column;
        gap: 10px;
      }

      #app-fundamet .delete-button {
        width: 100%;
        margin-left: 0;
      }

      #app-fundamet .results-container table {
        font-size: 0.8em;
      }

      #app-fundamet .results-container th,
      #app-fundamet .results-container td {
        padding: 5px;
      }

      #app-fundamet .tabs-container {
        flex-direction: column;
      }

      #app-fundamet .tab-button {
        padding: 10px;
        margin-bottom: 5px;
      }

      #app-fundamet .inline-input-group {
        flex-direction: column;
        gap: 10px;
      }

      #app-fundamet .history-selector {
        flex-direction: column;
        gap: 10px;
      }

      #app-fundamet .module-date-input {
        width: 100%;
      }

      #app-fundamet .tolerance-note {
        padding: 10px;
        font-size: 0.8em;
      }
    }

    /* Small screens (phones 320px to 479px) */
    @media (min-width: 320px) and (max-width: 479px) {
      #app-fundamet {
        margin: 10px auto;
        border-radius: 8px;
      }

      #app-fundamet .app-header {
        padding: 15px;
      }

      #app-fundamet .app-header h1 {
        font-size: 1.3em;
      }

      #app-fundamet .app-screen {
        padding: 15px;
      }

      #app-fundamet button {
        padding: 12px;
        font-size: 0.9em;
      }

      #app-fundamet .form-group {
        margin-bottom: 15px;
      }

      #app-fundamet .form-group input,
      #app-fundamet .form-group select {
        padding: 10px;
        font-size: 0.9em;
      }

      #app-fundamet .center-point-input-wrapper {
        padding: 10px;
        margin-bottom: 10px;
      }

      #app-fundamet .module-item-wrapper {
        flex-direction: column;
        margin-bottom: 10px;
      }

      #app-fundamet .module-item-wrapper .list-button {
        border-radius: 8px;
      }

      #app-fundamet .check-button {
        padding: 10px;
        margin-top: 5px;
        margin-left: 0;
      }

      #app-fundamet .project-row {
        flex-direction: column;
        gap: 10px;
      }

      #app-fundamet .delete-button {
        width: 100%;
        margin-left: 0;
      }

      #app-fundamet .results-container table {
        font-size: 0.8em;
      }

      #app-fundamet .results-container th,
      #app-fundamet .results-container td {
        padding: 5px;
      }

      #app-fundamet .tabs-container {
        flex-direction: column;
      }

      #app-fundamet .tab-button {
        padding: 10px;
        margin-bottom: 5px;
      }

      #app-fundamet .inline-input-group {
        flex-direction: column;
        gap: 10px;
      }

      #app-fundamet .history-selector {
        flex-direction: column;
        gap: 10px;
      }

      #app-fundamet .module-date-input {
        width: 100%;
      }

      #app-fundamet .tolerance-note {
        padding: 10px;
        font-size: 0.8em;
      }
    }

    /* Medium screens (tablets 480px to 767px) */
    @media (min-width: 480px) and (max-width: 767px) {
      #app-fundamet {
        margin: 15px auto;
        max-width: 95%;
      }

      #app-fundamet .app-header {
        padding: 18px 20px;
      }

      #app-fundamet .app-header h1 {
        font-size: 1.4em;
      }

      #app-fundamet .radio-group label {
        display: flex;
      }

      #app-fundamet .app-screen {
        padding: 20px;
      }

      #app-fundamet .module-item-wrapper {
        flex-direction: column;
      }

      #app-fundamet .module-item-wrapper .list-button {
        border-radius: 8px 8px 0 0;
      }

      #app-fundamet .check-button {
        border-radius: 0 0 8px 8px;
        margin-left: 0;
      }

      #app-fundamet .project-row {
        flex-direction: column;
        align-items: stretch;
      }

      #app-fundamet .delete-button {
        width: 100%;
        margin-left: 0;
        margin-top: 10px;
      }

      #app-fundamet .results-container table {
        font-size: 0.85em;
      }

      #app-fundamet .tabs-container {
        flex-wrap: wrap;
      }

      #app-fundamet .tab-button {
        flex: 1 0 auto;
        margin-bottom: 5px;
      }

      #app-fundamet .inline-input-group {
        flex-direction: column;
      }

      #app-fundamet .inline-input-group>div {
        width: 100%;
      }

      #app-fundamet .history-selector {
        flex-direction: column;
        align-items: stretch;
      }

      #app-fundamet .history-controls {
        flex-direction: column;
      }

      #app-fundamet .history-controls button {
        width: 100%;
      }
    }

    /* Large screens (tablets 768px to 1023px) */
    @media (min-width: 768px) and (max-width: 1023px) {
      #app-fundamet {
        margin: 15px auto;
        max-width: 90%;
      }

      #app-fundamet .app-header {
        padding: 18px 22px;
      }

      #app-fundamet .app-screen {
        padding: 22px;
      }

      #app-fundamet .results-container table {
        font-size: 0.9em;
      }

      #app-fundamet .tabs-container {
        flex-wrap: nowrap;
      }

      #app-fundamet .history-controls {
        flex-wrap: wrap;
      }

      #app-fundamet .history-controls button {
        flex: 1;
      }
    }

    /* Extra large screens (desktops 1024px and above) */
    @media (min-width: 1024px) {
      #app-fundamet {
        margin: 20px auto;
      }

      #app-fundamet .app-header {
        padding: 20px 25px;
      }

      #app-fundamet .app-screen {
        padding: 25px;
      }

      #app-fundamet .results-container table {
        font-size: 0.9em;
      }
    }
	/* --- ДОБАВЛЕНО: Скролл для динамических таблиц --- */
    .table-scroll-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Чтобы таблицы внутри контейнера не сжимались меньше 800px */
    .table-scroll-container table {
      min-width: 800px !important;
    }

    /* --- ДОБАВЛЕНО: Улучшение работы инпутов на телефоне --- */
    input[readonly] {
      touch-action: pan-y !important; /* Позволяет листать экран, трогая инпут */
      -webkit-tap-highlight-color: transparent; /* Убирает синюю рамку при тапе */
      cursor: default;
    }

    /* --- ДОБАВЛЕНО: Горизонтальный режим клавиатуры (в один ряд) --- */
    @media (orientation: landscape) and (max-height: 500px) {
      #custom-keyboard-container { 
        padding: 8px 5px !important; 
        bottom: -100%; /* По умолчанию скрыта */
      }
      #custom-keyboard-container.active {
        bottom: 0;
      }
      .kb-grid {
        display: flex !important; 
        flex-wrap: nowrap !important;
        max-width: 100% !important; 
        gap: 5px !important; 
        justify-content: center !important;
        grid-template-columns: none !important; /* Отключаем сетку для флекса */
      }
      .kb-key { 
        flex: 1; 
        height: 52px !important; 
        font-size: 20px !important; 
        min-width: 35px !important; 
      }
      
      /* Задаем порядок: цифры, потом знаки, потом навигация */
      .kb-key:nth-child(1)  { order: 1; }  /* 1 */
      .kb-key:nth-child(2)  { order: 2; }  /* 2 */
      .kb-key:nth-child(3)  { order: 3; }  /* 3 */
      .kb-key:nth-child(5)  { order: 4; }  /* 4 */
      .kb-key:nth-child(6)  { order: 5; }  /* 5 */
      .kb-key:nth-child(7)  { order: 6; }  /* 6 */
      .kb-key:nth-child(9)  { order: 7; }  /* 7 */
      .kb-key:nth-child(10) { order: 8; }  /* 8 */
      .kb-key:nth-child(11) { order: 9; }  /* 9 */
      .kb-key:nth-child(14) { order: 10; } /* 0 */
      .kb-key.action:nth-of-type(1) { order: 11; } /* ± */
      .kb-key.action:nth-of-type(2) { order: 12; } /* . */
      .kb-key.action:nth-of-type(3) { order: 13; } /* ‹ */
      .kb-key.action:nth-of-type(4) { order: 14; } /* › */
      .kb-key.delete { order: 15; }               /* ⌫ */
      .kb-key.ok-btn { order: 16; min-width: 70px; flex: 1.5; }
    }
  </style>
  <style>




#app-bottom {
  width: 100%;
  max-width: 1200px;
  margin: 20px auto;
  background-color: var(--white);
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  overflow: hidden;
  border: 1px solid var(--border-color);
  /* visibility: hidden;  */
  display: none;
}


#app-bottom .container-module.bottom-screen-container {
  display: block;
}

#app-bottom .app-header {
  background-color: var(--primary-blue);
  color: var(--white);
  padding: 20px 25px;
  text-align: center;
}

#app-bottom .app-header h1 {
  margin: 0;
  font-size: 1.5em;
}

#app-bottom .app-header p {
  margin: 5px 0 0;
  font-size: 0.9em;
  opacity: 0.9;
}

#app-bottom .app-screen {
  padding: 25px;
}

#app-bottom .hidden {
  display: none;
}

#app-bottom button {
  display: block;
  width: 100%;
  padding: 15px;
  font-size: 1em;
  font-weight: 600;
  color: var(--white);
  background-color: var(--primary-blue);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 15px;
  transition: background-color 0.2s;
}

#app-bottom button:hover {
  background-color: #004a80;
}

#app-bottom button.secondary {
  background-color: var(--white);
  color: var(--primary-blue);
  border: 2px solid var(--primary-blue);
}

#app-bottom button.secondary:hover {
  background-color: #f5faff;
}

#app-bottom button.reset {
  background-color: var(--white);
  color: var(--reset-orange);
  border: 2px solid var(--reset-orange);
}

#app-bottom button.reset:hover {
  background-color: #fef5e7;
  color: #d35400;
}

#app-bottom button.export-excel {
  background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
  color: var(--white);
  border: none;
  box-shadow: var(--shadow-light);
  transition: all 0.3s ease;
}

#app-bottom button.export-excel:hover {
  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
  box-shadow: var(--shadow-medium);
  transform: translateY(-2px);
}

#app-bottom .excel-icon {
  display: inline-block;
  margin-right: 8px;
  font-weight: bold;
}

#app-bottom .form-group {
  margin-bottom: 20px;
}

#app-bottom .form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--primary-blue);
}

#app-bottom .inline-group {
  display: flex;
  gap: 15px;
  align-items: flex-end;
}

#app-bottom .inline-group>div {
  flex: 1;
}

#app-bottom .form-group input,
#app-bottom .form-group select {
  width: 100%;
  padding: 12px;
  font-size: 1em;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-sizing: border-box;
}

#app-bottom .module-item-wrapper {
  display: flex;
  align-items: stretch;
  margin-bottom: 15px;
}

#app-bottom .module-item-wrapper .list-button {
  flex-grow: 1;
  margin-top: 0;
  text-align: left;
  padding-left: 20px;
  border-radius: 10px;
  white-space: normal;
  line-height: 1.4;
}

#app-bottom .module-item-wrapper .list-button.completed {
  background-color: var(--success-green);
  color: var(--white);
  border: 1px solid var(--success-green);
}

#app-bottom button.back-button {
  background-color: #f0f5fa;
  border-color: #b0c4de;
  color: #555;
  margin-top: 25px;
}

#app-bottom button.back-button:hover {
  background-color: #e6f0f7;
}

#app-bottom .project-row {
  display: flex;
  align-items: center;
  margin-top: 15px;
}

#app-bottom .project-row .list-button {
  flex-grow: 1;
  margin-top: 0;
}

#app-bottom .delete-button {
  background-color: #fceded;
  color: var(--danger-red);
  border: 1px solid #f7d3d2;
  padding: 15px;
  min-width: 50px;
  width: auto;
  margin-top: 0;
  margin-left: 10px;
  font-weight: 700;
}

#app-bottom .delete-button:hover {
  background-color: var(--danger-red);
  color: var(--white);
}

#app-bottom .results-container {
  overflow-x: auto;
}

#app-bottom .results-container table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 0.85em;
}

#app-bottom .results-container th,
#app-bottom .results-container td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
  vertical-align: middle;
}

#app-bottom .results-container th {
  background-color: #f2f2f2;
  font-weight: 600;
}

#app-bottom .out-of-tolerance {
  background-color: #fceded;
  color: var(--danger-red);
  font-weight: 700;
}

#app-bottom .tolerance-note {
  font-size: 0.85em;
  margin-top: 20px;
  padding: 15px;
  border: 1px dashed var(--primary-blue);
  background-color: var(--secondary-blue);
  border-radius: 5px;
  line-height: 1.5;
}

#app-bottom .tolerance-summary {
  font-weight: 700;
  margin-top: 10px;
  padding: 10px;
  border-radius: 5px;
  text-align: center;
}

#app-bottom .tolerance-summary.ok {
  background-color: #eafbea;
  color: var(--success-green);
  border: 1px solid var(--success-green);
}

#app-bottom .tolerance-summary.error {
  background-color: #fceded;
  color: var(--danger-red);
  border: 1px solid var(--danger-red);
}

#app-bottom .grid-inputs {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 15px;
}

#app-bottom .rise-input-card {
  background: #f8f8f8;
  border: 1px solid #e0e0e0;
  padding: 10px;
  border-radius: 5px;
  text-align: center;
}

#app-bottom .rise-input-card h4 {
  margin: 0 0 5px 0;
  font-size: 0.9em;
  color: var(--primary-blue);
}

#app-bottom .rise-input-card input {
  padding: 8px;
  font-size: 0.9em;
  border: 1px solid #ccc;
  width: 100%;
  box-sizing: border-box;
  border-radius: 4px;
}

/* Обновленные стили для карточек швов */
#app-bottom .seam-card {
  background: linear-gradient(145deg, #ffffff, #f9fbff);
  border: 2px solid #e1e8ff;
  padding: 15px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 90, 156, 0.08);
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#app-bottom .seam-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 90, 156, 0.12);
  border-color: #b8d4ff;
}

#app-bottom .seam-card h4 {
  margin: 0 0 5px 0;
  font-size: 0.9em;
  color: var(--primary-blue);
  background: linear-gradient(90deg, #e6f0f7, #f0f7ff);
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #d0e3ff;
}

#app-bottom .seam-input-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

#app-bottom .seam-input-group label {
  font-size: 0.75em;
  font-weight: 600;
  color: #555;
  text-align: left;
  padding-left: 2px;
}

#app-bottom .seam-input-group input {
  padding: 10px 12px;
  font-size: 0.95em;
  border: 2px solid #d0e3ff;
  border-radius: 8px;
  width: 100%;
  box-sizing: border-box;
  background-color: #f9fcff;
  transition: all 0.2s;
}

#app-bottom .seam-input-group input:focus {
  border-color: var(--primary-blue);
  outline: none;
  background-color: #ffffff;
  box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.1);
}

#app-bottom .seam-input-group input::placeholder {
  color: #a0b8d0;
  font-size: 0.85em;
}

#app-bottom .seam-inputs-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

#app-bottom .buckle-card {
  background-color: #fff8e1;
  padding: 15px;
  border: 1px solid #ffe0b2;
  border-radius: 8px;
  margin-bottom: 15px;
}

#app-bottom .buckle-card h4 {
  margin: 0 0 10px 0;
  color: #d84315;
  border-bottom: 1px solid #ffe0b2;
  padding-bottom: 5px;
}

#app-bottom .buckle-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
}

#app-bottom .buckle-input-group label {
  display: block;
  font-size: 0.75em;
  margin-bottom: 3px;
  color: #555;
  font-weight: 600;
}

#app-bottom .buckle-input-group input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9em;
  box-sizing: border-box;
}

#app-bottom .contour-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
}

#app-bottom .contour-tab {
  flex: 1;
  padding: 10px 5px;
  background-color: #f0f0f0;
  color: #555;
  border: 1px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9em;
  transition: all 0.3s;
  margin-top: 0;
}

#app-bottom .contour-tab.active {
  background-color: var(--success-green);
  color: white;
  border-color: var(--success-green);
}

#app-bottom .contour-tab:hover:not(.active) {
  background-color: #e0e0e0;
}

#app-bottom .contour-input-card {
  background-color: #ffffff;
  border: 1px solid #e1e4e8;
  border-radius: 8px;
  padding: 12px;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
  transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

#app-bottom .contour-input-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  border-color: var(--primary-blue);
}

#app-bottom .contour-point-label {
  font-size: 0.85em;
  font-weight: 700;
  color: var(--primary-blue);
  margin-bottom: 8px;
  display: block;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#app-bottom .contour-input-card input {
  text-align: center;
  font-weight: 600;
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 8px;
  width: 100%;
  box-sizing: border-box;
}

#app-bottom .contour-input-card input:focus {
  border-color: var(--primary-blue);
  outline: none;
  background-color: #f9fcff;
}

#app-bottom .button-group {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

#app-bottom .button-group button {
  flex: 1;
  margin-top: 0;
}

/* Responsive design for bottom module */

/* Very small screens (phones under 320px) */
@media (max-width: 319px) {
  #app-bottom {
    margin: 10px auto;
    border-radius: 8px;
  }

  #app-bottom .app-header {
    padding: 15px;
  }

  #app-bottom .app-header h1 {
    font-size: 1.2em;
  }

  #app-bottom .app-screen {
    padding: 15px;
  }

  #app-bottom button {
    padding: 12px;
    font-size: 0.9em;
  }

  #app-bottom .inline-group {
    flex-direction: column;
    gap: 10px;
  }

  #app-bottom .module-item-wrapper {
    flex-direction: column;
  }

  #app-bottom .module-item-wrapper .list-button {
    border-radius: 8px;
  }

  #app-bottom .check-button {
    padding: 10px;
    margin-top: 5px;
    margin-left: 0;
  }

  #app-bottom .project-row {
    flex-direction: column;
    gap: 10px;
  }

  #app-bottom .delete-button {
    width: 100%;
    margin-left: 0;
  }

  #app-bottom .grid-inputs {
    grid-template-columns: 1fr;
    gap: 10px;
  }

  #app-bottom .seam-inputs-wrapper {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  #app-bottom .seam-card {
    padding: 12px;
  }

  #app-bottom .results-container table {
    font-size: 0.75em;
  }

  #app-bottom .results-container th,
  #app-bottom .results-container td {
    padding: 5px;
  }

  #app-bottom .buckle-grid {
    grid-template-columns: 1fr;
  }

  #app-bottom .contour-tabs {
    flex-direction: column;
  }

  #app-bottom .contour-tab {
    margin-bottom: 5px;
  }

  #app-bottom .button-group {
    flex-direction: column;
  }

  #app-bottom .tolerance-note {
    padding: 10px;
    font-size: 0.75em;
  }
}

/* Small screens (phones 320px to 479px) */
@media (min-width: 320px) and (max-width: 479px) {
  #app-bottom {
    margin: 10px auto;
    border-radius: 8px;
  }

  #app-bottom .app-header {
    padding: 15px;
  }

  #app-bottom .app-header h1 {
    font-size: 1.3em;
  }

  #app-bottom .app-screen {
    padding: 15px;
  }

  #app-bottom button {
    padding: 12px;
    font-size: 0.9em;
  }

  #app-bottom .inline-group {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  #app-bottom .module-item-wrapper {
    flex-direction: column;
  }
#app-bottom .inline-group>div{
  width: 100%;
}
  #app-bottom .module-item-wrapper .list-button {
    border-radius: 8px;
  }

  #app-bottom .check-button {
    padding: 10px;
    margin-top: 5px;
    margin-left: 0;
  }

  #app-bottom .project-row {
    flex-direction: column;
    gap: 10px;
  }

  #app-bottom .delete-button {
    width: 100%;
    margin-left: 0;
  }

  #app-bottom .grid-inputs {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
  }

  #app-bottom .seam-inputs-wrapper {
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
  }

  #app-bottom .seam-card {
    padding: 12px;
  }

  #app-bottom .results-container table {
    font-size: 0.8em;
  }

  #app-bottom .results-container th,
  #app-bottom .results-container td {
    padding: 6px;
  }

  #app-bottom .buckle-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }

  #app-bottom .contour-tabs {
    flex-direction: column;
  }

  #app-bottom .contour-tab {
    margin-bottom: 5px;
  }

  #app-bottom .button-group {
    flex-direction: column;
  }

  #app-bottom .tolerance-note {
    padding: 10px;
    font-size: 0.8em;
  }
}

/* Medium screens (tablets 480px to 767px) */
@media (min-width: 480px) and (max-width: 767px) {
  #app-bottom {
    margin: 15px auto;
    max-width: 95%;
  }

  #app-bottom .app-header {
    padding: 18px 20px;
  }

  #app-bottom .app-header h1 {
    font-size: 1.4em;
  }

  #app-bottom .app-screen {
    padding: 20px;
  }

  #app-bottom .module-item-wrapper {
    flex-direction: column;
  }

  #app-bottom .module-item-wrapper .list-button {
    border-radius: 8px 8px 0 0;
  }

  #app-bottom .check-button {
    border-radius: 0 0 8px 8px;
    margin-left: 0;
  }

  #app-bottom .project-row {
    flex-direction: column;
    align-items: stretch;
  }

  #app-bottom .delete-button {
    width: 100%;
    margin-left: 0;
    margin-top: 10px;
  }

  #app-bottom .grid-inputs {
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 13px;
  }

  #app-bottom .seam-inputs-wrapper {
    grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    gap: 18px;
  }

  #app-bottom .results-container table {
    font-size: 0.85em;
  }

  #app-bottom .inline-group {
    flex-direction: column;
  }

  #app-bottom .inline-group>div {
    width: 100%;
  }

  #app-bottom .buckle-grid {
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  }

  #app-bottom .contour-tabs {
    flex-wrap: wrap;
  }

  #app-bottom .button-group {
    flex-direction: column;
  }

  #app-bottom .button-group button {
    width: 100%;
  }
}

/* Large screens (tablets 768px to 1023px) */
@media (min-width: 768px) and (max-width: 1023px) {
  #app-bottom {
    margin: 15px auto;
    max-width: 90%;
  }

  #app-bottom .app-header {
    padding: 18px 22px;
  }

  #app-bottom .app-screen {
    padding: 22px;
  }

  #app-bottom .results-container table {
    font-size: 0.88em;
  }

  #app-bottom .contour-tabs {
    flex-wrap: nowrap;
  }

  #app-bottom .button-group {
    flex-wrap: wrap;
  }

  #app-bottom .button-group button {
    flex: 1 0 auto;
  }
}

/* Extra large screens (desktops 1024px and above) */
@media (min-width: 1024px) {
  #app-bottom {
    margin: 20px auto;
  }

  #app-bottom .app-header {
    padding: 20px 25px;
  }

  #app-bottom .app-screen {
    padding: 25px;
  }

  #app-bottom .results-container table {
    font-size: 0.85em;
  }
}
  </style>
  <style>


* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

#app-wall {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #f5f9ff 0%, #e6f0f7 100%);
    color: var(--text-color);
    min-height: 100vh;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
}

#app-wall {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background-color: var(--white);
    border-radius: 16px;
    box-shadow: var(--shadow-medium);
    overflow: hidden;
    border: 1px solid var(--border-color);
    min-height: 90vh;
    display: none;
    transition: all 0.3s ease;
}

#app-wall .app-header {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    color: var(--white);
    padding: 25px 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

#app-wall .app-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1%, transparent 1%);
    background-size: 20px 20px;
    opacity: 0.3;
}

#app-wall .app-header h1 {
    margin: 0;
    font-size: 1.8em;
    font-weight: 600;
    position: relative;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#app-wall .app-header p {
    margin: 8px 0 0;
    font-size: 0.95em;
    opacity: 0.9;
    position: relative;
}

#app-wall .app-screen {
    padding: 30px;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

#app-wall .hidden {
    display: none !important;
}

/* Кнопки */
#app-wall button {
    display: block;
    width: 100%;
    padding: 16px 20px;
    font-size: 1em;
    font-weight: 600;
    color: var(--white);
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#app-wall button::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: 0.5s;
}

#app-wall button:hover::after {
    left: 100%;
}

#app-wall button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

#app-wall button:active {
    transform: translateY(0);
}

#app-wall button.secondary {
    background: var(--white);
    color: var(--primary-blue);
    border: 2px solid var(--primary-blue);
}

#app-wall button.secondary:hover {
    background: var(--light-blue);
}

#app-wall button.reset {
    background: var(--white);
    color: var(--reset-orange);
    border: 2px solid var(--reset-orange);
}

#app-wall button.reset:hover {
    background: #fef5e7;
    color: #d35400;
}

#app-wall button.success {
    background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
}

#app-wall button.export-excel {
    background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
}

#app-wall button.export-excel:hover {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
}

/* Формы */
#app-wall .form-group {
    margin-bottom: 25px;
}

#app-wall .form-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--primary-blue);
    font-size: 0.95em;
}

#app-wall .inline-group {
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
}

#app-wall .inline-group > div {
    flex: 1;
    min-width: 200px;
}

#app-wall .form-group input,
#app-wall .form-group select {
    width: 100%;
    padding: 14px 16px;
    font-size: 1em;
    border: 2px solid var(--light-border);
    border-radius: 10px;
    background: var(--light-blue);
    transition: all 0.3s ease;
}

#app-wall .form-group input:focus,
#app-wall .form-group select:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
    background: var(--white);
}

/* Карточки модулей */
#app-wall .module-item-wrapper {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--light-border);
    transition: all 0.3s ease;
    background: var(--primary-blue);
    color: var(--white);
    min-height: 60px;
}

#app-wall .module-item-wrapper:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
    border-color: var(--accent-blue);
    background: var(--accent-blue);
}

#app-wall .module-item-wrapper .list-button {
    flex-grow: 1;
    margin: 0;
    text-align: left;
    padding: 15px 20px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--white);
    font-weight: 500;
    white-space: normal;
    line-height: 1.5;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 1em;
    height: auto;
}

#app-wall .module-item-wrapper .list-button.completed {
    background: var(--success-green);
    color: var(--white);
    border: 1px solid var(--success-green);
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.35);
}

/* Карточки проектов */
#app-wall .project-row {
    display: flex;
    align-items: center;
    margin-top: 20px;
    background: var(--white);
    border-radius: 12px;
    padding: 5px;
    border: 1px solid var(--light-border);
    transition: all 0.3s ease;
}

#app-wall .project-row:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow-light);
}

#app-wall .project-row .list-button {
    flex-grow: 1;
    margin: 0;
    background: transparent;
    color: var(--text-color);
    text-align: left;
    border: none;
    font-weight: 500;
}

#app-wall .delete-button {
    background: var(--white);
    color: var(--danger-red);
    border: 2px solid #f7d3d2;
    padding: 12px 20px;
    min-width: 60px;
    margin: 0 0 0 10px;
    font-weight: 600;
    border-radius: 8px;
}

#app-wall .delete-button:hover {
    background: var(--danger-red);
    color: var(--white);
    border-color: var(--danger-red);
}

/* Результаты - ОБНОВЛЕННЫЕ СТИЛИ */
#app-wall .results-container {
    overflow-x: auto;
    margin-top: 25px;
    border-radius: 12px;
    border: 1px solid var(--light-border);
    padding: 20px;
    background: var(--light-blue);
    width: 100%;
}

#app-wall .results-container table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95em;
    background: var(--white);
    border-radius: 8px;
    overflow: hidden;
    min-width: 800px;
    table-layout: fixed;
}

#app-wall .results-container th {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    color: var(--white);
    padding: 14px 10px;
    text-align: center;
    font-weight: 600;
    border: none;
    font-size: 0.95em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#app-wall .results-container td {
    border: 1px solid var(--light-border);
    padding: 12px 8px;
    text-align: center;
    vertical-align: middle;
    font-size: 0.95em;
    height: 50px;
    transition: all 0.2s ease;
}

#app-wall .results-container tr:nth-child(even) {
    background-color: var(--light-blue);
}

#app-wall .results-container tr:hover {
    background-color: #e3f2fd;
}

#app-wall .results-container td:hover {
    background-color: #f0f7ff;
    transform: scale(1.02);
    z-index: 1;
    position: relative;
    box-shadow: 0 0 0 1px var(--accent-blue);
}

#app-wall .out-of-tolerance {
    background-color: #fceded !important;
    color: var(--danger-red);
    font-weight: 700;
    position: relative;
}

#app-wall .out-of-tolerance::after {
    content: '*';
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.8em;
    font-weight: bold;
}

/* Улучшенные стили для заголовка таблицы */
#app-wall .results-container .table-header-title {
    font-size: 1.3em;
    font-weight: 700;
    color: var(--white);
    margin-bottom: 5px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(255,255,255,0.2);
}

#app-wall .results-container .table-header-subtitle {
    font-size: 0.9em;
    color: rgba(255,255,255,0.9);
    margin-top: 5px;
}

/* Карточки ввода */
#app-wall .input-card {
    background: var(--white);
    border: 2px solid var(--light-border);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-light);
}

#app-wall .input-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
    border-color: var(--accent-blue);
}

#app-wall .input-card h4 {
    margin: 0 0 15px 0;
    font-size: 0.95em;
    color: var(--primary-blue);
    font-weight: 600;
}

#app-wall .input-card input {
    padding: 12px;
    font-size: 1em;
    border: 2px solid var(--light-border);
    border-radius: 8px;
    width: 100%;
    background: var(--light-blue);
    transition: all 0.3s ease;
}

#app-wall .input-card input:focus {
    border-color: var(--accent-blue);
    outline: none;
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
}

/* Сетки */
#app-wall .grid-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

/* Вспомогательные элементы */
#app-wall .tolerance-note {
    font-size: 0.9em;
    margin: 25px 0;
    padding: 20px;
    border: 2px dashed var(--primary-blue);
    background: var(--light-blue);
    border-radius: 10px;
    line-height: 1.6;
}

#app-wall .tolerance-note strong {
    color: var(--primary-blue);
}

#app-wall .tolerance-summary {
    font-weight: 700;
    margin-top: 20px;
    padding: 15px 20px;
    border-radius: 10px;
    text-align: center;
    font-size: 1.1em;
    border: 2px solid;
}

#app-wall .tolerance-summary.ok {
    background-color: #e8f5e9;
    color: var(--success-green);
    border-color: var(--success-green);
}

#app-wall .tolerance-summary.error {
    background-color: #fceded;
    color: var(--danger-red);
    border-color: var(--danger-red);
}

/* Группы кнопок */
#app-wall .button-group {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
}

#app-wall .button-group button {
    flex: 1;
    min-width: 200px;
    margin-top: 0;
}

/* Заголовки экранов */
#app-wall .screen-title {
    font-size: 1.5em;
    color: var(--primary-blue);
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--light-blue);
}

/* Стили для таблиц хлопунов */
#app-wall .bulge-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 0.9em;
}

#app-wall .bulge-table th {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    color: white;
    padding: 12px 8px;
    text-align: center;
    border: 1px solid var(--light-border);
    font-weight: 600;
    white-space: nowrap;
}

#app-wall .bulge-table td {
    padding: 8px 6px;
    border: 1px solid var(--light-border);
    text-align: center;
    vertical-align: middle;
}

#app-wall .bulge-table input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    text-align: center;
    font-size: 0.9em;
}

#app-wall .bulge-table tr:nth-child(even) {
    background-color: var(--light-blue);
}

/* Стили для вертикальности (из калькулятора) */
#app-wall .guide-card {
    background: var(--white);
    border: 1px solid var(--light-border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: var(--shadow-light);
}

#app-wall .guide-card-title {
    font-size: 1.1em;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#app-wall .guide-card-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 10px;
}

#app-wall .guide-card-inputs input {
    text-align: center;
    font-size: 1.1em;
    padding: 12px 8px;
    border: 2px solid var(--light-border);
    border-radius: 8px;
    background: var(--light-blue);
}

#app-wall .guide-card-inputs input:first-child {
    background: #eff6ff;
    border-color: #bfdbfe;
    color: #1e40af;
    font-weight: 700;
}

#app-wall .guide-card-inputs input:focus {
    border-color: var(--accent-blue);
    outline: none;
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
}

/* Кнопка "Снаружи" */
#app-wall .btn-toggle-mode {
    background: var(--white);
    color: var(--primary-blue);
    border: 2px solid var(--primary-blue);
}

#app-wall .btn-toggle-mode.active {
    background: #22c55e;
    color: white;
    border-color: #16a34a;
}

/* Модальные окна */
#app-wall .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    display: none;
}

#app-wall .modal-overlay.visible {
    display: flex;
}

#app-wall .modal-box {
    background-color: var(--white);
    padding: 30px;
    border-radius: 16px;
    box-shadow: var(--shadow-medium);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

#app-wall .modal-title {
    font-size: 1.5em;
    color: var(--primary-blue);
    margin-bottom: 20px;
}

#app-wall .modal-body {
    margin-bottom: 30px;
    font-size: 1em;
    line-height: 1.6;
}

#app-wall .modal-actions {
    display: flex;
    gap: 15px;
}

#app-wall .modal-actions button {
    flex: 1;
}

/* Настройка высоты поясов */
#app-wall .belt-height-input-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

#app-wall .belt-height-input-row label {
    width: 40%;
    font-weight: 600;
    color: var(--primary-blue);
}

#app-wall .belt-height-input-row input {
    width: 60%;
    padding: 12px;
    border: 2px solid var(--light-border);
    border-radius: 8px;
    background: var(--light-blue);
}

/* Индикатор автосохранения */
#app-wall .autosave-indicator {
    position: fixed;
    top: 100px;
    right: 30px;
    background-color: #10b981;
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 0.9em;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 100;
    pointer-events: none;
    box-shadow: var(--shadow-medium);
}

#app-wall .autosave-indicator.show {
    opacity: 1;
}

/* Стили для толщины поясов */
#app-wall .belt-thickness-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

#app-wall .belt-thickness-input {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

#app-wall .belt-thickness-input label {
    font-size: 0.9em;
    color: var(--primary-blue);
    font-weight: 600;
}

/* Адаптивность */
@media (max-width: 319px) {
    #app-wall {
        margin: 10px auto;
        border-radius: 12px;
        padding: 0;
    }
    
    #app-wall .app-header {
        padding: 15px;
    }
    
    #app-wall .app-header h1 {
        font-size: 1.4em;
    }
    
    #app-wall .app-screen {
        padding: 15px;
    }
    
    #app-wall button {
        padding: 14px 16px;
        font-size: 0.95em;
        margin-top: 15px;
    }
    
    #app-wall .inline-group {
        flex-direction: column;
        gap: 12px;
    }
    
    #app-wall .inline-group > div {
        width: 100%;
    }
    
    #app-wall .form-group {
        margin-bottom: 20px;
    }
    
    #app-wall .grid-inputs {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    #app-wall .module-item-wrapper {
        flex-direction: column;
        min-height: auto;
    }
    
    #app-wall .check-button {
        width: 100%;
        padding: 10px;
        min-width: 100%;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        height: auto;
        margin-top: 5px;
    }
    
    #app-wall .module-item-wrapper .list-button {
        width: 100%;
        border-radius: 8px 8px 0 0;
    }
    
    #app-wall .project-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    #app-wall .delete-button {
        width: 100%;
        margin: 0;
    }
    
    #app-wall .results-container {
        padding: 10px;
        margin: 15px 0;
        border-radius: 8px;
    }
    
    #app-wall .results-container table {
        font-size: 0.8em;
        min-width: 100%;
    }
    
    #app-wall .results-container th,
    #app-wall .results-container td {
        padding: 6px 4px;
        font-size: 0.8em;
    }
    
    #app-wall .screen-title {
        font-size: 1.3em;
        margin-bottom: 20px;
        padding-bottom: 10px;
    }
    
    #app-wall .button-group {
        flex-direction: column;
    }
    
    #app-wall .button-group button {
        min-width: 100%;
    }
    
    #app-wall .guide-card-inputs {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    #app-wall .modal-box {
        width: 95%;
        padding: 15px;
        margin: 10px;
    }
    
    #app-wall .tolerance-note {
        padding: 15px;
        font-size: 0.85em;
    }
    
    #app-wall .tolerance-summary {
        padding: 12px 15px;
        font-size: 1em;
    }
    
    #app-wall .belt-thickness-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (min-width: 320px) and (max-width: 479px) {
    #app-wall {
        margin: 10px auto;
        border-radius: 12px;
        padding: 0;
    }
    
    #app-wall .app-header {
        padding: 18px 20px;
    }
    
    #app-wall .app-header h1 {
        font-size: 1.5em;
    }
    
    #app-wall .app-screen {
        padding: 20px;
    }
    
    #app-wall button {
        padding: 15px 18px;
        font-size: 0.95em;
        margin-top: 18px;
    }
    
    #app-wall .inline-group {
        flex-direction: column;
        gap: 15px;
    }
    
    #app-wall .inline-group > div {
        width: 100%;
    }
    
    #app-wall .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 18px;
    }
    
    #app-wall .module-item-wrapper {
        flex-direction: column;
        min-height: auto;
    }
    
    #app-wall .check-button {
        width: 100%;
        padding: 12px;
        min-width: 100%;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        height: auto;
        margin-top: 5px;
    }
    
    #app-wall .module-item-wrapper .list-button {
        width: 100%;
        border-radius: 8px 8px 0 0;
    }
    
    #app-wall .project-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    #app-wall .delete-button {
        width: 100%;
        margin: 0;
    }
    
    #app-wall .results-container {
        padding: 12px;
        margin: 20px -10px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #app-wall .results-container table {
        font-size: 0.85em;
        min-width: 600px;
    }
    
    #app-wall .results-container th,
    #app-wall .results-container td {
        padding: 7px 4px;
    }
    
    #app-wall .button-group {
        flex-direction: column;
    }
    
    #app-wall .button-group button {
        min-width: 100%;
    }
    
    #app-wall .guide-card-inputs {
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
        gap: 10px;
    }
    
    #app-wall .modal-box {
        width: 95%;
        padding: 20px;
    }
    
    #app-wall .belt-thickness-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
    }
}

@media (min-width: 480px) and (max-width: 767px) {
    #app-wall {
        margin: 15px auto;
        max-width: 95%;
    }
    
    #app-wall .app-header {
        padding: 20px 25px;
    }
    
    #app-wall .app-header h1 {
        font-size: 1.6em;
    }
    
    #app-wall .app-screen {
        padding: 25px;
    }
    
    #app-wall .inline-group {
        flex-direction: column;
        gap: 15px;
    }
    
    #app-wall .inline-group > div {
        width: 100%;
    }
    
    #app-wall .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 18px;
    }
    
    #app-wall .module-item-wrapper {
        flex-direction: column;
    }
    
    #app-wall .check-button {
        width: 100%;
        border-radius: 0 0 12px 12px;
        margin-top: 0;
    }
    
    #app-wall .module-item-wrapper .list-button {
        border-radius: 12px 12px 0 0;
    }
    
    #app-wall .project-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    #app-wall .delete-button {
        width: 100%;
        margin: 10px 0 0 0;
    }
    
    #app-wall .results-container {
        margin: 20px -15px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #app-wall .results-container table {
        font-size: 0.9em;
        min-width: 700px;
    }
    
    #app-wall .button-group {
        flex-wrap: nowrap;
    }
    
    #app-wall .button-group button {
        flex: 1;
        min-width: 150px;
    }
    
    #app-wall .guide-card-inputs {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 12px;
    }
    
    #app-wall .belt-thickness-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 14px;
    }
}

@media (min-width: 768px) and (max-width: 1023px) {
    #app-wall {
        margin: 15px auto;
        max-width: 90%;
    }
    
    #app-wall .app-header {
        padding: 22px 25px;
    }
    
    #app-wall .app-header h1 {
        font-size: 1.7em;
    }
    
    #app-wall .app-screen {
        padding: 28px;
    }
    
    #app-wall .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 18px;
    }
    
    #app-wall .results-container table {
        font-size: 0.92em;
    }
    
    #app-wall .button-group {
        flex-wrap: wrap;
    }
    
    #app-wall .belt-thickness-grid {
        grid-template-columns: repeat(auto-fill, minmax(115px, 1fr));
        gap: 15px;
    }
}

@media (min-width: 1024px) {
    #app-wall .app-header {
        padding: 25px 30px;
    }
    
    #app-wall .app-header h1 {
        font-size: 1.8em;
    }
    
    #app-wall .app-screen {
        padding: 30px;
    }
    
    #app-wall .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
    }
    
    #app-wall .results-container table {
        font-size: 0.95em;
    }
    
    #app-wall .belt-thickness-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
    }
}

/* Анимация загрузки */
#app-wall .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid var(--light-blue);
    border-radius: 50%;
    border-top-color: var(--primary-blue);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Стили для ввода толщины в угловатости */
#app-wall .thickness-input-group {
    display: flex;
    align-items: flex-end;
    gap: 10px;
}

#app-wall .thickness-input-group .form-group {
    flex: 1;
    margin-bottom: 0;
}

#app-wall .thickness-input-group button {
    margin-top: 0;
    width: auto;
    padding: 14px 16px;
    white-space: nowrap;
}

/* Стили для подсветки недопусков в таблице */
#app-wall .input-out-of-tolerance {
    background-color: #fceded !important;
    color: var(--danger-red) !important;
    border-color: #d9534f !important;
    font-weight: bold;
}

/* Иконка Excel */
#app-wall .excel-icon {
    display: inline-block;
    margin-right: 8px;
    font-weight: bold;
}

/* Стили для статуса */
#app-wall .status-ok {
    color: var(--success-green);
    font-weight: bold;
}

#app-wall .status-error {
    color: var(--danger-red);
    font-weight: bold;
}
  </style>
  <style>




#app-roof {
    width: 100%;
    max-width: 1200px;
    margin: 20px auto;
    background-color: var(--white);
    border-radius: 16px;
    box-shadow: var(--shadow-medium);
    overflow: hidden;
    border: 1px solid var(--border-color);
    min-height: 90vh;
    display: none;
}

#app-roof .app-header {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    color: var(--white);
    padding: 25px 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

#app-roof .app-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1%, transparent 1%);
    background-size: 20px 20px;
    opacity: 0.3;
}

#app-roof .app-header h1 {
    margin: 0;
    font-size: 1.8em;
    font-weight: 600;
    position: relative;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#app-roof .app-header p {
    margin: 8px 0 0;
    font-size: 0.95em;
    opacity: 0.9;
    position: relative;
}

#app-roof .app-screen {
    padding: 30px;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

#app-roof .hidden {
    display: none !important;
}

/* Кнопки */
#app-roof button {
    display: block;
    width: 100%;
    padding: 16px 20px;
    font-size: 1em;
    font-weight: 600;
    color: var(--white);
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#app-roof button::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: 0.5s;
}

#app-roof button:hover::after {
    left: 100%;
}

#app-roof button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

#app-roof button:active {
    transform: translateY(0);
}

#app-roof button.secondary {
    background: var(--white);
    color: var(--primary-blue);
    border: 2px solid var(--primary-blue);
}

#app-roof button.secondary:hover {
    background: var(--light-blue);
}

#app-roof button.success {
    background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
}

#app-roof button.export-excel {
    background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
}

#app-roof button.reset {
    background: var(--white);
    color: var(--reset-orange);
    border: 2px solid var(--reset-orange);
}

/* Карточки проектов */
#app-roof .project-row {
    display: flex;
    align-items: center;
    margin-top: 20px;
    background: var(--white);
    border-radius: 12px;
    padding: 5px;
    border: 1px solid var(--light-border);
    transition: all 0.3s ease;
}

#app-roof .project-row:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow-light);
}

#app-roof .project-row .list-button {
    flex-grow: 1;
    margin: 0;
    background: transparent;
    color: var(--text-color);
    text-align: left;
    border: none;
    font-weight: 500;
}

#app-roof .delete-button {
    background: var(--white);
    color: var(--danger-red);
    border: 2px solid #f7d3d2;
    padding: 12px 20px;
    min-width: 60px;
    margin: 0 0 0 10px;
    font-weight: 600;
    border-radius: 8px;
}

#app-roof .delete-button:hover {
    background: var(--danger-red);
    color: var(--white);
    border-color: var(--danger-red);
}

/* Формы */
#app-roof .form-group {
    margin-bottom: 25px;
}

#app-roof .form-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--primary-blue);
    font-size: 0.95em;
}

#app-roof .inline-group {
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
}

#app-roof .inline-group > div {
    flex: 1;
    min-width: 200px;
}

#app-roof .form-group input,
#app-roof .form-group select {
    width: 100%;
    padding: 14px 16px;
    font-size: 1em;
    border: 2px solid var(--light-border);
    border-radius: 10px;
    background: var(--light-blue);
    transition: all 0.3s ease;
}

#app-roof .form-group input:focus,
#app-roof .form-group select:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
    background: var(--white);
}

#app-roof .screen-title {
    font-size: 1.5em;
    color: var(--primary-blue);
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--light-blue);
}

#app-roof .tolerance-note {
    font-size: 0.9em;
    margin: 25px 0;
    padding: 20px;
    border: 2px dashed var(--primary-blue);
    background: var(--light-blue);
    border-radius: 10px;
    line-height: 1.6;
}

#app-roof .tolerance-note strong {
    color: var(--primary-blue);
}

/* Кнопки зон измерения */
#app-roof .zone-buttons {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

#app-roof .zone-button {
    flex: 1;
    min-width: 150px;
    padding: 15px;
    border: 2px solid var(--primary-blue);
    background: var(--white);
    color: var(--primary-blue);
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    text-align: center;
}

#app-roof .zone-button:hover {
    background: var(--light-blue);
}

#app-roof .zone-button.active {
    background: var(--success-green);
    color: var(--white);
    border-color: var(--success-green);
}

#app-roof .button-group {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
}

#app-roof .button-group button {
    flex: 1;
    min-width: 200px;
    margin-top: 0;
}

/* Результаты */
#app-roof .results-container {
    overflow-x: auto;
    margin-top: 25px;
    border-radius: 12px;
    border: 1px solid var(--light-border);
    padding: 20px;
    background: var(--light-blue);
    width: 100%;
}

#app-roof .results-container table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95em;
    background: var(--white);
    border-radius: 8px;
    overflow: hidden;
    min-width: 600px;
}

#app-roof .results-container th {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
    color: var(--white);
    padding: 14px 10px;
    text-align: center;
    font-weight: 600;
    border: none;
    font-size: 0.95em;
    white-space: nowrap;
}

#app-roof .results-container td {
    border: 1px solid var(--light-border);
    padding: 12px 8px;
    text-align: center;
    vertical-align: middle;
    font-size: 0.95em;
    height: 50px;
}

#app-roof .results-container tr:nth-child(even) {
    background-color: var(--light-blue);
}

#app-roof .out-of-tolerance {
    background-color: #fceded !important;
    color: var(--danger-red);
    font-weight: 700;
    position: relative;
}

#app-roof .out-of-tolerance::after {
    content: '*';
    position: absolute;
    top: 2px;
    right: 2px;
    font-size: 0.8em;
    font-weight: bold;
}

/* Сетка ввода */
#app-roof .grid-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

#app-roof .input-card {
    background: var(--white);
    border: 2px solid var(--light-border);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-light);
}

#app-roof .input-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
    border-color: var(--accent-blue);
}

#app-roof .input-card h4 {
    margin: 0 0 15px 0;
    font-size: 0.95em;
    color: var(--primary-blue);
    font-weight: 600;
}

#app-roof .input-card input {
    padding: 12px;
    font-size: 1em;
    border: 2px solid var(--light-border);
    border-radius: 8px;
    width: 100%;
    background: var(--light-blue);
    transition: all 0.3s ease;
}

#app-roof .input-card input:focus {
    border-color: var(--accent-blue);
    outline: none;
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
}

/* Модальные окна */
#app-roof .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    display: none;
}

#app-roof .modal-overlay.visible {
    display: flex;
}

#app-roof .modal-box {
    background-color: var(--white);
    padding: 30px;
    border-radius: 16px;
    box-shadow: var(--shadow-medium);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

#app-roof .modal-title {
    font-size: 1.5em;
    color: var(--primary-blue);
    margin-bottom: 20px;
}

#app-roof .modal-body {
    margin-bottom: 30px;
    font-size: 1em;
    line-height: 1.6;
}

#app-roof .modal-actions {
    display: flex;
    gap: 15px;
}

#app-roof .modal-actions button {
    flex: 1;
}

#app-roof .excel-icon {
    display: inline-block;
    margin-right: 8px;
    font-weight: bold;
}

/* Главное меню модулей */
#app-roof .module-item-wrapper {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--light-border);
    transition: all 0.3s ease;
    background: var(--primary-blue);
    color: var(--white);
    min-height: 60px;
}

#app-roof .module-item-wrapper:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
    border-color: var(--accent-blue);
    background: var(--accent-blue);
}

#app-roof .module-item-wrapper .list-button {
    flex-grow: 1;
    margin: 0;
    text-align: left;
    padding: 15px 20px;
    border-radius: 0;
    border: none;
    background: transparent;
    color: var(--white);
    font-weight: 500;
    white-space: normal;
    line-height: 1.5;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 1em;
    height: auto;
}

#app-roof .module-item-wrapper .list-button.completed {
    background: var(--success-green);
    color: var(--white);
    border: 1px solid var(--success-green);
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.35);
}

/* Responsive design for roof module */

/* Very small screens (phones under 320px) */
@media (max-width: 319px) {
    #app-roof {
        margin: 10px auto;
        border-radius: 12px;
        padding: 0;
    }
    
    #app-roof .app-header {
        padding: 15px;
    }
    
    #app-roof .app-header h1 {
        font-size: 1.4em;
    }
    
    #app-roof .app-screen {
        padding: 15px;
    }
    
    #app-roof button {
        padding: 14px 16px;
        font-size: 0.95em;
        margin-top: 15px;
    }
    
    #app-roof .inline-group {
        flex-direction: column;
        gap: 12px;
    }
    
    #app-roof .inline-group > div {
        width: 100%;
    }
    
    #app-roof .form-group {
        margin-bottom: 20px;
    }
    
    #app-roof .grid-inputs {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    #app-roof .module-item-wrapper {
        flex-direction: column;
        min-height: auto;
    }
    
    #app-roof .module-item-wrapper .list-button {
        width: 100%;
        border-radius: 8px;
    }
    
    #app-roof .project-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    #app-roof .delete-button {
        width: 100%;
        margin: 0;
    }
    
    #app-roof .results-container {
        padding: 10px;
        margin: 15px 0;
        border-radius: 8px;
    }
    
    #app-roof .results-container table {
        font-size: 0.8em;
        min-width: 100%;
    }
    
    #app-roof .results-container th,
    #app-roof .results-container td {
        padding: 6px 4px;
        font-size: 0.8em;
    }
    
    #app-roof .screen-title {
        font-size: 1.3em;
        margin-bottom: 20px;
        padding-bottom: 10px;
    }
    
    #app-roof .button-group {
        flex-direction: column;
    }
    
    #app-roof .button-group button {
        min-width: 100%;
    }
    
    #app-roof .zone-buttons {
        flex-direction: column;
    }
    
    #app-roof .zone-button {
        width: 100%;
    }
    
    #app-roof .modal-box {
        width: 95%;
        padding: 15px;
        margin: 10px;
    }
    
    #app-roof .tolerance-note {
        padding: 15px;
        font-size: 0.85em;
    }
    
    #app-roof .input-card {
        padding: 15px;
    }
    
    #app-roof .input-card input {
        padding: 10px;
    }
}

/* Small screens (phones 320px to 479px) */
@media (min-width: 320px) and (max-width: 479px) {
    #app-roof {
        margin: 10px auto;
        border-radius: 12px;
        padding: 0;
    }
    
    #app-roof .app-header {
        padding: 18px 20px;
    }
    
    #app-roof .app-header h1 {
        font-size: 1.5em;
    }
    
    #app-roof .app-screen {
        padding: 20px;
    }
    
    #app-roof button {
        padding: 15px 18px;
        font-size: 0.95em;
        margin-top: 18px;
    }
    
    #app-roof .inline-group {
        flex-direction: column;
        gap: 15px;
    }
    
    #app-roof .inline-group > div {
        width: 100%;
    }
    
    #app-roof .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 18px;
    }
    
    #app-roof .module-item-wrapper {
        flex-direction: column;
        min-height: auto;
    }
    
    #app-roof .module-item-wrapper .list-button {
        width: 100%;
        border-radius: 8px;
    }
    
    #app-roof .project-row {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    #app-roof .delete-button {
        width: 100%;
        margin: 0;
    }
    
    #app-roof .results-container {
        padding: 12px;
        margin: 20px -10px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #app-roof .results-container table {
        font-size: 0.85em;
        min-width: 600px;
    }
    
    #app-roof .results-container th,
    #app-roof .results-container td {
        padding: 7px 4px;
    }
    
    #app-roof .button-group {
        flex-direction: column;
    }
    
    #app-roof .button-group button {
        min-width: 100%;
    }
    
    #app-roof .zone-buttons {
        flex-direction: column;
    }
    
    #app-roof .zone-button {
        width: 100%;
    }
    
    #app-roof .modal-box {
        width: 95%;
        padding: 20px;
    }
    
    #app-roof .input-card {
        padding: 18px;
    }
}

/* Medium screens (tablets 480px to 767px) */
@media (min-width: 480px) and (max-width: 767px) {
    #app-roof {
        margin: 15px auto;
        max-width: 95%;
    }
    
    #app-roof .app-header {
        padding: 20px 25px;
    }
    
    #app-roof .app-header h1 {
        font-size: 1.6em;
    }
    
    #app-roof .app-screen {
        padding: 25px;
    }
    
    #app-roof .inline-group {
        flex-direction: column;
        gap: 15px;
    }
    
    #app-roof .inline-group > div {
        width: 100%;
    }
    
    #app-roof .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 18px;
    }
    
    #app-roof .module-item-wrapper {
        flex-direction: column;
    }
    
    #app-roof .module-item-wrapper .list-button {
        border-radius: 8px 8px 0 0;
    }
    
    #app-roof .project-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    #app-roof .delete-button {
        width: 100%;
        margin: 10px 0 0 0;
    }
    
    #app-roof .results-container {
        margin: 20px -15px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    #app-roof .results-container table {
        font-size: 0.9em;
    }
    
    #app-roof .button-group {
        flex-wrap: nowrap;
    }
    
    #app-roof .button-group button {
        flex: 1;
        min-width: 150px;
    }
    
    #app-roof .zone-buttons {
        flex-wrap: nowrap;
        flex-direction: row;
    }
    
    #app-roof .zone-button {
        flex: 1;
        min-width: 100px;
    }
}

/* Large screens (tablets 768px to 1023px) */
@media (min-width: 768px) and (max-width: 1023px) {
    #app-roof {
        margin: 15px auto;
        max-width: 90%;
    }
    
    #app-roof .app-header {
        padding: 22px 25px;
    }
    
    #app-roof .app-header h1 {
        font-size: 1.7em;
    }
    
    #app-roof .app-screen {
        padding: 28px;
    }
    
    #app-roof .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 18px;
    }
    
    #app-roof .results-container table {
        font-size: 0.92em;
    }
    
    #app-roof .button-group {
        flex-wrap: wrap;
    }
}

/* Extra large screens (desktops 1024px and above) */
@media (min-width: 1024px) {
    #app-roof .app-header {
        padding: 25px 30px;
    }
    
    #app-roof .app-header h1 {
        font-size: 1.8em;
    }
    
    #app-roof .app-screen {
        padding: 30px;
    }
    
    #app-roof .grid-inputs {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
    }
    
    #app-roof .results-container table {
        font-size: 0.95em;
    }
}
    </style>
    <style>
      /* --- 1. БАЗОВЫЕ СТИЛИ И СБРОС --- */
/* html, body {
    overscroll-behavior: none !important;
    touch-action: pan-y !important;
    overflow: hidden !important;
    height: 100%;
    height: 100dvh;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: #e0e7ff;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
} */

/* --- 2. СТРУКТУРА И МАКЕТ --- */
#inst-hat-pipes {
    max-width: 1200px;
    width: 100%;
    margin: 20px auto;
    /* width: 100vw; */
    /* height: 100vh; */
    background-color: #f8fafc;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s;
    display: none;
    border-radius: 10px;

}

/* Компактный дизайн для десктопа */
/* @media (min-width: 640px) {
    #inst-hat-pipes {
        width: 600px;
        height: 800px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    #main-content {
        padding: 1rem !important;
        padding-bottom: 120px !important;
    }
    
    .input-container input {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
    }
    
    .btn {
        padding: 0.75rem !important;
        font-size: 0.9rem !important;
    }
    
    .btn-calculate {
        padding: 0.875rem !important;
        font-size: 1rem !important;
    }
} */

#inst-hat-pipes .status-bar {
    height: 2rem;
    background-color: #2563eb;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 1rem;
    font-size: 0.75rem;
    z-index: 20;
    user-select: none;
    flex-shrink: 0;
}

#inst-hat-pipes .app-header {
    background-color: var(--primary-blue);
    color: var(--white);
    padding: 20px 25px;
    text-align: center;
    height: 3.5rem;
    /* background-color: white; */
    /* color: #1e293b; */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    z-index: 10;
    flex-shrink: 0;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
}

#inst-hat-pipes .app-header h1 {
    font-size: 1.125rem;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
    text-align: center;
}

#inst-hat-pipes .header-actions {
    position: absolute;
    right: 1rem;
    display: flex;
    gap: 0.75rem;
    color: #4b5563;
}

#inst-hat-pipes .header-actions svg {
    width: 1.5rem;
    height: 1.5rem;
    cursor: pointer;
}

#inst-hat-pipes #main-content {
    overscroll-behavior-y: contain;
    -webkit-overscrolling: touch;
    touch-action: pan-y;
    flex-grow: 1;
    padding: 0.75rem;
    padding-bottom: 120px;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    scroll-behavior: smooth;
}

/* Плавная прокрутка */
#inst-hat-pipes #main-content::-webkit-scrollbar {
    width: 6px;
}

#inst-hat-pipes #main-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#inst-hat-pipes #main-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

#inst-hat-pipes #main-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* --- 3. ВКЛАДКИ --- */
#inst-hat-pipes .tabs-container {
    margin-bottom: 1.25rem;
}

#inst-hat-pipes .tabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

#inst-hat-pipes .tab {
    text-align: center;
    padding: 0.75rem 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #4b5563;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    background-color: #f3f4f6;
    border: 1px solid #e5e7eb;
}

#inst-hat-pipes .tab.active {
    background-color: var(--primary-blue);
    color: white;
    box-shadow: 0 1px 3px rgba(37, 99, 235, 0.3);
}

/* --- 4. КОМПОНЕНТЫ ИНТЕРФЕЙСА --- */
#inst-hat-pipes .input-group {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.07);
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
}

#inst-hat-pipes .input-group h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #374151;
}

#inst-hat-pipes .input-container {
    margin-bottom: 0.875rem;
}

#inst-hat-pipes .input-container:last-child {
    margin-bottom: 0;
}

#inst-hat-pipes .input-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 700;
    color: #6b7280;
    text-transform: uppercase;
    margin-bottom: 0.375rem;
}

#inst-hat-pipes .input-label span {
    color: #9ca3af;
    font-size: 0.8rem;
    text-transform: none;
    margin-left: 0.25rem;
}

#inst-hat-pipes input[type="text"],
#inst-hat-pipes input[type="tel"] {
    width: 100%;
    padding: 0.75rem;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    box-sizing: border-box;
    user-select: text;
}

#inst-hat-pipes input[type="tel"].text-center {
    text-align: center;
}

#inst-hat-pipes input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    background-color: white;
}

#inst-hat-pipes .input-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

/* Кнопки */
#inst-hat-pipes .btn {
    width: 100%;
    font-weight: 700;
    padding: 0.75rem;
    border-radius: 8px;
    transition: all 0.15s;
    cursor: pointer;
    border: none;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    box-sizing: border-box;
}

#inst-hat-pipes .btn:active {
    transform: scale(0.97);
}

#inst-hat-pipes .btn svg {
    width: 1rem;
    height: 1rem;
}

#inst-hat-pipes .btn-primary {
    background-color: #2563eb;
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

#inst-hat-pipes .btn-primary:hover {
    background-color: #1d4ed8;
}

#inst-hat-pipes .btn-calculate {
    background-color: var(--success-green);
    color: white;
    box-shadow: 0 4px 10px -1px rgba(29, 78, 216, 0.3);
    font-size: 1rem;
    padding: 0.875rem;
    border-radius: 10px;
    margin-top: 0.75rem;
}

#inst-hat-pipes .btn-calculate:hover {
    background-color: #1e40af;
}

#inst-hat-pipes .btn-secondary {
    background-color: #e5e7eb;
    color: #374151;
    border: 1px solid #d1d5db;
}

#inst-hat-pipes .btn-secondary:hover {
    background-color: #d1d5db;
}

#inst-hat-pipes .btn-warning {
    background-color: #eab308;
    color: white;
}

#inst-hat-pipes .btn-warning:hover {
    background-color: #d97706;
}

#inst-hat-pipes .back-button {
    background-color: #f0f5fa;

    color: #555;
    margin-top: 25px;
    border: 2px solid #b0c4de;

    display: block;
    width: 100%;
    padding: 15px;
    font-size: 1em;
    font-weight: 600;

    border-radius: 8px;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.2s;

}

#inst-hat-pipes .back-button:hover {
    background-color: #e6f0f7;
}

#inst-hat-pipes .btn-link {
    font-size: 0.75rem;
    color: #ef4444;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
}

/* --- 5. РЕЗУЛЬТАТЫ ДУГИ --- */
#inst-hat-pipes .arc-result {
    background-color: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 0.5rem;
    text-align: center;
    font-size: 0.8rem;
}

#inst-hat-pipes .arc-result-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1d4ed8;
    margin-top: 0.25rem;
}

/* Обратный расчет дуги */
#inst-hat-pipes .arc-conversion {
    background-color: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 1rem;
}

#inst-hat-pipes .arc-conversion-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 0.5rem;
}

#inst-hat-pipes .angle-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background-color: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    margin-bottom: 0.5rem;
}

#inst-hat-pipes .angle-result-label {
    font-size: 0.8rem;
    color: #4b5563;
}

#inst-hat-pipes .angle-result-value {
    font-size: 0.9rem;
    font-weight: 700;
    color: #1d4ed8;
}

#inst-hat-pipes .angle-result-detail {
    font-size: 0.7rem;
    color: #6b7280;
    margin-top: 0.125rem;
}

/* --- 6. ТАБЛИЦА РЕЗУЛЬТАТОВ --- */
#inst-hat-pipes .table-wrapper {
    overflow-x: auto;
    border-radius: 8px;
    margin-top: 1rem;
    border: 1px solid #d1d5db;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.07);
}


.table-wrapper::-webkit-scrollbar {
  width: 18px;
  height: 24px;
}

.table-wrapper::-webkit-scrollbar-track {
  background: rgba(0,0,0,.06);
  border-radius: 999px;
  margin: 6px;
}

.table-wrapper::-webkit-scrollbar-thumb {
  border-radius: 999px;
  border: 6px solid transparent;     
  background-clip: padding-box;
  background-color: rgba(0,0,0,.28); 
}

.table-wrapper::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0,0,0,.38); 
}

.table-wrapper::-webkit-scrollbar-thumb:active {
  background-color: rgba(0,0,0,.5); 
}


#inst-hat-pipes table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
    font-size: 0.8rem;
}


#inst-hat-pipes th,
#inst-hat-pipes td {
    padding: 8px 6px;
    text-align: center;
    border: 1px solid #d1d5db;
    white-space: normal;
    word-break: break-word;
}


/* Заголовок таблицы */
#inst-hat-pipes thead tr:first-child th {
    background-color: #f9fafb;
    color: #1f2937;
    border-bottom: 2px solid #d1d5db;
    padding: 0.75rem;
    text-align: left;
    font-size: 0.8rem;
}

#inst-hat-pipes .table-title {
    font-size: 1rem;
    font-weight: 700;
    color: #1d4ed8;
    margin-bottom: 0.25rem;
}

#inst-hat-pipes .table-subtitle {
    font-size: 0.8rem;
    color: #4b5563;
    font-weight: 400;
}

/* Заголовки колонок */
#inst-hat-pipes thead tr:nth-child(2) th {
    background-color: #3b82f6;
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    border-color: #2563eb;
    padding: 6px 4px;
}

#inst-hat-pipes tbody tr:nth-child(even) {
    background-color: #f9fafb;
}

#inst-hat-pipes tbody tr:nth-child(odd) {
    background-color: white;
}

#inst-hat-pipes .table-wrapper {
    width: 100%;
    max-width: 100%;
}


/* --- 7. ПОЛЯ ДЛЯ ПАТРУБКОВ --- */
#inst-hat-pipes .nozzle-inputs-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1rem;
}

#inst-hat-pipes .nozzle-row-container {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.875rem;
    background-color: #f9fafb;
}

#inst-hat-pipes .nozzle-row-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
}

#inst-hat-pipes .nozzle-row-title {
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

#inst-hat-pipes .nozzle-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto auto;
    gap: 0.5rem;
    align-items: end;
}

#inst-hat-pipes .nozzle-row input {
    font-size: 0.8rem;
    padding: 0.5rem;
}

/* Для крыши - другая сетка (градус перед расстоянием) */
#inst-hat-pipes .nozzle-row-roof {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1.5fr auto auto;
    gap: 0.5rem;
    align-items: end;
}

#inst-hat-pipes .btn-delete {
    padding: 0.375rem;
    background-color: #fee2e2;
    border: 1px solid #fecaca;
    border-radius: 6px;
    color: #dc2626;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

#inst-hat-pipes .btn-delete:hover {
    background-color: #fecaca;
}

#inst-hat-pipes .btn-reset {
    padding: 0.375rem;
    background-color: #fef3c7;
    border: 1px solid #fde68a;
    border-radius: 6px;
    color: #d97706;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

#inst-hat-pipes .btn-reset:hover {
    background-color: #fde68a;
}

#inst-hat-pipes .btn-delete svg,
#inst-hat-pipes .btn-reset svg {
    width: 1rem;
    height: 1rem;
}

/* --- 8. ИНФОРМАЦИЯ ОБ ОСЯХ --- */
#inst-hat-pipes .axes-info {
    background-color: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 0.75rem;
    font-size: 0.8rem;
}

#inst-hat-pipes .axes-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-top: 0.5rem;
}

#inst-hat-pipes .axis-item {
    background-color: white;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    text-align: center;
}

#inst-hat-pipes .axis-number {
    font-weight: 700;
    color: #2563eb;
    font-size: 0.9rem;
}

#inst-hat-pipes .axis-degrees {
    color: #4b5563;
    font-size: 0.75rem;
}

#inst-hat-pipes .axis-length {
    font-weight: 600;
    color: #059669;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

/* --- 9. КАЛЬКУЛЯТОР --- */
#inst-hat-pipes .calculator-modal {
    width: 100%;
    height: 100%;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
    padding: 1rem;
    display: none;
}

#inst-hat-pipes .calculator-modal.visible {
    display: flex;
}

#inst-hat-pipes .calculator-box {
    background-color: white;
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 280px;
}

#inst-hat-pipes .calculator-display {
    background-color: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    text-align: right;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    min-height: 2rem;
    overflow-x: auto;
    white-space: nowrap;
}

#inst-hat-pipes .calculator-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.375rem;
}

#inst-hat-pipes .calc-btn {
    padding: 0.75rem;
    font-size: 1rem;
    font-weight: 700;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background-color: white;
    cursor: pointer;
    transition: all 0.1s;
}

#inst-hat-pipes .calc-btn:active {
    background-color: #f3f4f6;
    transform: scale(0.95);
}

#inst-hat-pipes .calc-btn.operator {
    background-color: #3b82f6;
    color: white;
    border-color: #2563eb;
}

#inst-hat-pipes .calc-btn.equals {
    background-color: #10b981;
    color: white;
    border-color: #059669;
    grid-column: span 2;
}

#inst-hat-pipes .calc-btn.clear {
    background-color: #ef4444;
    color: white;
    border-color: #dc2626;
    grid-column: span 2;
}

/* --- 10. МОДАЛЬНЫЕ ОКНА --- */
#inst-hat-pipes .modal-overlay {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(4px);
    padding: 1rem;
    display: none;
}

#inst-hat-pipes .modal-overlay.visible {
    display: flex;
}

#inst-hat-pipes .modal-box {
    background-color: white;
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 280px;
}

#inst-hat-pipes .modal-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #1e293b;
    margin-top: 0;
}

#inst-hat-pipes .modal-body {
    margin-bottom: 1rem;
    font-size: 0.8rem;
    color: #4b5563;
    line-height: 1.5;
}

/* --- 11. ХЕЛПЕРЫ --- */
#inst-hat-pipes .hidden {
    display: none !important;
}

/* --- 12. ИМПОРТ ДАННЫХ --- */
#inst-hat-pipes .import-tab {
    background-color: #f8fafc;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

#inst-hat-pipes .import-tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: #f1f5f9;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
}

#inst-hat-pipes .import-tab-header:hover {
    background-color: #e2e8f0;
}

#inst-hat-pipes .import-tab-header.active {
    background-color: #dbeafe;
    border-bottom: 1px solid #bfdbfe;
}

#inst-hat-pipes .import-tab-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #1e293b;
    font-size: 0.9rem;
}

#inst-hat-pipes .import-tab-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: #3b82f6;
    transition: transform 0.3s ease;
}

#inst-hat-pipes .import-tab-header.active .import-tab-icon {
    transform: rotate(180deg);
}

#inst-hat-pipes .import-tab-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out, padding 0.3s ease;
    padding: 0 1rem;
}

#inst-hat-pipes .import-tab-content.expanded {
    max-height: 600px;
    padding: 1rem;
    overflow-y: auto;
    scroll-behavior: smooth;
}

#inst-hat-pipes .import-tab-content::-webkit-scrollbar {
    width: 6px;
}

#inst-hat-pipes .import-tab-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#inst-hat-pipes .import-tab-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

#inst-hat-pipes .import-tab-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

#inst-hat-pipes .import-columns-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

#inst-hat-pipes .import-column {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

#inst-hat-pipes .import-column-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #4b5563;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#inst-hat-pipes .import-textarea {
    width: 100%;
    min-height: 100px;
    max-height: 200px;
    padding: 0.75rem;
    font-size: 0.85rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    resize: vertical;
    background-color: white;
    transition: border-color 0.2s;
    overflow-y: auto;
    scroll-behavior: smooth;
}

#inst-hat-pipes .import-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#inst-hat-pipes .import-textarea::-webkit-scrollbar {
    width: 6px;
}

#inst-hat-pipes .import-textarea::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#inst-hat-pipes .import-textarea::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

#inst-hat-pipes .import-hint {
    font-size: 0.7rem;
    color: #6b7280;
    line-height: 1.4;
    margin-bottom: 1rem;
    padding: 0.5rem;
    background-color: #f9fafb;
    border-radius: 6px;
    border-left: 3px solid #3b82f6;
}

#inst-hat-pipes .import-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

#inst-hat-pipes .clear-btn {
    background: none;
    border: none;
    color: #ef4444;
    font-size: 0.7rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

#inst-hat-pipes .clear-btn:hover {
    background-color: #fee2e2;
}

/* Responsive design for inst-hat-pipes module */

/* Very small screens (phones under 320px) */
@media (max-width: 319px) {
    #inst-hat-pipes {
        margin: 10px auto;
        border-radius: 8px;
    }

    #inst-hat-pipes .app-header {
        padding: 15px;
        height: auto;
    }

    #inst-hat-pipes .app-header h1 {
        font-size: 1rem;
    }

    #inst-hat-pipes .header-actions {
        right: 0.5rem;
    }

    #inst-hat-pipes #main-content {
        padding: 0.5rem;
        padding-bottom: 100px;
    }

    #inst-hat-pipes .tabs {
        grid-template-columns: 1fr;
        gap: 0.3rem;
    }

    #inst-hat-pipes .tab {
        padding: 0.6rem 0.4rem;
        font-size: 0.8rem;
    }

    #inst-hat-pipes .input-group {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border-radius: 8px;
    }

    #inst-hat-pipes .input-group h2 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    #inst-hat-pipes .input-container {
        margin-bottom: 0.6rem;
    }

    #inst-hat-pipes .input-label {
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
    }

    #inst-hat-pipes .input-label span {
        font-size: 0.7rem;
    }

    #inst-hat-pipes input[type="text"],
    #inst-hat-pipes input[type="tel"] {
        padding: 0.6rem;
        font-size: 0.8rem;
    }

    #inst-hat-pipes .btn {
        padding: 0.6rem;
        font-size: 0.8rem;
    }

    #inst-hat-pipes .btn-calculate {
        padding: 0.7rem;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }

    #inst-hat-pipes .arc-result {
        padding: 0.5rem;
        font-size: 0.7rem;
    }

    #inst-hat-pipes .arc-result-value {
        font-size: 0.9rem;
    }

    #inst-hat-pipes .arc-conversion {
        padding: 0.5rem;
    }

    #inst-hat-pipes .arc-conversion-title {
        font-size: 0.7rem;
        margin-bottom: 0.4rem;
    }

    #inst-hat-pipes .angle-result-item {
        padding: 0.4rem;
        margin-bottom: 0.4rem;
    }

    #inst-hat-pipes .angle-result-label {
        font-size: 0.7rem;
    }

    #inst-hat-pipes .angle-result-value {
        font-size: 0.8rem;
    }

    #inst-hat-pipes .table-wrapper {
        margin-top: 0.75rem;
    }

    #inst-hat-pipes table {
        font-size: 0.7rem;
    }

    #inst-hat-pipes th,
    #inst-hat-pipes td {
        padding: 6px 4px;
    }

    #inst-hat-pipes .nozzle-inputs-grid {
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    #inst-hat-pipes .nozzle-row-container {
        padding: 0.6rem;
    }

    #inst-hat-pipes .nozzle-row-header {
        margin-bottom: 0.5rem;
        padding-bottom: 0.4rem;
    }

    #inst-hat-pipes .nozzle-row-title {
        font-size: 0.8rem;
    }

    #inst-hat-pipes .nozzle-row {
        grid-template-columns: 1fr 1fr;
        gap: 0.4rem;
    }

    #inst-hat-pipes .nozzle-row-roof {
        grid-template-columns: 1fr 1fr;
        gap: 0.4rem;
    }

    #inst-hat-pipes .nozzle-row input {
        font-size: 0.7rem;
        padding: 0.4rem;
    }

    #inst-hat-pipes .axes-grid {
        grid-template-columns: 1fr;
        gap: 0.4rem;
    }

    #inst-hat-pipes .axis-item {
        padding: 0.4rem;
    }

    #inst-hat-pipes .axis-number {
        font-size: 0.8rem;
    }

    #inst-hat-pipes .axis-degrees {
        font-size: 0.7rem;
    }

    #inst-hat-pipes .axis-length {
        font-size: 0.7rem;
        margin-top: 0.2rem;
    }

    #inst-hat-pipes .import-columns-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    #inst-hat-pipes .import-column {
        gap: 0.4rem;
    }

    #inst-hat-pipes .import-column-label {
        font-size: 0.7rem;
    }

    #inst-hat-pipes .import-textarea {
        min-height: 80px;
        padding: 0.5rem;
        font-size: 0.75rem;
    }

    #inst-hat-pipes .import-hint {
        font-size: 0.65rem;
        margin-bottom: 0.75rem;
        padding: 0.4rem;
    }

    #inst-hat-pipes .import-actions {
        gap: 0.4rem;
        margin-top: 0.4rem;
    }

    #inst-hat-pipes .clear-btn {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
    }

    #inst-hat-pipes .back-button {
        padding: 12px;
        font-size: 0.9em;
        margin-top: 15px;
    }
}

/* Small screens (phones 320px to 479px) */
@media (min-width: 320px) and (max-width: 479px) {
    #inst-hat-pipes {
        margin: 10px auto;
        border-radius: 8px;
    }

    #inst-hat-pipes .app-header {
        padding: 16px 20px;
        height: auto;
    }

    #inst-hat-pipes .app-header h1 {
        font-size: 1.05rem;
    }

    #inst-hat-pipes .header-actions {
        right: 0.75rem;
    }

    #inst-hat-pipes #main-content {
        padding: 0.6rem;
        padding-bottom: 110px;
    }

    #inst-hat-pipes .tabs {
        grid-template-columns: 1fr;
        gap: 0.4rem;
    }

    #inst-hat-pipes .tab {
        padding: 0.65rem 0.45rem;
        font-size: 0.8rem;
    }

    #inst-hat-pipes .input-group {
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        border-radius: 8px;
    }

    #inst-hat-pipes .input-group h2 {
        font-size: 1.05rem;
        margin-bottom: 0.6rem;
    }

    #inst-hat-pipes .input-container {
        margin-bottom: 0.7rem;
    }

    #inst-hat-pipes .input-label {
        font-size: 0.75rem;
        margin-bottom: 0.3rem;
    }

    #inst-hat-pipes .input-label span {
        font-size: 0.75rem;
    }

    #inst-hat-pipes input[type="text"],
    #inst-hat-pipes input[type="tel"] {
        padding: 0.65rem;
        font-size: 0.85rem;
    }

    #inst-hat-pipes .btn {
        padding: 0.65rem;
        font-size: 0.85rem;
    }

    #inst-hat-pipes .btn-calculate {
        padding: 0.75rem;
        font-size: 0.95rem;
        margin-top: 0.6rem;
    }

    #inst-hat-pipes .arc-result {
        padding: 0.6rem;
        font-size: 0.75rem;
    }

    #inst-hat-pipes .arc-result-value {
        font-size: 1rem;
    }

    #inst-hat-pipes .arc-conversion {
        padding: 0.6rem;
    }

    #inst-hat-pipes .arc-conversion-title {
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
    }

    #inst-hat-pipes .angle-result-item {
        padding: 0.45rem;
        margin-bottom: 0.5rem;
    }

    #inst-hat-pipes .angle-result-label {
        font-size: 0.75rem;
    }

    #inst-hat-pipes .angle-result-value {
        font-size: 0.85rem;
    }

    #inst-hat-pipes .table-wrapper {
        margin-top: 0.8rem;
    }

    #inst-hat-pipes table {
        font-size: 0.75rem;
    }

    #inst-hat-pipes th,
    #inst-hat-pipes td {
        padding: 6px 5px;
    }

    #inst-hat-pipes .nozzle-inputs-grid {
        gap: 0.8rem;
        margin-bottom: 0.8rem;
    }

    #inst-hat-pipes .nozzle-row-container {
        padding: 0.7rem;
    }

    #inst-hat-pipes .nozzle-row-header {
        margin-bottom: 0.6rem;
        padding-bottom: 0.5rem;
    }

    #inst-hat-pipes .nozzle-row-title {
        font-size: 0.85rem;
    }

    #inst-hat-pipes .nozzle-row {
        grid-template-columns: 1fr 1fr;
        gap: 0.45rem;
    }

    #inst-hat-pipes .nozzle-row-roof {
        grid-template-columns: 1fr 1fr;
        gap: 0.45rem;
    }

    #inst-hat-pipes .nozzle-row input {
        font-size: 0.75rem;
        padding: 0.45rem;
    }

    #inst-hat-pipes .axes-grid {
        gap: 0.5rem;
    }

    #inst-hat-pipes .axis-item {
        padding: 0.45rem;
    }

    #inst-hat-pipes .axis-number {
        font-size: 0.85rem;
    }

    #inst-hat-pipes .axis-degrees {
        font-size: 0.75rem;
    }

    #inst-hat-pipes .axis-length {
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    #inst-hat-pipes .import-columns-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
    }

    #inst-hat-pipes .import-column {
        gap: 0.5rem;
    }

    #inst-hat-pipes .import-column-label {
        font-size: 0.75rem;
    }

    #inst-hat-pipes .import-textarea {
        min-height: 90px;
        padding: 0.6rem;
        font-size: 0.8rem;
    }

    #inst-hat-pipes .import-hint {
        font-size: 0.7rem;
        margin-bottom: 0.8rem;
        padding: 0.45rem;
    }

    #inst-hat-pipes .import-actions {
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    #inst-hat-pipes .clear-btn {
        font-size: 0.7rem;
        padding: 0.25rem 0.45rem;
    }

    #inst-hat-pipes .back-button {
        padding: 13px;
        font-size: 0.95em;
        margin-top: 18px;
    }
}

/* Medium screens (tablets 480px to 767px) */
@media (min-width: 480px) and (max-width: 767px) {
    #inst-hat-pipes {
        margin: 15px auto;
        max-width: 95%;
    }

    #inst-hat-pipes .app-header {
        padding: 18px 22px;
    }

    #inst-hat-pipes .app-header h1 {
        font-size: 1.1rem;
    }

    #inst-hat-pipes .tabs {
        grid-template-columns: repeat(3, 1fr);
    }

    #inst-hat-pipes .input-group {
        padding: 0.9rem;
    }

    #inst-hat-pipes .input-group h2 {
        font-size: 1.08rem;
    }

    #inst-hat-pipes .nozzle-row {
        grid-template-columns: 2fr 1fr 1fr 1fr auto auto;
    }

    #inst-hat-pipes .nozzle-row-roof {
        grid-template-columns: 2fr 1fr 1fr 1.5fr auto auto;
    }

    #inst-hat-pipes .axes-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    #inst-hat-pipes .import-columns-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    #inst-hat-pipes .back-button {
        padding: 14px;
        font-size: 1em;
        margin-top: 20px;
    }
}

/* Large screens (tablets 768px to 1023px) */
@media (min-width: 768px) and (max-width: 1023px) {
    #inst-hat-pipes {
        margin: 15px auto;
        max-width: 90%;
    }

    #inst-hat-pipes .app-header {
        padding: 19px 24px;
    }

    #inst-hat-pipes .input-group {
        padding: 0.95rem;
    }

    #inst-hat-pipes .input-group h2 {
        font-size: 1.1rem;
    }

    #inst-hat-pipes .table-wrapper {
        margin-top: 0.9rem;
    }

    #inst-hat-pipes table {
        font-size: 0.8rem;
    }

    #inst-hat-pipes .back-button {
        padding: 14.5px;
        font-size: 1.05em;
        margin-top: 22px;
    }
}

/* Extra large screens (desktops 1024px and above) */
@media (min-width: 1024px) {
    #inst-hat-pipes .app-header {
        padding: 20px 25px;
    }

    #inst-hat-pipes .input-group {
        padding: 1rem;
    }

    #inst-hat-pipes .input-group h2 {
        font-size: 1.1rem;
    }

    #inst-hat-pipes .table-wrapper {
        margin-top: 1rem;
    }

    #inst-hat-pipes table {
        font-size: 0.8rem;
    }

    #inst-hat-pipes .back-button {
        padding: 15px;
        font-size: 1em;
        margin-top: 25px;
    }
}
      </style>
      <style>
        :root {
    --primary-color: #1e40af;
    --primary-light: #3b82f6;
    --secondary-color: #0ea5e9;
    --bg-color: #f0f9ff;
    --card-bg: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #475569;
    --border-color: #cbd5e1;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --hatch-color: #3b82f6;
    --pipe-color: #10b981;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --tab-active-green: #10b981;
    --tab-inactive-blue: #3b82f6;
}

/* body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-primary);
    line-height: 1.6;
    padding: 16px;
    min-height: 100vh;
} */

#insp-hat-pipes {
    max-width: 1200px;
    margin: 20px auto;
    background-color: #f8fafc;
    border-radius: 16px;
    /* box-shadow: var(--shadow); */
    overflow: hidden;
    display: none;

}

/* --- ШАПКА --- */
#insp-hat-pipes .header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 24px 32px;
    position: relative;
    /* overflow: hidden; */
}

#insp-hat-pipes .header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    opacity: 0.1;
}

#insp-hat-pipes .header h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
}

#insp-hat-pipes .header p {
    opacity: 0.9;
    font-size: 16px;
    position: relative;
    z-index: 1;
}

/* --- ВКЛАДКИ РЕЖИМОВ --- */
#insp-hat-pipes .mode-tabs {
    display: flex;
    background: #e2e8f0;
    border-bottom: 2px solid var(--border-color);
    position: relative;
    z-index: 10;
}

#insp-hat-pipes .mode-tab {
    flex: 1;
    padding: 18px;
    text-align: center;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    background-color: var(--tab-inactive-blue);
    border-bottom: 4px solid transparent;
}

#insp-hat-pipes .mode-tab:hover {
    opacity: 0.9;
}

#insp-hat-pipes .mode-tab.active {
    background-color: var(--tab-active-green);
    border-bottom: 4px solid white;
}

/* --- ПАНЕЛЬ УПРАВЛЕНИЯ ПРОЕКТОМ --- */
#insp-hat-pipes .project-controls {
    background: white;
    padding: 20px 32px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

#insp-hat-pipes .project-selector {
    flex: 1;
    min-width: 300px;
    display: flex;
    gap: 8px;
}

#insp-hat-pipes .project-selector select {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 15px;
    background: white;
    cursor: pointer;
}

#insp-hat-pipes .project-selector select:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* --- СОДЕРЖИМОЕ ВКЛАДОК --- */
#insp-hat-pipes .tab-content {
    padding: 24px;
    display: none;
}

#insp-hat-pipes .tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- ФОРМЫ И КОНТРОЛЫ --- */
#insp-hat-pipes .form-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

#insp-hat-pipes .form-section h3 {
    font-size: 18px;
    color: var(--primary-color);
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
}

#insp-hat-pipes .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

#insp-hat-pipes .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

#insp-hat-pipes .form-group label {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-secondary);
}

#insp-hat-pipes .form-group input {
    padding: 10px 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
}

#insp-hat-pipes .form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* --- УПРАВЛЕНИЕ ТАБЛИЦЕЙ --- */
#insp-hat-pipes .table-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

#insp-hat-pipes .table-controls .btn {
    width: auto;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

#insp-hat-pipes .btn-primary {
    background: var(--primary-color);
    color: white;
}

#insp-hat-pipes .btn-primary:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
}

#insp-hat-pipes .btn-secondary {
    background: #e2e8f0;
    color: var(--text-primary);
}

#insp-hat-pipes .btn-secondary:hover {
    background: #cbd5e1;
}

#insp-hat-pipes .btn-success {
    background: var(--success-color);
    color: white;
}

#insp-hat-pipes .btn-success:hover {
    background: #059669;
}

#insp-hat-pipes .export-excel {
    background: linear-gradient(135deg, var(--success-green) 0%, #4CAF50 100%);
    color: var(--white);
    border: none;
    box-shadow: var(--shadow-light);
    transition: all 0.3s ease;
}

#insp-hat-pipes .export-excel:hover {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

#insp-hat-pipes .excel-icon {
    display: inline-block;
    margin-right: 8px;
    font-weight: bold;
}

#insp-hat-pipes .btn-warning {
    background: var(--warning-color);
    color: white;
}

#insp-hat-pipes .btn-danger {
    background: var(--danger-color);
    color: white;
}

#insp-hat-pipes .btn-danger:hover {
    background: #dc2626;
}

#insp-hat-pipes .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

/* --- ТАБЛИЦА --- */
#insp-hat-pipes .table-wrapper {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding-bottom: 6px;
}

#insp-hat-pipes table {
    width: 100%;
    border-collapse: collapse;
    min-width: 2200px;
}

#insp-hat-pipes thead {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
}

#insp-hat-pipes thead th {
    padding: 10px 6px;
    text-align: center;
    font-weight: 600;
    font-size: 11px;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    vertical-align: middle;
}

#insp-hat-pipes thead th:last-child {
    border-right: none;
}

#insp-hat-pipes .column-group {
    background: #1e3a8a;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

#insp-hat-pipes tbody tr {
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s;
}

#insp-hat-pipes tbody tr:hover {
    background-color: #f8fafc;
}

#insp-hat-pipes tbody tr:nth-child(even) {
    background-color: #f8fafc;
}

#insp-hat-pipes tbody tr:nth-child(even):hover {
    background-color: #f1f5f9;
}

#insp-hat-pipes tbody td {
    padding: 8px 6px;
    text-align: center;
    border-right: 1px solid var(--border-color);
    min-width: 120px;
}

#insp-hat-pipes tbody td:last-child {
    border-right: none;
}

#insp-hat-pipes tbody input {
    width: 100%;
    padding: 8px 10px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    text-align: center;
    font-size: 14px;
    min-width: 110px;
    transition: all 0.3s;
}

#insp-hat-pipes tbody input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

#insp-hat-pipes tbody input.invalid {
    border-color: var(--danger-color);
    background-color: rgba(239, 68, 68, 0.05);
}

#insp-hat-pipes tbody input.valid {
    border-color: var(--success-color);
    background-color: rgba(16, 185, 129, 0.05);
}

/* --- КНОПКИ Л и П --- */
#insp-hat-pipes .type-selector {
    display: flex;
    gap: 4px;
    justify-content: center;
}

#insp-hat-pipes .type-btn {
    padding: 4px 8px;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    background: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 32px;
}

#insp-hat-pipes .type-btn:hover {
    transform: translateY(-1px);
}

#insp-hat-pipes .type-btn.hatch {
    color: var(--hatch-color);
    border-color: var(--hatch-color);
}

#insp-hat-pipes .type-btn.hatch.active {
    background: var(--hatch-color);
    color: white;
}

#insp-hat-pipes .type-btn.pipe {
    color: var(--pipe-color);
    border-color: var(--pipe-color);
}

#insp-hat-pipes .type-btn.pipe.active {
    background: var(--pipe-color);
    color: white;
}
#insp-hat-pipes .back-button{
    background-color: #f0f5fa;

    color: #555;
    margin-top: 25px;
    border: 2px solid #b0c4de;

    display: block;
    width: 100%;
    padding: 15px;
    font-size: 1em;
    font-weight: 600;

    border-radius: 8px;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.2s;
}

#insp-hat-pipes .back-button:hover{
    background-color: #e6f0f7;
}

#insp-hat-pipes .delete-row {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

#insp-hat-pipes .delete-row:hover {
    background-color: rgba(239, 68, 68, 0.1);
}

/* --- МАССОВЫЙ ВВОД --- */
#insp-hat-pipes .bulk-input-btn {
    margin-left: auto;
}

.bulk-input-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    display: none;
}

.bulk-input-modal.active {
    display: flex;
}

.bulk-input-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.bulk-input-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin: 16px 0;
}

.bulk-column {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.bulk-column h4 {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.bulk-column textarea {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 12px;
    resize: vertical;
}

.bulk-column textarea:focus {
    outline: none;
    border-color: var(--primary-color);
}



/* --- ПРИМЕЧАНИЕ --- */
.note-section {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-radius: 12px;
    padding: 16px;
    margin-top: 20px;
    border: 1px solid #fbbf24;
    overflow: hidden;
}

.note-section h3 {
    color: #92400e;
    margin-bottom: 12px;
    font-size: 15px;
    text-align: center;
}

.note-wrapper {
    overflow-x: auto;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #f59e0b;
}

.note-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    min-width: 600px;
    font-size: 11px;
}

.note-table th {
    background: #f59e0b;
    color: white;
    padding: 8px 4px;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    line-height: 1.2;
}

.note-table td {
    padding: 8px 4px;
    border-bottom: 1px solid #fde68a;
    text-align: center;
    line-height: 1.2;
}

.note-table tr:last-child td {
    border-bottom: none;
}

.note-table tr:nth-child(even) {
    background: #fffbeb;
}

.standard-ref {
    font-size: 10px;
    color: #475569;
    margin-top: 10px;
    font-style: italic;
    text-align: center;
}

/* --- АДАПТИВНОСТЬ --- */
@media (max-width: 319px) {
    #insp-hat-pipes {
        margin: 10px auto;
        border-radius: 12px;
    }

    #insp-hat-pipes .header {
        padding: 14px 16px;
    }

    #insp-hat-pipes .header h1 {
        font-size: 18px;
    }

    #insp-hat-pipes .header p {
        font-size: 14px;
    }

    #insp-hat-pipes .mode-tabs {
        flex-direction: column;
    }

    #insp-hat-pipes .mode-tab {
        padding: 12px;
        font-size: 14px;
    }

    #insp-hat-pipes .project-controls {
        flex-direction: column;
        align-items: stretch;
        padding: 12px;
        gap: 8px;
    }

    #insp-hat-pipes .project-selector {
        min-width: 100%;
        flex-direction: column;
    }

    #insp-hat-pipes .project-selector select {
        min-width: 100%;
    }

    #insp-hat-pipes .tab-content {
        padding: 12px;
    }

    #insp-hat-pipes .form-section {
        padding: 12px;
        margin-bottom: 15px;
    }

    #insp-hat-pipes .form-section h3 {
        font-size: 16px;
        margin-bottom: 12px;
    }

    #insp-hat-pipes .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 15px;
    }

    #insp-hat-pipes .form-group {
        gap: 5px;
    }

    #insp-hat-pipes .form-group label {
        font-size: 12px;
    }

    #insp-hat-pipes .form-group input {
        padding: 8px;
        font-size: 13px;
    }

    #insp-hat-pipes .table-controls {
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
    }

    #insp-hat-pipes .table-controls .btn {
        width: 100%;
        justify-content: center;
        padding: 8px 16px;
        font-size: 13px;
    }

    #insp-hat-pipes .table-wrapper {
        margin-bottom: 15px;
    }

    #insp-hat-pipes table {
        min-width: 100%;
        font-size: 10px;
    }

    #insp-hat-pipes thead th {
        padding: 6px 4px;
        font-size: 9px;
    }

    #insp-hat-pipes .column-group {
        font-size: 8px;
    }

    #insp-hat-pipes tbody td {
        padding: 6px 4px;
        font-size: 10px;
    }

    #insp-hat-pipes tbody input {
        padding: 4px;
        font-size: 10px;
    }

    #insp-hat-pipes .type-selector {
        gap: 3px;
    }

    #insp-hat-pipes .type-btn {
        padding: 3px 6px;
        font-size: 11px;
        min-width: 24px;
    }

    #insp-hat-pipes .back-button {
        padding: 12px;
        font-size: 0.9em;
        margin-top: 15px;
    }

    #insp-hat-pipes .delete-row {
        padding: 2px;
    }

    .bulk-input-content {
        width: 95%;
        padding: 12px;
        max-width: none;
    }

    .bulk-input-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 12px 0;
    }

    .bulk-column textarea {
        min-height: 80px;
        padding: 8px;
        font-size: 11px;
    }

    .note-section {
        padding: 12px;
        margin-top: 15px;
    }

    .note-section h3 {
        font-size: 13px;
    }

    .note-table {
        font-size: 9px;
        min-width: 100%;
    }

    .note-table th,
    .note-table td {
        padding: 6px 3px;
    }

    .standard-ref {
        font-size: 9px;
    }
}

@media (min-width: 320px) and (max-width: 479px) {
    #insp-hat-pipes {
        margin: 10px auto;
        border-radius: 12px;
    }

    #insp-hat-pipes .header {
        padding: 16px 20px;
    }

    #insp-hat-pipes .header h1 {
        font-size: 20px;
    }

    #insp-hat-pipes .header p {
        font-size: 14px;
    }

    #insp-hat-pipes .mode-tabs {
        flex-direction: column;
    }

    #insp-hat-pipes .mode-tab {
        padding: 14px;
        font-size: 14px;
    }

    #insp-hat-pipes .project-controls {
        flex-direction: column;
        align-items: stretch;
        padding: 16px;
        gap: 10px;
    }

    #insp-hat-pipes .project-selector {
        min-width: 100%;
        flex-direction: column;
    }

    #insp-hat-pipes .project-selector select {
        min-width: 100%;
    }

    #insp-hat-pipes .tab-content {
        padding: 16px;
    }

    #insp-hat-pipes .form-section {
        padding: 16px;
        margin-bottom: 16px;
    }

    #insp-hat-pipes .form-section h3 {
        font-size: 16px;
        margin-bottom: 14px;
    }

    #insp-hat-pipes .form-grid {
        grid-template-columns: 1fr;
        gap: 14px;
        margin-bottom: 18px;
    }

    #insp-hat-pipes .form-group {
        gap: 6px;
    }

    #insp-hat-pipes .form-group label {
        font-size: 12px;
    }

    #insp-hat-pipes .form-group input {
        padding: 8px;
        font-size: 13px;
    }

    #insp-hat-pipes .table-controls {
        flex-direction: column;
        gap: 8px;
        margin-bottom: 14px;
    }

    #insp-hat-pipes .table-controls .btn {
        width: 100%;
        justify-content: center;
        padding: 8px 16px;
        font-size: 13px;
    }

    #insp-hat-pipes .table-wrapper {
        margin-bottom: 18px;
    }

    #insp-hat-pipes table {
        min-width: 100%;
        font-size: 11px;
    }

    #insp-hat-pipes thead th {
        padding: 7px 4px;
        font-size: 10px;
    }

    #insp-hat-pipes .column-group {
        font-size: 9px;
    }

    #insp-hat-pipes tbody td {
        padding: 6px 4px;
        font-size: 11px;
    }

    #insp-hat-pipes tbody input {
        padding: 5px;
        font-size: 11px;
    }

    #insp-hat-pipes .type-selector {
        gap: 3px;
    }

    #insp-hat-pipes .type-btn {
        padding: 3px 6px;
        font-size: 12px;
        min-width: 28px;
    }

    #insp-hat-pipes .back-button {
        padding: 13px;
        font-size: 0.95em;
        margin-top: 20px;
    }

    #insp-hat-pipes .delete-row {
        padding: 3px;
    }

    .bulk-input-content {
        width: 95%;
        padding: 16px;
        max-width: none;
    }

    .bulk-input-grid {
        grid-template-columns: 1fr;
        gap: 14px;
        margin: 14px 0;
    }

    .bulk-column textarea {
        min-height: 90px;
        padding: 9px;
        font-size: 11px;
    }

    .note-section {
        padding: 14px;
        margin-top: 18px;
    }

    .note-section h3 {
        font-size: 14px;
    }

    .note-table {
        font-size: 10px;
        min-width: 100%;
    }

    .note-table th,
    .note-table td {
        padding: 6px 3px;
    }

    .standard-ref {
        font-size: 9px;
    }
}

@media (min-width: 480px) and (max-width: 767px) {
    #insp-hat-pipes .header {
        padding: 18px 22px;
    }

    #insp-hat-pipes .header h1 {
        font-size: 22px;
    }

    #insp-hat-pipes .mode-tabs {
        flex-direction: column;
    }

    #insp-hat-pipes .project-controls {
        flex-direction: column;
        align-items: stretch;
        padding: 18px;
        gap: 10px;
    }

    #insp-hat-pipes .project-selector {
        min-width: 100%;
    }

    #insp-hat-pipes .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 14px;
    }

    #insp-hat-pipes .table-controls {
        flex-wrap: nowrap;
    }

    #insp-hat-pipes .table-wrapper {
        overflow-x: auto;
    }

    #insp-hat-pipes table {
        min-width: 1200px;
    }

    #insp-hat-pipes .bulk-input-content {
        width: 95%;
        max-width: 700px;
    }

    #insp-hat-pipes .bulk-input-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    #insp-hat-pipes .note-table {
        min-width: 500px;
    }
}

@media (min-width: 768px) and (max-width: 1023px) {
    #insp-hat-pipes .header {
        padding: 20px 26px;
    }

    #insp-hat-pipes .header h1 {
        font-size: 24px;
    }

    #insp-hat-pipes .project-controls {
        padding: 18px 26px;
    }

    #insp-hat-pipes .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }

    #insp-hat-pipes .form-section {
        padding: 18px;
    }

    #insp-hat-pipes .table-wrapper {
        overflow-x: auto;
    }

    #insp-hat-pipes table {
        min-width: 1500px;
    }

    #insp-hat-pipes .note-table {
        min-width: 550px;
    }
}

@media (min-width: 1024px) {
    #insp-hat-pipes .header {
        padding: 24px 32px;
    }

    #insp-hat-pipes .header h1 {
        font-size: 28px;
    }

    #insp-hat-pipes .project-controls {
        padding: 20px 32px;
    }

    #insp-hat-pipes .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    #insp-hat-pipes .form-section {
        padding: 20px;
    }

    #insp-hat-pipes .table-wrapper {
        overflow-x: auto;
    }

    #insp-hat-pipes table {
        min-width: 1800px;
    }

    #insp-hat-pipes .note-table {
        min-width: 600px;
    }
}

/* --- УТИЛИТЫ --- */
#insp-hat-pipes .hidden {
    display: none !important;
}

#insp-hat-pipes .icon {
    width: 18px;
    height: 18px;
    stroke-width: 2;
}

.scroll-to-top {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: all 0.3s;
    z-index: 100;
}

.scroll-to-top:hover {
    transform: translateY(-4px);
    background: var(--primary-light);
}

/* --- ДЛЯ УМЕНЬШЕННОГО ТЕКСТА В ЗАГОЛОВКАХ --- */
.small-text {
    font-size: 10px;
    line-height: 1.1;
    font-weight: 500;
}

.nowrap {
    white-space: nowrap;
}

/* --- МОДАЛЬНЫЕ ОКНА --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    display: none;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 16px;
}

/* --- КНОПКА УДАЛЕНИЯ ПРОЕКТА --- */
.delete-project-btn {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--danger-color);
    color: var(--danger-color);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.delete-project-btn:hover {
    background: var(--danger-color);
    color: white;
}

/* --- ВИЗУАЛИЗАЦИЯ ТИПА --- */
.type-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
}

.type-indicator.hatch {
    background-color: var(--hatch-color);
}

.type-indicator.pipe {
    background-color: var(--pipe-color);
}

/* --- АВТОСОХРАНЕНИЕ ИНДИКАТОР --- */
.autosave-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--success-color);
    opacity: 0;
    transition: opacity 0.3s;
    margin-left: 10px;
}

.autosave-indicator.visible {
    opacity: 1;
}

.autosave-indicator .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--success-color);
    animation: pulse 2s infinite;
}



@keyframes pulse {
    0% {
        opacity: 0.5;
    }

    50% {
        opacity: 1;
    }

    100% {
        opacity: 0.5;
    }
}
        </style>
			<style>
/* 1. Основной экран */
#geodesy-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(235, 240, 245, 0.98);
    z-index: 9999;
    display: none;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    padding: 10px;
    box-sizing: border-box;
}

/* 2. Карточка */
.geo-wrapper {
    width: 98%;
    max-width: 1200px;
    background: #ffffff;
    border-radius: 25px;
    padding: 25px 15px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.1);
    margin: 10px auto;
    box-sizing: border-box;
}

/* 3. Поля ввода */
.geo-inputs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .geo-inputs-grid { grid-template-columns: 1fr; }
}

.geo-field label {
    display: block;
    font-weight: 600;
    color: #546e7a;
    margin-bottom: 8px;
}

.geo-input-style {
    width: 100%;
    padding: 12px 18px;
    border: 1.5px solid #e1e8ed;
    border-radius: 50px !important;
    box-sizing: border-box;
    font-size: 1rem;
    background: #f8fafc;
    transition: 0.3s;
}

.geo-input-style:focus {
    border-color: #1e88e5;
    background: #fff;
    outline: none;
}

/* 3.1 Опции */
.geo-options-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin: 20px 0;
    background: #f8fafc;
    padding: 15px;
    border-radius: 20px;
    border: 1px solid #edf2f7;
}

.geo-option-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
    min-width: 140px;
}

.option-label {
    font-weight: 800;
    color: #1e88e5;
    font-size: 0.85rem;
    text-transform: uppercase;
}

/* --- 4. ТАБЛИЦА: ФИКСИРОВАННАЯ (БЕЗ ПРОКРУТКИ) --- */
.geo-table-container {
    width: 100%;
    margin: 15px 0;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
}

#geo-main-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
}

#geo-main-table th:nth-child(1), #geo-main-table td:nth-child(1) { width: 15%; text-align: center; }
#geo-main-table th:nth-child(2), #geo-main-table td:nth-child(2) { width: 70%; }
#geo-main-table th:nth-child(3), #geo-main-table td:nth-child(3) { width: 15%; text-align: center; }

#geo-main-table th {
    background: #e3f2fd;
    color: #1565c0;
    padding: 12px 2px;
    font-size: 0.85rem;
}

#geo-main-table td {
    padding: 8px 4px;
    vertical-align: middle;
}

#geo-main-table .geo-input-style {
    width: 100%;
    padding: 0 10px;
    height: 40px;
    border-radius: 8px !important;
    font-size: 1rem;
    text-align: center;
}

/* --- 5. КНОПКИ: ЕДИНЫЙ СТАНДАРТ --- */
.geo-btn-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
    width: 100%;
}

.geo-btn-group-top {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.btn-universal {
    width: 100%;
    height: 54px;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    border: none;
    box-sizing: border-box;
    transition: transform 0.1s;
}

.btn-universal:active { transform: scale(0.98); }

.btn-blue { background-color: #1e88e5; color: white; }
.btn-green { background-color: #2e7d32; color: white; }

.btn-white-outline {
    background-color: #ffffff;
    color: #546e7a;
    border: 2px solid #cfd8dc;
}

@media (min-width: 600px) {
    .geo-btn-group-top { flex-direction: row; }
}

/* 1. Убираем влияние глобальных table-стилей */
#geodesy-screen table {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    table-layout: fixed !important;
    border-collapse: collapse;
}

/* 2. Запрещаем горизонтальный скролл */
#geodesy-screen,
#geodesy-screen .geo-wrapper,
#geodesy-screen .geo-table-container {
    overflow-x: hidden !important;
}

/* 3. Ячейки не имеют минимальной ширины */
#geodesy-screen th,
#geodesy-screen td {
    min-width: 0 !important;
    word-break: break-word;
    overflow-wrap: anywhere;
}

/* 4. INPUT не распирает ячейку */
#geodesy-screen input {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    box-sizing: border-box;
}

/* 5. Мобильный портрет — ужимаем */
@media (max-width: 480px) {
    #geodesy-screen th,
    #geodesy-screen td {
        font-size: 12px;
        padding: 4px 2px;
    }

    #geodesy-screen input {
        font-size: 13px;
        padding: 0 6px;
    }
}

#geodesy-screen .geo-input-style {
    width: 100%;
    max-width: 100%;
    min-width: unset !important;
}

#geodesy-screen input[type="radio"] {
    width: auto !important;
    min-width: auto !important;
    max-width: none !important;
    margin: 0 6px 0 0;
    vertical-align: middle;
}

#geodesy-screen label {
    display: flex;
    align-items: center;
    gap: 6px;
    line-height: 1.2;
}

.geo-inputs-grid > .geo-field {
    min-width: 0;
}

#geodesy-screen .geo-input-style {
    height: 54px;
    padding: 14px 18px;
    font-size: 16px;
}

#geodesy-screen #geo-main-table thead th {
    height: 44px;
    padding: 10px 6px;
    font-size: 13px;
    vertical-align: middle;
}

#geodesy-screen #geo-main-table tbody td {
    height: 42px;
}

#geodesy-screen {
    position: fixed;
    inset: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.geo-wrapper {
    padding-bottom: 120px;
}
        </style>
			<style>
/* Объемный стиль для названия Мастер РВС */
.hero-title {
  color: var(--dark-blue) !important; /* Используем ваш основной темно-синий цвет */
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 2px;
  
  /* Создание эффекта глубины (3D) за счет наслоения теней */
  text-shadow: 
    0 1px 0 #bbb,
    0 2px 0 #b9b9b9,
    0 3px 0 #aaa,
    0 4px 0 #a9a9a9,
    0 5px 0 #999,
    0 6px 1px rgba(0,0,0,.1),
    0 0 5px rgba(0,0,0,.1),
    0 1px 3px rgba(0,0,0,.3),
    0 3px 5px rgba(0,0,0,.2),
    0 5px 10px rgba(0,0,0,.25),
    0 10px 10px rgba(0,0,0,.2),
    0 20px 20px rgba(0,0,0,.15);
  
  transition: transform 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Эффект легкого «приподнимания» при наведении */
.hero-title:hover {
  transform: translateY(-3px);
}


</style>
</head>

<body>
  <div class="container-hero">
    <!-- Шапка приложения -->
    <header class="header">
  <h1 class="hero-title pulsing-title" id="wave-title">
    <i class="fas fa-project-diagram"></i> Мастер РВС
  </h1>
</header>

    <main class="main-content">
      <!-- Секция проектов -->
      <section class="projects-section app-screen" id="projectsSection">
        <h2 class="section-title"><i class="fas fa-list"></i> Список проектов</h2>

        <!-- Форма добавления проекта -->
        <form class="add-project-form" id="addProjectForm">
          <input type="text" class="form-input" id="projectName" placeholder="Введите название проекта" required>
          <button type="submit" class="btn btn-primary" id="addProjectBtn">
            <i class="fas fa-plus"></i> Создать проект
          </button>
        </form>

        <!-- Список проектов -->
        <div class="projects-list" id="projectsList">
          <!-- Проекты будут загружаться здесь -->
        </div>
      </section>

      <!-- Секция модулей (изначально скрыта) -->
      <section class="modules-section app-screen hidden" id="modulesSection">
        <div class="modules-header">
          <button class="btn btn-secondary" id="backToProjectsBtn">
            <i class="fas fa-arrow-left"></i> Назад к проектам
          </button>
          <h2 class="section-title" id="modulesTitle">
            <i class="fas fa-cubes"></i> Модули проекта: <span id="currentProjectName"></span>
          </h2>
        </div>

        <!-- Список модулей -->
        <div class="modules-list" id="modulesList">
          <!-- Модули будут загружаться здесь -->
        </div>
      </section>
    </main>

  </div>
  <div id="app-fundamet" class="container-module fundament-screen-container">
    <div id="project-list-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Мои проекты РВС</h1>
      </div>
      <p>Выберите проект для продолжения работы:</p>
      <div id="projects-list-container"></div>
      <!-- <button id="create-new-project-button">Создать новый РВС</button> -->
    </div>

    <div id="setup-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Новый замер</h1>
      </div>
      <div class="form-group">
        <label for="rvs-name">Название РВС (Объект):</label>
        <input type="text" id="rvs-name" placeholder="Например, РВС-5000 №1">
      </div>
      <div class="form-group">
        <label for="rvs-date">Дата проекта:</label>
        <input type="date" id="rvs-date">
      </div>
      <button id="start-button-bottom">Начать работу</button>
      <button id="cancel-setup-button-bottom" class="secondary">Отмена</button>
    </div>

    <div id="fundament-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1 id="fundament-rvs-name"></h1>
        <p>Модуль: <strong>Фундамент</strong></p>
        <p id="fundament-rvs-date" style="font-size: 0.8em; opacity: 0.8;"></p>
      </div>

      <div id="fundament-module-list" class="module-list">
      </div>

      <button id="fundament-back-to-list-button" class="secondary back-button">Вернуться к списку проектов</button>
      <button id="fundament-back-to-modules-button" class="secondary back-button">Вернуться к выбору модулей</button>
    </div>

    <div id="annular-elevation-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Отметка поверхности кольцевого фундамента</h1>
      </div>
      <div class="form-group">
        <label for="annular-date">Дата замера:</label>
        <input type="date" id="annular-date" class="module-date-input">
      </div>
      <div class="form-group">
        <label for="rvs-diameter">Диаметр РВС, **мм**:</label>
        <input type="tel" id="rvs-diameter" min="1000" step="1" placeholder="20000">
      </div>
      <div class="form-group">
        <label>Единица измерения:</label>
        <div class="radio-group">
          <label><input type="radio" name="elevationUnit" value="m" checked> Метры (м) - Балтийская система
            координат (абсолютная)</label>
          <label><input type="radio" name="elevationUnit" value="mm"> Миллиметры (мм) - Относительная система
            координат</label>
        </div>
      </div>
      <div class="form-group">
        <label for="point-count">Количество точек:</label>
        <input type="tel" id="point-count" min="2" placeholder="Минимум 2">
      </div>
      <button id="generate-points-button" style="margin-top: -5px; background-color: #38761d;">Создать поля
        ввода</button>
      <div class="tolerance-note">
        <strong>Отметки поверхности фундамента, определяемые в зоне расположения стенки</strong><br>
        - Разность отметок смежных точек <strong>(не более 6 м)</strong>:<br>
        &nbsp;&nbsp;&nbsp;&nbsp;Диаметр резервуара до 12 м: <strong>не более</strong> 6 мм; Свыше 12 м:
        <strong>не более</strong> 8 мм.<br>
        - Разность отметок любых других точек (Макс. перепад):<br>
        &nbsp;&nbsp;&nbsp;&nbsp;Диаметр резервуара до 12 м: <strong>не более</strong> 12 мм; 12-40 м: <strong>не
          более</strong> 12 мм; 40-95 м: <strong>не более</strong> 24 мм.<br>
        <strong>ГОСТ 31385-2023 таб. 17</strong>
      </div>
      <div id="point-inputs-container"></div>
      <button id="calculate-button">Рассчитать</button>
      <div id="results-table-container" class="results-container"></div>
      <button id="export-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>

    <div id="annular-width-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Ширина кольцевого фундамента</h1>
      </div>
      <div class="form-group">
        <label for="annular-width-date">Дата замера:</label>
        <input type="date" id="annular-width-date" class="module-date-input">
      </div>
      <div class="form-group">
        <label for="projected-width">Проектная ширина, **мм**:</label>
        <input type="tel" id="projected-width" min="100" step="1" placeholder="1000">
      </div>
      <div class="tolerance-note">
        <strong>Ширина фундамента через каждые 6 м, <strong>не более</strong>.</strong><br>
        Допуск: **0, +50 мм**.<br>
        <strong>ГОСТ 31385-2023 таб. 17</strong>
      </div>
      <div class="form-group">
        <label for="point-count-width">Количество точек:</label>
        <input type="tel" id="point-count-width" min="2">
      </div>
      <button id="generate-width-points-button" style="margin-top: -5px; background-color: #38761d;">Создать поля
        ввода</button>
      <div id="width-point-inputs-container"></div>
      <button id="calculate-width-button">Рассчитать</button>
      <div id="width-results-table-container" class="results-container"></div>
      <button id="export-width-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>

    <div id="annular-diameter-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Наружный диаметр фундамента</h1>
      </div>
      <div class="form-group">
        <label for="annular-diameter-date">Дата замера:</label>
        <input type="date" id="annular-diameter-date" class="module-date-input">
      </div>
      <div class="form-group">
        <label for="rvs-diameter-annular">Диаметр РВС (проект), мм:</label>
        <input type="tel" id="rvs-diameter-annular" min="1000" placeholder="Для допуска">
      </div>
      <div class="form-group">
        <label for="projected-fundament-diameter-annular">Диаметр Фундамента (проект), мм:</label>
        <input type="tel" id="projected-fundament-diameter-annular" min="1000" placeholder="Для расчета разности">
      </div>
      <div id="diameter-tolerance-note" class="tolerance-note" style="display: none;"></div>
      <p>Введите <strong>радиус</strong> в 8 точках (в мм):</p>
      <div id="diameter-point-inputs-container"></div>
      <button id="calculate-diameter-button">Рассчитать</button>
      <div id="diameter-results-table-container" class="results-container"></div>
      <button id="export-diameter-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>

    <div id="hydroizol-elevation-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Поверхность гидроизолирующего слоя</h1>
      </div>
      <div class="form-group">
        <label for="hydroizol-elevation-date">Дата замера:</label>
        <input type="date" id="hydroizol-elevation-date" class="module-date-input">
      </div>
      <div class="tolerance-note">
        <strong>Допуски (согласно запросу):</strong><br>
        - Разность отметок смежных точек: **не более 10 мм**.<br>
        - Разность отметок любых других точек (Макс. перепад): **не более 10 мм**.<br>
        <span style="font-size: 0.8em; color: gray;">Данные могут быть использованы для автозаполнения отметок
          краев в модуле "Отметка центра основания".</span><br><br>
        <strong>ГОСТ 31385-2023 Г.3.4 Толщина гидроизолирующего слоя под центральной частью днища — (50 ± 10)
          мм, под окрайкой днища — (20 ± 5) мм.</strong>
      </div>
      <div class="form-group">
        <label>Единица измерения:</label>
        <div class="radio-group">
          <label><input type="radio" name="hydroizolElevationUnit" value="m" checked> Метры (м) - Балтийская
            система координат (абсолютная)</label>
          <label><input type="radio" name="hydroizolElevationUnit" value="mm"> Миллиметры (мм) - Относительная
            система координат</label>
        </div>
      </div>
      <div class="form-group">
        <label for="point-count-hydroizol">Количество точек:</label>
        <input type="tel" id="point-count-hydroizol" min="2">
      </div>
      <button id="generate-hydroizol-points-button" style="margin-top: -5px; background-color: #38761d;">Создать
        поля ввода</button>
      <div id="hydroizol-point-inputs-container"></div>
      <button id="calculate-hydroizol-button">Рассчитать</button>
      <div id="hydroizol-history-panel" class="history-controls hidden">
        <button id="save-hydroizol-history-btn" class="action-btn" style="background-color: #005a9c;">💾
          Сохранить как эталон (История)</button>
        <button id="compare-hydroizol-history-btn" class="action-btn"
          style="background-color: #6f42c1; display: none;">⚖️ Сравнить с эталоном</button>
      </div>
      <div id="history-status-msg" style="font-size: 0.8em; margin-top: 5px; color: #555;"></div>
      <div id="hydroizol-results-table-container" class="results-container"></div>
      <button id="export-hydroizol-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>

    <div id="hydroizol-thickness-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Толщина гидроизолирующего слоя</h1>
      </div>
      <div class="form-group">
        <label for="hydroizol-thickness-date">Дата замера:</label>
        <input type="date" id="hydroizol-thickness-date" class="module-date-input">
      </div>
      <div class="tolerance-note">
        <strong>Требование:</strong> 20 &plusmn; 5 мм.<br>
        <strong>Допустимый диапазон:</strong> [15 мм; 25 мм].<br>
        <strong>ГОСТ 31385-2023 Г.3.4 Толщина гидроизолирующего слоя под центральной частью днища — (50 ± 10)
          мм, под окрайкой днища — (20 ± 5) мм.</strong>
      </div>
      <div class="form-group">
        <label for="point-count-thickness">Количество точек:</label>
        <input type="tel" id="point-count-thickness" min="2" placeholder="Минимум 2">
      </div>
      <button id="generate-thickness-points-button" style="margin-top: -5px; background-color: #38761d;">Создать
        поля ввода</button>
      <div id="thickness-point-inputs-container"></div>
      <button id="calculate-thickness-button">Готово (Рассчитать)</button>
      <div id="thickness-results-table-container" class="results-container"></div>
      <button id="export-thickness-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>

    <div id="center-elevation-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Отметка центра основания</h1>
      </div>
      <div class="form-group">
        <label for="center-elevation-date">Дата замера:</label>
        <input type="date" id="center-elevation-date" class="module-date-input">
      </div>
      <div class="form-group">
        <label for="rvs-diameter-center">Диаметр РВС, **мм**:</label>
        <input type="tel" id="rvs-diameter-center" min="1000" placeholder="20000">
      </div>
      <div class="form-group">
        <label for="fundament-type-center">Тип основания:</label>
        <select id="fundament-type-center">
          <option value="flat">Плоское</option>
          <option value="center-up">С подъемом к центру (коническое)</option>
          <option value="center-down">С уклоном от центра</option>
        </select>
      </div>
      <div class="form-group" id="slope-ratio-n-center-group">
        <label for="slope-ratio-n-center">Соотношение уклона N (1:N):</label>
        <input type="tel" id="slope-ratio-n-center" min="50" value="100">
      </div>
      <div class="form-group">
        <label>Единица измерения:</label>
        <div class="radio-group">
          <label><input type="radio" name="centerElevationUnit" value="m" checked> Метры (м) - Балтийская
            система координат (абсолютная)</label>
          <label><input type="radio" name="centerElevationUnit" value="mm"> Миллиметры (мм) - Относительная
            система координат</label>
        </div>
      </div>

      <!-- Примечание с допусками -->
      <div id="center-tolerance-note" class="tolerance-note">
        <strong>Допуски:</strong><br>
        - Введите диаметр резервуара и тип основания, чтобы увидеть допуски.<br>
        <strong>ГОСТ 31385-2023 таб. 17. Допуск зависит от диаметра резервуара.</strong>
      </div>

      <!-- Красивые рамки для ввода значений точек -->
      <div class="center-point-input-wrapper">
        <label for="center-point-value">Отметка центра (H центр):</label>
        <input type="tel" id="center-point-value" class="point-value-center" step="0.001" placeholder="м">
      </div>

      <h3>Отметки поверхности гидроизола (4 точки):</h3>
      <button id="auto-fill-hydroizol-points-button" class="secondary"
        style="margin-top: 10px; margin-bottom: 10px; background-color: #eafbea; border: 1px solid var(--success-green); color: var(--success-green);">Заполнить
        из последнего замера гидроизола</button>

      <div id="center-hydroizol-inputs-container">
        <div class="center-point-input-wrapper">
          <label>Точка 1:</label>
          <input type="tel" class="point-value-hydro-center" step="0.001" placeholder="м">
        </div>
        <div class="center-point-input-wrapper">
          <label>Точка 2:</label>
          <input type="tel" class="point-value-hydro-center" step="0.001" placeholder="м">
        </div>
        <div class="center-point-input-wrapper">
          <label>Точка 3:</label>
          <input type="tel" class="point-value-hydro-center" step="0.001" placeholder="м">
        </div>
        <div class="center-point-input-wrapper">
          <label>Точка 4:</label>
          <input type="tel" class="point-value-hydro-center" step="0.001" placeholder="м">
        </div>
      </div>

      <button id="calculate-center-button">Рассчитать</button>
      <div id="center-results-table-container" class="results-container"></div>
      <button id="export-center-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>

    <div id="settlement-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Осадка фундамента после испытаний</h1>
      </div>

      <div class="form-group">
        <label for="settlement-date-base">Дата замера (ДО испытаний):</label>
        <input type="date" id="settlement-date-base" class="module-date-input">
      </div>

      <div class="form-group">
        <label for="settlement-point-count">Количество точек:</label>
        <input type="tel" id="settlement-point-count" min="2" placeholder="Например, 12">
      </div>

      <div class="form-group">
        <label>Единица измерения ввода:</label>
        <div class="radio-group">
          <label><input type="radio" name="settlementUnit" value="m" checked> Метры (м) - Балтийская система
            координат (абсолютная)</label>
          <label><input type="radio" name="settlementUnit" value="mm"> Миллиметры (мм) - Относительная система
            координат</label>
        </div>
        <div id="center-tolerance-note" class="tolerance-note">
                        <strong>ГОСТ 31385-2023 п 11.6</strong><br>
                        - За условную стабилизацию осадки принимают уплотненность грунта, когда осадка за 24 ч не превышает 5 мм.<br>
                    </div>
      </div>

      <button id="settlement-generate-btn" style="background-color: #38761d;">Сгенерировать поля</button>

      <div id="settlement-tabs" class="tabs-container hidden">
        <button id="tab-btn-base" class="tab-button active">1. ДО испытаний</button>
        <button id="tab-btn-during" class="tab-button">2. ВО ВРЕМЯ испытаний</button>
        <button id="tab-btn-after" class="tab-button">3. ПОСЛЕ испытаний</button>
      </div>

      <div id="settlement-input-area" class="hidden">
        <div id="settlement-base-section" class="input-section active">
          <div class="tolerance-note" style="margin-bottom:15px; border-color: #ccc;">
            Введите исходные значения отметок **до** начала испытаний. Данные сохраняются автоматически.
          </div>
          <div id="settlement-base-inputs"></div>
          <!-- Добавленная кнопка -->
          <button id="settlement-base-done-btn" style="margin-top: 15px; background-color: var(--success-green);">
            ✓ Готово (Данные сохранены)
          </button>
        </div>

        <div id="settlement-during-section" class="input-section">
          <div class="tolerance-note" style="margin-bottom:15px; border-color: #f0ad4e; background-color: #fff8e1;">
            Текущий замер сравнивается с исходным **(До)** и предыдущим **(Во время)** для отслеживания
            стабилизации.
          </div>

          <div class="history-selector">
            <label>Замер:</label>
            <select id="settlement-during-history-select"></select>
            <button id="settlement-save-during-btn">💾 Сохранить замер</button>
            <button id="settlement-delete-during-btn" class="action-btn"
              style="background-color: var(--danger-red);">🗑️ Удалить замер</button>
          </div>

          <div id="settlement-during-inputs"></div>
        </div>

        <div id="settlement-after-section" class="input-section">
          <div class="tolerance-note" style="margin-bottom:15px; border-color: #ccc;">
            Введите окончательные значения отметок **после** испытаний.
          </div>
          <div id="settlement-after-inputs"></div>
        </div>

        <button id="settlement-calculate-btn" style="margin-top: 20px;">Рассчитать осадку (Текущие /
          Окончательные)</button>
      </div>

      <div id="settlement-results-container" class="results-container">
        <div class="settlement-results-title"></div>
        <div class="settlement-results-table-container"></div>
      </div>

      <button id="export-settlement-csv-button" class="export-excel" style="margin-top: 20px; display: none;">
        <span class="excel-icon">📊</span> Экспорт в Excel
      </button>
      <button class="secondary back-button back-to-fundament">Назад к модулю "Фундамент"</button>
    </div>
  </div>

  <div id="app-bottom" class="container-module bottom-screen-container">
    <div id="project-list-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Мои проекты РВС (Днище)</h1>
      </div>
      <p>Выберите проект или создайте новый:</p>
      <div id="projects-list-container"></div>
      <button id="create-new-project-button">Создать новый РВС</button>
    </div>

    <div id="setup-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Новый замер днища</h1>
      </div>
      <div class="form-group">
        <label for="rvs-name">Название РВС (Объект):</label>
        <input type="text" id="rvs-name" placeholder="Например, РВС-10000 №5">
      </div>
      <div class="form-group">
        <label for="rvs-date">Дата замера:</label>
        <input type="date" id="rvs-date">
      </div>
      <button id="start-button">Начать работу</button>
      <button id="cancel-setup-button" class="secondary">Отмена</button>
    </div>

    <div id="bottom-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1 id="bottom-rvs-name"></h1>
        <p>Модуль: <strong>Днище</strong></p>
        <p id="bottom-rvs-date" style="font-size: 0.8em; opacity: 0.8;"></p>
      </div>
      <div id="bottom-module-list" class="module-list"></div>
      <button id="bottom-back-to-list-button" class="secondary back-button">Вернуться к списку проектов</button>
      <button id="bottom-back-to-modules-button" class="secondary back-button">Вернуться к выбору модулей</button>
    </div>

    <div id="radial-seams-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Местные отклонения от проектной формы в зонах радиальных монтажных сварных швов кольца окраек</h1>
      </div>
      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023, таблица 18: Угловатость (f):</strong> Допуск ±3 мм.<br>
        Измерения проводят шаблоном контроля радиуса на базе 200 мм.<br><br>
        <strong>ГОСТ 31385-2023, пункт 9.3.8: Линейное смещение (b):</strong><br>
        Для деталей толщиной не более 10 мм — 1,0 мм;<br>
        Для деталей толщиной более 10 мм — 10 % толщины, но не более 3 мм.
      </div>
      <div class="form-group">
        <label for="radial-seams-date">Дата замера:</label>
        <input type="date" id="radial-seams-date">
      </div>
      <div class="inline-group">
        <div class="form-group">
          <label for="plate-thickness">Толщина листов (мм):</label>
          <input type="tel" id="plate-thickness" value="10" placeholder="10">
        </div>
        <div class="form-group">
          <label for="seam-tolerance">Допуск угловатости (мм):</label>
          <input type="tel" id="seam-tolerance" value="3">
        </div>
      </div>
      <div class="form-group">
        <label for="seam-count">Количество стыков (швов):</label>
        <input type="tel" id="seam-count" min="1" placeholder="Например, 16">
      </div>
      <div class="button-group">
        <button id="generate-seams-button" style="background-color: #38761d;">Создать поля ввода</button>
        <button id="reset-seams-button" class="reset">Сбросить данные</button>
      </div>
      <div id="seams-inputs-container" class="seam-inputs-wrapper"></div>
      <div class="button-group">
        <button id="calculate-seams-button">Рассчитать</button>
        <button id="export-seams-excel-button" class="export-excel">
          <span class="excel-icon">📊</span> Экспорт в Excel
        </button>
      </div>
      <div id="seams-results-container" class="results-container"></div>
      <button class="secondary back-button back-to-bottom">Назад к модулю "Днище"</button>
    </div>

    <div id="plate-rise-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Подъем окраек</h1>
      </div>
      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023 таб. 18 Подъем окраек в зоне сопряжения с центральной частью днища:</strong><br>
        При диаметре резервуара до 25 м: f<sub>a</sub> ≤ 0,03L,<br>
        При диаметре резервуара св. 25 м: f<sub>a</sub> ≤ 0,04L,<br>
        где f<sub>a</sub> — высота подъема окрайки, мм; L — ширина окрайки, мм.
      </div>
      <div class="inline-group">
        <div class="form-group">
          <label>Диаметр (D), мм:</label>
          <input type="tel" id="tank-diameter" value="20000">
        </div>
        <div class="form-group">
          <label>Длина окрайки (L), мм:</label>
          <input type="tel" id="edge-length" value="500">
        </div>
      </div>
      <div class="form-group">
        <label for="plate-rise-date">Дата замера:</label>
        <input type="date" id="plate-rise-date">
      </div>
      <div class="form-group">
        <label for="rise-point-count">Количество точек:</label>
        <input type="tel" id="rise-point-count" min="2" value="8">
      </div>
      <div class="button-group">
        <button id="generate-rise-button" style="background-color: #38761d;">Создать поля ввода</button>
        <button id="reset-rise-button" class="reset">Сбросить данные</button>
      </div>
      <div id="rise-inputs-container" class="grid-inputs" style="margin-top:20px;"></div>
      <div class="button-group">
        <button id="calculate-rise-button">Готово (Рассчитать)</button>
        <button id="export-rise-excel-button" class="export-excel">
          <span class="excel-icon">📊</span> Экспорт в Excel
        </button>
      </div>
      <div id="rise-results-container" class="results-container"></div>
      <button class="secondary back-button back-to-bottom">Назад к модулю "Днище"</button>
    </div>

    <div id="buckles-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -25px -25px 25px -25px;">
        <h1>Местные неровности (хлопуны)</h1>
      </div>
      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023 таб. 18: Допуск высоты (f):</strong> Высота местных выпучин или вмятин на центральной
        части
        днища f ≤ 0,03R, R ≥ 500 мм.<br>
        f — максимальная стрелка вмятины или выпучины на днище, мм;<br>
        R — радиус вписанной окружности на любом участке вмятины или выпучины, мм.<br>
        Резкие перегибы и складки не допускаются.
      </div>
      <div class="form-group">
        <label for="buckle-count">Количество хлопунов:</label>
        <input type="tel" id="buckle-count" min="1">
      </div>
      <div class="form-group">
        <label for="buckles-date">Дата замера:</label>
        <input type="date" id="buckles-date">
      </div>
      <div class="button-group">
        <button id="generate-buckles-button" style="background-color: #38761d;">Создать поля ввода</button>
        <button id="reset-buckles-button" class="reset">Сбросить данные</button>
      </div>
      <div id="buckles-inputs-container" style="margin-top: 20px;"></div>
      <div class="button-group">
        <button id="calculate-buckles-button">Проверить и рассчитать</button>
        <button id="export-buckles-excel-button" class="export-excel">
          <span class="excel-icon">📊</span> Экспорт в Excel
        </button>
      </div>
      <div id="buckles-results-container" class="results-container"></div>
      <button class="secondary back-button back-to-bottom">Назад к модулю "Днище"</button>
    </div>

    <div id="outer-contour-screen" class="app-screen hidden">
  <div class="app-header" style="margin: -25px -25px 25px -25px;">
    <h1>Отметки наружного контура днища</h1>
  </div>

  <label style="font-weight:600; color: var(--primary-blue); margin-bottom:5px; display:block;">Условия замера:</label>
  <div class="contour-tabs">
    <button class="contour-tab active" data-mode="before">До испытаний</button>
    <button class="contour-tab" data-mode="after">После испытаний</button>
    <button class="contour-tab" data-mode="water">При заполненном водой</button>
  </div>

  <div class="form-group" style="margin-top: 10px;">
    <label for="outer-contour-date">Дата замера:</label>
    <input type="date" id="outer-contour-date">
  </div>

  <div class="form-group" style="background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
    <label style="font-weight:600; margin-bottom: 8px; display: block;">Система координат / Ед. изм:</label>
    <div style="display: flex; gap: 15px;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="radio" name="coord-system" value="mm" checked style="margin-right: 5px;"> 
        мм (Относительная)
      </label>
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="radio" name="coord-system" value="m" style="margin-right: 5px;"> 
        м (Балтийская)
      </label>
    </div>
  </div>
  <div class="inline-group">
    <div class="form-group">
      <label for="contour-tank-diameter">Диаметр РВС (D), мм:</label>
      <input type="tel" id="contour-tank-diameter" placeholder="Например, 10000">
    </div>
    <div class="form-group">
      <label for="contour-point-count">Количество точек:</label>
      <input type="tel" id="contour-point-count" min="4" placeholder="Например, 12">
    </div>
  </div>

  <div class="tolerance-note" id="contour-tolerance-display">
    <em>Выберите диаметр и режим для отображения допусков.</em>
  </div>

  <div class="button-group">
    <button id="generate-contour-button" style="background-color: #38761d;">Создать поля ввода</button>
    <button id="reset-contour-button" class="reset">Сбросить данные</button>
  </div>

  <div id="contour-inputs-container" class="grid-inputs" style="margin-top:20px;"></div>

  <div class="button-group">
    <button id="calculate-contour-button">Готово (Рассчитать)</button>
    <button id="export-contour-excel-button" class="export-excel">
      <span class="excel-icon">📊</span> Экспорт в Excel
    </button>
  </div>

  <div id="contour-results-container" class="results-container"></div>
  <button class="secondary back-button back-to-bottom">Назад к модулю "Днище"</button>
</div>

  </div>

  <div id="app-wall" class="container-module setup-screen-wall-container">
    <!-- Экран списка проектов -->
    <div id="project-list-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Контроль качества стенок РВС</h1>
        <p>Управление проектами и замеры</p>
      </div>
      <div class="screen-title">Мои проекты</div>
      <p style="margin-bottom: 25px; color: #666;">Выберите проект или создайте новый:</p>
      <div id="projects-list-container"></div>
      <button id="create-new-project-button" class="success">Создать новый проект</button>
    </div>

    <!-- Экран создания проекта -->
    <div id="setup-screen-wall" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Новый проект контроля стенки</h1>
        <h2 class="title-buttom"></h2>
      </div>
      <!-- <div class="form-group">
        <label for="rvs-name">Название РВС (Объект):</label>
        <input type="text" id="rvs-name" placeholder="Например, РВС-20000 №3">
      </div>
      <div class="form-group">
        <label for="rvs-date">Дата проекта:</label>
        <input type="date" id="rvs-date">
      </div> -->
      <div class="form-group">
        <label for="rvs-diameter-wall">Диаметр РВС (мм):</label>
        <input type="tel" id="rvs-diameter-wall" placeholder="Например, 20000">
      </div>
      <div class="form-group">
        <label for="rvs-height">Высота стенки (мм):</label>
        <input type="tel" id="rvs-height" placeholder="Например, 12000">
      </div>
      <button id="start-button-wall">Начать работу</button>
      <button id="wallmenu-back-to-modules-button" class="secondary">Вернуться к выбору модулей</button>
    </div>

    <!-- Главный экран модулей стенок -->
    <div id="wall-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1 id="wall-rvs-name"></h1>
        <p>Модуль: <strong>Контроль стенок</strong></p>

        <p id="wall-rvs-date" style="font-size: 0.85em; opacity: 0.9;"></p>
      </div>
      <div id="wall-module-list" class="module-list"></div>
      <button id="wall-back-to-list-button" class="secondary">Вернуться к списку проектов</button>
      <button id="wall-back-to-modules-button" class="secondary">Вернуться к выбору модулей</button>
    </div>

    <!-- Модуль 1: Вертикальность -->
    <div id="verticality-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Вертикальность стенки</h1>
        <p>ГОСТ 31385-2023, таблица 19</p>
      </div>

      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023 таблица 19:</strong><br><br>

        <strong>Отклонение по вертикали образующих на высоте каждого пояса:</strong><br>
        • ±1/200 Н (где Н — расстояние от днища до точки измерения)<br><br>

        <strong>Измерения:</strong><br>
        • Проводят не реже, чем через каждые 6 м, по всему периметру стенки<br>
        • Проводят в пределах 50 мм ниже горизонтальных швов<br><br>

        <strong>Расчет допуска:</strong><br>
        • Допуск = (Н - 50) / 200<br>
        • Н — сумма высот всех поясов от днища до точки измерения<br>
        • Результат в миллиметрах
      </div>

      <!-- Настройки замера -->
      <div id="settings-input">
        <h2 class="screen-title">Настройки замера</h2>

        <div class="inline-group">
          <div class="form-group">
            <label for="tank-name">Название резервуара:</label>
            <input type="text" id="tank-name" placeholder="Например: РВС-5000 №4">
          </div>

          <div class="form-group">
            <label for="tank-date">Дата замера:</label>
            <input type="date" id="tank-date">
          </div>
        </div>

        <div class="inline-group">
          <div class="form-group">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label for="wall-height-mm" style="margin: 0;">
                Высота 1-го пояса (мм):
              </label>
              <button id="belt-settings-btn"
                style="width: auto; padding: 8px 15px; margin: 0; font-size: 0.9em; background: var(--success-green); color: white; border: 1px solid var(--success-green); box-shadow: 0 2px 6px rgba(0,0,0,0.12);">
                Настроить все пояса
              </button>
            </div>
            <input type="tel" id="wall-height-mm" placeholder="Например: 12000" min="0">
          </div>

          <div class="form-group">
            <label for="num-belts">Количество поясов:</label>
            <input type="tel" id="num-belts" value="5" min="1" class="text-center">
          </div>

          <div class="form-group">
            <label for="num-guides">Количество направляющих:</label>
            <input type="tel" id="num-guides" value="8" min="1" class="text-center">
          </div>
        </div>

        <button id="wall-btn-setup-input-grid" class="btn success">
          Создать таблицу для ввода данных
        </button>

        <button id="back-to-wall-screen" class="btn secondary" style="margin-top: 15px;">
          Назад к выбору модулей
        </button>
      </div>

      <!-- Ввод данных (скрыт по умолчанию) -->
      <div id="data-input" class="hidden">
        <h2 class="screen-title">Ввод данных измерений</h2>

        <div id="current-settings-display"
          style="margin-bottom: 25px; padding: 15px; background: var(--light-blue); border-radius: 10px; border-left: 4px solid var(--accent-blue);">
        </div>

        <div id="guide-input-grid"></div>

        <div class="button-group">
          <button id="wall-process-data" class="btn success" style="font-size: 1.1em; padding: 18px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
              style="width: 20px; height: 20px; margin-right: 10px; display: inline-block; vertical-align: middle;">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                clip-rule="evenodd" />
            </svg>
            Рассчитать вертикальность
          </button>
        </div>

        <div class="button-group">
          <button id="wall-back-vertical-settings" class="btn secondary">
            Назад к настройкам
          </button>
          <button id="wall-reset-vertial" class="btn reset">
            Сбросить все данные
          </button>
          <button onclick="backToWallScreen()" id="wall-back-screen" class="btn secondary">
            Назад к выбору модулей
          </button>
        </div>
      </div>

      <!-- Результаты -->
      <div id="results-block" class="hidden">
        <h2 class="screen-title">Результаты расчета вертикальности</h2>

        <div class="results-container"
          style="background: linear-gradient(135deg, #f8fbff 0%, #e6f0f7 100%); border: 2px solid var(--accent-blue);">
          <div
            style="margin-bottom: 20px; padding: 15px; background: var(--primary-blue); border-radius: 10px; color: white;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">Параметры расчета</h3>
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 0.95em;">
              <div><strong>Резервуар:</strong> <span id="results-tank-name"></span></div>
              <div><strong>Дата замера:</strong> <span id="results-tank-date"></span></div>
              <div><strong>Режим:</strong> <span id="results-mode">Внутри</span></div>
              <div><strong>ГОСТ:</strong> 31385-2023, таблица 19</div>
            </div>
          </div>

          <div style="overflow-x: auto; border-radius: 8px; box-shadow: var(--shadow-light);">
            <table id="results-table"></table>
          </div>

          <div
            style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid var(--success-green);">
            <strong>ПРИМЕЧАНИЕ:</strong> Значения, отмеченные <span
              style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска по ГОСТ 31385-2023
          </div>
        </div>

        <div class="button-group">
          <button id="wall-to-input-vertival" class="btn secondary">
            Назад к вводу данных
          </button>

          <button id="btn-outside-mode" onclick="toggleOutsideMode()" class="btn btn-toggle-mode">
            Снаружи
          </button>

          <button onclick="exportVerticalityToExcel()" class="btn export-excel">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
        </div>

        <div class="button-group">
          <button onclick="resetFormVertical()" class="btn" style="background: var(--warning-orange);">
            Новый расчет
          </button>
          <button onclick="backToWallScreen()" class="btn secondary">
            Назад к выбору модулей
          </button>
        </div>
      </div>
    </div>

    <!-- Модуль 2: Угловатость -->
    <div id="angularity-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Угловатость стенки</h1>
        <p>ГОСТ 31385-2023, пункты 10.1.6-10.1.7</p>
      </div>

      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023, пункты 10.1.6-10.1.7:</strong><br>
        Местные отклонения от цилиндрической формы вертикальных монтажных сварных швов (угловатость).<br>
        Угловатость f — стрела прогиба сварного стыка (измерения проводят шаблоном контроля радиуса,
        выполненным по проектному радиусу стенки на базе 500 мм).<br><br>

        <strong>Допустимые значения угловатости (для резервуаров до 50 000 м³, срок службы 40 лет, ≤250
          циклов/год):</strong><br>
        • При толщине пояса 5 ≤ t ≤ 10 мм: f ≤ 8 мм<br>
        • При толщине пояса 10 < t ≤ 15 мм: f ≤ 7 мм<br>
          • При толщине пояса t > 15 мм: f ≤ 5 мм<br><br>

          <em>Для резервуаров свыше 50 000 м³ или режимов нагружения >250 циклов/год
            требуется расчет усталостной долговечности.</em>
      </div>

      <!-- Настройки -->
      <div class="inline-group">
        <div class="form-group">
          <label for="angular-belts">Количество поясов стенки:</label>
          <input type="tel" id="angular-belts" min="1" placeholder="Например, 8" value="5">
        </div>
        <div class="form-group">
          <label for="angular-seams">Количество вертикальных стыков:</label>
          <input type="tel" id="angular-seams" min="1" placeholder="Например, 16" value="8">
        </div>
        <div class="form-group">
          <label for="angular-measurement-date">Дата замера:</label>
          <input type="date" id="angular-measurement-date" value="">
        </div>
      </div>

      <!-- Ввод толщины поясов -->
      <div class="thickness-input-group">
        <div class="form-group">
          <label for="common-thickness">Толщина поясов (мм):</label>
          <input type="tel" id="common-thickness" placeholder="Например, 10" step="0.1" min="5">
        </div>
        <button id="setup-individual-thickness" class="secondary" style="width: auto; margin-top: 0;">
          Настроить для каждого пояса
        </button>
      </div>

      <div class="button-group">
        <button id="setup-angular-button" class="success">Создать таблицу ввода</button>
        <button id="reset-all-angular-button" class="reset">Сбросить все данные</button>
        <button class="secondary btn-back-to-wall-screen">Назад к выбору модулей</button>
      </div>

      <div id="angular-inputs-container" style="margin-top: 25px; overflow-x: auto; display: none;"></div>

      <div class="button-group" style="display: none;" id="angular-calc-buttons">
        <button id="calculate-angular-button">Рассчитать угловатость</button>
        <button onclick="exportAngularToExcel()" class="export-excel">
          <span class="excel-icon">📊</span> Экспорт в Excel
        </button>
        <button class="btn-back-to-wall-screen" class="secondary">Назад к выбору модулей</button>
      </div>
    </div>

    <!-- Модуль 3: Отклонения внутреннего диаметра и высоты стенки -->
    <div id="dimensions-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Отклонения внутреннего диаметра и высоты стенки</h1>
        <p>ГОСТ 31385-2023, таблица 19</p>
      </div>

      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023, таблица 19:</strong><br><br>

        <strong>Высота стенки:</strong><br>
        • до 12 м включительно: ±20 мм<br>
        • свыше 12 до 18 м: ±30 мм<br>
        • свыше 18 м: ±40 мм<br><br>

        <strong>Измерения:</strong><br>
        • Высота: Восемь измерений с угловыми координатами через 45°<br>
        • Диаметр: Внутренний диаметр на уровне 300 мм от днища. Четыре измерения с угловыми координатами через
        45°<br><br>

        <strong>Предельное отклонение внутреннего диаметра (D — диаметр резервуара в метрах, R — радиус в
          метрах):</strong><br>
        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
          <tr>
            <td style="padding: 5px; border: 1px solid var(--light-border);">До 12 м</td>
            <td style="padding: 5px; border: 1px solid var(--light-border);">0,005R</td>
          </tr>
          <tr>
            <td style="padding: 5px; border: 1px solid var(--light-border);">Свыше 12 до 25 м</td>
            <td style="padding: 5px; border: 1px solid var(--light-border);">0,003R</td>
          </tr>
          <tr>
            <td style="padding: 5px; border: 1px solid var(--light-border);">Свыше 25 до 40 м</td>
            <td style="padding: 5px; border: 1px solid var(--light-border);">0,002R</td>
          </tr>
          <tr>
            <td style="padding: 5px; border: 1px solid var(--light-border);">Свыше 40 м</td>
            <td style="padding: 5px; border: 1px solid var(--light-border);">0,0015R</td>
          </tr>
        </table>
        <em>* Все значения в миллиметрах</em>
      </div>

      <div class="button-group" style="margin-top: 30px;">
        <button id="start-diameter-button" class="success">Внутренний диаметр</button>
        <button id="start-height-button" class="success">Высота стенки</button>
        <button class="secondary btn-back-to-wall-screen">Назад к выбору модулей</button>
      </div>

      <!-- Раздел для диаметра -->
      <div id="diameter-section" style="display: none;">
        <h3 style="color: var(--primary-blue); margin: 30px 0 20px 0;">Внутренний диаметр</h3>

        <div id="diameter-step-1">
          <div class="inline-group">
            <div class="form-group">
              <label for="project-diameter">Проектный диаметр резервуара, мм:</label>
              <input type="tel" id="project-diameter" placeholder="Например, 20000">
            </div>

            <div class="form-group">
              <label for="diameter-measurement-date">Дата замера диаметра:</label>
              <input type="date" id="diameter-measurement-date">
            </div>
          </div>

          <div id="diameter-tolerance-info"
            style="display: none; margin: 20px 0; padding: 15px; background: var(--light-blue); border-radius: 10px; border-left: 4px solid var(--accent-blue);">
            <strong>Рассчитанный допуск:</strong> <span id="calculated-tolerance">0</span> мм
          </div>

          <div class="button-group">
            <button id="save-diameter-button" class="success">Перейти к вводу измерений</button>
            <button id="reset-diameter-button" class="reset">Сбросить данных диаметра</button>
            <button onclick="backToDimensionsMenu()" class="secondary">Назад к выбору раздела</button>
          </div>
        </div>

        <div id="diameter-step-2" style="display: none;">
          <h4 style="color: var(--primary-blue); margin-bottom: 20px;">Ввод значений радиуса (диаметр/2) в 8 точках</h4>
          <div style="background: var(--light-blue); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <strong>Схема расположения точек:</strong><br>
            • Точка 1: 0°<br>
            • Точка 2: 45°<br>
            • Точка 3: 90°<br>
            • Точка 4: 135°<br>
            • Точка 5: 180°<br>
            • Точка 6: 225°<br>
            • Точка 7: 270°<br>
            • Точка 8: 315°<br>
            (Точки расположены через 45° по периметру резервуара)
          </div>
          <div class="grid-inputs" id="radius-inputs-grid"></div>

          <div class="button-group">
            <button id="calculate-diameter-button-1" class="success">Рассчитать диаметр</button>
            <button id="back-to-diameter-step1" class="secondary">Назад к вводу диаметра</button>
          </div>
        </div>

        <div id="diameter-results-container" class="results-container" style="display: none; margin-top: 20px;"></div>

        <div id="diameter-export-buttons" class="button-group" style="display: none; margin-top: 20px;">
          <button onclick="exportDiameterToExcel()" class="export-excel">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
          <button class="wall-back-to-dimensions-menu" onclick="backToDimensionsMenu()" class="secondary">Назад к выбору
            раздела</button>
        </div>
      </div>

      <!-- Раздел для высоты -->
      <div id="height-section" style="display: none;">
        <h3 style="color: var(--primary-blue); margin: 30px 0 20px 0;">Высота стенки</h3>

        <div id="height-step-1">
          <div class="inline-group">
            <div class="form-group">
              <label for="project-height">Проектная высота стенки, мм:</label>
              <input type="tel" id="project-height" placeholder="Например, 12000">
            </div>

            <div class="form-group">
              <label for="height-measurement-date">Дата замера высоты:</label>
              <input type="date" id="height-measurement-date">
            </div>
          </div>

          <div id="height-tolerance-info"
            style="display: none; margin: 20px 0; padding: 15px; background: var(--light-blue); border-radius: 10px; border-left: 4px solid var(--accent-blue);">
            <strong>Допуск по ГОСТ:</strong> <span id="height-tolerance-value">0</span> мм
          </div>

          <div class="button-group">
            <button id="save-height-button" class="success">Перейти к вводу измерений</button>
            <button id="reset-height-button" class="reset">Сбросить данных высоты</button>
            <button onclick="backToDimensionsMenu()" class="secondary wall-back-to-dimensions-menu">Назад к выбору
              раздела</button>
          </div>
        </div>

        <div id="height-step-2" style="display: none;">
          <h4 style="color: var(--primary-blue); margin-bottom: 20px;">Ввод значений высоты стенки в 8 точках (через
            45°)</h4>
          <div style="background: var(--light-blue); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <strong>Схема расположения точек:</strong><br>
            • Точка 1: 0°<br>
            • Точка 2: 45°<br>
            • Точка 3: 90°<br>
            • Точка 4: 135°<br>
            • Точка 5: 180°<br>
            • Точка 6: 225°<br>
            • Точка 7: 270°<br>
            • Точка 8: 315°<br>
          </div>
          <div class="grid-inputs" id="height-inputs-grid"></div>

          <div class="button-group">
            <button id="calculate-height-button" class="success">Рассчитать отклонения высоты</button>
            <button id="back-to-height-step1" class="secondary">Назад к вводу высоты</button>
          </div>
        </div>

        <div id="height-results-container" class="results-container" style="display: none; margin-top: 20px;"></div>

        <div id="height-export-buttons" class="button-group" style="display: none; margin-top: 20px;">
          <button onclick="exportHeightToExcel()" class="export-excel">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
          <button onclick="backToDimensionsMenu()" class="secondary wall-back-to-dimensions-menu">Назад к выбору
            раздела</button>
        </div>
      </div>
    </div>

    <!-- Модуль 4: Местные отклонения (хлопуны) -->
    <div id="local-deviations-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Местные отклонения (хлопуны) стенки</h1>
        <p>ГОСТ 31385-2023, таблица 19</p>
      </div>

      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023 таблица 19:</strong><br>
        Локальные отклонения от проектной формы (на длине 1 м)<br>
        Допуск ±15 мм<br><br>

        Измерения проводят вертикальной рейкой и горизонтальным шаблоном контроля радиуса,
        выполненным по проектному радиусу стенки.
      </div>

      <div class="inline-group">
        <div class="form-group">
          <label for="bulge-count">Количество хлопунов:</label>
          <input type="tel" id="bulge-count" min="1" placeholder="Например, 3" value="3">
        </div>
        <div class="form-group">
          <label for="bulge-measurement-date">Дата замера:</label>
          <input type="date" id="bulge-measurement-date" value="">
        </div>
      </div>

      <div class="button-group">
        <button id="generate-bulge-button" class="success">Создать таблицу</button>
        <button id="reset-bulge-button" class="reset">Сбросить все</button>
        <button class="secondary btn-back-to-wall-screen">Назад к выбору модулей</button>
      </div>

      <div id="bulge-inputs-container" style="margin-top: 25px; overflow-x: auto; display: none;"></div>

      <div class="button-group" style="display: none;" id="bulge-calc-buttons">
        <button id="calculate-bulge-button">Рассчитать хлопуны</button>
        <button id="btn-wall-export-excel" class="export-excel">
          <span class="excel-icon">📊</span> Экспорт в Excel
        </button>
        <button class="secondary btn-back-to-wall-screen">Назад к выбору модулей</button>
      </div>

      <div id="bulge-results-container" class="results-container" style="display: none;"></div>
    </div>

    <!-- Модальные окна для модуля вертикальности -->


    <div id="belt-height-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 class="modal-title">Настройка высоты поясов</h3>
        <div id="belt-height-inputs"></div>
        <div class="modal-actions">
          <button onclick="closeBeltHeightModal()" class="btn secondary">Отмена</button>
          <button onclick="saveBeltHeights()" class="btn success">Сохранить</button>
        </div>
      </div>
    </div>

    <div id="belt-thickness-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 class="modal-title">Настройка толщины поясов</h3>
        <div id="belt-thickness-modal-inputs"></div>
        <div class="modal-actions">
          <button onclick="closeBeltThicknessModal()" class="btn secondary">Отмена</button>
          <button onclick="saveBeltThickness()" class="btn success">Сохранить и продолжить</button>
        </div>
      </div>
    </div>

    <!-- Индикатор автосохранения -->
    <div id="autosave-indicator" class="autosave-indicator">
      Автосохранение...
    </div>
  </div>

  <div id="app-roof" class="container-module roof-screen-container">
    <!-- Экран списка проектов -->
    <div id="project-list-screen" class="app-screen">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Контроль качества резервуаров</h1>
        <p>Управление проектами</p>
      </div>

      <div class="screen-title">Мои проекты</div>
      <p style="margin-bottom: 25px; color: #666;">Выберите проект или создайте новый:</p>

      <div id="projects-list-container"></div>

      <button id="create-new-project-button" class="success">Создать новый проект</button>
    </div>

    <!-- Экран создания проекта -->
    <div id="setup-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1>Новый проект контроля резервуара</h1>
      </div>

      <div class="form-group">
        <label for="project-name">Название проекта (резервуара):</label>
        <input type="text" id="project-name" placeholder="Например: РВС-20000 №3">
      </div>

      <div class="form-group">
        <label for="project-date">Дата создания проекта:</label>
        <input type="date" id="project-date">
      </div>

      <div class="button-group">
        <button id="save-project-button" class="success">Сохранить проект</button>
        <button id="cancel-setup-button" class="secondary">Отмена</button>
      </div>
    </div>

    <!-- Главное меню модулей -->
    <div id="roof-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1 id="roof-rvs-name"></h1>
        <p>Модуль: <strong>Крыша</strong></p>
        <p id="roof-rvs-date" style="font-size: 0.8em; opacity: 0.8;"></p>
      </div>

      <div class="screen-title">Модули контроля</div>

      <div id="modules-list">
        <div class="module-item-wrapper">
          <button id="btn-radial-beams" class="list-button">
            <span>Разность отметок смежных узлов верха радиальных балок</span>
          </button>
        </div>

        <div class="module-item-wrapper">
          <button id="btn-roof-top" class="list-button">
            <span>Отметка верха крыши</span>
          </button>
        </div>
      </div>

      <button id="roof-to-back" class="secondary">Вернуться к списку проектов</button>
      <button id="roof-to-modules" class="secondary">Вернуться к выбору модулей</button>
    </div>

    <!-- Модуль 1: Разность отметок смежных узлов верха радиальных балок -->
    <div id="radial-beams-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1 id="radial-project-name"></h1>
        <p>Разность отметок смежных узлов верха радиальных балок</p>
      </div>

      <div class="tolerance-note">
        <strong>ГОСТ 31385-2023 таблица 20 Разность отметок смежных узлов верха радиальных балок и
          ферм:</strong><br><br>

        <strong>• в зоне сопряжения со стенкой:</strong> ±20 мм<br>
        <strong>• в зоне сопряжения с центральным щитом:</strong> ±10 мм<br>
        <strong>• в зоне стыковки радиальных балок:</strong><br>
        &nbsp;&nbsp;&nbsp;- при диаметре резервуара до 25 м включительно: ±20 мм<br>
        &nbsp;&nbsp;&nbsp;- при диаметре резервуара свыше 25 м: ±30 мм
      </div>

      <!-- Шаг 1: Ввод параметров -->
      <div id="radial-step-1">
        <h2 class="screen-title">Параметры расчета</h2>

        <div class="form-group">
          <label for="measurement-date-radial">Дата замера:</label>
          <input type="date" id="measurement-date-radial">
        </div>

        <div class="form-group">
          <label for="radial-tank-diameter">Диаметр резервуара (мм):</label>
          <input type="tel" id="radial-tank-diameter" placeholder="Например: 20000" min="0">
          <div id="beam-joint-tolerance-info"
            style="margin-top: 10px; padding: 10px; background: #f0f7ff; border-radius: 5px; display: none;">
            <small>Допуск для зоны стыковки радиальных балок: <strong id="beam-joint-tolerance-value">±0</strong>
              мм</small>
          </div>
        </div>

        <div class="form-group">
          <label for="beam-count">Количество радиальных балок:</label>
          <input type="tel" id="beam-count" min="2" placeholder="Минимум 2" value="8">
        </div>

        <div class="form-group">
          <label>Тип зоны измерения:</label>
          <div class="zone-buttons">
            <div class="zone-button" data-zone="wall" onclick="selectZone('wall')">
              Стенка
            </div>
            <div class="zone-button" data-zone="center" onclick="selectZone('center')">
              Центральный щит
            </div>
            <div class="zone-button" data-zone="joint" onclick="selectZone('joint')">
              Стыковка балок
            </div>
          </div>
          <input type="hidden" id="selected-zone" value="wall">
        </div>

        <div class="button-group">
          <button onclick="generateBeamTable()" class="success">
            Создать таблицу для ввода данных
          </button>
          <button onclick="showMainMenu()" class="secondary">
            Назад в меню модулей
          </button>
        </div>
      </div>

      <!-- Шаг 2: Ввод данных балок -->
      <div id="radial-step-2" class="hidden">
        <h2 class="screen-title">Ввод высотных отметок радиальных балок</h2>

        <div id="current-settings-beam"
          style="margin-bottom: 25px; padding: 15px; background: var(--light-blue); border-radius: 10px; border-left: 4px solid var(--accent-blue);">
          <strong id="settings-summary"></strong>
        </div>

        <div class="grid-inputs" id="beam-inputs-grid"></div>

        <div class="button-group">
          <button onclick="calculateBeamDifferences()" class="success" style="font-size: 1.1em; padding: 18px;">
            Рассчитать разность отметок
          </button>
        </div>

        <div class="button-group">
          <button onclick="backToRadialStep1()" class="secondary">
            Назад к параметрам
          </button>
          <button onclick="resetRadialForm()" class="reset">
            Сбросить все данные
          </button>
        </div>
      </div>

      <!-- Шаг 3: Результаты -->
      <div id="radial-step-3" class="hidden">
        <h2 class="screen-title">Результаты расчета разности отметок</h2>

        <div class="results-container">
          <div
            style="margin-bottom: 20px; padding: 15px; background: var(--primary-blue); border-radius: 10px; color: white;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">Параметры расчета</h3>
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 0.95em;">
              <div><strong>Проект:</strong> <span id="results-project-name-beam"></span></div>
              <div><strong>Дата замера:</strong> <span id="results-date-beam"></span></div>
              <div><strong>Диаметр:</strong> <span id="results-diameter-beam"></span> мм</div>
              <div><strong>Допуск:</strong> <span id="results-tolerance-beam"></span></div>
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table id="beam-results-table"></table>
          </div>

          <div id="beam-summary"
            style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid var(--success-green);">
            <strong>ПРИМЕЧАНИЕ:</strong> Значения, отмеченные <span
              style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска по ГОСТ 31385-2023
          </div>
        </div>

        <div class="button-group">
          <button onclick="backToRadialStep2()" class="secondary">
            Назад к вводу данных
          </button>

          <button onclick="exportRadialBeamsToExcel()" class="export-excel">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
        </div>

        <div class="button-group">
          <button onclick="resetRadialForm()" class="reset">
            Новый расчет
          </button>
          <button onclick="showMainMenu()" class="secondary">
            Назад в меню модулей
          </button>
        </div>
      </div>
    </div>

    <!-- Модуль 2: Отметка верха крыши -->
    <div id="roof-top-screen" class="app-screen hidden">
      <div class="app-header" style="margin: -30px -30px 30px -30px;">
        <h1 id="roof-project-name"></h1>
        <p>Отметка верха крыши</p>
      </div>

      <div class="tolerance-note">
        <strong>Допустимые отклонения отметки верха конических и сферических крыш:</strong><br><br>

        <strong>• до 25 м включительно:</strong> ±30 мм<br>
        <strong>• свыше 25 м:</strong> ±50 мм
      </div>

      <!-- Шаг 1: Ввод параметров -->
      <div id="roof-step-1">
        <h2 class="screen-title">Параметры расчета</h2>

        <div class="form-group">
          <label for="measurement-date-roof">Дата замера:</label>
          <input type="date" id="measurement-date-roof">
        </div>

        <div class="inline-group">
          <div class="form-group">
            <label for="roof-tank-diameter">Диаметр резервуара (мм):</label>
            <input type="tel" id="roof-tank-diameter" placeholder="Например: 20000" min="0">
            <div id="roof-tolerance-info"
              style="margin-top: 10px; padding: 10px; background: #f0f7ff; border-radius: 5px;">
              <small>Допуск для данного диаметра: <strong id="roof-tolerance-value">±0</strong> мм</small>
            </div>
          </div>

          <div class="form-group">
            <label for="project-roof-height">Проектная отметка верха крыши (мм):</label>
            <input type="tel" id="project-roof-height" placeholder="Например: 12000">
          </div>
        </div>

        <div class="button-group">
          <button onclick="goToRoofStep2()" class="success">
            Перейти к замерам
          </button>
          <button onclick="showMainMenu()" class="secondary">
            Назад в меню модулей
          </button>
        </div>
      </div>

      <!-- Шаг 2: Ввод замеров -->
      <div id="roof-step-2" class="hidden">
        <h2 class="screen-title">Ввод данных замеров</h2>

        <div id="current-settings-roof"
          style="margin-bottom: 25px; padding: 15px; background: var(--light-blue); border-radius: 10px; border-left: 4px solid var(--accent-blue);">
          <strong id="roof-settings-summary"></strong>
        </div>

        <div class="inline-group">
          <div class="form-group">
            <label for="bottom-slope">Уклон днища резервуара (мм):</label>
            <input type="tel" id="bottom-slope" placeholder="Например: 50" step="0.1" min="0">
          </div>

          <div class="form-group">
            <label for="distance-to-flange">Расстояние от центральной части днища до верха фланца центрального патрубка
              (мм):</label>
            <input type="tel" id="distance-to-flange" placeholder="Например: 1500">
          </div>
        </div>

        <div class="button-group">
          <button onclick="calculateRoofHeight()" class="success" style="font-size: 1.1em; padding: 18px;">
            Рассчитать фактическую отметку
          </button>
        </div>

        <div class="button-group">
          <button onclick="backToRoofStep1()" class="secondary">
            Назад к параметрам
          </button>
          <button onclick="resetRoofForm()" class="reset">
            Сбросить все данные
          </button>
        </div>
      </div>

      <!-- Шаг 3: Результаты -->
      <div id="roof-step-3" class="hidden">
        <h2 class="screen-title">Результаты расчета отметки верха крыши</h2>

        <div class="results-container">
          <div
            style="margin-bottom: 20px; padding: 15px; background: var(--primary-blue); border-radius: 10px; color: white;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">Параметры расчета</h3>
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 0.95em;">
              <div><strong>Проект:</strong> <span id="results-project-name-roof"></span></div>
              <div><strong>Дата замера:</strong> <span id="results-date-roof"></span></div>
              <div><strong>Допуск:</strong> <span id="results-tolerance-roof"></span></div>
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table id="roof-results-table" style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="background: var(--accent-blue); color: white; padding: 12px;">Параметр</th>
                  <th style="background: var(--accent-blue); color: white; padding: 12px;">Значение, мм</th>
                </tr>
              </thead>
              <tbody id="roof-results-body">
                <!-- Данные будут заполнены скриптом -->
              </tbody>
            </table>
          </div>

          <div id="roof-summary"
            style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid var(--success-green);">
            <strong>ПРИМЕЧАНИЕ:</strong> Значение, отмеченное <span
              style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска
          </div>
        </div>

        <div class="button-group">
          <button onclick="backToRoofStep2()" class="secondary">
            Назад к замерам
          </button>

          <button onclick="exportRoofTopToExcel()" class="export-excel">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
        </div>

        <div class="button-group">
          <button onclick="resetRoofForm()" class="reset">
            Новый расчет
          </button>
          <button onclick="showMainMenu()" class="secondary">
            Назад в меню модулей
          </button>
        </div>
      </div>
    </div>



  </div>
  <div id="inst-hat-pipes" class="container-module inst-hat-pipes-container">

    <!-- <div class="status-bar">
      <span id="clock">12:00</span>
      <div class="status-bar-icons"></div>
    </div> -->

    <div class="app-header">
      <h1>Люки и патрубки</h1>
      <div class="header-actions">
        <svg onclick="openCalculator()" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke-width="2" stroke="currentColor" style="color: #dee6f6;">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V13.5zm0 2.25h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V18zm2.498-6.75h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V13.5zm0 2.25h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V18zm2.504-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zm0 2.25h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V18zm2.498-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zM8.25 6h7.5v2.25h-7.5V6zM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25 2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0012 2.25z" />
        </svg>
        <!-- <svg
          onclick="showModal('О приложении', 'Версия 2.0<br>+ Расчет длины дуги<br>+ Обратный расчет дуги<br>+ Люки в стенке<br>+ Люки в крыше<br>+ Экспорт в Excel<br>+ Импорт данных по столбцам<br>+ Сортировка по градусу')"
          xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
        </svg> -->
      </div>
    </div>

    <div id="main-content">

      <div class="tabs-container">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('arc')">Дуга</div>
          <div class="tab" onclick="switchTab('wall')">В стенке</div>
          <div class="tab" onclick="switchTab('roof')">В крыше</div>
        </div>
      </div>

      <!-- ВКЛАДКА ДУГИ -->
      <div id="arc-tab" class="input-group">
        <h2>Расчет длины дуги</h2>

        <div class="input-container">
          <label class="input-label" for="tank-diameter">Диаметр резервуара <span>(мм)</span></label>
          <input type="tel" id="tank-diameter-arc" placeholder="Например: 15198" min="0" oninput="calculateArcLength()">
        </div>

        <div class="arc-result hidden" id="one-degree-result">
          Длина дуги 1°:
          <div class="arc-result-value" id="one-degree-value">0.00 мм</div>
        </div>

        <div class="input-container" style="margin-top: 0.75rem;">
          <label class="input-label" for="degrees-count">Количество градусов</label>
          <input type="tel" id="degrees-count" placeholder="Например: 2" min="0" max="360"
            oninput="calculateArcLength()">
        </div>

        <div class="arc-result hidden" id="custom-degree-result">
          Длина дуги для <span id="degrees-display">0</span>°:
          <div class="arc-result-value" id="custom-degree-value">0.00 мм</div>
        </div>

        <!-- ОБРАТНЫЙ РАСЧЕТ -->
        <div class="arc-conversion hidden" id="arc-to-angle-conversion">
          <div class="arc-conversion-title">Обратный расчет: из длины дуги в угол</div>

          <div class="input-container">
            <label class="input-label" for="arc-length-input">Длина дуги <span>(мм)</span></label>
            <input type="tel" id="arc-length-input" placeholder="Введите длину дуги" min="0"
              oninput="calculateAngleFromArc()">
          </div>

          <div class="arc-conversion-result hidden" id="angle-result">
            <div class="angle-result-item">
              <div>
                <div class="angle-result-label">Градусы:</div>
                <div class="angle-result-detail">основная единица</div>
              </div>
              <div class="angle-result-value" id="angle-degrees">0°</div>
            </div>

            <div class="angle-result-item">
              <div>
                <div class="angle-result-label">Минуты:</div>
                <div class="angle-result-detail">1° = 60′</div>
              </div>
              <div class="angle-result-value" id="angle-minutes">0′</div>
            </div>

            <div class="angle-result-item">
              <div>
                <div class="angle-result-label">Секунды:</div>
                <div class="angle-result-detail">1′ = 60″</div>
              </div>
              <div class="angle-result-value" id="angle-seconds">0″</div>
            </div>

            <div class="angle-result-item" style="background-color: #eff6ff; border-color: #bfdbfe;">
              <div>
                <div class="angle-result-label">Полный угол:</div>
                <div class="angle-result-detail">градусы.десятичные</div>
              </div>
              <div class="angle-result-value" id="angle-full">0.0000°</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ВКЛАДКА ЛЮКИ В СТЕНКЕ -->
      <div id="wall-tab" class="input-group hidden">
        <h2>Люки и патрубки в стенке</h2>

        <!-- ДОБАВЛЕНО: Поле для названия резервуара -->
        <div class="input-container">
          <label class="input-label" for="wall-tank-name">Название резервуара</label>
          <input type="text" id="wall-tank-name" placeholder="Например: РВС-5000">
        </div>

        <div class="input-container">
          <label class="input-label" for="wall-tank-diameter">Диаметр резервуара <span>(мм)</span></label>
          <input type="tel" id="wall-tank-diameter" placeholder="Например: 10000" min="0"
            oninput="updateWallAxesInfo()">
        </div>

        <div class="axes-info hidden" id="wall-axes-info">
          <div style="font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;">Длины дуг осей:</div>
          <div class="axes-grid" id="wall-axes-grid">
            <!-- Динамически заполняется -->
          </div>
        </div>

        <!-- ВКЛАДКА ИМПОРТА ДЛЯ СТЕНКИ -->
        <div class="import-tab">
          <div class="import-tab-header" onclick="toggleImportTab('wall')">
            <div class="import-tab-title">
              <svg class="import-tab-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
              Импорт данных по столбцам
            </div>
            <div style="font-size: 0.7rem; color: #6b7280;">Нажмите для развертывания</div>
          </div>
          <div class="import-tab-content" id="wall-import-tab">
            <div class="import-hint">
              Введите данные для каждого столбца отдельно. Можно вводить через пробел (строка) или каждый элемент с
              новой строки (столбец).
            </div>

            <div class="import-columns-grid">
              <div class="import-column">
                <div class="import-column-label">
                  Названия
                  <button class="clear-btn" onclick="clearImportColumn('wall', 'names')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="wall-import-names" placeholder="Пример:
Люк Д500
Патрубок 1
Патрубок 2"></textarea>
              </div>
              <div class="import-column">
                <div class="import-column-label">
                  Ду, мм
                  <button class="clear-btn" onclick="clearImportColumn('wall', 'diameters')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="wall-import-diameters" placeholder="Пример:
500
300
200"></textarea>
              </div>
              <div class="import-column">
                <div class="import-column-label">
                  Градусы
                  <button class="clear-btn" onclick="clearImportColumn('wall', 'degrees')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="wall-import-degrees" placeholder="Пример:
45
90
180"></textarea>
              </div>
              <div class="import-column">
                <div class="import-column-label">
                  Высоты, мм
                  <button class="clear-btn" onclick="clearImportColumn('wall', 'heights')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="wall-import-heights" placeholder="Пример:
1500
1200
1000"></textarea>
              </div>
            </div>

            <div class="import-actions">
              <button onclick="importWallDataByColumns()" class="btn btn-primary" style="flex: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" style="width: 1rem; height: 1rem; margin-right: 0.25rem;">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                Импортировать все столбцы
              </button>
            </div>
          </div>
        </div>

        <div class="input-container">
          <div class="input-label-wrapper" style="display: flex; justify-content: space-between; align-items: center;">
            <label class="input-label" for="wall-nozzles-count">Количество люков/патрубков</label>
            <button onclick="addNozzleRow('wall')" class="btn-link" style="color: #2563eb;">+ Добавить</button>
          </div>
          <input type="tel" id="wall-nozzles-count" value="1" min="1" max="20" oninput="updateNozzleRows('wall')"
            class="text-center">
        </div>

        <div id="wall-nozzle-inputs-grid" class="nozzle-inputs-grid">
          <!-- Динамически генерируемые строки -->
          <div class="nozzle-row-container" data-index="0" data-tab="wall">
            <div class="nozzle-row-header">
              <div class="nozzle-row-title">Патрубок #1</div>
              <div style="display: flex; gap: 0.375rem;">
                <button class="btn-reset" onclick="resetNozzleRow(this)" title="Сбросить">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                  </svg>
                </button>
                <button class="btn-delete" onclick="deleteNozzleRow(this)" style="display: none;" title="Удалить">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- ОСНОВНЫЕ ПОЛЯ -->
            <div class="nozzle-row">
              <input type="text" class="nozzle-name" placeholder="Название люка или патрубка"
                oninput="updateNozzleTitle(this, 0, 'wall')">
              <input type="text" class="nozzle-diameter" placeholder="Ду, мм">
              <input type="text" class="nozzle-degree" placeholder="Градус">
              <input type="text" class="nozzle-height" placeholder="Высота, мм">
              <div style="display: flex; gap: 0.375rem;">
                <!-- Кнопки уже в заголовке -->
              </div>
            </div>
          </div>
        </div>

        <button onclick="calculateWallNozzles()" class="btn btn-calculate">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
            style="width: 1rem; height: 1rem;">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
              clip-rule="evenodd" />
          </svg>
          Рассчитать
        </button>
      </div>

      <!-- ВКЛАДКА ЛЮКИ В КРЫШЕ -->
      <div id="roof-tab" class="input-group hidden">
        <h2>Люки и патрубки в крыше</h2>

        <!-- ДОБАВЛЕНО: Поле для названия резервуара -->
        <div class="input-container">
          <label class="input-label" for="roof-tank-name">Название резервуара</label>
          <input type="text" id="roof-tank-name" placeholder="Например: РВС-5000">
        </div>

        <div class="input-container">
          <label class="input-label" for="roof-tank-diameter">Диаметр резервуара <span>(мм)</span></label>
              <input type="text" id="roof-tank-diameter-1" placeholder="Например: 10000"
                oninput="updateRoofAxesInfo()">
        </div>

        <!-- ОБЩИЙ УКЛОН КРЫШИ -->
        <div class="input-container">
          <label class="input-label" for="common-roof-slope">Уклон крыши для всех патрубков <span>(1 к N)</span></label>
          <input type="tel" id="common-roof-slope" placeholder="Например: 6" min="0" step="0.1">
        </div>

        <div class="axes-info hidden" id="roof-axes-info">
          <div style="font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;">Длины дуг осей:</div>
          <div class="axes-grid" id="roof-axes-grid">
            <!-- Динамически заполняется -->
          </div>
        </div>

        <!-- ВКЛАДКА ИМПОРТА ДЛЯ КРЫШИ -->
        <div class="import-tab">
          <div class="import-tab-header" onclick="toggleImportTab('roof')">
            <div class="import-tab-title">
              <svg class="import-tab-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
              </svg>
              Импорт данных по столбцам
            </div>
            <div style="font-size: 0.7rem; color: #6b7280;">Нажмите для развертывания</div>
          </div>
          <div class="import-tab-content" id="roof-import-tab">
            <div class="import-hint">
              Введите данные для каждого столбца отдельно. Можно вводить через пробел (строка) или каждый элемент с
              новой строки (столбец).
            </div>

            <div class="import-columns-grid">
              <div class="import-column">
                <div class="import-column-label">
                  Названия
                  <button class="clear-btn" onclick="clearImportColumn('roof', 'names')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="roof-import-names" placeholder="Пример:
Люк Д500
Патрубок 1
Патрубок 2"></textarea>
              </div>
              <div class="import-column">
                <div class="import-column-label">
                  Ду, мм
                  <button class="clear-btn" onclick="clearImportColumn('roof', 'diameters')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="roof-import-diameters" placeholder="Пример:
500
300
200"></textarea>
              </div>
              <div class="import-column">
                <div class="import-column-label">
                  Градусы
                  <button class="clear-btn" onclick="clearImportColumn('roof', 'degrees')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="roof-import-degrees" placeholder="Пример:
45
90
180"></textarea>
              </div>
              <div class="import-column">
                <div class="import-column-label">
                  А, мм
                  <button class="clear-btn" onclick="clearImportColumn('roof', 'distances')">Очистить</button>
                </div>
                <textarea class="import-textarea" id="roof-import-distances" placeholder="Пример:
2000
1500
1000"></textarea>
              </div>
            </div>

            <div class="import-actions">
              <button onclick="importRoofDataByColumns()" class="btn btn-primary" style="flex: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" style="width: 1rem; height: 1rem; margin-right: 0.25rem;">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                Импортировать все столбцы
              </button>
            </div>
          </div>
        </div>

        <div class="input-container">
          <div class="input-label-wrapper" style="display: flex; justify-content: space-between; align-items: center;">
            <label class="input-label" for="roof-nozzles-count">Количество люков/патрубков</label>
            <button onclick="addNozzleRow('roof')" class="btn-link" style="color: #2563eb;">+ Добавить</button>
          </div>
          <input type="tel" id="roof-nozzles-count" value="1" min="1" max="20" oninput="updateNozzleRows('roof')"
            class="text-center">
        </div>

        <div id="roof-nozzle-inputs-grid" class="nozzle-inputs-grid">
          <!-- Динамически генерируемые строки -->
          <div class="nozzle-row-container" data-index="0" data-tab="roof">
            <div class="nozzle-row-header">
              <div class="nozzle-row-title">Патрубок #1</div>
              <div style="display: flex; gap: 0.375rem;">
                <button class="btn-reset" onclick="resetNozzleRow(this)" title="Сбросить">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                  </svg>
                </button>
                <button class="btn-delete" onclick="deleteNozzleRow(this)" style="display: none;" title="Удалить">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- ОСНОВНЫЕ ПОЛЯ КРЫШИ -->
            <!-- Градус перед расстоянием -->
            <div class="nozzle-row-roof">
              <input type="text" class="nozzle-name" placeholder="Название люка или патрубка"
                oninput="updateNozzleTitle(this, 0, 'roof')">
              <input type="text" class="nozzle-diameter" placeholder="Ду, мм">
              <input type="text" class="nozzle-degree" placeholder="Градус">
              <input type="text" class="distance-from-center" placeholder="А, мм">
              <div style="display: flex; gap: 0.375rem;">
                <!-- Кнопки уже в заголовке -->
              </div>
            </div>
          </div>
        </div>

        <button onclick="calculateRoofNozzles()" class="btn btn-calculate">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
            style="width: 1rem; height: 1rem;">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
              clip-rule="evenodd" />
          </svg>
          Рассчитать
        </button>
      </div>

      <!-- РЕЗУЛЬТАТЫ (СТЕНКА) -->
      <div id="wall-results-block" class="input-group hidden">
        <div class="table-wrapper">
          <table id="wall-results-table">
          </table>
        </div>

        <div class="results-actions">
          <div class="results-actions-grid"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <button onclick="backToWallInput()" class="btn btn-warning">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
                style="width: 0.875rem; height: 0.875rem;">
                <path fill-rule="evenodd"
                  d="M10.707 2.293a1 1 0 010 1.414L6.414 8H17a1 1 0 110 2H6.414l4.293 4.293a1 1 0 01-1.414 1.414l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 0z"
                  clip-rule="evenodd" />
              </svg>
              Назад
            </button>

            <button onclick="exportToExcel2('wall')" class="btn export-excel">
              <span class="excel-icon">📊</span> Экспорт в Excel
            </button>
          </div>

          <button onclick="sortWallResultsByDegree()" class="btn btn-secondary" style="margin-bottom: 0.75rem;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" style="width: 0.875rem; height: 0.875rem; margin-right: 0.25rem;">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
            </svg>
            Упорядочить по градусу
          </button>

          <button onclick="resetForm('wall')" class="btn btn-secondary">
            Новый расчет
          </button>
        </div>
      </div>

      <!-- РЕЗУЛЬТАТЫ (КРЫША) -->
      <div id="roof-results-block" class="input-group hidden">
        <div class="table-wrapper">
          <table id="roof-results-table-1">
          </table>
        </div>

        <div class="results-actions">
          <div class="results-actions-grid"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <button onclick="backToRoofInput()" class="btn btn-warning">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"
                style="width: 0.875rem; height: 0.875rem;">
                <path fill-rule="evenodd"
                  d="M10.707 2.293a1 1 0 010 1.414L6.414 8H17a1 1 0 110 2H6.414l4.293 4.293a1 1 0 01-1.414 1.414l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 0z"
                  clip-rule="evenodd" />
              </svg>
              Назад
            </button>

            <button onclick="exportToExcel2('roof')" class="btn export-excel">
              <span class="excel-icon">📊</span> Экспорт в Excel
            </button>
          </div>

          <button onclick="sortRoofResultsByDegree()" class="btn btn-secondary" style="margin-bottom: 0.75rem;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" style="width: 0.875rem; height: 0.875rem; margin-right: 0.25rem;">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
            </svg>
            Упорядочить по градусу
          </button>

          <button onclick="resetForm('roof')" class="btn btn-secondary">
            Новый расчет
          </button>
        </div>
      </div>
      <button id="inst-hat-pipes-back-to-list-button" class="secondary back-button">Вернуться к списку проектов</button>
      <button id="inst-hat-pipes-back-to-modules-button" class="secondary back-button">Вернуться к выбору модулей</button>

    </div>

    <!-- КАЛЬКУЛЯТОР -->
    <div id="calculator-modal" class="calculator-modal">
      <div class="calculator-box">
        <div class="calculator-display" id="calc-display">0</div>
        <div class="calculator-buttons">
          <button class="calc-btn clear" onclick="clearCalculator()">C</button>
          <button class="calc-btn" onclick="calcInput('/')">/</button>
          <button class="calc-btn" onclick="calcInput('*')">×</button>
          <button class="calc-btn" onclick="calcInput('7')">7</button>
          <button class="calc-btn" onclick="calcInput('8')">8</button>
          <button class="calc-btn" onclick="calcInput('9')">9</button>
          <button class="calc-btn operator" onclick="calcInput('-')">-</button>
          <button class="calc-btn" onclick="calcInput('4')">4</button>
          <button class="calc-btn" onclick="calcInput('5')">5</button>
          <button class="calc-btn" onclick="calcInput('6')">6</button>
          <button class="calc-btn operator" onclick="calcInput('+')">+</button>
          <button class="calc-btn" onclick="calcInput('1')">1</button>
          <button class="calc-btn" onclick="calcInput('2')">2</button>
          <button class="calc-btn" onclick="calcInput('3')">3</button>
          <button class="calc-btn" onclick="calcInput('0')">0</button>
          <button class="calc-btn" onclick="calcInput('.')">.</button>
          <button class="calc-btn equals" onclick="calculateResult()">=</button>
        </div>
        <button onclick="closeCalculator()" class="btn btn-secondary" style="margin-top: 0.75rem;">Закрыть</button>
      </div>
    </div>
  </div>
  <!-- МОДАЛЬНОЕ ОКНО -->


  <div id="insp-hat-pipes" class="container-module insp-hat-pipes-container">
    <!-- ШАПКА -->
    <div class="header">
      <h1>Контроль качества установки люков и патрубков РВС</h1>
      <p>Протокол измерений с проверкой отклонений по ГОСТ 31385-2023</p>
    </div>

    <!-- ВКЛАДКИ РЕЖИМОВ -->
    <div class="mode-tabs">
      <div class="mode-tab active" data-tab="wall">Люки и патрубки в стенке</div>
      <div class="mode-tab" data-tab="roof">Люки и патрубки в крыше</div>
    </div>



    <!-- СОДЕРЖИМОЕ РЕЖИМА СТЕНКИ -->
    <div id="wall-content" class="tab-content active">


      <!-- УПРАВЛЕНИЕ ТАБЛИЦЕЙ -->
      <div class="form-section">
        <h3>Таблица контроля</h3>
        <div class="form-grid" style="margin-bottom: 12px;">
          <div class="form-group">
            <label for="wall-date">Дата замера</label>
            <input type="date" id="wall-date" oninput="autosave()">
          </div>
        </div>
        <div class="table-controls">
          <button class="btn btn-primary" onclick="addRow('wall')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Добавить строку
          </button>
          <button class="btn btn-secondary" onclick="clearTable('wall')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Очистить таблицу
          </button>
          <button class="btn btn-warning bulk-input-btn" onclick="openBulkInput('wall')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
            </svg>
            Массовый ввод
          </button>
          <button class="btn export-excel" onclick="exportToExcel3('wall')">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
        </div>

        <!-- ТАБЛИЦА -->
        <div class="table-wrapper big-scroll">
          <table id="wall-table">
            <thead>
              <tr class="column-group">
                <th colspan="3">Идентификация</th>
                <th colspan="2">Угол установки, °</th>
                <th colspan="2">А, мм</th>
                <th colspan="2">В, мм</th>
                <th colspan="2">С, мм</th>
                <th colspan="4" class="nowrap">Отклонения</th>
                <th rowspan="2">Действия</th>
              </tr>
              <tr>
                <!-- Идентификация -->
                <th class="small-text">Тип</th>
                <th class="small-text">Обознач.<br>по КМ</th>
                <th class="small-text">Ду,<br>мм</th>

                <!-- Угол установки -->
                <th class="small-text">ɑ°<br>проект</th>
                <th class="small-text">ɑ°<br>факт</th>

                <!-- А, мм -->
                <th class="small-text">А<br>проект,<br>мм</th>
                <th class="small-text">А<br>факт,<br>мм</th>

                <!-- В, мм -->
                <th class="small-text">В<br>проект,<br>мм</th>
                <th class="small-text">В<br>факт,<br>мм</th>

                <!-- С, мм -->
                <th class="small-text">С<br>проект,<br>мм</th>
                <th class="small-text">С<br>факт,<br>мм</th>

                <!-- Отклонения -->
                <th class="small-text" style="min-width: 100px;">Отклон.<br>оси фл-ца<br>в вертик.<br>пл-сти, мм</th>
                <th class="small-text" style="min-width: 120px;">Отклон. оси от проект.<br>положения (поворот)<br>в
                  вертик. плоскости, мм</th>
                <th class="small-text" style="min-width: 120px;">Отклон. оси от проект.<br>положения (поворот)<br>в
                  гориз. плоскости, мм</th>
                <th class="small-text" style="min-width: 90px;">Зазор<br>между усил.<br>листом и<br>стенкой РВС,<br>мм
                </th>
              </tr>
            </thead>
            <tbody id="wall-tbody">
              <!-- Строки будут добавляться динамически -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- ПРИМЕЧАНИЯ -->
      <div class="note-section">
        <h3>Допустимые отклонения по ГОСТ 31385-2023 (Таблица 22)</h3>

        <div class="note-wrapper">
          <table class="note-table">
            <thead>
              <tr>
                <th rowspan="2">Наименование параметра</th>
                <th colspan="2">Предельное отклонение</th>
              </tr>
              <tr>
                <th>Люки</th>
                <th>Патрубки</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1. Отметка высоты установки на стенке</td>
                <td>±10 мм</td>
                <td>±6 мм</td>
              </tr>
              <tr>
                <td>2. Радиус установки от центра крыши</td>
                <td>50 мм</td>
                <td>10 мм</td>
              </tr>
              <tr>
                <td>3. Расстояние от наружной поверхности фланца до стенки или крыши резервуара</td>
                <td>±10 мм</td>
                <td>±5 мм</td>
              </tr>
              <tr>
                <td>4. Поворот главных осей фланца в вертикальной плоскости</td>
                <td>±5°</td>
                <td>±5°</td>
              </tr>
              <tr>
                <td>5. Отклонение оси от проектного положения (поворот), измеренное по наружной поверхности фланца в
                  вертикальной и горизонтальной плоскостях</td>
                <td>10 мм</td>
                <td>6 мм</td>
              </tr>
              <tr>
                <td>6. Зазор между усиливающим листом и стенкой резервуара (измерение проводят через контрольное
                  отверстие в усиливающем листе)</td>
                <td>5 мм</td>
                <td>10 мм</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="standard-ref">
          <strong>ГОСТ 31385-2023:</strong> Резервуары вертикальные цилиндрические стальные для нефти и нефтепродуктов.
          Общие технические условия.
        </div>
      </div>
    </div>

    <!-- СОДЕРЖИМОЕ РЕЖИМА КРЫШИ -->
    <div id="roof-content" class="tab-content">
      <!-- УПРАВЛЕНИЕ ТАБЛИЦЕЙ -->
      <div class="form-section">
        <h3>Таблица контроля</h3>
        <div class="form-grid" style="margin-bottom: 12px;">
          <div class="form-group">
            <label for="roof-date">Дата замера</label>
            <input type="date" id="roof-date" oninput="autosave()">
          </div>
        </div>
        <div class="table-controls">
          <button class="btn btn-primary" onclick="addRow('roof')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Добавить строку
          </button>
          <button class="btn btn-secondary" onclick="clearTable('roof')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Очистить таблицу
          </button>
          <button class="btn btn-warning bulk-input-btn" onclick="openBulkInput('roof')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
            </svg>
            Массовый ввод
          </button>
          <button class="btn export-excel" onclick="exportToExcel3('roof')">
            <span class="excel-icon">📊</span> Экспорт в Excel
          </button>
        </div>

        <!-- ТАБЛИЦА -->
        <div class="table-wrapper">
          <table id="roof-table">
            <thead>
              <tr class="column-group">
                <th colspan="3">Идентификация</th>
                <th colspan="2">Угол установки, °</th>
                <th colspan="2">А, мм</th>
                <th colspan="2">В, мм</th>
                <th colspan="2">С, мм</th>
                <th colspan="3" class="nowrap">Отклонения</th>
                <th rowspan="2">Действия</th>
              </tr>
              <tr>
                <!-- Идентификация -->
                <th class="small-text">Тип</th>
                <th class="small-text">Обознач.<br>по КМ</th>
                <th class="small-text">Ду,<br>мм</th>

                <!-- Угол установки -->
                <th class="small-text">ɑ°<br>проект</th>
                <th class="small-text">ɑ°<br>факт</th>

                <!-- А, мм -->
                <th class="small-text">А<br>проект,<br>мм</th>
                <th class="small-text">А<br>факт,<br>мм</th>

                <!-- В, мм -->
                <th class="small-text">В<br>проект,<br>мм</th>
                <th class="small-text">В<br>факт,<br>мм</th>

                <!-- С, мм -->
                <th class="small-text">С<br>проект,<br>мм</th>
                <th class="small-text">С<br>факт,<br>мм</th>

                <!-- Отклонения -->
                <th class="small-text" style="min-width: 100px;">Отклон.<br>оси фл-ца<br>в вертик.<br>пл-сти, мм</th>
                <th class="small-text" style="min-width: 120px;">Отклон. оси от проект.<br>положения (поворот)<br>в
                  вертик. плоскости, мм</th>
                <th class="small-text" style="min-width: 120px;">Отклон. оси от проект.<br>положения (поворот)<br>в
                  гориз. плоскости, мм</th>
              </tr>
            </thead>
            <tbody id="roof-tbody">
              <!-- Строки будут добавляться динамически -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- ПРИМЕЧАНИЯ -->
      <div class="note-section">
        <h3>Допустимые отклонения по ГОСТ 31385-2023 (Таблица 22)</h3>

        <div class="note-wrapper">
          <table class="note-table">
            <thead>
              <tr>
                <th rowspan="2">Наименование параметра</th>
                <th colspan="2">Предельное отклонение</th>
              </tr>
              <tr>
                <th>Люки</th>
                <th>Патрубки</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1. Отметка высоты установки на стенке</td>
                <td>±10 мм</td>
                <td>±6 мм</td>
              </tr>
              <tr>
                <td>2. Радиус установки от центра крыши</td>
                <td>50 мм</td>
                <td>10 мм</td>
              </tr>
              <tr>
                <td>3. Расстояние от наружной поверхности фланца до стенки или крыши резервуара</td>
                <td>±10 мм</td>
                <td>±5 мм</td>
              </tr>
              <tr>
                <td>4. Поворот главных осей фланца в вертикальной плоскости</td>
                <td>±5°</td>
                <td>±5°</td>
              </tr>
              <tr>
                <td>5. Отклонение оси от проектного положения (поворот), измеренное по наружной поверхности фланца в
                  вертикальной и горизонтальной плоскостях</td>
                <td>10 мм</td>
                <td>6 мм</td>
              </tr>
              <tr>
                <td>6. Зазор между усиливающим листом и стенкой резервуара (измерение проводят через контрольное
                  отверстие в усиливающем листе)</td>
                <td>5 мм</td>
                <td>10 мм</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="standard-ref">
          <strong>ГОСТ 31385-2023:</strong> Резервуары вертикальные цилиндрические стальные для нефти и нефтепродуктов.
          Общие технические условия.
        </div>
      </div>
    </div>
    <div style="display: flex; gap: 8px; margin: 12px 0;">
      <button id="insp-hat-pipes-back-to-list-button" class="secondary back-button">Вернуться к списку проектов</button>
      <button id="insp-hat-pipes-back-to-modules-button" class="secondary back-button">Вернуться к выбору модулей</button>
    </div>

  </div>

  <!-- МОДАЛЬНОЕ ОКНО МАССОВОГО ВВОДА -->
  <div id="bulk-input-modal" class="bulk-input-modal">
    <div class="bulk-input-content">
      <h3 id="bulk-modal-title">Массовый ввод данных</h3>
      <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 13px;">
        Введите данные для каждого столбца отдельно. Можно вводить через пробел или каждый элемент с новой строки.
      </p>

      <div class="bulk-input-grid">
        <div class="bulk-column">
          <h4>Тип (Л или П)</h4>
          <textarea id="bulk-types" placeholder="Л
П
Л
П"></textarea>
        </div>

        <div class="bulk-column">
          <h4>Обозначения по КМ</h4>
          <textarea id="bulk-designations" placeholder="Л-1
П-1
Л-2
П-2"></textarea>
        </div>

        <div class="bulk-column">
          <h4>Ду, мм</h4>
          <textarea id="bulk-diameter" placeholder="600
300
800
400"></textarea>
        </div>

        <div class="bulk-column">
          <h4>Угол проект, °</h4>
          <textarea id="bulk-angle-project" placeholder="45
90
180
270"></textarea>
        </div>

        <div class="bulk-column">
          <h4>А проект, мм</h4>
          <textarea id="bulk-a-project" placeholder="1500
1200
1800
1000"></textarea>
        </div>

        <div class="bulk-column">
          <h4>В проект, мм</h4>
          <textarea id="bulk-b-project" placeholder="100
80
120
90"></textarea>
        </div>

        <div class="bulk-column">
          <h4>С проект, мм</h4>
          <textarea id="bulk-c-project" placeholder="50
40
60
45"></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeBulkInput()">Отмена</button>
        <button class="btn btn-primary" onclick="importBulkData()">Импортировать</button>
      </div>
    </div>
  </div>

  <!-- КНОПКА ПРОКРУТКИ ВВЕРХ -->
  <!-- <div class="scroll-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
  </div> -->


  <!-- Модальное окно для сообщений -->
  <div id="access-gate-modal" class="access-gate-modal hidden">
    <div class="access-gate-box">
      <div class="access-gate-title">Доступ к приложению</div>
      <div class="access-gate-subtitle">Введите ключ доступа, чтобы продолжить работу.</div>
      <input id="access-key-input" class="access-gate-input" type="text" placeholder="Ключ доступа">
      <div class="access-gate-actions">
        <button id="access-key-submit" class="access-gate-button">Получить доступ</button>
      </div>
      <div id="access-gate-status" class="access-gate-status"></div>
    </div>
  </div>

  <div id="message-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="modal-title" class="modal-title">Сообщение</h3>
      <div id="modal-body" class="modal-body"></div>
      <button onclick="closeModal()" class="btn">Понятно</button>
    </div>
  </div>
  <!-- Уведомления -->
  <div class="notification" id="notification"></div>
<div id="geodesy-screen">
    <div class="geo-wrapper">
        <div style="text-align: center; font-size: 3rem; color: #1e88e5; margin-bottom: 5px;">
            <i class="fas fa-drafting-compass"></i>
        </div>
        <h2 style="text-align: center; color: #1565c0; font-size: 1.6rem; margin: 0 0 20px 0;">Геодезия</h2>

        <div class="geo-inputs-grid">
            <div class="geo-field">
                <label>Место работ:</label>
                <input type="text" id="geo-obj-name" class="geo-input-style" placeholder="Напр: Секция 1">
            </div>
            <div class="geo-field">
                <label>Вид работ:</label>
                <input type="text" id="geo-work-type" class="geo-input-style" placeholder="Напр: Осадка">
            </div>
        </div>

        <div class="geo-options-container">
            <div class="geo-option-group">
                <span class="option-label">Тип:</span>
                <label><input type="radio" name="geo-type" value="Высота" checked> Высота</label>
                <label><input type="radio" name="geo-type" value="Длина"> Длина</label>
            </div>
            <div class="geo-option-group">
                <span class="option-label">Ед.изм:</span>
                <label><input type="radio" name="geo-u" value="м" checked> м</label>
                <label><input type="radio" name="geo-u" value="мм"> мм</label>
            </div>
        </div>

        <div class="geo-table-container">
            <table id="geo-main-table">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Значение</th>
                        <th><i class="fas fa-times"></i></th>
                    </tr>
                </thead>
                <tbody id="geo-table-body">
                </tbody>
            </table>
        </div>

        <div class="geo-btn-group">
            <div class="geo-btn-group geo-btn-group-top" style="margin-top: 0;">
                <button class="btn-universal btn-blue" onclick="addGeoRow()">
                    <i class="fas fa-plus"></i> Добавить
                </button>
                <button class="btn-universal btn-green" onclick="exportGeodesyToExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>

            <button class="btn-universal btn-white-outline" onclick="closeGeodesy()">
                <i class="fas fa-arrow-left"></i> Назад к выбору модулей
            </button>
        </div>
    </div>
</div>

<script> 
  
    // Глобально блокируем свайпы, которые вызывают перезагрузку/сброс на мобильных
    (function setupSwipeBlocker() {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 900;
      if (!isMobile) return;

      let touchStartY = 0;
      let touchStartX = 0;

      const getScrollableAncestor = (node) => {
        let current = node;
        while (current && current !== document.body) {
          const style = window.getComputedStyle(current);
          const canScrollY = /(auto|scroll)/.test(style.overflowY);
          if (canScrollY && current.scrollHeight > current.clientHeight) {
            return current;
          }
          current = current.parentElement;
        }
        return document.scrollingElement || document.documentElement;
      };

      const shouldIgnoreTarget = (target) => target.closest('input, textarea, select');

      window.addEventListener('touchstart', (event) => {
        if (event.touches.length !== 1) return;
        touchStartY = event.touches[0].clientY;
        touchStartX = event.touches[0].clientX;
      }, { passive: false });

      window.addEventListener('touchmove', (event) => {
        if (event.touches.length !== 1) return;

        const target = event.target;
        if (shouldIgnoreTarget(target)) return;

        const currentY = event.touches[0].clientY;
        const currentX = event.touches[0].clientX;
        const deltaY = currentY - touchStartY;
        const deltaX = currentX - touchStartX;

        if (Math.abs(deltaX) > Math.abs(deltaY)) return;

        const scrollContainer = getScrollableAncestor(target);
        if (!scrollContainer) return;

        const isAtTop = scrollContainer.scrollTop <= 0;
        const isAtBottom = Math.ceil(scrollContainer.scrollTop + scrollContainer.clientHeight) >= scrollContainer.scrollHeight - 1;
        const isPullingDown = deltaY > 0;
        const isPullingUp = deltaY < 0;

        if ((isAtTop && isPullingDown) || (isAtBottom && isPullingUp)) {
          event.preventDefault();
          event.stopPropagation();
        }
      }, { passive: false });
    })();

    function getActiveProject() {
      const activeProjectName = localStorage.getItem("projectActiveName");
      const project = getAllProjects().find(p => p.name === activeProjectName);

      // Если проект существует, но у него нет данных о подмодулях фундамента, добавляем их
      if (project) {
        if (!project.data) project.data = {};

        // Проверяем, есть ли уже fundamentSubmodules в проекте
        if (!project.data.fundamentSubmodules) {
          // Если нет, создаём с дефолтными значениями
          project.data.fundamentSubmodules = [
            { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen', status: 'pending' },
            { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen', status: 'pending' },
            { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen', status: 'pending' },
            { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen', status: 'pending' },
            { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen', status: 'pending' },
            { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen', status: 'pending' },
            { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen', status: 'pending' }
          ];
        }
      }
      return project;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const ALL_PROJECTS_KEY = 'projectManagerProjects';
      const ACTIVE_PROJECT_NAME_KEY = 'projectActiveName';
      localStorage.removeItem(ACTIVE_PROJECT_NAME_KEY); 

      // МАППИНГ ДЛЯ ИМЕН ФАЙЛОВ ЭКСПОРТА 
      const SUBMODULE_NAMES_MAP = {
        'annularElevation': 'КольцевойФундаментОтметка',
        'annularWidth': 'КольцевойФундаментШирина',
        'annularDiameter': 'ФундаментНаружныйДиаметр',
        'hydroizolElevation': 'ГидроизолПоверхностьОтметка',
        'hydroizolThickness': 'ГидроизолТолщина',
        'centerElevation': 'ОснованиеЦентрОтметка',
        'settlement': 'ОсадкаФундамента'
      };

      // --- СОСТОЯНИЕ ---
      let currentUnit = 'm';
      let hydroizolCurrentUnit = 'm';
      let centerCurrentUnit = 'm';
      let settlementCurrentUnit = 'm';
      let settlementActiveTab = 'base';
      let activeDuringIndex = 0;
      // --- КОНСТАНТЫ И НАСТРОЙКИ ---

      // Для модуля гидроизола
      let hydroizolComparisonMode = false;

      // --- ЭЛЕМЕНТЫ DOM (ОСНОВНЫЕ) ---
      const screens = document.querySelectorAll('.app-screen');
      const projectListScreen = document.getElementById('project-list-screen');
      const setupScreen = document.getElementById('setup-screen');
      const fundamentScreen = document.getElementById('fundament-screen');
      const projectsListContainer = document.getElementById('projects-list-container');
      const fundamentModuleList = document.getElementById('fundament-module-list');

      // Заголовки
      const fundamentRvsName = document.getElementById('fundament-rvs-name');
      const fundamentRvsDate = document.getElementById('fundament-rvs-date');

      // --- ФУНКЦИИ ХРАНИЛИЩА ---
      function getAllProjects() {
        return JSON.parse(localStorage.getItem(ALL_PROJECTS_KEY) || '[]');
      }
      function saveAllProjects(projects) {
        localStorage.setItem(ALL_PROJECTS_KEY, JSON.stringify(projects));
      }
      function getActiveProject() {
        const activeProjectName = localStorage.getItem("projectActiveName");
        if (!activeProjectName) return null;

        const allProjects = JSON.parse(localStorage.getItem('projectManagerProjects') || '[]');
        const project = allProjects.find(p => p.name === activeProjectName);

        if (!project) return null;

        // Initialize project data if it doesn't exist
        if (!project.data) project.data = {};

        // Ensure fundamentSubmodules exist in the project data
        if (!project.data.fundamentSubmodules) {
          // Use default submodule structure if not present
          project.data.fundamentSubmodules = [
            { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen', status: 'pending' },
            { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen', status: 'pending' },
            { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen', status: 'pending' },
            { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen', status: 'pending' },
            { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen', status: 'pending' },
            { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen', status: 'pending' },
            { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen', status: 'pending' }
          ];
        }

        return project;
      }
      function saveActiveProject(updatedProject) {
        let projects = getAllProjects();
        const index = projects.findIndex(p => p.name === updatedProject.name);
        if (index !== -1) {
          projects[index] = updatedProject;
          saveAllProjects(projects);
        }
      }
      function saveCompletionState(submoduleId, isCompleted) {
        let project = getActiveProject();
        if (project) {
          if (!project.data) project.data = {};
          if (!project.data.fundament) project.data.fundament = {};
          project.data.fundament[submoduleId] = isCompleted;

          const defaultSubmodules = [
            { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen', status: 'pending' },
            { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen', status: 'pending' },
            { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen', status: 'pending' },
            { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen', status: 'pending' },
            { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen', status: 'pending' },
            { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen', status: 'pending' },
            { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen', status: 'pending' }
          ];

          if (!project.data.fundamentSubmodules) {
            project.data.fundamentSubmodules = JSON.parse(JSON.stringify(defaultSubmodules));
          }

          const sub = project.data.fundamentSubmodules.find(sm => sm.id === submoduleId);
          if (sub) {
            sub.status = isCompleted ? 'completed' : 'pending';
          }

          saveActiveProject(project);
          return project;
        }
        return null;
      }

      // Функция для форматирования даты в формат "число.месяц.год"
      function formatDateToDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;

        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();

        return `${day}.${month}.${year}`;
      }

      // Функция для сохранения даты в формате ГГГГ-ММ-ДД
      // function formatDateForStorage(dateString) {
      //     if (!dateString) return '';
      //     const date = new Date(dateString);
      //     if (isNaN(date.getTime())) return dateString;

      //     const year = date.getFullYear();
      //     const month = (date.getMonth() + 1).toString().padStart(2, '0');
      //     const day = date.getDate().toString().padStart(2, '0');

      //     return `${year}-${month}-${day}`;
      // }

      // Функция для получения даты замера (использует дату модуля или проекта)
      // function getMeasurementDate(moduleDateInputId) {
      //     const moduleDateInput = document.getElementById(moduleDateInputId);
      //     if (moduleDateInput && moduleDateInput.value) {
      //         return moduleDateInput.value;
      //     }
      //     const project = getActiveProject();
      //     return project ? project.date : '';
      // }

      function unitToMM(value, unit) {
        const num = parseFloat(value);
        if (isNaN(num)) return NaN;
        return unit === 'm' ? num * 1000 : num;
      }

      function mmToUnit(value, unit) {
        const num = parseFloat(value);
        if (isNaN(num)) return NaN;
        return unit === 'm' ? num / 1000 : num;
      }

      function formatNumber(value, unit) {
        if (isNaN(value)) return '';
        if (unit === 'mm') {
          return value % 1 === 0 ? value.toString() : value.toFixed(1);
        } else {
          // Для метров: 3 знака после запятой
          return value.toFixed(3).replace(/\.?0+$/, '');
        }
      }

      // --- НАВИГАЦИЯ ---
      function showScreen(screenId) {
        screens.forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(screenId);
        if (target) target.classList.remove('hidden');
      }

      // function addedNewDataInActiveProject() {
      //     // renderProjectList();
      //     showFundamentScreen()
      //     addedNewDataInActiveProject()
      //     // showScreen('fundament-screen');
      // }


      function showFundamentScreen() {
        addedNewDataInActiveProject();

        const projects = JSON.parse(localStorage.getItem(ALL_PROJECTS_KEY) || '[]');
        const activeNameProject = localStorage.getItem('projectActiveName');

        if (!projects || !activeNameProject) return;

        const index = projects.findIndex(p => p.name === activeNameProject);
        if (index === -1) return;

        const project = projects[index];

        if (!project.data) {
          project.data = {};
        }
        // Гарантируем наличие раздела fundament, но не очищаем его при каждом открытии
        if (!project.data.fundament) {
          project.data.fundament = {};
        }
        

        fundamentRvsName.textContent = project.name;
        fundamentRvsDate.textContent = `Дата проекта: ${formatDateToDisplay(project.createdAt)}`;
        renderFundamentModuleList(project);
      }




      // --- РЕНДЕРИНГ МЕНЮ МОДУЛЕЙ ---
      function renderFundamentModuleList(project = null) {
        fundamentModuleList.innerHTML = '';
        const activeName = localStorage.getItem('projectActiveName');
        const allProjects = JSON.parse(localStorage.getItem('projectManagerProjects') || '[]');
        const activeProject = allProjects.find(p => p.name === activeName);
        // Определяем структуру подмодулей для отображения
        const modulesToRender = [
          { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen' },
          { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen' },
          { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen' },
          { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen' },
          { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen' },
          { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen' },
          { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen' }
        ];


        modulesToRender.forEach(module => {
          // Получаем статус из данных проекта, если он существует
          const projectSubmodule = activeProject.data && activeProject.data.fundamentSubmodules ?
            activeProject.data.fundamentSubmodules.find(sm => sm.id === module.id) : null;
          const status = projectSubmodule ? projectSubmodule.status : (activeProject.data && activeProject.data[module.id] ? 'completed' : 'pending');

          const wrapper = document.createElement('div');
          wrapper.className = 'module-item-wrapper';

          const btn = document.createElement('button');
          btn.textContent = module.text;
          btn.className = 'list-button';
          if (status === 'completed') {
            btn.classList.add('completed');
            btn.textContent += ' (Завершено)';
          }
          btn.onclick = () => {
            if (module.id === 'annularElevation') prepareAnnularElevationScreen();
            if (module.id === 'annularWidth') prepareAnnularWidthScreen();
            if (module.id === 'annularDiameter') prepareDiameterScreen();
            if (module.id === 'centerElevation') prepareCenterScreen();
            if (module.id === 'hydroizolElevation') prepareHydroizolScreen();
            if (module.id === 'hydroizolThickness') prepareThicknessScreen();
            if (module.id === 'settlement') prepareSettlementScreen();
            showScreen(module.screen);
          };

          wrapper.appendChild(btn);
          fundamentModuleList.appendChild(wrapper);
        });
      }

      window.renderFundamentModuleList = renderFundamentModuleList;

      // Функция для переключения статуса подмодуля
      function toggleSubmoduleStatus(submoduleId) {
        let project = getActiveProject();
        if (!project) return;

        // Инициализируем структуру данных проекта, если она не существует
        if (!project.data) project.data = {};
        if (!project.data.fundamentSubmodules) {
          project.data.fundamentSubmodules = [
            { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen', status: 'pending' },
            { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen', status: 'pending' },
            { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen', status: 'pending' },
            { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen', status: 'pending' },
            { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen', status: 'pending' },
            { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen', status: 'pending' },
            { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen', status: 'pending' }
          ];
        }

        // Находим подмодуль в данных проекта
        let submodule = project.data.fundamentSubmodules.find(sm => sm.id === submoduleId);
        if (submodule) {
          // Переключаем статус
          submodule.status = submodule.status === 'completed' ? 'pending' : 'completed';
        } else {
          // Если подмодуль не найден, создаем его на основе дефолтной структуры
          const defaultSubmodules = [
            { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen', status: 'pending' },
            { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen', status: 'pending' },
            { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen', status: 'pending' },
            { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen', status: 'pending' },
            { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen', status: 'pending' },
            { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen', status: 'pending' },
            { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen', status: 'pending' }
          ];
          const template = defaultSubmodules.find(sm => sm.id === submoduleId);
          project.data.fundamentSubmodules.push({
            ...(template || { id: submoduleId, text: submoduleId, screen: null }),
            status: 'completed'
          });
        }

        // Сохраняем изменения в проекте
        saveActiveProject(project);
        // Обновляем отображение списка
        renderFundamentModuleList(project);
      }

      // --- УПРАВЛЕНИЕ ПРОЕКТАМИ ---
      // function renderProjectList() {
      //     projectsListContainer.innerHTML = '';
      //     const projects = getAllProjects();
      //     if (projects.length === 0) {
      //         projectsListContainer.innerHTML = '<p>Список пуст.</p>';
      //         return;
      //     }
      //     projects.forEach(p => {
      //         const row = document.createElement('div');
      //         row.className = 'project-row';
      //         row.innerHTML = `
      //             <button class="list-button">${p.name} (${formatDateToDisplay(p.createdAt)})</button>
      //             <button class="delete-button">🗑️</button>
      //         `;
      //         row.querySelector('.list-button').onclick = () => {
      //             // localStorage.setItem(ACTIVE_PROJECT_NAME_KEY, p.name);
      //             showFundamentScreen();

      //         };
      //         // row.querySelector('.delete-button').onclick = () => {
      //         //     if(confirm('Удалить проект?')) {
      //         //         const newProjects = projects.filter(proj => proj.name !== p.name);
      //         //         saveAllProjects(newProjects);
      //         //         renderProjectList();
      //         //     }
      //         // };
      //         projectsListContainer.appendChild(row);
      //     });
      // }

      // document.getElementById('create-new-project-button').onclick = () => {
      //     document.getElementById('rvs-name').value = '';
      //     document.getElementById('rvs-date').valueAsDate = new Date();
      //     showScreen('setup-screen');
      // };


      function addedNewDataInActiveProject() {
        const projectActive = getActiveProject();
        if (!projectActive) return;

        const allProjects = getAllProjects();
        const projectIndex = allProjects.findIndex(p => p.name === projectActive.name);
        if (projectIndex === -1) return;

        const existingData = allProjects[projectIndex].data || {};

        allProjects[projectIndex].data = {
          ...existingData,
          // не трогаем уже существующий fundament, только создаём, если его нет
          fundament: existingData.fundament || {},
          // не затираем settlementData, если уже есть сохранённые значения
          settlementData: existingData.settlementData || {
            count: 0,
            unit: 'm',
            base: [],
            during: [],
            after: []
          }
        };

        localStorage.setItem(ALL_PROJECTS_KEY, JSON.stringify(allProjects));
      }

      // document.getElementById('cancel-setup-button').onclick = showProjectList;
      document.querySelectorAll('.back-to-fundament').forEach(b => b.onclick = () => {
        showScreen("fundament-screen")
      });
      document.getElementById('fundament-back-to-list-button').addEventListener('click', () => {
        showScreen('projectsSection');
        document.getElementById('app-fundamet').style.display = 'none';
        document.querySelector("header").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
      });
      document.getElementById('fundament-back-to-modules-button').addEventListener('click', () => {
        showScreen('modulesSection');
        document.getElementById('app-fundamet').style.display = 'none';
        document.querySelector("header").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
      });

      // ==========================================
      // === ОБЩИЕ ФУНКЦИИ ===
      // ==========================================

      // ОБНОВЛЕННАЯ функция для генерации имени файла (без даты проекта, только дата замера)
      function generateExportFilename(submoduleId, measurementDate = null) {
        const proj = getActiveProject();
        const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;
        const sanitizeName = (name) => {
          return name.trim().replace(/[^a-zA-Zа-яА-ЯёЁ0-9-]+/g, '_').replace(/_+/g, '_');
        };
        const rvsNameSanitized = sanitizeName(proj.name);
        const subNameSanitized = sanitizeName(subName);

        // Используем дату замера
        let dateToUse = measurementDate;
        let dateFormatted = '';

        if (dateToUse) {
          // Форматируем дату в "дд.мм.гггг"
          const dateParts = dateToUse.split('-');
          if (dateParts.length === 3) {
            dateFormatted = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
          } else {
            dateFormatted = formatDateToDisplay(dateToUse);
          }
        } else {
          // Если даты замера нет, используем текущую дату
          const today = new Date();
          dateFormatted = `${today.getDate().toString().padStart(2, '0')}.${(today.getMonth() + 1).toString().padStart(2, '0')}.${today.getFullYear()}`;
        }

        return `${rvsNameSanitized}_${subNameSanitized}_${dateFormatted}.xlsx`;
      }

      function exportLinesToExcel(lines, filename, sheetName = 'Данные') {
        const aoa = lines.map(line => (line === '' ? [''] : line.split(';')));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, filename);
      }

      // ==========================================
      // === МОДУЛЬ: ОТМЕТКА КОЛЬЦЕВОГО ФУНДАМЕНТА ===
      // ==========================================

      const rvsDiameterInput = document.getElementById('rvs-diameter');
      const pointCountInput = document.getElementById('point-count');
      const pointInputsContainer = document.getElementById('point-inputs-container');
      const elevationUnitRadios = document.querySelectorAll('input[name="elevationUnit"]');
      const annularDateInput = document.getElementById('annular-date');

      function saveAnnularElevationData() {
        let project = getActiveProject();
        if (!project.data) project.data = {};
        if (!project.data.annularElevationData) project.data.annularElevationData = {};
        const data = project.data.annularElevationData;

        data.date = annularDateInput.value;
        data.diameter = rvsDiameterInput.value;
        data.unit = document.querySelector('input[name="elevationUnit"]:checked').value;
        data.count = pointCountInput.value;
        data.points = Array.from(document.querySelectorAll('.point-value-elevation')).map(i => i.value);

        saveActiveProject(project);
      }

      function loadAnnularElevationData() {
        const project = getActiveProject();
        const data = project.data.annularElevationData || {};

        annularDateInput.value = data.date || '';
        rvsDiameterInput.value = data.diameter || '';
        pointCountInput.value = data.count || '';
        currentUnit = data.unit || 'm';
        const rb = document.querySelector(`input[name="elevationUnit"][value="${currentUnit}"]`);
        if (rb) rb.checked = true;

        if (data.count && data.points) {
          generateElevationInputs(parseInt(data.count), data.points);
        } else {
          pointInputsContainer.innerHTML = '';
        }
      }

      function prepareAnnularElevationScreen() {
        loadAnnularElevationData();
        document.getElementById('results-table-container').innerHTML = '';
        document.getElementById('export-csv-button').style.display = 'none';
      }

      function generateElevationInputs(count, values = []) {
        pointInputsContainer.innerHTML = '';
        const placeholder = currentUnit === 'm' ? 'м' : 'мм';
        for (let i = 0; i < count; i++) {
          const inputGroup = document.createElement('div');
          inputGroup.className = 'form-group styled-input-wrapper';
          inputGroup.innerHTML = `<label>Точка ${i + 1}:</label><input type="tel" class="point-value-elevation" step="${currentUnit === 'm' ? '0.001' : '1'}" value="${values[i] || ''}" placeholder="${placeholder}">`;
          inputGroup.querySelector('input').oninput = saveAnnularElevationData;
          pointInputsContainer.appendChild(inputGroup);
        }
      }

      document.getElementById('generate-points-button').onclick = () => {
        const count = parseInt(pointCountInput.value);
        if (count < 2 || isNaN(count)) {
          alert("Введите корректное количество точек (минимум 2).");
          return;
        }
        generateElevationInputs(count);
        saveAnnularElevationData();
      };

      elevationUnitRadios.forEach(r => r.onchange = () => {
        currentUnit = document.querySelector('input[name="elevationUnit"]:checked').value;
        const placeholder = currentUnit === 'm' ? 'м' : 'мм';
        document.querySelectorAll('.point-value-elevation').forEach(i => {
          i.placeholder = placeholder;
          i.step = currentUnit === 'm' ? '0.001' : '1';
        });
        saveAnnularElevationData();
      });

      document.getElementById('calculate-button').onclick = () => {
        saveAnnularElevationData();

        const RVS_D = parseFloat(rvsDiameterInput.value);
        const inputs = Array.from(document.querySelectorAll('.point-value-elevation')).map(i => parseFloat(i.value));
        const filteredInputs = inputs.filter(n => !isNaN(n));
        const count = filteredInputs.length;

        if (isNaN(RVS_D) || count < 2) {
          alert("Проверьте, что указан диаметр РВС и введены отметки минимум двух точек.");
          return;
        }

        const pointsMM = filteredInputs.map(v => unitToMM(v, currentUnit));

        const minElevation = Math.min(...pointsMM);
        const maxElevation = Math.max(...pointsMM);
        const maxDiff = maxElevation - minElevation;

        let allOk = true;
        let html = '<h3>Результаты</h3>';

        // Определяем заголовки в зависимости от единиц измерения
        const elevationUnitLabel = currentUnit === 'm' ? ' (м)' : ' (мм)';
        html += `<table><thead><tr><th>Точка</th><th>Отметка${elevationUnitLabel}</th><th>Сравн. со смежн. (мм)</th><th>Откл. от Мин. (мм)</th></tr></thead><tbody>`;

        const diameterM = RVS_D / 1000;
        let maxToleranceAdjacent = 0;
        let maxToleranceTotal = 0;

        if (diameterM <= 12) {
          maxToleranceAdjacent = 6;
          maxToleranceTotal = 12;
        } else if (diameterM <= 40) {
          maxToleranceAdjacent = 8;
          maxToleranceTotal = 12;
        } else if (diameterM <= 95) {
          maxToleranceAdjacent = 8;
          maxToleranceTotal = 24;
        } else {
          maxToleranceAdjacent = 8;
          maxToleranceTotal = 24;
          html += `<p style="color:var(--warning-orange);">Внимание: Диаметр > 95 м. Применены допуски для D=95 м.</p>`;
        }

        for (let i = 0; i < count; i++) {
          const currentMM = pointsMM[i];
          const prevMM = (i > 0) ? pointsMM[i - 1] : pointsMM[count - 1];

          // 1. Считаем разницу
          const rawDiffAdj = currentMM - prevMM;
          const rawDiffMin = currentMM - minElevation;

          // 2. Определяем, есть ли недопуск (расчет ведем математически)
          const absDiffAdjacent = Math.abs(rawDiffAdj);
          const adjacentOk = absDiffAdjacent <= maxToleranceAdjacent;
          const totalOk = rawDiffMin <= maxToleranceTotal;

          const isDiffAdjacentOut = !adjacentOk;
          const isDiffFromMinOut = !totalOk;

          const rowClass = (isDiffAdjacentOut || isDiffFromMinOut) ? 'out-of-tolerance' : '';
          if (rowClass !== '') allOk = false;

          // 3. ФОРМАТИРОВАНИЕ ДЛЯ ОТОБРАЖЕНИЯ (Убираем нули)
          
          // А) Основное значение (Отметка)
          let displayValue;
          if (currentUnit === 'm') {
              // В метрах всегда 3 знака (0.100)
              displayValue = mmToUnit(currentMM, 'm').toFixed(3);
          } else {
              // В мм убираем лишний ноль: 15.0 -> 15
              displayValue = parseFloat(currentMM.toFixed(1));
          }

          // Б) Разница со смежным (ВСЕГДА в мм) -> убираем ноль
          // parseFloat превращает строку "5.0" в число 5
          const diffAdjClean = parseFloat(rawDiffAdj.toFixed(1)); 
          
          // В) Отклонение от мин (ВСЕГДА в мм) -> убираем ноль
          const diffMinClean = parseFloat(rawDiffMin.toFixed(1));

          // Г) Собираем HTML с проверкой на звездочки
          const diffAdjacentDisplay = isDiffAdjacentOut 
              ? `<span class="out-of-tolerance-val">${diffAdjClean}*</span>` 
              : diffAdjClean;
              
          const diffFromMinDisplay = isDiffFromMinOut 
              ? `<span class="out-of-tolerance-val">${diffMinClean}*</span>` 
              : diffMinClean;

          html += `
              <tr class="${rowClass}">
                  <td>${i + 1}</td>
                  <td>${displayValue}</td>
                  <td>${diffAdjacentDisplay}</td>
                  <td>${diffFromMinDisplay}</td>
              </tr>
          `;
        }

        html += `</tbody></table>`;

        html += `<div class="tolerance-note" style="margin-top: 20px; background-color: #f0f5fa; border-color: var(--primary-blue);">
                    <strong>Допуски:</strong><br>
                    - Разность отметок смежных точек <strong>(не более 6 м)</strong>: **&plusmn;${maxToleranceAdjacent} мм**.<br>
                    - Разность отметок любых других точек (Макс. перепад): **${maxToleranceTotal} мм** (относительно минимальной отметки).<br>
                    <span class="out-of-tolerance-val" style="font-weight: bold; font-size: 0.9em;">* - Отклонение от допуска.</span>
                </div>`;

        const overallStatus = allOk && (maxDiff <= maxToleranceTotal);
        html += `<div class="tolerance-summary ${overallStatus ? 'ok' : 'error'}">ОБЩИЙ СТАТУС: ${overallStatus ? 'ОК' : 'ЕСТЬ ОТКЛОНЕНИЯ'}</div>`;

        document.getElementById('results-table-container').innerHTML = html;
        document.getElementById('export-csv-button').style.display = 'block';
        saveCompletionState('annularElevation', overallStatus);
      };

      function exportAnnularElevationToCSV(submoduleId) {
        const proj = getActiveProject();
        const data = proj.data.annularElevationData || {};

        const measurementDate = data.date || proj.date;
        const RVS_D = parseFloat(data.diameter);
        const inputs = data.points.map(v => parseFloat(v));
        const filteredInputs = inputs.filter(n => !isNaN(n));
        const count = filteredInputs.length;
        const currentUnit = data.unit;

        if (isNaN(RVS_D) || count < 2) {
          return alert("Ошибка экспорта: Отсутствуют входные данные.");
        }

        // --- 1. ОБНОВЛЕННАЯ ФУНКЦИЯ ФОРМАТИРОВАНИЯ ---
        // Теперь принимает второй аргумент isFixed3 (нужно ли строго 3 знака)
        const formatForExcel = (val, isFixed3) => {
            if (typeof val !== 'number') return val;
            
            let s;
            if (isFixed3) {
                // Если МЕТРЫ: оставляем строго 3 знака (100.120)
                s = val.toFixed(3);
            } else {
                // Если ММ: убираем лишние нули (15.0 -> 15, 15.5 -> 15.5)
                s = parseFloat(val.toFixed(1)).toString();
            }
            
            // Меняем точку на запятую для Excel
            return s.replace('.', ',');
        };
        // --------------------------------------------------

        const pointsMM = filteredInputs.map(v => unitToMM(v, currentUnit));
        const minElevation = Math.min(...pointsMM);

        let maxToleranceAdjacent = 0;
        let maxToleranceTotal = 0;

        const diameterM = RVS_D / 1000;
        if (diameterM <= 12) {
          maxToleranceAdjacent = 6;
          maxToleranceTotal = 12;
        } else if (diameterM <= 40) {
          maxToleranceAdjacent = 8;
          maxToleranceTotal = 12;
        } else if (diameterM <= 95) {
          maxToleranceAdjacent = 8;
          maxToleranceTotal = 24;
        } else {
          maxToleranceAdjacent = 8;
          maxToleranceTotal = 24;
        }

        let csv = [];
        const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;

        csv.push(`РВС;${proj.name}`);
        csv.push(`Подмодуль;${subName}`);
        csv.push(`Дата замера;${formatDateToDisplay(measurementDate)}`);
        csv.push("");

        const unitLabel = currentUnit === 'm' ? ' (м)' : ' (мм)';
        csv.push(`Точка;Отметка${unitLabel};Сравн. со смежн. (мм);Откл. от Мин. (мм)`);

        // --- 2. ОБНОВЛЕННЫЙ ЦИКЛ ---
        for (let i = 0; i < count; i++) {
          const currentMM = pointsMM[i];
          const prevMM = (i > 0) ? pointsMM[i - 1] : pointsMM[count - 1];

          const diffFromMin = currentMM - minElevation;
          const diffAdjacent = currentMM - prevMM;
          const absDiffAdjacent = Math.abs(diffAdjacent);

          const adjacentOk = absDiffAdjacent <= maxToleranceAdjacent;
          const totalOk = diffFromMin <= maxToleranceTotal;

          // Определяем значение для записи (в м или мм)
          let currentValue = (currentUnit === 'm') ? mmToUnit(currentMM, 'm') : currentMM;
          
          // ФОРМАТИРОВАНИЕ:
          // 1. Отметка: если метры -> true (будет 3 знака), если мм -> false (без нулей)
          const valExcel = formatForExcel(currentValue, currentUnit === 'm');
          
          // 2. Разницы (всегда в мм) -> false (без нулей)
          const adjExcel = formatForExcel(diffAdjacent, false);
          const minExcel = formatForExcel(diffFromMin, false);

          const diffAdjacentCSV = adjacentOk ? adjExcel : `${adjExcel}*`;
          const diffFromMinCSV = totalOk ? minExcel : `${minExcel}*`;

          csv.push(`${i + 1};${valExcel};${diffAdjacentCSV};${diffFromMinCSV}`);
        }
        // ----------------------------

        csv.push("");
        csv.push(`Примечания:`);
        csv.push(`Разность отметок смежных точек;+/-${maxToleranceAdjacent} мм`);
        csv.push(`Разность отметок любых других точек (Макс. перепад);${maxToleranceTotal} мм`);
        csv.push(`* - Отклонение от допуска`);
        csv.push(`Отметки поверхности фундамента, определяемые в зоне расположения стенки`);
        csv.push(`ГОСТ 31385-2023 таб. 17`);

        exportLinesToExcel(csv, generateExportFilename(submoduleId, measurementDate), subName);

        saveCompletionState('annularElevation', true);
        renderFundamentModuleList(getActiveProject());
      }

      document.getElementById('export-csv-button').onclick = () => {
        exportAnnularElevationToCSV('annularElevation');
      };

      // ==========================================
      // === МОДУЛЬ: ШИРИНА КОЛЬЦЕВОГО ФУНДАМЕНТА ===
      // ==========================================

      const projectedWidthInput = document.getElementById('projected-width');
      const widthPointCountInput = document.getElementById('point-count-width');
      const widthPointInputsContainer = document.getElementById('width-point-inputs-container');
      const annularWidthDateInput = document.getElementById('annular-width-date');

      function saveAnnularWidthData() {
        let project = getActiveProject();
        if (!project.data) project.data = {};
        if (!project.data.annularWidthData) project.data.annularWidthData = {};
        const data = project.data.annularWidthData;

        data.date = annularWidthDateInput.value;
        data.projectedWidth = projectedWidthInput.value;
        data.count = widthPointCountInput.value;
        data.points = Array.from(document.querySelectorAll('.point-value-width')).map(i => i.value);

        saveActiveProject(project);
      }

      function loadAnnularWidthData() {
        const project = getActiveProject();
        const data = project.data.annularWidthData || {};

        annularWidthDateInput.value = data.date || '';
        projectedWidthInput.value = data.projectedWidth || '';
        widthPointCountInput.value = data.count || '';

        if (data.count && data.points) {
          generateWidthInputs(parseInt(data.count), data.points);
        } else {
          widthPointInputsContainer.innerHTML = '';
        }
      }

      function prepareAnnularWidthScreen() {
        loadAnnularWidthData();
        document.getElementById('width-results-table-container').innerHTML = '';
        document.getElementById('export-width-csv-button').style.display = 'none';
      }

      function generateWidthInputs(count, values = []) {
        widthPointInputsContainer.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const inputGroup = document.createElement('div');
          inputGroup.className = 'form-group styled-input-wrapper';
          inputGroup.innerHTML = `<label>Точка ${i + 1} (мм):</label><input type="tel" class="point-value-width" step="1" value="${values[i] || ''}" placeholder="Ширина">`;
          inputGroup.querySelector('input').oninput = saveAnnularWidthData;
          widthPointInputsContainer.appendChild(inputGroup);
        }
      }

      document.getElementById('generate-width-points-button').onclick = () => {
        const count = parseInt(widthPointCountInput.value);
        if (count < 2 || isNaN(count)) {
          alert("Введите корректное количество точек (минимум 2).");
          return;
        }
        generateWidthInputs(count);
        saveAnnularWidthData();
      };

      document.getElementById('calculate-width-button').onclick = () => {
        saveAnnularWidthData();

        const projectedW = parseFloat(projectedWidthInput.value);
        const inputs = Array.from(document.querySelectorAll('.point-value-width')).map(i => parseFloat(i.value));
        const actualWidths = inputs.filter(n => !isNaN(n));

        if (actualWidths.length === 0) {
          alert("Введите фактические замеры ширины.");
          return;
        }

        const hasProjected = !isNaN(projectedW);
        const maxTolerance = 50;
        let allOk = true;

        let html = '<h3>Результаты проверки ширины' + (hasProjected ? ' (Допуск: 0, +50 мм)' : '') + '</h3>';

        if (hasProjected) {
          html += '<table><thead><tr><th>Точка</th><th>Проект (мм)</th><th>Факт (мм)</th><th>Отклонение (мм)</th></tr></thead><tbody>';
        } else {
          html += '<table><thead><tr><th>Точка</th><th>Факт (мм)</th></tr></thead><tbody>';
        }

        actualWidths.forEach((actualW, index) => {
          if (hasProjected) {
            const deviation = actualW - projectedW;
            const deviationDisplay = Number(deviation);
            const isOk = (deviation >= 0) && (deviation <= maxTolerance);

            if (!isOk) allOk = false;

            const deviationHtml = isOk ?
              deviationDisplay :
              `<span class="out-of-tolerance-val">${deviationDisplay}*</span>`;

            html += `
                            <tr class="${isOk ? 'ok' : 'out-of-tolerance'}">
                                <td>${index + 1}</td>
                                <td>${Number(projectedW)}</td>
                                <td>${Number(actualW)}</td>
                                <td>${deviationHtml}</td>
                            </tr>
                        `;
          } else {
            html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${actualW.toFixed(1)}</td>
                            </tr>
                        `;
          }
        });

        html += `</tbody></table>`;

        if (hasProjected) {
          html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ОБЩИЙ СТАТУС: ${allOk ? 'ОК' : 'ЕСТЬ ОТКЛОНЕНИЯ'}</div>`;
          saveCompletionState('annularWidth', allOk);
        }

        document.getElementById('width-results-table-container').innerHTML = html;
        document.getElementById('export-width-csv-button').style.display = 'block';
      };

      function exportAnnularWidthToCSV(submoduleId) {
  const proj = getActiveProject();
  const data = proj.data.annularWidthData || {};

  const measurementDate = data.date || proj.date;
  const projectedW = parseFloat(data.projectedWidth);
  const inputs = data.points.map(v => parseFloat(v));
  const actualWidths = inputs.filter(n => !isNaN(n));

  if (actualWidths.length === 0) {
    return alert("Ошибка экспорта: Отсутствуют входные данные.");
  }

  const maxTolerance = 50;
  let allOk = true;
  let csv = [];
  const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;

  csv.push(`РВС;${proj.name}`);
  csv.push(`Подмодуль;${subName}`);
  csv.push(`Дата замера;${formatDateToDisplay(measurementDate)}`);
  csv.push("");

  if (!isNaN(projectedW)) {
    csv.push("Точка;Проект (мм);Факт (мм);Отклонение (мм)");

    actualWidths.forEach((actualW, index) => {
      const deviation = actualW - projectedW;
      
      // Обертка Number() убирает .0, но оставляет .5 как есть
      const cleanProjected = Number(projectedW);
      const cleanActual = Number(actualW);
      const cleanDeviation = Number(deviation);

      const isOk = (deviation >= 0) && (deviation <= maxTolerance);
      if (!isOk) allOk = false;

      const deviationCSV = isOk ? cleanDeviation : `${cleanDeviation}*`;

      csv.push(`${index + 1};${cleanProjected};${cleanActual};${deviationCSV}`);
    });

    csv.push("");
    csv.push(`Примечания:`);
    csv.push(`Допуск;0, +${maxTolerance} мм`);
    csv.push(`* - Отклонение от допуска`);
  } else {
    csv.push("Точка;Факт (мм)");
    actualWidths.forEach((actualW, index) => {
      csv.push(`${index + 1};${Number(actualW)}`);
    });
  }
  
  csv.push(`Ширина фундамента через каждые 6 м`);
  csv.push(`ГОСТ 31385-2023 таб. 17`);

  exportLinesToExcel(csv, generateExportFilename(submoduleId, measurementDate), subName);
  saveCompletionState('annularWidth', true);
  renderFundamentModuleList(getActiveProject());
}

      document.getElementById('export-width-csv-button').onclick = () => {
        exportAnnularWidthToCSV('annularWidth');
      };

      // ==========================================
      // === МОДУЛЬ: НАРУЖНЫЙ ДИАМЕТР ФУНДАМЕНТА ===
      // ==========================================

      const rvsDiameterAnnularInput = document.getElementById('rvs-diameter-annular');
      const projectedFundamentDiameterAnnularInput = document.getElementById('projected-fundament-diameter-annular');
      const diameterInputsContainer = document.getElementById('diameter-point-inputs-container');
      const diameterToleranceNote = document.getElementById('diameter-tolerance-note');
      const annularDiameterDateInput = document.getElementById('annular-diameter-date');

      function calculateDiameterTolerance(D_RVS) {
        const D_RVS_m = D_RVS / 1000;
        if (D_RVS_m <= 12) return { plus: 20, minus: 20 };
        if (D_RVS_m <= 25) return { plus: 20, minus: 20 };
        if (D_RVS_m <= 40) return { plus: 30, minus: 20 };
        if (D_RVS_m <= 65) return { plus: 40, minus: 30 };
        if (D_RVS_m <= 95) return { plus: 50, minus: 30 };
        return { plus: 50, minus: 30 };
      }

      function updateDiameterToleranceNote() {
        const D_RVS = parseFloat(rvsDiameterAnnularInput.value);

        if (isNaN(D_RVS)) {
          diameterToleranceNote.style.display = 'none';
          return;
        }

        const tolerance = calculateDiameterTolerance(D_RVS);

        diameterToleranceNote.innerHTML = `
                    <strong>Наружный диаметр фундамента, четыре измерения на ортогональных осях:</strong><br>
                    Допуск для диаметра ${D_RVS} мм (${Number(D_RVS / 1000)} м): <strong>+${tolerance.plus}; -${tolerance.minus} мм</strong><br><br>
                    <strong>Примечание:</strong><br>
                    - наружный диаметр фундамента измерять в четырёх положениях по осям I-III, II-IV и под углом 45 градусов относительно осей; ГОСТ 31385-2023 таб. 17.
                `;
        diameterToleranceNote.style.display = 'block';
      }

      rvsDiameterAnnularInput.oninput = updateDiameterToleranceNote;
      projectedFundamentDiameterAnnularInput.oninput = updateDiameterToleranceNote;

      function saveAnnularDiameterData() {
        let project = getActiveProject();
        if (!project.data) project.data = {};
        if (!project.data.annularDiameterData) project.data.annularDiameterData = {};
        const data = project.data.annularDiameterData;

        data.date = annularDiameterDateInput.value;
        data.rvsDiameter = rvsDiameterAnnularInput.value;
        data.projectedFundamentDiameter = projectedFundamentDiameterAnnularInput.value;
        data.radii = Array.from(document.querySelectorAll('.point-value-diameter')).map(i => i.value);

        saveActiveProject(project);
      }

      function loadAnnularDiameterData() {
        const project = getActiveProject();
        const data = project.data.annularDiameterData || {};

        annularDiameterDateInput.value = data.date || '';
        rvsDiameterAnnularInput.value = data.rvsDiameter || '';
        projectedFundamentDiameterAnnularInput.value = data.projectedFundamentDiameter || '';

        updateDiameterToleranceNote();

        diameterInputsContainer.innerHTML = '';
        // Создаем 8 точек с новыми названиями
        const pointNames = ['точка 1', 'точка 1/2', 'точка 2', 'точка 2/3', 'точка 3', 'точка 3/4', 'точка 4', 'точка 4/1'];
        for (let i = 0; i < 8; i++) {
          const inputGroup = document.createElement('div');
          inputGroup.className = 'form-group styled-input-wrapper';
          inputGroup.innerHTML = `<label>${pointNames[i]} (мм):</label><input type="tel" class="point-value-diameter" step="1" value="${data.radii ? data.radii[i] || '' : ''}" placeholder="Радиус">`;
          inputGroup.querySelector('input').oninput = saveAnnularDiameterData;
          diameterInputsContainer.appendChild(inputGroup);
        }
      }

      function prepareDiameterScreen() {
        loadAnnularDiameterData();
        document.getElementById('diameter-results-table-container').innerHTML = '';
        document.getElementById('export-diameter-csv-button').style.display = 'none';
      }

      document.getElementById('calculate-diameter-button').onclick = () => {
        saveAnnularDiameterData();

        const D_RVS = parseFloat(rvsDiameterAnnularInput.value);
        const D_PROJECTED = parseFloat(projectedFundamentDiameterAnnularInput.value);
        const inputs = Array.from(document.querySelectorAll('.point-value-diameter')).map(i => parseFloat(i.value));
        const radii = inputs.filter(n => !isNaN(n));

        if (radii.length !== 8) {
          alert("Введите замеры радиуса для всех 8 точек.");
          return;
        }

        const tolerance = calculateDiameterTolerance(D_RVS);
        const hasProjected = !isNaN(D_PROJECTED);
        let allOk = true;

        let html = '<h3>Результаты проверки наружного диаметра</h3>';
        if (!isNaN(D_RVS)) {
          html += `<p>Диаметр резервуара: <strong>${Number(D_RVS)} мм</strong></p>`;
        }
        if (hasProjected) {
          html += `<p>Проектный диаметр фундамента: <strong>${Number(D_PROJECTED)} мм</strong></p>`;
          html += `<p>Допуск на диаметр: <strong>+${tolerance.plus} мм; -${tolerance.minus} мм</strong></p>`;
        }

        // Рассчитываем диаметры по парам (сумма двух радиусов = диаметр)
        const diameters = [
          { name: '1+3 (ось I-III)', diameter: radii[0] + radii[4] }, // точка 1 + точка 3 = диаметр
          { name: '1/2+3/4 (45°)', diameter: radii[1] + radii[5] }, // точка 1/2 + точка 3/4 = диаметр
          { name: '2+4 (ось II-IV)', diameter: radii[2] + radii[6] }, // точка 2 + точка 4 = диаметр
          { name: '2/3+4/1 (45°)', diameter: radii[3] + radii[7] } // точка 2/3 + точка 4/1 = диаметр
        ];

        // ИСПРАВЛЕННАЯ ТАБЛИЦА: убрана колонка "Радиус (мм)"
        if (hasProjected) {
          html += '<table><thead><tr><th>Диаметр по оси</th><th>Диаметр факт (мм)</th><th>Отклонение (Факт - Проект), мм</th></tr></thead><tbody>';
        } else {
          html += '<table><thead><tr><th>Диаметр по оси</th><th>Диаметр факт (мм)</th></tr></thead><tbody>';
        }

        diameters.forEach((d) => {
          const D_ACTUAL = d.diameter;

          if (hasProjected) {
            const deviation = D_ACTUAL - D_PROJECTED;
            const deviationDisplay = Number(deviation);

            const isOk = (deviation <= tolerance.plus) && (deviation >= -tolerance.minus);
            if (!isOk) allOk = false;

            const deviationHtml = isOk ?
              deviationDisplay :
              `<span class="out-of-tolerance-val">${deviationDisplay}*</span>`;

            html += `
                            <tr class="${isOk ? 'ok' : 'out-of-tolerance'}">
                                <td>${d.name}</td>
                                <td>${Number(D_ACTUAL)}</td>
                                <td>${deviationHtml}</td>
                            </tr>
                        `;
          } else {
            html += `
                            <tr>
                                <td>${d.name}</td>
                                <td>${Number(D_ACTUAL)}</td>
                            </tr>
                        `;
          }
        });

        html += `</tbody></table>`;

        // Добавляем таблицу с исходными радиусами
        html += '<h4 style="margin-top: 20px;">Исходные значения радиусов (мм):</h4>';
        html += '<table><thead><tr><th>Точка</th><th>Радиус (мм)</th></tr></thead><tbody>';

        const pointNames = ['Точка 1', 'Точка 1/2', 'Точка 2', 'Точка 2/3', 'Точка 3', 'Точка 3/4', 'Точка 4', 'Точка 4/1'];
        pointNames.forEach((name, index) => {
          html += `
                        <tr>
                            <td>${name}</td>
                            <td>${Number(radii[index])}</td>
                        </tr>
                    `;
        });

        html += `</tbody></table>`;

        if (hasProjected) {
          html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ОБЩИЙ СТАТУС: ${allOk ? 'ОК' : 'ЕСТЬ ОТКЛОНЕНИЯ'}</div>`;
          saveCompletionState('annularDiameter', allOk);
        }

        document.getElementById('diameter-results-table-container').innerHTML = html;
        document.getElementById('export-diameter-csv-button').style.display = 'block';
      };

      function exportAnnularDiameterToCSV(submoduleId) {
        const proj = getActiveProject();
        const data = proj.data.annularDiameterData || {};

        const measurementDate = data.date || proj.date;
        const D_RVS = parseFloat(data.rvsDiameter);
        const D_PROJECTED = parseFloat(data.projectedFundamentDiameter);
        const inputs = data.radii.map(v => parseFloat(v));
        const radii = inputs.filter(n => !isNaN(n));

        if (radii.length !== 8) {
          return alert("Ошибка экспорта: Отсутствуют входные данные.");
        }

        const tolerance = calculateDiameterTolerance(D_RVS || 0);
        let allOk = true;

        let csv = [];
        const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;

        csv.push(`РВС;${proj.name}`);
        csv.push(`Подмодуль;${subName}`);
        // ТОЛЬКО дата замера (без даты проекта)
        csv.push(`Дата замера;${formatDateToDisplay(measurementDate)}`);
        csv.push("");

        // Таблица исходных радиусов
        csv.push(`Исходные радиусы (мм):`);
        const pointNames = ['Точка 1', 'Точка 1/2', 'Точка 2', 'Точка 2/3', 'Точка 3', 'Точка 3/4', 'Точка 4', 'Точка 4/1'];
        csv.push(`Точка;Радиус (мм)`);

        pointNames.forEach((name, index) => {
          csv.push(`${name};${Number(radii[index])}`);
        });

        csv.push("");

        // Таблица диаметров (сумма двух радиусов)
        csv.push(`Результаты измерений диаметров (сумма двух радиусов):`);
        csv.push(`Диаметр по оси;Радиус 1;Радиус 2;Диаметр факт (мм)${!isNaN(D_PROJECTED) ? ';Проектный диаметр (мм);Отклонение (Факт - Проект), мм;Статус' : ''}`);

        const diameters = [
          { name: '1+3 (ось I-III)', r1: radii[0], r2: radii[4], diameter: radii[0] + radii[4] },
          { name: '1/2+3/4 (45°)', r1: radii[1], r2: radii[5], diameter: radii[1] + radii[5] },
          { name: '2+4 (ось II-IV)', r1: radii[2], r2: radii[6], diameter: radii[2] + radii[6] },
          { name: '2/3+4/1 (45°)', r1: radii[3], r2: radii[7], diameter: radii[3] + radii[7] }
        ];

        diameters.forEach((d) => {
          if (!isNaN(D_PROJECTED)) {
            const deviation = d.diameter - D_PROJECTED;
            const deviationDisplay = Number(deviation);

            const isOk = (deviation <= tolerance.plus) && (deviation >= -tolerance.minus);
            if (!isOk) allOk = false;

            const status = isOk ? 'ОК' : 'НЕДОПУСК';
            const deviationCSV = isOk ? deviationDisplay : `${deviationDisplay}*`;

            csv.push(`${d.name};${Number(d.r1)};${Number(d.r2)};${Number(d.diameter)};${Number(D_PROJECTED)};${deviationCSV};${status}`);
          } else {
            csv.push(`${d.name};${Number(d.r1)};${Number(d.r2)};${Number(d.diameter)}`);
          }
        });

        csv.push("");
        csv.push(`Примечания:`);
        csv.push(`Проектный диаметр резервуара;${Number(D_RVS)} мм`);
        if (!isNaN(D_PROJECTED)) {
          csv.push(`Проектный диаметр фундамента;${Number(D_PROJECTED)} мм`);
          csv.push(`Допуск на диаметр;+${tolerance.plus} мм; -${tolerance.minus} мм`);
          csv.push(`* - Отклонение от допуска`);
        }
        csv.push(`Наружный диаметр фундамента измерять в четырёх положениях по осям I-III, II-IV и под углом 45 градусов относительно осей`);
        csv.push(`ГОСТ 31385-2023 таб. 17`);

        exportLinesToExcel(csv, generateExportFilename(submoduleId, measurementDate), subName);

        // Помечаем подмодуль выполненным сразу после экспорта, чтобы вкладка подсветилась зелёным
        saveCompletionState('annularDiameter', true);
        renderFundamentModuleList(getActiveProject());
      }

      document.getElementById('export-diameter-csv-button').onclick = () => {
        exportAnnularDiameterToCSV('annularDiameter');
      };

      // ==========================================
      // === МОДУЛЬ: ПОВЕРХНОСТЬ ГИДРОИЗОЛА ===
      // ==========================================

      const hydroizolCountInput = document.getElementById('point-count-hydroizol');
      const hydroizolContainer = document.getElementById('hydroizol-point-inputs-container');
      const hydroizolUnitRadios = document.querySelectorAll('input[name="hydroizolElevationUnit"]');
      const hydroizolHistoryPanel = document.getElementById('hydroizol-history-panel');
      const saveHydroizolHistoryBtn = document.getElementById('save-hydroizol-history-btn');
      const compareHydroizolHistoryBtn = document.getElementById('compare-hydroizol-history-btn');
      const historyStatusMsg = document.getElementById('history-status-msg');
      const hydroizolElevationDateInput = document.getElementById('hydroizol-elevation-date');

      function saveHydroizolElevationData() {
        let project = getActiveProject();
        if (!project.data) project.data = {};
        if (!project.data.hydroizolElevationData) project.data.hydroizolElevationData = {};
        const data = project.data.hydroizolElevationData;

        data.date = hydroizolElevationDateInput.value;
        data.unit = document.querySelector('input[name="hydroizolElevationUnit"]:checked').value;
        data.count = hydroizolCountInput.value;
        data.points = Array.from(document.querySelectorAll('.point-value-hydroizol')).map(i => i.value);

        saveActiveProject(project);
        updateHydroizolHistoryUI();
      }

      function loadHydroizolElevationData() {
        const project = getActiveProject();
        const data = project.data.hydroizolElevationData || {};

        hydroizolElevationDateInput.value = data.date || '';
        hydroizolCountInput.value = data.count || '';
        hydroizolCurrentUnit = data.unit || 'm';
        const rb = document.querySelector(`input[name="hydroizolElevationUnit"][value="${hydroizolCurrentUnit}"]`);
        if (rb) rb.checked = true;

        if (data.count && data.points) {
          generateHydroizolInputs(parseInt(data.count), data.points);
        } else {
          hydroizolContainer.innerHTML = '';
        }
        updateHydroizolHistoryUI();
      }

      function generateHydroizolInputs(count, values = []) {
        hydroizolContainer.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const inputGroup = document.createElement('div');
          inputGroup.className = 'form-group styled-input-wrapper';
          const formattedValue = values[i] !== undefined && values[i] !== '' ?
            formatNumber(parseFloat(values[i]), hydroizolCurrentUnit) :
            '';
          inputGroup.innerHTML = `<label>Точка ${i + 1}:</label><input type="tel" class="point-value-hydroizol" step="${hydroizolCurrentUnit === 'mm' ? '1' : '0.001'}" value="${formattedValue}" placeholder="${hydroizolCurrentUnit === 'm' ? 'м' : 'мм'}">`;
          const inputEl = inputGroup.querySelector('input');

// Форматирование ТОЛЬКО для метров
inputEl.onblur = () => {
  if (hydroizolCurrentUnit === 'm' && inputEl.value !== '') {
    let val = parseFloat(inputEl.value.replace(',', '.').trim());
    if (!isNaN(val)) {
      inputEl.value = val.toFixed(3);
    }
  }
  saveHydroizolElevationData();
};

// Просто сохранение при вводе
inputEl.oninput = saveHydroizolElevationData;
          hydroizolContainer.appendChild(inputGroup);
        }

        // Показываем панель истории только если есть введенные точки
        if (count > 0) {
          hydroizolHistoryPanel.classList.remove('hidden');
        } else {
          hydroizolHistoryPanel.classList.add('hidden');
        }
      }

      function updateHydroizolHistoryUI() {
        const project = getActiveProject();
        const data = project.data.hydroizolElevationData || {};

        const hasBaseline = data.baselinePoints && data.baselinePoints.length > 0;

        if (hasBaseline) {
          compareHydroizolHistoryBtn.style.display = 'block';
          if (hydroizolComparisonMode) {
            historyStatusMsg.textContent = `⚠️ Режим сравнения с эталоном ВКЛЮЧЕН (эталон от ${data.baselineDate || '—'}).`;
            compareHydroizolHistoryBtn.textContent = '🔴 Отменить сравнение';
          } else {
            historyStatusMsg.textContent = `⚠️ Доступно сравнение с эталоном от ${data.baselineDate || '—'}.`;
            compareHydroizolHistoryBtn.textContent = '⚖️ Сравнить с эталоном';
          }
          saveHydroizolHistoryBtn.textContent = '🔄 Обновить эталон';
        } else {
          compareHydroizolHistoryBtn.style.display = 'none';
          historyStatusMsg.textContent = '✅ Нет сохраненного эталона. Сохраните текущий замер.';
          saveHydroizolHistoryBtn.textContent = '💾 Сохранить как эталон (История)';
          hydroizolComparisonMode = false;
        }
      }

      function prepareHydroizolScreen() {
        loadHydroizolElevationData();
        document.getElementById('hydroizol-results-table-container').innerHTML = '';
        document.getElementById('export-hydroizol-csv-button').style.display = 'none';
        if (!hydroizolCountInput.value) hydroizolHistoryPanel.classList.add('hidden');

        // Сбрасываем режим сравнения при входе в экран
        hydroizolComparisonMode = false;
      }

      document.getElementById('generate-hydroizol-points-button').onclick = () => {
        const count = parseInt(hydroizolCountInput.value);
        if (count < 2 || isNaN(count)) {
          alert("Введите корректное количество точек (минимум 2).");
          return;
        }
        generateHydroizolInputs(count);
        saveHydroizolElevationData();
      };

      hydroizolUnitRadios.forEach(r => r.onchange = () => {
        hydroizolCurrentUnit = document.querySelector('input[name="hydroizolElevationUnit"]:checked').value;
        document.querySelectorAll('.point-value-hydroizol').forEach(input => {
          input.step = hydroizolCurrentUnit === 'mm' ? '1' : '0.001';
          input.placeholder = hydroizolCurrentUnit === 'm' ? 'м' : 'мм';
        });
        saveHydroizolElevationData();
      });

      saveHydroizolHistoryBtn.onclick = () => {
        saveHydroizolElevationData();

        const proj = getActiveProject();
        const data = proj.data.hydroizolElevationData;
        const points = Array.from(document.querySelectorAll('.point-value-hydroizol')).map(i => i.value);
        const filteredPoints = points.filter(v => v !== '');

        if (filteredPoints.length === 0) {
          return alert('Сначала введите замеры для сохранения эталона.');
        }

        data.baselinePoints = points;
        data.baselineDate = new Date().toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        data.baselineUnit = data.unit;
        saveActiveProject(proj);
        alert('Текущий замер сохранен как эталон.');

        // Выключаем режим сравнения при сохранении нового эталона
        hydroizolComparisonMode = false;
        updateHydroizolHistoryUI();

        // Пересчитываем результаты если они есть
        const resultsContainer = document.getElementById('hydroizol-results-table-container');
        if (resultsContainer.innerHTML !== '') {
          document.getElementById('calculate-hydroizol-button').click();
        }
      };

      compareHydroizolHistoryBtn.onclick = () => {
        const proj = getActiveProject();
        const data = proj.data.hydroizolElevationData || {};
        const hasBaseline = data.baselinePoints && data.baselinePoints.length > 0;

        if (!hasBaseline) {
          alert('Сначала сохраните эталон для сравнения.');
          return;
        }

        hydroizolComparisonMode = !hydroizolComparisonMode;
        updateHydroizolHistoryUI();

        // Пересчитываем результаты если они есть
        const resultsContainer = document.getElementById('hydroizol-results-table-container');
        if (resultsContainer.innerHTML !== '') {
          document.getElementById('calculate-hydroizol-button').click();
        }
      };

      document.getElementById('calculate-hydroizol-button').onclick = () => {
        saveHydroizolElevationData();

        const inputs = Array.from(document.querySelectorAll('.point-value-hydroizol')).map(i => parseFloat(i.value));
        const filteredInputs = inputs.filter(n => !isNaN(n));
        const count = filteredInputs.length;
        const project = getActiveProject();
        const data = project.data.hydroizolElevationData || {};

        if (count < 2) {
          alert("Введите отметки минимум двух точек.");
          return;
        }

        const pointsMM = filteredInputs.map(v => unitToMM(v, hydroizolCurrentUnit));
        let allOk = true;
        let html = '<h3>Результаты проверки поверхности гидроизола</h3>';

        const minElevation = Math.min(...pointsMM);
        const maxElevation = Math.max(...pointsMM);
        const maxDiff = maxElevation - minElevation;
        const maxToleranceAdjacent = 10;
        const maxToleranceTotal = 10;

        // Проверяем, есть ли сохраненные данные для эталона
        const baselinePoints = data.baselinePoints || [];
        const baselineUnit = data.baselineUnit || 'm';
        const hasBaselineData = baselinePoints.length > 0;

        // ВСЕГДА показываем первую таблицу с результатами проверки допусков
        html += '<h4>Проверка допусков:</h4>';

        const unitLabel = hydroizolCurrentUnit === 'm' ? ' (м)' : ' (мм)';
        html += `<table><thead><tr><th>Точка</th><th>Отметка${unitLabel}</th><th>Разница со смежной (мм)</th><th>Отклонение от минимальной (мм)</th></tr></thead><tbody>`;

        for (let i = 0; i < count; i++) {
          const currentMM = pointsMM[i];
          const prevMM = (i > 0) ? pointsMM[i - 1] : pointsMM[count - 1];

          const diffFromMin = (currentMM - minElevation).toString();
          const diffAdjacent = (currentMM - prevMM).toString();
          const absDiffAdjacent = Math.abs(parseFloat(diffAdjacent));

          const adjacentOk = absDiffAdjacent <= maxToleranceAdjacent;
          const totalOk = parseFloat(diffFromMin) <= maxToleranceTotal;

          const rowStatus = (adjacentOk && totalOk) ? 'ok' : 'out-of-tolerance';
          if (rowStatus === 'out-of-tolerance') allOk = false;

          const diffFromMinDisplay = totalOk ? diffFromMin : `<span class="out-of-tolerance-val">${diffFromMin}*</span>`;
          const diffAdjacentDisplay = adjacentOk ? diffAdjacent : `<span class="out-of-tolerance-val">${diffAdjacent}*</span>`;

          // Отображаем значение в исходных единицах
          const displayValue = hydroizolCurrentUnit === 'm' 
    ? mmToUnit(currentMM, 'm').toFixed(3) 
    : currentMM.toString(); // Выводит число как есть без лишнего нуля

          html += `
                        <tr class="${rowStatus}">
                            <td>${i + 1}</td>
                            <td>${displayValue}</td>
                            <td>${diffAdjacentDisplay}</td>
                            <td>${diffFromMinDisplay}</td>
                        </tr>
                    `;
        }

        html += `</tbody></table>`; // Конец таблицы
html += `<div class="tolerance-note">Максимальный перепад (Max.Diff): **${maxDiff.toString()} мм** (Допуск: **${maxToleranceTotal} мм**)</div>`;
const overallStatus = allOk && (maxDiff <= maxToleranceTotal);
html += `<div class="tolerance-summary ${overallStatus ? 'ok' : 'error'}">ОБЩИЙ СТАТУС: ${overallStatus ? 'ОК' : 'ЕСТЬ ОТКЛОНЕНИЯ'}</div>`;
        // Если включен режим сравнения и есть данные эталона - показываем вторую таблицу сравнения
        if (hydroizolComparisonMode && hasBaselineData) {
          if (baselinePoints.length === filteredInputs.length) {
            html += `<h4 style="margin-top: 30px; color:#6f42c1;">Сравнение с эталоном от ${data.baselineDate || '—'}:</h4>`;
            html += '<table><thead><tr><th>Точка</th><th>Начальные измерения (мм)</th><th>Текущие измерения (мм)</th><th>Разница между измерениями (мм)</th></tr></thead><tbody>';

            // Преобразуем эталонные точки в мм для сравнения
            const baselinePointsMM = baselinePoints.map(v => {
              const num = parseFloat(v);
              return isNaN(num) ? 0 : unitToMM(num, baselineUnit);
            });

            for (let i = 0; i < count; i++) {
              const currentMM = pointsMM[i];
              const baselineMM = i < baselinePointsMM.length ? baselinePointsMM[i] : NaN;

              const baselineVal = !isNaN(baselineMM) ? formatNumber(baselineMM, 'mm') : '—';
              const currentVal = formatNumber(currentMM, 'mm');

              let diffDisplay = '—';

              if (!isNaN(baselineMM)) {
                const diff = currentMM - baselineMM;
                diffDisplay = diff.toString();
              }

              html += `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${baselineVal}</td>
                                    <td>${currentVal}</td>
                                    <td>${diffDisplay}</td>
                                </tr>
                            `;
            }

            html += `</tbody></table>`;
          } else {
            html += `<div class="tolerance-note" style="border-color: var(--warning-orange); background-color: #fff8e1;">
                            <strong>Внимание:</strong> Количество точек в эталоне (${baselinePoints.length}) не совпадает с текущим количеством точек (${filteredInputs.length}). Сравнение невозможно.
                        </div>`;
          }
        } else if (hydroizolComparisonMode && !hasBaselineData) {
          html += `<div class="tolerance-note" style="border-color: var(--warning-orange); background-color: #fff8e1;">
                        <strong>Внимание:</strong> Режим сравнения включен, но нет сохраненного эталона. Сохраните текущий замер как эталон для сравнения.
                    </div>`;
        }

        document.getElementById('hydroizol-results-table-container').innerHTML = html;
        document.getElementById('export-hydroizol-csv-button').style.display = 'block';
        saveCompletionState('hydroizolElevation', overallStatus);
      };

      function exportHydroizolElevationToCSV(submoduleId) {
        const proj = getActiveProject();
        const data = proj.data.hydroizolElevationData || {};

        const measurementDate = data.date || proj.date;
        const inputs = data.points ? data.points.map(v => parseFloat(v)) : [];
        const filteredInputs = inputs.filter(n => !isNaN(n));
        const count = filteredInputs.length;
        const currentUnit = data.unit || 'm';

        const unitLabel = currentUnit === 'm' ? ' (м)' : ' (мм)';

        if (count < 2) {
          return alert("Ошибка экспорта: Отсутствуют входные данные.");
        }

        const pointsMM = filteredInputs.map(v => unitToMM(v, currentUnit));
        const minElevation = Math.min(...pointsMM);
        const maxToleranceAdjacent = 10;
        const maxToleranceTotal = 10;
        let allOk = true;

        let csv = [];
        const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;

        csv.push(`РВС;${proj.name}`);
        csv.push(`Подмодуль;${subName}`);
        // ТОЛЬКО дата замера (без даты проекта)
        csv.push(`Дата замера;${formatDateToDisplay(measurementDate)}`);
        csv.push(`Единица измерения;${currentUnit === 'm' ? 'метры' : 'миллиметры'}`);
        csv.push("");

        // Экспортируем только первую таблицу (4 колонки)
        csv.push(`Точка;Отметка${unitLabel};Разница со смежной (мм);Отклонение от минимальной (мм)`);

        for (let i = 0; i < count; i++) {
          const currentMM = pointsMM[i];
          const prevMM = (i > 0) ? pointsMM[i - 1] : pointsMM[count - 1];

          const diffFromMin = currentMM - minElevation;
          const diffAdjacent = currentMM - prevMM;
          const absDiffAdjacent = Math.abs(diffAdjacent);

          const adjacentOk = absDiffAdjacent <= maxToleranceAdjacent;
          const totalOk = diffFromMin <= maxToleranceTotal;

          const diffAdjacentStr = diffAdjacent.toString().replace('.', ',');
const diffFromMinStr = diffFromMin.toString().replace('.', ',');

let currentValue = '';
if (currentUnit === 'm') {
    // Метры: всегда 3 знака, точка заменяется на запятую
    currentValue = mmToUnit(currentMM, 'm').toFixed(3).replace('.', ',');
} else {
    // Миллиметры: как есть (без лишних нулей), точка на запятую
    currentValue = currentMM.toString().replace('.', ',');
}

          const diffAdjacentCSV = adjacentOk ? diffAdjacentStr : `${diffAdjacentStr}*`;
          const diffFromMinCSV = totalOk ? diffFromMinStr : `${diffFromMinStr}*`;

          if (!(adjacentOk && totalOk)) allOk = false;

          csv.push(`${i + 1};${currentValue};${diffAdjacentCSV};${diffFromMinCSV}`);
        }

        csv.push("");
        csv.push(`Примечания:`);
        csv.push(`Разность отметок смежных точек;+/-${maxToleranceAdjacent} мм`);
        csv.push(`Разность отметок любых других точек (Макс. перепад);${maxToleranceTotal} мм`);
        csv.push(`* - Отклонение от допуска`);
        csv.push(`ГОСТ 31385-2023 Г.3.4 Толщина гидроизолирующего слоя под центральной частью днища — (50 ± 10) мм, под окрайкой днища — (20 ± 5) мм`);

        exportLinesToExcel(csv, generateExportFilename(submoduleId, measurementDate), subName);

        saveCompletionState('hydroizolElevation', true);
        renderFundamentModuleList(getActiveProject());
      }

      document.getElementById('export-hydroizol-csv-button').onclick = () => {
        exportHydroizolElevationToCSV('hydroizolElevation');
      };

      // ==========================================
      // === МОДУЛЬ: ТОЛЩИНА ГИДРОИЗОЛА ===
      // ==========================================

      const thicknessCountInput = document.getElementById('point-count-thickness');
      const thicknessContainer = document.getElementById('thickness-point-inputs-container');
      const hydroizolThicknessDateInput = document.getElementById('hydroizol-thickness-date');

      function saveHydroizolThicknessData() {
        let project = getActiveProject();
        if (!project.data) project.data = {};
        if (!project.data.hydroizolThicknessData) project.data.hydroizolThicknessData = {};
        const data = project.data.hydroizolThicknessData;

        data.date = hydroizolThicknessDateInput.value;
        data.count = thicknessCountInput.value;
        data.points = Array.from(document.querySelectorAll('.point-value-thickness')).map(i => i.value);

        saveActiveProject(project);
      }

      function loadHydroizolThicknessData() {
        const project = getActiveProject();
        const data = project.data.hydroizolThicknessData || {};

        hydroizolThicknessDateInput.value = data.date || '';
        thicknessCountInput.value = data.count || '';

        if (data.count && data.points) {
          generateThicknessInputs(parseInt(data.count), data.points);
        } else {
          thicknessContainer.innerHTML = '';
        }
      }

      function generateThicknessInputs(count, values = []) {
        thicknessContainer.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const inputGroup = document.createElement('div');
          inputGroup.className = 'form-group styled-input-wrapper';
          inputGroup.innerHTML = `<label>Точка ${i + 1} (мм):</label><input type="tel" class="point-value-thickness" step="1" value="${values[i] || ''}" placeholder="Толщина">`;
          inputGroup.querySelector('input').oninput = saveHydroizolThicknessData;
          thicknessContainer.appendChild(inputGroup);
        }
      }

      function prepareThicknessScreen() {
        loadHydroizolThicknessData();
        document.getElementById('thickness-results-table-container').innerHTML = '';
        document.getElementById('export-thickness-csv-button').style.display = 'none';
      }

      document.getElementById('generate-thickness-points-button').onclick = () => {
        const count = parseInt(thicknessCountInput.value);
        if (count < 2 || isNaN(count)) {
          alert("Введите корректное количество точек (минимум 2).");
          return;
        }
        generateThicknessInputs(count);
        saveHydroizolThicknessData();
      };

      document.getElementById('calculate-thickness-button').onclick = () => {
        saveHydroizolThicknessData();

        const minTolerance = 15;
        const maxTolerance = 25;
        const targetValue = 20; // Целевое значение

        const inputs = Array.from(document.querySelectorAll('.point-value-thickness')).map(i => parseFloat(i.value));
        const actualThicknesses = inputs.filter(n => !isNaN(n));

        if (actualThicknesses.length === 0) {
          alert("Введите фактические замеры толщины.");
          return;
        }

        let allOk = true;

        let html = '<h3>Результаты проверки толщины (Допуск: 15 мм - 25 мм)</h3>';
        html += '<table><thead><tr><th>Точка</th><th>Факт (мм)</th><th>Отклонение от ближайшего допуска (мм)</th><th>Соответствие диапазону</th></tr></thead><tbody>';

        actualThicknesses.forEach((actualT, index) => {
          // Определяем ближайшее значение допуска
          let deviationFromNearest = 0;
          if (actualT < minTolerance) {
            deviationFromNearest = actualT - minTolerance; // Отрицательное значение
          } else if (actualT > maxTolerance) {
            deviationFromNearest = actualT - maxTolerance; // Положительное значение
          } else {
            deviationFromNearest = 0; // В пределах допуска
          }

          const deviationDisplay = Number(deviationFromNearest.toFixed(1)).toString();
          const isOk = (actualT >= minTolerance) && (actualT <= maxTolerance);

          if (!isOk) allOk = false;

          const deviationHtml = isOk ?
            deviationDisplay :
            `<span class="out-of-tolerance-val">${deviationDisplay}*</span>`;

          const rangeStatus = isOk ? '✅' : '❌';

          html += `
                        <tr class="${isOk ? 'ok' : 'out-of-tolerance'}">
                            <td>${index + 1}</td>
                            <td>${Number(actualT.toFixed(1)).toString()}</td>
                            <td>${deviationHtml}</td>
                            <td>${rangeStatus}</td>
                        </tr>
                    `;
        });

        html += `</tbody></table>`;
        html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ОБЩИЙ СТАТУС: ${allOk ? 'ОК' : 'ЕСТЬ ОТКЛОНЕНИЯ'}</div>`;

        document.getElementById('thickness-results-table-container').innerHTML = html;
        document.getElementById('export-thickness-csv-button').style.display = 'block';
        saveCompletionState('hydroizolThickness', allOk);
      };

      function exportHydroizolThicknessToCSV(submoduleId) {
        const proj = getActiveProject();
        const data = proj.data.hydroizolThicknessData || {};

        const measurementDate = data.date || proj.date;
        const inputs = data.points.map(v => parseFloat(v));
        const actualThicknesses = inputs.filter(n => !isNaN(n));

        if (actualThicknesses.length === 0) {
          return alert("Ошибка экспорта: Отсутствуют входные данные.");
        }

        const minTolerance = 15;
        const maxTolerance = 25;
        let allOk = true;

        let csv = [];
        const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;

        csv.push(`РВС;${proj.name}`);
        csv.push(`Подмодуль;${subName}`);
        // ТОЛЬКО дата замера (без даты проекта)
        csv.push(`Дата замера;${formatDateToDisplay(measurementDate)}`);
        csv.push("");

        csv.push("Точка;Факт (мм);Отклонение от ближайшего допуска (мм);Соответствие диапазону");

        // ИСПРАВЛЕНО: убрана лишняя "а" в названии переменной
        actualThicknesses.forEach((actualT, index) => {
          let deviationFromNearest = 0;
          if (actualT < minTolerance) {
            deviationFromNearest = actualT - minTolerance;
          } else if (actualT > maxTolerance) {
            deviationFromNearest = actualT - maxTolerance;
          } else {
            deviationFromNearest = 0;
          }

          // 1. Форматируем отклонение: убираем ноль и меняем точку на запятую
          const deviationDisplayFormatted = Number(deviationFromNearest.toFixed(1)).toString().replace('.', ',');
          
          // 2. Форматируем факт: убираем ноль и меняем точку на запятую
          const actualTFormatted = Number(actualT.toFixed(1)).toString().replace('.', ',');

          const isOk = (actualT >= minTolerance) && (actualT <= maxTolerance);
          if (!isOk) allOk = false;

          // Добавляем звездочку для CSV, если не в допуске
          const deviationCSV = isOk ? deviationDisplayFormatted : `${deviationDisplayFormatted}*`;
          const rangeCSV = isOk ? 'ДА' : 'НЕТ';

          // 3. Записываем строку в массив CSV (используем правильные переменные)
          csv.push(`${index + 1};${actualTFormatted};${deviationCSV};${rangeCSV}`);
        });
        csv.push("");
        csv.push(`Примечания:`);
        csv.push(`Допуск;[${minTolerance} мм; ${maxTolerance} мм]`);
        csv.push(`* - Отклонение от допуска`);
        csv.push(`ГОСТ 31385-2023 Г.3.4 Толщина гидроизолирующего слоя под центральной частью днища — (50 ± 10) мм, под окрайкой днища — (20 ± 5) мм`);

        exportLinesToExcel(csv, generateExportFilename(submoduleId, measurementDate), subName);

        saveCompletionState('hydroizolThickness', true);
        renderFundamentModuleList(getActiveProject());
      }

      document.getElementById('export-thickness-csv-button').onclick = () => {
        exportHydroizolThicknessToCSV('hydroizolThickness');
      };

      // ==========================================
      // === МОДУЛЬ: ОТМЕТКА ЦЕНТРА ОСНОВАНИЯ ===
      // ==========================================

      const centerDiameterInput = document.getElementById('rvs-diameter-center');
      const centerTypeSelect = document.getElementById('fundament-type-center');
      const centerSlopeGroup = document.getElementById('slope-ratio-n-center-group');
      const centerSlopeInput = document.getElementById('slope-ratio-n-center');
      const centerUnitRadios = document.querySelectorAll('input[name="centerElevationUnit"]');
      const centerPointValueInput = document.getElementById('center-point-value');
      const centerHydroizolInputs = document.querySelectorAll('.point-value-hydro-center');
      const centerElevationDateInput = document.getElementById('center-elevation-date');

      // Функция для расчета допусков в зависимости от диаметра и типа основания
      function calculateCenterTolerance(D_RVS, type) {
        const D_RVS_m = D_RVS / 1000;
        let minTolerance = 0;
        let maxTolerance = 0;

        if (type === 'flat' || type === 'center-up') {
          // Для плоского и с подъемом к центру
          if (D_RVS_m <= 12) {
            minTolerance = 0;
            maxTolerance = 10;
          } else if (D_RVS_m <= 25) {
            minTolerance = 0;
            maxTolerance = 20;
          } else if (D_RVS_m <= 40) {
            minTolerance = 0;
            maxTolerance = 30;
          } else if (D_RVS_m <= 65) {
            minTolerance = 0;
            maxTolerance = 15;
          } else if (D_RVS_m <= 95) {
            minTolerance = 0;
            maxTolerance = 45;
          } else {
            minTolerance = 0;
            maxTolerance = 45; // Для диаметров более 95 м
          }
        } else if (type === 'center-down') {
          // С уклоном от центра (к центру)
          if (D_RVS_m <= 12) {
            minTolerance = -5;
            maxTolerance = 0;
          } else if (D_RVS_m <= 25) {
            minTolerance = -10;
            maxTolerance = 0;
          } else if (D_RVS_m <= 40) {
            minTolerance = -15;
            maxTolerance = 0;
          } else if (D_RVS_m <= 65) {
            minTolerance = -20;
            maxTolerance = 0;
          } else if (D_RVS_m <= 95) {
            minTolerance = -20;
            maxTolerance = 0;
          } else {
            minTolerance = -20;
            maxTolerance = 0; // Для диаметров более 95 м
          }
        }

        return { min: minTolerance, max: maxTolerance };
      }

      function updateCenterToleranceNote() {
  const D_RVS = parseFloat(centerDiameterInput.value);
  const type = centerTypeSelect.value;

  // Теперь скрываем только для плоского ('flat')
  if (type === 'flat') {
    centerSlopeGroup.style.display = 'none';
  } else {
    centerSlopeGroup.style.display = 'block';
  }

        if (isNaN(D_RVS)) {
          document.getElementById('center-tolerance-note').innerHTML = `
                        <strong>Допуски:</strong><br>
                        - Введите диаметр резервуара и тип основания, чтобы увидеть допуски.<br>
                        <strong>ГОСТ 31385-2023 таб. 17. Допуск зависит от диаметра резервуара.</strong>
                    `;
          return;
        }

        const { min, max } = calculateCenterTolerance(D_RVS, type);

        let note = '<strong>Допуски для данного диаметра резервуара:</strong><br>';

        if (type === 'flat') {
          note += `- Для плоского основания: <strong>${min};+${max} мм</strong><br>`;
        } else if (type === 'center-up') {
          note += `- С подъемом к центру: <strong>${min};+${max} мм</strong><br>`;
        } else if (type === 'center-down') {
          note += `- С уклоном от центра: <strong>${min};${max} мм</strong><br>`;
        }

        note += `<strong>ГОСТ 31385-2023 таб. 17. Допуск зависит от диаметра резервуара.</strong>`;

        document.getElementById('center-tolerance-note').innerHTML = note;
      }

      function saveCenterElevationData() {
        let project = getActiveProject();
        if (!project.data) project.data = {};
        if (!project.data.centerElevationData) project.data.centerElevationData = {};
        const data = project.data.centerElevationData;

        data.date = centerElevationDateInput.value;
        data.diameter = centerDiameterInput.value;
        data.type = centerTypeSelect.value;
        data.slopeN = centerSlopeInput.value;
        data.unit = document.querySelector('input[name="centerElevationUnit"]:checked').value;
        data.centerValue = centerPointValueInput.value;
        data.hydroizolValues = Array.from(centerHydroizolInputs).map(i => i.value);

        saveActiveProject(project);
      }

      function loadCenterElevationData() {
        const project = getActiveProject();
        const data = project.data.centerElevationData || {};

        centerElevationDateInput.value = data.date || '';
        centerDiameterInput.value = data.diameter || '';
        centerTypeSelect.value = data.type || 'flat';
        centerSlopeInput.value = data.slopeN || '100';
        centerPointValueInput.value = data.centerValue || '';

        centerCurrentUnit = data.unit || 'm';
        const rb = document.querySelector(`input[name="centerElevationUnit"][value="${centerCurrentUnit}"]`);
        if (rb) rb.checked = true;

        updateCenterToleranceNote();

        centerHydroizolInputs.forEach((input, index) => {
          input.value = data.hydroizolValues ? data.hydroizolValues[index] || '' : '';
          input.placeholder = centerCurrentUnit === 'm' ? 'м' : 'мм';
          input.oninput = saveCenterElevationData;
        });
        centerPointValueInput.placeholder = centerCurrentUnit === 'm' ? 'м' : 'мм';
        centerPointValueInput.oninput = saveCenterElevationData;
      }

      function prepareCenterScreen() {
        loadCenterElevationData();
        document.getElementById('center-results-table-container').innerHTML = '';
        document.getElementById('export-center-csv-button').style.display = 'none';
      }

      centerDiameterInput.oninput = () => {
        saveCenterElevationData();
        updateCenterToleranceNote();
      };

      centerTypeSelect.onchange = () => {
        saveCenterElevationData();
        updateCenterToleranceNote();
      };

      centerSlopeInput.oninput = saveCenterElevationData;

      centerUnitRadios.forEach(r => r.onchange = () => {
        centerCurrentUnit = document.querySelector('input[name="centerElevationUnit"]:checked').value;
        const placeholder = centerCurrentUnit === 'm' ? 'м' : 'мм';
        centerPointValueInput.placeholder = placeholder;
        centerHydroizolInputs.forEach(i => i.placeholder = placeholder);
        saveCenterElevationData();
        updateCenterToleranceNote();
      });

      document.getElementById('auto-fill-hydroizol-points-button').onclick = () => {
        const project = getActiveProject();
        const hydroizolData = project.data.hydroizolElevationData || {};
        const points = hydroizolData.points;

        if (!points || points.length === 0) {
          return alert('Нет сохраненных данных в модуле "Отметка поверхности гидроизолирующего слоя".');
        }

        const fillPoints = points.slice(0, 4);

        centerHydroizolInputs.forEach((input, index) => {
          input.value = fillPoints[index] || '';
        });

        if (hydroizolData.unit !== centerCurrentUnit) {
          const rb = document.querySelector(`input[name="centerElevationUnit"][value="${hydroizolData.unit}"]`);
          if (rb) rb.checked = true;
          centerCurrentUnit = hydroizolData.unit;
        }

        saveCenterElevationData();
        updateCenterToleranceNote();
        alert(`Отметки периферии заполнены (${fillPoints.length} точек).`);
      };

      document.getElementById('calculate-center-button').onclick = () => {
        saveCenterElevationData();

        const D_RVS = parseFloat(centerDiameterInput.value);
        const type = centerTypeSelect.value;
        const slopeN = parseFloat(centerSlopeInput.value);
        const H_CENTER_INPUT = parseFloat(centerPointValueInput.value);
        const H_PERIPHERY_INPUTS = Array.from(centerHydroizolInputs).map(i => parseFloat(i.value));
        const H_PERIPHERY_FILTERED = H_PERIPHERY_INPUTS.filter(n => !isNaN(n));

        if (isNaN(D_RVS) || isNaN(H_CENTER_INPUT) || H_PERIPHERY_FILTERED.length !== 4) {
          alert("Проверьте, что указан диаметр РВС, отметка центра и 4 отметки периферии.");
          return;
        }

        if ((type === 'center-up' || type === 'center-down') && isNaN(slopeN)) {
          alert("Введите корректное соотношение уклона N (1:N).");
          return;
        }

        const { min: minTolerance, max: maxTolerance } = calculateCenterTolerance(D_RVS, type);

        const H_CENTER_MM = unitToMM(H_CENTER_INPUT, centerCurrentUnit);
        const H_PERIPHERY_MM = H_PERIPHERY_INPUTS.map(v => unitToMM(v, centerCurrentUnit));

        let allOk = true;
        let html = '<h3>Результаты проверки отметок центра и периферии</h3>';
        const unitLabel = centerCurrentUnit === 'm' ? ' (м)' : ' (мм)';

        let projectedDifference = 0;
        if (type === 'center-up' || type === 'center-down') {
          projectedDifference = (D_RVS / 2) / slopeN;
        }

        html += `<table class="center-results-table"><thead><tr>
                    <th>Точка</th>
                    <th>Отметка${unitLabel}</th>
                    <th>Разность (Центр - Точка), мм</th>
                    <th>Отклонение от проектного, мм</th>
                </tr></thead><tbody>`;

        const centerDisplayValue = centerCurrentUnit === 'm'
  ? mmToUnit(H_CENTER_MM, 'm').toFixed(3)
  : Number(H_CENTER_MM.toFixed(1)).toString();


        html += `<tr class="center-row"><td>Центр</td><td>${centerDisplayValue}</td><td>—</td><td>—</td></tr>`;

        for (let i = 0; i < H_PERIPHERY_MM.length; i++) {
          const H_PERIPHERY = H_PERIPHERY_MM[i];
          const difference = H_CENTER_MM - H_PERIPHERY;
          
          // ИСПРАВЛЕНИЕ: объявляем переменные один раз
          let deviationFromProjected = 0;
          let isOk = true;

          if (type === 'flat') {
            deviationFromProjected = difference;
            isOk = (difference >= minTolerance && difference <= maxTolerance);
          } else if (type === 'center-up') {
            deviationFromProjected = difference - projectedDifference;
            isOk = (deviationFromProjected >= minTolerance && deviationFromProjected <= maxTolerance);
          } else if (type === 'center-down') {
            // Центр ниже периферии, разность должна быть отрицательной
            deviationFromProjected = difference - (-projectedDifference);
            isOk = (deviationFromProjected >= minTolerance && deviationFromProjected <= maxTolerance);
          }

          if (!isOk) allOk = false;

          const diffDisp = Number(difference.toFixed(1)).toString();
          const devDisp = Number(deviationFromProjected.toFixed(1)).toString();
          const diffHtml = isOk ? diffDisp : `<span class="out-of-tolerance-val">${diffDisp}*</span>`;
          const devHtml = isOk ? devDisp : `<span class="out-of-tolerance-val">${devDisp}*</span>`;

          const displayValue = centerCurrentUnit === 'm'
  ? mmToUnit(H_PERIPHERY, 'm').toFixed(3)
  : Number(H_PERIPHERY.toFixed(1)).toString();


          html += `<tr class="${isOk ? 'ok' : 'out-of-tolerance'}">
                    <td>${i + 1}</td>
                    <td>${displayValue}</td>
                    <td>${diffHtml}</td>
                    <td>${devHtml}</td>
                  </tr>`;
        }

        html += `</tbody></table>`;
        
        html += `<div class="tolerance-note" style="margin-top: 20px;"><strong>Расчетные значения:</strong><br>`;
        if (type === 'flat') {
          html += `- Проектное значение: плоское основание<br>`;
        } else {
          const sign = type === 'center-down' ? '-' : '';
          html += `- Проектная разность (Центр - Периферия): <strong>${sign}${Number(projectedDifference.toFixed(1))} мм</strong><br>`;
        }
        html += `- Допуск для D=${D_RVS.toFixed(0)} мм: <strong>${minTolerance};${maxTolerance} мм</strong><br>
                 <strong>ГОСТ 31385-2023 таб. 17.</strong></div>`;

        html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ОБЩИЙ СТАТУС: ${allOk ? 'ОК' : 'ЕСТЬ ОТКЛОНЕНИЯ'}</div>`;

        // ВЫВОД НА ЭКРАН
        document.getElementById('center-results-table-container').innerHTML = html;
        
        // ОЖИВЛЯЕМ КНОПКУ ЭКСПОРТА
        const exportBtn = document.getElementById('export-center-csv-button');
        exportBtn.style.display = 'block';
        exportBtn.onclick = () => exportCenterElevationToCSV('centerElevation');

        saveCompletionState('centerElevation', allOk);
      }; // ВОТ ТЕПЕРЬ КОНЕЦ ФУНКЦИИ РАСЧЕТА

      // ФУНКЦИЯ ЭКСПОРТА (вынесена отдельно)
      function exportCenterElevationToCSV(submoduleId) {
  const proj = getActiveProject();
  const data = proj.data.centerElevationData || {};
  const measurementDate = data.date || proj.date;
  const D_RVS = parseFloat(data.diameter);
  const type = data.type || 'flat';
  const slopeN = parseFloat(data.slopeN) || 100;
  const H_CENTER_INPUT = parseFloat(data.centerValue);
  const H_PERIPHERY_INPUTS = data.hydroizolValues ? data.hydroizolValues.map(v => parseFloat(v)) : [];

  if (isNaN(D_RVS) || isNaN(H_CENTER_INPUT) || H_PERIPHERY_INPUTS.length !== 4) {
    return alert("Ошибка: Недостаточно данных для экспорта.");
  }

  const { min: minTolerance, max: maxTolerance } = calculateCenterTolerance(D_RVS, type);
  const unit = data.unit || 'm';

  const H_CENTER_MM = unitToMM(H_CENTER_INPUT, unit);
  const H_PERIPHERY_MM = H_PERIPHERY_INPUTS.map(v => unitToMM(v, unit));
  const projectedDiff = (type === 'flat') ? 0 : (D_RVS / 2) / slopeN;

  // --- Форматирование чисел БЕЗ округления ---

  // мм — без округления и без лишних нулей (10,0 -> 10)
  const fmtMM = (v) => {
    let str = String(v).replace('.', ',');
    if (str.includes(',')) str = str.replace(/,?0+$/, '');
    return str;
  };

  // метры — строго 3 знака после запятой, без округления (обрезаем)
  const fmtMeters = (mmVal) => {
    const meters = mmToUnit(mmVal, 'm');
    let [intPart, decPart = ''] = String(meters).split('.');
    decPart = (decPart + '000').substring(0, 3);
    return intPart + ',' + decPart;
  };

  // отметка: если м -> 3 знака, если мм -> без ",0"
  const fmtLevel = (mmVal, u) => (u === 'm' ? fmtMeters(mmVal) : fmtMM(mmVal));

  // --- конец форматирования ---

  let csv = [];
  const subName = SUBMODULE_NAMES_MAP[submoduleId] || "Отметка центра";
  const typeNames = {
    'flat': 'Плоское (без уклона)',
    'center-up': 'С уклоном от периферии к центру (коническое)',
    'center-down': 'С уклоном от центра к периферии (коническое)'
  };

  csv.push(`РВС;${proj.name}`);
  csv.push(`Дата;${formatDateToDisplay(measurementDate)}`);
  csv.push(`Диаметр РВС;${D_RVS} мм`);
  csv.push(`Тип фундамента;${typeNames[type] || type}`);
  csv.push("");
  csv.push(`Точка;Отметка;Разность (Факт), мм;Отклонение, мм`);

  // ЦЕНТР
  const cVal = fmtLevel(H_CENTER_MM, unit);
  csv.push(`Центр;${cVal};—;—`);

  let hasDefects = false;

  // ТОЧКИ
  H_PERIPHERY_MM.forEach((H_PERI, i) => {
    const factDiff = H_CENTER_MM - H_PERI;

    let dev = 0;
    if (type === 'flat') dev = factDiff;
    else if (type === 'center-up') dev = factDiff - projectedDiff;
    else if (type === 'center-down') dev = factDiff - (-projectedDiff);

    const isOk = (dev >= minTolerance && dev <= maxTolerance);
    if (!isOk) hasDefects = true;

    const pVal = fmtLevel(H_PERI, unit);

    // ВАЖНО: тут больше нет toFixed(1) -> не будет "10,0"
    const diffStr = fmtMM(factDiff);
    const devStr = fmtMM(dev);

    csv.push(`${i + 1};${pVal};${diffStr};${devStr}${isOk ? '' : '*'}`);
  });

  csv.push("");
  csv.push(`* - Отклонение от допуска`);

  const fmtTol = (val) => (val > 0 ? `+${val}` : val.toString());
  const toleranceStr = `${fmtTol(minTolerance)};${fmtTol(maxTolerance)}`;
  const sign = type === 'center-down' ? '-' : (type === 'center-up' ? '+' : '');

  // Проектная разность тоже без "10,0"
  const projDiffFormatted = fmtMM(projectedDiff);

  csv.push(`Проектная разность;${sign}${projDiffFormatted} мм`);
  csv.push(`Допуск;${toleranceStr} мм`);
  csv.push(`ОБЩИЙ СТАТУС;${hasDefects ? 'ЕСТЬ ОТКЛОНЕНИЯ' : 'НОРМА'}`);

  exportLinesToExcel(csv, generateExportFilename(submoduleId, measurementDate), subName);
  saveCompletionState(submoduleId, true);
  renderFundamentModuleList(getActiveProject());
}

	 
      // ==========================================
      // === МОДУЛЬ: ОСАДКА ФУНДАМЕНТА ===
      // ==========================================

      const settlementCountInput = document.getElementById('settlement-point-count');
      const settlementGenerateBtn = document.getElementById('settlement-generate-btn');
      const settlementTabs = document.getElementById('settlement-tabs');
      const settlementInputArea = document.getElementById('settlement-input-area');

      const settlementBaseInputs = document.getElementById('settlement-base-inputs');
      const settlementDuringInputs = document.getElementById('settlement-during-inputs');
      const settlementAfterInputs = document.getElementById('settlement-after-inputs');

      const settlementDuringHistorySelect = document.getElementById('settlement-during-history-select');
      const settlementSaveDuringBtn = document.getElementById('settlement-save-during-btn');
      const settlementDeleteDuringBtn = document.getElementById('settlement-delete-during-btn');

      const settlementResults = document.getElementById('settlement-results-container');
      const settlementExportBtn = document.getElementById('export-settlement-csv-button');

      const settlementDateBaseInput = document.getElementById('settlement-date-base');
      const settlementBaseDoneBtn = document.getElementById('settlement-base-done-btn');

      document.querySelectorAll('input[name="settlementUnit"]').forEach(r => {
        r.onchange = (e) => {
          settlementCurrentUnit = e.target.value;
          const placeholder = settlementCurrentUnit === 'm' ? 'м' : 'мм';
          document.querySelectorAll('.val-settlement').forEach(i => i.placeholder = placeholder);
          saveSettlementMetadata();
        };
      });

      function saveSettlementMetadata() {
        const proj = getActiveProject();
        if (!proj.data.settlementData) proj.data.settlementData = {
          count: 0,
          unit: 'm',
          base: [],
          during: [],
          after: [],
          dateBase: '',
          dateAfter: ''
        };
        proj.data.settlementData.count = parseInt(settlementCountInput.value) || 0;
        proj.data.settlementData.unit = settlementCurrentUnit;
        proj.data.settlementData.dateBase = settlementDateBaseInput.value;
        saveActiveProject(proj);
      }

      function saveSettlementData() {
        const proj = getActiveProject();
        if (!proj.data.settlementData) return;

        if (settlementActiveTab === 'base') {
          proj.data.settlementData.base = Array.from(document.querySelectorAll('.val-settlement-base')).map(i => i.value);
        } else if (settlementActiveTab === 'after') {
          proj.data.settlementData.after = Array.from(document.querySelectorAll('.val-settlement-after')).map(i => i.value);
        } else if (settlementActiveTab === 'during') {
          const currentValues = Array.from(document.querySelectorAll('.val-settlement-during')).map(i => i.value);
          const history = proj.data.settlementData.during;

          if (activeDuringIndex >= 0 && activeDuringIndex < history.length) {
            history[activeDuringIndex].values = currentValues;
            history[activeDuringIndex].numericValues = currentValues.map(v => parseFloat(v));
          }
        }
        saveActiveProject(proj);
      }

      function prepareSettlementScreen() {
        const proj = getActiveProject();
        settlementResults.innerHTML = '';
        settlementExportBtn.style.display = 'none';

        if (proj && proj.data && proj.data.settlementData && proj.data.settlementData.count > 0) {
          const data = proj.data.settlementData;
          settlementCountInput.value = data.count;
          settlementCurrentUnit = data.unit;
          const rb = document.querySelector(`input[name="settlementUnit"][value="${settlementCurrentUnit}"]`);
          if (rb) rb.checked = true;

          settlementDateBaseInput.value = data.dateBase || '';

          activeDuringIndex = data.during.length > 0 ? data.during.length - 1 : -1;
          renderSettlementInputs(data.count, data);

          settlementTabs.classList.remove('hidden');
          settlementInputArea.classList.remove('hidden');

          switchSettlementTab('base');

          // Показываем кнопку экспорта если есть данные "ДО"
          const hasBaseData = data.base && data.base.some(v => v && v !== '');
          if (hasBaseData) {
            settlementExportBtn.style.display = 'block';
          }
        } else {
          settlementTabs.classList.add('hidden');
          settlementInputArea.classList.add('hidden');
          settlementBaseInputs.innerHTML = '';
          settlementDuringInputs.innerHTML = '';
          settlementAfterInputs.innerHTML = '';
          settlementCountInput.value = '';
        }
      }

      settlementGenerateBtn.onclick = () => {
        const count = parseInt(settlementCountInput.value);
        if (!count || count < 2) return alert('Введите количество точек (минимум 2).');

        const proj = getActiveProject();
        proj.data.settlementData = {
          count: count,
          unit: settlementCurrentUnit,
          base: Array(count).fill(''),
          during: [],
          after: Array(count).fill(''),
          dateBase: settlementDateBaseInput.value,
          dateAfter: ''
        };
        saveActiveProject(proj);

        activeDuringIndex = -1;
        renderSettlementInputs(count, proj.data.settlementData);
        settlementTabs.classList.remove('hidden');
        settlementInputArea.classList.remove('hidden');
        switchSettlementTab('base');
      };

      function createInputGroup(index, className, placeholder, value) {
        const div = document.createElement('div');
        div.className = 'form-group styled-input-wrapper';
        const placeholderText = settlementCurrentUnit === 'm' ? 'м' : 'мм';
        div.innerHTML = `<label>Точка ${index + 1}:</label><input type="tel" class="val-settlement ${className}" step="${settlementCurrentUnit === 'mm' ? '1' : '0.001'}" value="${value}" placeholder="${placeholderText}">`;
        div.querySelector('input').addEventListener('input', saveSettlementData);
        return div;
      }

      function renderSettlementInputs(count, data) {
        const placeholderText = settlementCurrentUnit === 'm' ? 'м' : 'мм';

        settlementBaseInputs.innerHTML = '';
        for (let i = 0; i < count; i++) {
          settlementBaseInputs.appendChild(createInputGroup(i, 'val-settlement-base', placeholderText, data.base[i] || ''));
        }

        settlementAfterInputs.innerHTML = '';
        for (let i = 0; i < count; i++) {
          settlementAfterInputs.appendChild(createInputGroup(i, 'val-settlement-after', placeholderText, data.after[i] || ''));
        }

        settlementDuringHistorySelect.innerHTML = '';
        if (data.during.length > 0) {
          data.during.forEach((record, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Замер №${index + 1} (${record.date || '—'})`;
            settlementDuringHistorySelect.appendChild(option);
          });
        }
        const newOption = document.createElement('option');
        newOption.value = -1;
        newOption.textContent = 'НОВЫЙ ЗАМЕР...';
        settlementDuringHistorySelect.appendChild(newOption);

        settlementDuringInputs.innerHTML = '';
        let currentDuringValues = [];
        if (activeDuringIndex !== -1 && data.during[activeDuringIndex]) {
          currentDuringValues = data.during[activeDuringIndex].values;
          settlementDuringHistorySelect.value = activeDuringIndex;
        } else {
          currentDuringValues = Array(count).fill('');
          settlementDuringHistorySelect.value = -1;
        }

        for (let i = 0; i < count; i++) {
          settlementDuringInputs.appendChild(createInputGroup(i, 'val-settlement-during', placeholderText, currentDuringValues[i] || ''));
        }
      }

      // Обработчик для кнопки "Готово" в секции ДО испытаний
      settlementBaseDoneBtn.onclick = function () {
        saveSettlementData();
        alert('Данные "ДО испытаний" сохранены. Доступен экспорт в Excel.');
        settlementExportBtn.style.display = 'block';

        // Показываем сообщение
        const msg = document.createElement('div');
        msg.className = 'tolerance-note';
        msg.style.marginTop = '10px';
        msg.style.backgroundColor = '#eafbea';
        msg.innerHTML = '<strong>✓ Данные "ДО испытаний" успешно сохранены. Доступен экспорт в Excel.</strong>';

        const existingMsg = document.querySelector('#settlement-base-section .saved-msg');
        if (existingMsg) existingMsg.remove();

        msg.classList.add('saved-msg');
        document.getElementById('settlement-base-section').appendChild(msg);

        saveCompletionState('settlement', true);
        renderFundamentModuleList(getActiveProject());
      };

      settlementSaveDuringBtn.onclick = () => {
        const proj = getActiveProject();
        const data = proj.data.settlementData;
        const count = data.count;

        const currentValues = Array.from(document.querySelectorAll('.val-settlement-during')).map(i => i.value);
        if (currentValues.filter(v => v !== '').length === 0) {
          return alert('Введите значения для сохранения замера.');
        }

        const numericValues = currentValues.map(v => parseFloat(v));

        const newRecord = {
          date: new Date().toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
          values: currentValues,
          numericValues: numericValues
        };

        if (activeDuringIndex === -1 || activeDuringIndex >= data.during.length) {
          data.during.push(newRecord);
          activeDuringIndex = data.during.length - 1;
          alert(`Замер №${data.during.length} сохранен.`);
        } else {
          data.during[activeDuringIndex] = newRecord;
          alert(`Замер №${activeDuringIndex + 1} обновлен.`);
        }

        saveActiveProject(proj);

        renderSettlementInputs(count, data);
      };

      settlementDeleteDuringBtn.onclick = () => {
        const proj = getActiveProject();
        const data = proj.data.settlementData;

        if (data.during.length === 0 || activeDuringIndex === -1 || activeDuringIndex >= data.during.length) {
          alert('Нет активного замера для удаления.');
          return;
        }

        if (!confirm(`Удалить замер №${activeDuringIndex + 1}?`)) {
          return;
        }

        data.during.splice(activeDuringIndex, 1);

        if (data.during.length > 0) {
          activeDuringIndex = Math.max(0, activeDuringIndex - 1);
        } else {
          activeDuringIndex = -1;
        }

        saveActiveProject(proj);
        renderSettlementInputs(data.count, data);
        alert('Замер удален.');
      };

      settlementDuringHistorySelect.onchange = (e) => {
        activeDuringIndex = parseInt(e.target.value);
        const proj = getActiveProject();
        renderSettlementInputs(proj.data.settlementData.count, proj.data.settlementData);
      };

      document.getElementById('tab-btn-base').onclick = () => switchSettlementTab('base');
      document.getElementById('tab-btn-during').onclick = () => switchSettlementTab('during');
      document.getElementById('tab-btn-after').onclick = () => switchSettlementTab('after');

      function switchSettlementTab(tab) {
        saveSettlementData();

        settlementActiveTab = tab;
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.input-section').forEach(s => s.classList.remove('active'));

        document.getElementById(`tab-btn-${tab}`).classList.add('active');
        document.getElementById(`settlement-${tab}-section`).classList.add('active');
      }

      document.getElementById('settlement-calculate-btn').onclick = () => {
        saveSettlementData();

        const proj = getActiveProject();
        const data = proj.data.settlementData;
        const factor = settlementCurrentUnit === 'm' ? 1000 : 1;

        const baseVals = data.base.map(v => parseFloat(v)).map(v => v * factor);
        const afterVals = data.after.map(v => parseFloat(v)).map(v => v * factor);

        if (baseVals.filter(v => !isNaN(v)).length === 0) {
          return alert('Отсутствуют значения "ДО испытаний" для расчета осадки.');
        }

        // Функция формата: для метров 3 знака, для мм - целое число без .0
        const formatVal = (v) => settlementCurrentUnit === 'm' 
            ? (v / 1000).toFixed(3) 
            : Math.round(v).toString();

        let hasValidSettlement = false;
        let html = '';

        // --- ВКЛАДКА: ВО ВРЕМЯ (СРАВНЕНИЕ ЗАМЕРОВ) ---
        if (settlementActiveTab === 'during' && activeDuringIndex > 0 && data.during.length > activeDuringIndex) {

          if (data.during.length < 2) {
            return alert('Для сравнения "Во время" требуется минимум два сохраненных замера.');
          }

          const duringPenultimateMM = data.during[activeDuringIndex - 1].numericValues.map(v => v * factor);
          const duringLastMM = data.during[activeDuringIndex].numericValues.map(v => v * factor);

          html = `
            <h3>Результаты: ВО ВРЕМЯ (Замер №${activeDuringIndex + 1})</h3>
            <p>Сравнение: **Замер №${activeDuringIndex + 1}** vs. **Замер №${activeDuringIndex}**</p>
            <table>
              <thead>
                <tr>
                  <th>Точка</th>
                  <th>ДО испытаний (${settlementCurrentUnit})</th>
                  <th>ВО ВРЕМЯ предп. (${settlementCurrentUnit})</th>
                  <th>ВО ВРЕМЯ посл. (${settlementCurrentUnit})</th>
                  <th>Осадка (Посл - До), мм</th>
                  <th>Сдвиг (Посл - Предп), мм</th>
                </tr>
              </thead>
              <tbody>`;

          for (let i = 0; i < data.count; i++) {
            const baseMM = baseVals[i];
            const penultimateMM = duringPenultimateMM[i];
            const lastMM = duringLastMM[i];

            const baseDisplay = isNaN(baseMM) ? '—' : formatVal(baseMM);
            const penultimateDisplay = isNaN(penultimateMM) ? '—' : formatVal(penultimateMM);
            const lastDisplay = isNaN(lastMM) ? '—' : formatVal(lastMM);

            let settlementMM = '—';
            let shiftMM = '—';
            let shiftClass = '';

            if (!isNaN(baseMM) && !isNaN(lastMM)) {
              // Убираем лишний ноль через Number().toString()
              settlementMM = Number((lastMM - baseMM).toFixed(1)).toString();
              hasValidSettlement = true;
            }

            if (!isNaN(penultimateMM) && !isNaN(lastMM)) {
              const diff = (lastMM - penultimateMM).toFixed(1);
              shiftMM = Number(diff).toString(); 
              
              // Подсветка: КРАСНЫЙ если сдвиг > 5 мм
              const absShift = Math.abs(parseFloat(diff));
              if (absShift > 5) {
                shiftClass = 'out-of-tolerance'; 
              } else if (absShift < 0.5) {
                shiftClass = 'ok';
              }
            }

            html += `<tr>
                <td>${i + 1}</td>
                <td>${baseDisplay}</td>
                <td>${penultimateDisplay}</td>
                <td>${lastDisplay}</td>
                <td style="font-weight:bold; color: ${parseFloat(settlementMM) > 0 ? 'red' : 'green'};">${settlementMM}</td>
                <td class="${shiftClass}">${shiftMM}</td>
              </tr>`;
          }

        // --- ВКЛАДКИ: ПОСЛЕ ИЛИ ПЕРВЫЙ ЗАМЕР ---
        } else {
          let currentValsMM = null;
          let currentLabel = '';
          let duringLastValsMM = null;

          if (settlementActiveTab === 'after') {
            if (afterVals.filter(v => !isNaN(v)).length === 0) return alert('Отсутствуют значения "ПОСЛЕ испытаний".');
            currentValsMM = afterVals;
            currentLabel = 'ПОСЛЕ испытаний';
            if (data.during.length > 0) {
              duringLastValsMM = data.during[data.during.length - 1].numericValues.map(v => v * factor);
            }
          } else if (settlementActiveTab === 'during' && activeDuringIndex === 0 && data.during.length > 0) {
            currentValsMM = data.during[activeDuringIndex].numericValues.map(v => v * factor);
            currentLabel = 'ВО ВРЕМЯ (Замер №1)';
          } else {
            return alert('Недостаточно данных для расчета.');
          }

          const duringLastHeader = (settlementActiveTab === 'after' && duringLastValsMM) ? `<th>ВО ВРЕМЯ последнее (${settlementCurrentUnit})</th>` : '';
          const shiftHeader = (settlementActiveTab === 'after' && duringLastValsMM) ? 'Сдвиг (После - Посл. Вр), мм' : 'Сдвиг (Тек - До), мм';

          html = `
            <h3>Результаты: ${currentLabel}</h3>
            <div class="settlement-results-inner">
            <table>
              <thead>
                <tr>
                  <th>Точка</th>
                  <th>ДО испытаний (${settlementCurrentUnit})</th>
                  ${duringLastHeader}
                  <th>${currentLabel} (${settlementCurrentUnit})</th>
                  <th>Осадка (Тек - До), мм</th>
                  <th>${shiftHeader}</th>
                </tr>
              </thead>
              <tbody>`;

          for (let i = 0; i < data.count; i++) {
            const baseValMM = baseVals[i];
            const currentValMM = currentValsMM[i];
            let prevValForShiftMM = (settlementActiveTab === 'after' && duringLastValsMM) ? duringLastValsMM[i] : baseValMM;

            const baseDisplay = isNaN(baseValMM) ? '—' : formatVal(baseValMM);
            const currentDisplay = isNaN(currentValMM) ? '—' : formatVal(currentValMM);
            const duringLastDisplay = (duringLastValsMM && !isNaN(duringLastValsMM[i])) ? formatVal(duringLastValsMM[i]) : '—';

            let settlementMM = '—';
            let shiftMM = '—';
            let shiftClass = '';

            if (!isNaN(baseValMM) && !isNaN(currentValMM)) {
              settlementMM = Number((currentValMM - baseValMM).toFixed(1)).toString();
              hasValidSettlement = true;
            }

            if (!isNaN(prevValForShiftMM) && !isNaN(currentValMM)) {
              const diff = (currentValMM - prevValForShiftMM).toFixed(1);
              shiftMM = Number(diff).toString();
              if (Math.abs(parseFloat(diff)) > 5) shiftClass = 'out-of-tolerance';
            }

            html += `<tr>
                <td>${i + 1}</td>
                <td>${baseDisplay}</td>
                ${(settlementActiveTab === 'after' && duringLastValsMM) ? `<td>${duringLastDisplay}</td>` : ''}
                <td>${currentDisplay}</td>
                <td style="font-weight:bold; color: ${parseFloat(settlementMM) > 0 ? 'red' : 'green'};">${settlementMM}</td>
                <td class="${shiftClass}">${shiftMM}</td>
              </tr>`;
          }
        }

        html += `</tbody></table></div>`;
        settlementResults.innerHTML = html;
        settlementExportBtn.style.display = hasValidSettlement ? 'block' : 'none';
        saveCompletionState('settlement', hasValidSettlement);
      };

      function exportSettlementToCSV(submoduleId) {
  const proj = getActiveProject();
  const data = proj.data.settlementData;
  const count = data.count;
  const unit = data.unit;

  const baseVals = data.base;
  const afterVals = data.after;

  const latestDuring = data.during.length > 0 ? data.during[data.during.length - 1] : null;
  const penultimateDuring = data.during.length > 1 ? data.during[data.during.length - 2] : null;

  const measurementDate = data.dateBase || proj.date;
  const subName = SUBMODULE_NAMES_MAP[submoduleId];

  const factor = unit === 'm' ? 1000 : 1;
  const unitLabel = unit === 'm' ? ' (м)' : ' (мм)';

  // ---------- helpers ----------
  const fmt = (val) => {
    if (isNaN(val)) return '—';
    return unit === 'm'
      ? val.toFixed(3).replace('.', ',')
      : Math.round(val).toString();
  };

  const fmtDiff = (val) => {
    if (val === '—' || val === null) return '—';
    return parseFloat(val).toString().replace('.', ',');
  };

  // ---------- DATA ----------
  let rows = [];

  rows.push(['РВС', proj.name]);
  rows.push(['Подмодуль', subName]);
  rows.push(['Дата замера ДО испытаний', formatDateToDisplay(measurementDate)]);
  rows.push(['Ед. измерения', unit]);
  rows.push([]);

  rows.push([
    'Точка',
    `ДО испытаний${unitLabel}`,
    `Предпоследний ВО ВРЕМЯ${unitLabel}`,
    `Последний ВО ВРЕМЯ${unitLabel}`,
    'Разница (Посл-Предп), мм',
    'Разность ВО ВРЕМЯ (Посл-ДО), мм',
    `ПОСЛЕ испытаний${unitLabel}`,
    'Осадка ПОСЛЕ, мм'
  ]);

  for (let i = 0; i < count; i++) {
    const base = parseFloat(baseVals[i]);
    const after = parseFloat(afterVals[i]);
    const lastDuring = latestDuring ? parseFloat(latestDuring.values[i]) : NaN;
    const prevDuring = penultimateDuring ? parseFloat(penultimateDuring.values[i]) : NaN;

    let shiftBetween = '—';
    let shiftMark = '';

    if (!isNaN(lastDuring) && !isNaN(prevDuring)) {
      const diff = (lastDuring * factor) - (prevDuring * factor);
      shiftBetween = diff.toFixed(1);
      if (Math.abs(diff) > 5) shiftMark = '*';
    }

    let totalDuring = '—';
    if (!isNaN(base) && !isNaN(lastDuring)) {
      totalDuring = ((lastDuring * factor) - (base * factor)).toFixed(1);
    }

    let finalSettlement = '—';
    if (!isNaN(base) && !isNaN(after)) {
      finalSettlement = ((after * factor) - (base * factor)).toFixed(1);
    }

    rows.push([
      i + 1,
      fmt(base),
      fmt(prevDuring),
      fmt(lastDuring),
      fmtDiff(shiftBetween) + shiftMark,
      fmtDiff(totalDuring),
      fmt(after),
      fmtDiff(finalSettlement)
    ]);
  }

  // ---------- ПРИМЕЧАНИЕ (ОДНА ЯЧЕЙКА НА ВСЮ ШИРИНУ) ----------
  rows.push([]);
  const noteStartRow = rows.length;
  rows.push(['* Отклонение от допуска']);
  rows.push(['ГОСТ 31385-2023 п. 11.6']);
  rows.push(['За условную стабилизацию осадки принимают уплотненность грунта,']);
  rows.push(['когда осадка за 24 ч не превышает 5 мм']);

  // ---------- XLSX ----------
  const ws = XLSX.utils.aoa_to_sheet(rows);

  // MERGE A–H (0–7)
  ws['!merges'] = [
    { s: { r: noteStartRow,     c: 0 }, e: { r: noteStartRow,     c: 7 } },
    { s: { r: noteStartRow + 1, c: 0 }, e: { r: noteStartRow + 1, c: 7 } },
    { s: { r: noteStartRow + 2, c: 0 }, e: { r: noteStartRow + 2, c: 7 } },
    { s: { r: noteStartRow + 3, c: 0 }, e: { r: noteStartRow + 3, c: 7 } }
  ];

  // перенос строк
  Object.keys(ws).forEach(cell => {
    if (ws[cell] && ws[cell].v && typeof ws[cell].v === 'string') {
      ws[cell].s = { alignment: { wrapText: true, vertical: 'top' } };
    }
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, subName);

  XLSX.writeFile(
    wb,
    generateExportFilename('settlement', measurementDate).replace('.csv', '.xlsx')
  );

  saveCompletionState('settlement', true);
  renderFundamentModuleList(getActiveProject());
}


      settlementExportBtn.onclick = () => {
        exportSettlementToCSV('settlement');
      };

      showFundamentScreen()

      // ЗАПУСК
      // document.getElementById('app-container').style.visibility = 'visible';
      // if (getAllProjects().length > 0) showProjectList();
      // else showScreen('projectsSection');
    });

  </script>
  <script>

    document.addEventListener('DOMContentLoaded', () => {

      // --- КОНСТАНТЫ ---


      // const BOTTOM_SUBMODULES = [
      //     { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', screen: 'radial-seams-screen' },
      //     { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', screen: 'plate-rise-screen' },
      //     { id: 'buckles', text: 'Местные неровности (хлопуны)', screen: 'buckles-screen' },
      //     { id: 'outerContour', text: 'Отметки наружного контура днища', screen: 'outer-contour-screen' }
      // ];

      const STORAGE_KEY_PROJECTS = 'projectManagerProjects';
      const STORAGE_KEY_ACTIVE_NAME = 'projectActiveName';



      const SUBMODULE_NAMES_MAP = {
        'radialSeams': 'Днище_РадиальныеШвы',
        'plateRise': 'Днище_ПодъемОкраек',
        'buckles': 'Днище_Хлопуны',
        'outerContour': 'Днище_НаружныйКонтур'
      };
      // --- ЭЛЕМЕНТЫ DOM ---
      const screens = document.querySelectorAll('.app-screen');
      const projectListScreen = document.getElementById('project-list-screen');
      const setupScreen = document.getElementById('setup-screen');
      const bottomScreen = document.getElementById('bottom-screen');
      const projectsListContainer = document.getElementById('projects-list-container');
      const bottomModuleList = document.getElementById('bottom-module-list');

      const bottomRvsName = document.getElementById('bottom-rvs-name');
      const bottomRvsDate = document.getElementById('bottom-rvs-date');

      // --- УТИЛИТЫ ДЛЯ ФОРМАТИРОВАНИЯ ДАТЫ ---
      // function formatDateToDMY(dateString) {
      //     if (!dateString) return '';

      //     const date = new Date(dateString);
      //     if (isNaN(date.getTime())) return dateString;

      //     const day = String(date.getDate()).padStart(2, '0');
      //     const month = String(date.getMonth() + 1).padStart(2, '0');
      //     const year = date.getFullYear();

      //     return `${day}.${month}.${year}`;
      // }

      // function convertStorageDate(dateString) {
      //     return formatDateToDMY(dateString);
      // }

      // --- ХРАНИЛИЩЕ ---
      function getAllProjects() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_PROJECTS) || '[]');
      }
      function saveAllProjects(projects) {
        localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(projects));
      }
      function getActiveProject() {
        const activeName = localStorage.getItem(STORAGE_KEY_ACTIVE_NAME) || null;

        return getAllProjects().find(p => p.name === activeName);
      }
      function saveActiveProject(updatedProject) {
        let projects = getAllProjects();
        const index = projects.findIndex(p => p.name === updatedProject.name);
        if (index !== -1) {
          projects[index] = updatedProject;
          saveAllProjects(projects);
        }
      }
      function saveCompletionState(submoduleId, isCompleted) {
        let project = getActiveProject();
        if (project) {
          if (!project.data) project.data = {};
          project.data[submoduleId] = isCompleted;

          const defaultBottom = [
            { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', status: 'pending' },
            { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', status: 'pending' },
            { id: 'buckles', text: 'Местные неровности (хлопуны)', status: 'pending' },
            { id: 'outerContour', text: 'Отметки наружного контура днища', status: 'pending' }
          ];

          if (!project.data.bottomSubmodules) {
            project.data.bottomSubmodules = JSON.parse(JSON.stringify(defaultBottom));
          }

          const sub = project.data.bottomSubmodules.find(sm => sm.id === submoduleId);
          if (sub) {
            sub.status = isCompleted ? 'completed' : 'pending';
          }

          saveActiveProject(project);
          return project;
        }
        return null;
      }

      // --- ФУНКЦИИ ДЛЯ АВТОСОХРАНЕНИЯ ---
      function saveModuleData(moduleKey, data) {
        const project = getActiveProject();
        if (project) {
          const storageKey = `${moduleKey}_${project.name}`;
          localStorage.setItem(storageKey, JSON.stringify(data));
          console.log(`Сохранены данные для ${moduleKey}:`, data);
        }
      }

      function loadModuleData(moduleKey) {
        const project = getActiveProject();
        if (project) {
          const storageKey = `${moduleKey}_${project.name}`;
          const data = localStorage.getItem(storageKey);
          return data ? JSON.parse(data) : null;
        }
        return null;
      }

      function clearModuleData(moduleKey) {
        const project = getActiveProject();
        if (project) {
          const storageKey = `${moduleKey}_${project.name}`;
          localStorage.removeItem(storageKey);
          console.log(`Удалены данные для ${moduleKey}`);
        }
      }

      // Автосохранение при изменении полей ввода
      function setupAutoSave(inputs, moduleKey) {
        inputs.forEach(input => {
          input.addEventListener('input', () => {
            setTimeout(() => {
              saveCurrentModuleData(moduleKey);
            }, 500);
          });
        });
      }

      // Сохранение текущих данных модуля
      function saveCurrentModuleData(moduleKey) {
        const project = getActiveProject();
        if (!project) return;

        let data = {};

        switch (moduleKey) {
          case 'radialSeams':
            data = {
              measurementDate: document.getElementById('radial-seams-date').value,
              plateThickness: document.getElementById('plate-thickness').value,
              seamTolerance: document.getElementById('seam-tolerance').value,
              seamCount: document.getElementById('seam-count').value,
              inputs: []
            };

            const seamCards = document.querySelectorAll('.seam-card');
            seamCards.forEach(card => {
              const angValue = card.querySelector('.val-ang')?.value || '';
              const offValue = card.querySelector('.val-off')?.value || '';
              data.inputs.push({ ang: angValue, off: offValue });
            });
            break;

          case 'plateRise':
            data = {
              measurementDate: document.getElementById('plate-rise-date').value,
              tankDiameter: document.getElementById('tank-diameter').value,
              edgeLength: document.getElementById('edge-length').value,
              pointCount: document.getElementById('rise-point-count').value,
              inputs: []
            };

            const riseInputs = document.querySelectorAll('.val-rise');
            riseInputs.forEach(input => {
              data.inputs.push(input.value || '');
            });
            break;

          case 'buckles':
            data = {
              measurementDate: document.getElementById('buckles-date').value,
              buckleCount: document.getElementById('buckle-count').value,
              inputs: []
            };

            const buckleCards = document.querySelectorAll('.buckle-card');
            buckleCards.forEach(card => {
              const inputs = {
                c1: card.querySelector('.b-c1')?.value || '',
                c2: card.querySelector('.b-c2')?.value || '',
                c3: card.querySelector('.b-c3')?.value || '',
                c4: card.querySelector('.b-c4')?.value || '',
                l1: card.querySelector('.b-l1')?.value || '',
                l2: card.querySelector('.b-l2')?.value || '',
                rad: card.querySelector('.b-rad')?.value || '',
                h: card.querySelector('.b-h')?.value || ''
              };
              data.inputs.push(inputs);
            });
            break;

          case 'outerContour':
            data = {
              measurementDate: document.getElementById('outer-contour-date').value,
              tankDiameter: document.getElementById('contour-tank-diameter').value,
              pointCount: document.getElementById('contour-point-count').value,
              mode: contourMode,
              inputs: []
            };

            const contourInputs = document.querySelectorAll('.val-cont');
            contourInputs.forEach(input => {
              data.inputs.push(input.value || '');
            });
            break;
        }

        saveModuleData(moduleKey, data);
      }

      // Восстановление данных модуля
      function restoreModuleData(moduleKey) {
        const data = loadModuleData(moduleKey);
        if (!data) return false;

        console.log(`Восстановление данных для ${moduleKey}:`, data);

        switch (moduleKey) {
          case 'radialSeams':
            const todayRS = new Date().toISOString().split('T')[0];
            document.getElementById('radial-seams-date').value = data.measurementDate || todayRS;
            document.getElementById('plate-thickness').value = data.plateThickness || '10';
            document.getElementById('seam-tolerance').value = data.seamTolerance || '3';
            document.getElementById('seam-count').value = data.seamCount || '';

            if (data.inputs && data.inputs.length > 0) {
              // Генерируем поля ввода
              document.getElementById('seam-count').value = data.inputs.length;
              setTimeout(() => {
                document.getElementById('generate-seams-button').click();

                // Ждем создания полей и заполняем их
                setTimeout(() => {
                  const seamCards = document.querySelectorAll('.seam-card');
                  data.inputs.forEach((inputData, index) => {
                    if (seamCards[index]) {
                      const angInput = seamCards[index].querySelector('.val-ang');
                      const offInput = seamCards[index].querySelector('.val-off');
                      if (angInput && inputData.ang) angInput.value = inputData.ang;
                      if (offInput && inputData.off) offInput.value = inputData.off;
                    }
                  });

                  // Настраиваем автосохранение
                  const allInputs = document.querySelectorAll('#radial-seams-screen input');
                  setupAutoSave(allInputs, 'radialSeams');
                }, 100);
              }, 50);
            }
            return true;

          case 'plateRise':
            const todayPR = new Date().toISOString().split('T')[0];
            document.getElementById('plate-rise-date').value = data.measurementDate || todayPR;
            document.getElementById('tank-diameter').value = data.tankDiameter || '20000';
            document.getElementById('edge-length').value = data.edgeLength || '500';
            document.getElementById('rise-point-count').value = data.pointCount || '8';

            if (data.inputs && data.inputs.length > 0) {
              document.getElementById('rise-point-count').value = data.inputs.length;
              setTimeout(() => {
                document.getElementById('generate-rise-button').click();

                setTimeout(() => {
                  const riseInputs = document.querySelectorAll('.val-rise');
                  data.inputs.forEach((value, index) => {
                    if (riseInputs[index] && value !== '') {
                      riseInputs[index].value = value;
                    }
                  });

                  const allInputs = document.querySelectorAll('#plate-rise-screen input');
                  setupAutoSave(allInputs, 'plateRise');
                }, 100);
              }, 50);
            }
            return true;

          case 'buckles':
            const todayB = new Date().toISOString().split('T')[0];
            document.getElementById('buckles-date').value = data.measurementDate || todayB;
            document.getElementById('buckle-count').value = data.buckleCount || '';

            if (data.inputs && data.inputs.length > 0) {
              document.getElementById('buckle-count').value = data.inputs.length;
              setTimeout(() => {
                document.getElementById('generate-buckles-button').click();

                setTimeout(() => {
                  const buckleCards = document.querySelectorAll('.buckle-card');
                  data.inputs.forEach((inputData, index) => {
                    if (buckleCards[index]) {
                      const fields = ['c1', 'c2', 'c3', 'c4', 'l1', 'l2', 'rad', 'h'];
                      fields.forEach(field => {
                        const input = buckleCards[index].querySelector(`.b-${field}`);
                        if (input && inputData[field]) {
                          input.value = inputData[field];
                        }
                      });
                    }
                  });

                  const allInputs = document.querySelectorAll('#buckles-screen input');
                  setupAutoSave(allInputs, 'buckles');
                }, 100);
              }, 50);
            }
            return true;

          case 'outerContour':
            const todayOC = new Date().toISOString().split('T')[0];
            document.getElementById('outer-contour-date').value = data.measurementDate || todayOC;
            document.getElementById('contour-tank-diameter').value = data.tankDiameter || '';
            document.getElementById('contour-point-count').value = data.pointCount || '';
            contourMode = data.mode || 'before';

            // Устанавливаем активную вкладку
            document.querySelectorAll('.contour-tab').forEach(tab => {
              tab.classList.toggle('active', tab.getAttribute('data-mode') === contourMode);
            });
            updateContourToleranceDisplay();

            if (data.inputs && data.inputs.length > 0) {
              document.getElementById('contour-point-count').value = data.inputs.length;
              setTimeout(() => {
                document.getElementById('generate-contour-button').click();

                setTimeout(() => {
                  const contourInputs = document.querySelectorAll('.val-cont');
                  data.inputs.forEach((value, index) => {
                    if (contourInputs[index] && value !== '') {
                      contourInputs[index].value = value;
                    }
                  });

                  const allInputs = document.querySelectorAll('#outer-contour-screen input');
                  setupAutoSave(allInputs, 'outerContour');
                }, 100);
              }, 50);
            }
            return true;
        }

        return false;
      }

      // --- НАВИГАЦИЯ ---
      function showScreen(screenId) {
        console.log(screenId, "screenId")
        screens.forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(screenId);
        if (target) target.classList.remove('hidden');

        // Восстанавливаем данные при показе экрана модуля
        switch (screenId) {
          case 'radial-seams-screen':
            setTimeout(() => {
              if (!restoreModuleData('radialSeams')) {
                // Настраиваем автосохранение для новых полей
                const inputs = document.querySelectorAll('#radial-seams-screen input');
                setupAutoSave(inputs, 'radialSeams');
                const dateInput = document.getElementById('radial-seams-date');
                if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
              }
            }, 100);
            break;

          case 'plate-rise-screen':
            setTimeout(() => {
              if (!restoreModuleData('plateRise')) {
                const inputs = document.querySelectorAll('#plate-rise-screen input');
                setupAutoSave(inputs, 'plateRise');
                const dateInput = document.getElementById('plate-rise-date');
                if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
              }
            }, 100);
            break;

          case 'buckles-screen':
            setTimeout(() => {
              if (!restoreModuleData('buckles')) {
                const inputs = document.querySelectorAll('#buckles-screen input');
                setupAutoSave(inputs, 'buckles');
                const dateInput = document.getElementById('buckles-date');
                if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
              }
            }, 100);
            break;

          case 'outer-contour-screen':
            setTimeout(() => {
              if (!restoreModuleData('outerContour')) {
                const inputs = document.querySelectorAll('#outer-contour-screen input');
                setupAutoSave(inputs, 'outerContour');
                const dateInput = document.getElementById('outer-contour-date');
                if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
              }
            }, 100);
            break;
        }
      }

      function showProjectList() {
        document.querySelector("header").style.display = 'none';
        document.querySelector(".container-hero").style.display = 'none';
        document.getElementById("app-bottom").style.display = 'block';
        // renderProjectList();
        showScreen('bottom-screen');

      }

      // showProjectList()
      function showBottomScreen() {
        const project = getActiveProject();
        if (project) {
          // Показываем интерфейс активного проекта (нижнюю панель)
          // document.querySelector("header").style.display = 'none';
          // document.querySelector(".container-hero").style.display = 'none';
          // document.getElementById("app-bottom").style.display = 'block';

          bottomRvsName.textContent = project.name;
          bottomRvsDate.textContent = `Дата проекта: ${project.createdAt}`;
          renderBottomModuleList(project);
          // НЕ вызываем showProjectList() здесь!
        }
      }

      showBottomScreen()
      // --- РЕНДЕРИНГ МЕНЮ ---
      function renderBottomModuleList(project = null) {
        bottomModuleList.innerHTML = '';
        const activeName = localStorage.getItem('projectActiveName');
        const allProjects = JSON.parse(localStorage.getItem('projectManagerProjects') || '[]');
        const activeProject = allProjects.find(p => p.name === activeName);

        // Используем данные из проекта, а не из константы
        const modulesToRender = [
          { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', screen: 'radial-seams-screen' },
          { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', screen: 'plate-rise-screen' },
          { id: 'buckles', text: 'Местные неровности (хлопуны)', screen: 'buckles-screen' },
          { id: 'outerContour', text: 'Отметки наружного контура днища', screen: 'outer-contour-screen' }
        ];

        modulesToRender.forEach(module => {
          // Получаем статус из данных проекта, если они существуют
          const projectSubmodule = activeProject.data && activeProject.data.bottomSubmodules ?
            activeProject.data.bottomSubmodules.find(sm => sm.id === module.id) : null;
          const status = projectSubmodule ? projectSubmodule.status : (activeProject.data && activeProject.data[module.id] ? 'completed' : 'pending');

          const wrapper = document.createElement('div');
          wrapper.className = 'module-item-wrapper';

          const btn = document.createElement('button');
          btn.textContent = module.text;
          btn.className = 'list-button';
          if (status === 'completed') {
            btn.classList.add('completed');
            btn.innerHTML += '  <small>(Завершено)</small>';
          }
          btn.addEventListener('click', () => {
            showScreen(module.screen);
          });

          wrapper.appendChild(btn);
          bottomModuleList.appendChild(wrapper);
        });
      }
      window.renderBottomModuleList = renderBottomModuleList;

      // Функция для переключения статуса подмодуля
      function toggleSubmoduleStatus(submoduleId) {
        let project = getActiveProject();
        if (!project) return;

        // Инициализируем структуру данных проекта, если она не существует
        if (!project.data) project.data = {};
        if (!project.data.bottomSubmodules) {
          project.data.bottomSubmodules = [
            { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', status: 'pending' },
            { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', status: 'pending' },
            { id: 'buckles', text: 'Местные неровности (хлопуны)', status: 'pending' },
            { id: 'outerContour', text: 'Отметки наружного контура днища', status: 'pending' }
          ];
        }

        // Находим подмодуль в данных проекта
        let submodule = project.data.bottomSubmodules.find(sm => sm.id === submoduleId);
        if (submodule) {
          // Переключаем статус
          submodule.status = submodule.status === 'completed' ? 'pending' : 'completed';
        } else {
          // Если подмодуль не найден, создаем его
          const defaultSubmodules = [
            { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', status: 'pending' },
            { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', status: 'pending' },
            { id: 'buckles', text: 'Местные неровности (хлопуны)', status: 'pending' },
            { id: 'outerContour', text: 'Отметки наружного контура днища', status: 'pending' }
          ];
          const template = defaultSubmodules.find(sm => sm.id === submoduleId);
          project.data.bottomSubmodules.push({
            ...(template || { id: submoduleId, text: submoduleId, screen: null }),
            status: 'completed'
          });
        }

        // Сохраняем изменения в проекте
        saveActiveProject(project);
        // Обновляем отображение списка
        renderBottomModuleList(project);
      }


      // --- УПРАВЛЕНИЕ ПРОЕКТАМИ ---


      document.getElementById('create-new-project-button').onclick = () => {
        document.getElementById('rvs-name').value = '';
        document.getElementById('rvs-date').valueAsDate = new Date();
        showScreen('setup-screen');
      };

      document.getElementById('start-button-bottom').onclick = () => {
        const name = document.getElementById('rvs-name').value.trim();
        const date = document.getElementById('rvs-date').value;
        if (name && date) {
          const projects = getAllProjects();
          if (projects.some(p => p.name === name)) {
            alert('Проект с таким именем уже существует'); return;
          }
          const newProj = { name, date, data: {} };
          projects.push(newProj);
          saveAllProjects(projects);
          localStorage.setItem(STORAGE_KEY_ACTIVE_NAME, name);
          showBottomScreen();
        } else {
          alert('Заполните все поля');
        }
      };
      document.getElementById('cancel-setup-button-bottom').addEventListener('click', function () {
        console.log('cancel-setup-button')
        showScreen("projectsSection")
      });
      document.querySelectorAll('.back-to-bottom').forEach(b => {
        b.addEventListener('click', function () {
          // showScreen('projectsSection');
          console.log('back-to-bottom')
          // showBottomScreen();
          showScreen('bottom-screen');

        });
      });
      document.getElementById('bottom-back-to-list-button').onclick = () => {
        showScreen('projectsSection');
        document.querySelector("header").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.getElementById("app-bottom").style.display = 'none';
      }
      document.getElementById('bottom-back-to-modules-button').onclick = () => {
        showScreen('modulesSection');
        document.querySelector("header").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.getElementById("app-bottom").style.display = 'none';
      }

      // --- УТИЛИТЫ ЭКСПОРТА В EXCEL ---
      function generateExportFilename(submoduleId, measurementDate = null) {
        const proj = getActiveProject();
        const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;
        const sanitizeName = (name) => name.trim().replace(/[^a-zA-Zа-яА-ЯёЁ0-9-]+/g, '_');
        let formattedDate = convertStorageDate(proj.date);
        if (measurementDate) {
          formattedDate = convertStorageDate(measurementDate);
        }
        return `${sanitizeName(proj.name)}_${sanitizeName(subName)}_${formattedDate}.xlsx`;
      }

      function exportToExcel(data, filename) {
        // Создаем новую рабочую книгу
        const wb = XLSX.utils.book_new();

        // Создаем рабочий лист из данных
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Добавляем лист в книгу
        XLSX.utils.book_append_sheet(wb, ws, "Данные");

        // Генерируем файл и скачиваем
        XLSX.writeFile(wb, filename);
      }

      // Функция для установки статуса "экспортировано" и обновления отображения
      function markModuleAsExported(moduleId) {
        const project = getActiveProject();
        if (project) {
          saveCompletionState(moduleId, true);
          renderBottomModuleList(getActiveProject());
        }
      }

      // ===============================================
      // === ЛОГИКА 1: Радиальные швы                ===
      // ===============================================
      const seamCountIn = document.getElementById('seam-count');
      const seamsContainer = document.getElementById('seams-inputs-container');
      const seamsRes = document.getElementById('seams-results-container');
      const plateThickIn = document.getElementById('plate-thickness');

      document.getElementById('generate-seams-button').onclick = () => {
        const c = parseInt(seamCountIn.value);
        if (!c || c < 1) return alert('Введите количество швов');
        seamsContainer.innerHTML = ''; seamsRes.innerHTML = '';

        for (let i = 1; i <= c; i++) {
          const div = document.createElement('div');
          div.className = 'seam-card';
          div.innerHTML = `
                        <h4>Шов №${i}</h4>
                        <div class="seam-input-group">
                            <label>Угловатость (мм)</label>
                            <input type="tel" class="val-ang" placeholder="Введите значение" step="0.1">
                        </div>
                        <div class="seam-input-group">
                            <label>Смещение (мм)</label>
                            <input type="tel" class="val-off" placeholder="Введите значение" step="0.1">
                        </div>
                    `;
          seamsContainer.appendChild(div);
        }

        // Настраиваем автосохранение для новых полей
        const allInputs = document.querySelectorAll('#radial-seams-screen input');
        setupAutoSave(allInputs, 'radialSeams');

        // Сохраняем текущее состояние
        saveCurrentModuleData('radialSeams');
      };

      // Кнопка сброса данных для радиальных швов
      document.getElementById('reset-seams-button').onclick = () => {
        if (confirm('Вы уверены, что хотите сбросить все данные для радиальных швов? Все введенные значения будут удалены.')) {
          seamsContainer.innerHTML = '';
          seamsRes.innerHTML = '';
          document.getElementById('seam-count').value = '';
          document.getElementById('plate-thickness').value = '10';
          document.getElementById('seam-tolerance').value = '3';

          // Очищаем сохраненные данные
          clearModuleData('radialSeams');
        }
      };

      document.getElementById('calculate-seams-button').onclick = () => {
        const angTol = parseFloat(document.getElementById('seam-tolerance').value);
        const measurementDate = document.getElementById('radial-seams-date').value || proj.date;
        const thickness = parseFloat(plateThickIn.value);
        if (isNaN(thickness) || thickness <= 0) return alert('Введите корректную толщину листов');

        let offsetTol;
        if (thickness <= 10) {
          offsetTol = 1.0;
        } else {
          const calc = thickness * 0.10;
          offsetTol = calc > 3.0 ? 3.0 : calc;
        }

        const cards = document.querySelectorAll('.seam-card');
        if (cards.length === 0) return;

        let html = `<h3>Результаты</h3>
                            <div style="font-size:0.9em; margin-bottom:10px;">
                                <b>Толщина:</b> ${thickness} мм. 
                                <b>Допуск угловатости:</b> ±${angTol} мм. 
                                <b>Допуск смещения:</b> ${Number(offsetTol).toString()} мм.
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>№</th>
                                        <th>Угловатость (мм)</th>
                                        <th>Смещение (мм)</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody>`;
        let allOk = true;

        cards.forEach((card, idx) => {
          const angInput = card.querySelector('.val-ang');
          const offInput = card.querySelector('.val-off');
          const angVal = parseFloat(angInput.value);
          const offVal = parseFloat(offInput.value);

          if (isNaN(angVal) || isNaN(offVal)) {
            html += `<tr><td>${idx + 1}</td><td colspan="2">Нет данных</td><td>-</td></tr>`;
            return;
          }
          const angOk = Math.abs(angVal) <= angTol;
          const offOk = Math.abs(offVal) <= offsetTol;
          const rowOk = angOk && offOk;
if (!rowOk) allOk = false;

// Очищаем нули для экрана
const angClean = Number(angVal).toString();
const offClean = Number(offVal).toString();

const angCell = angOk ? angClean : `<span style="color:red; font-weight:bold">${angClean}*</span>`;
const offCell = offOk ? offClean : `<span style="color:red; font-weight:bold">${offClean}*</span>`;

          html += `<tr class="${!rowOk ? 'out-of-tolerance' : ''}">
                                <td>${idx + 1}</td>
                                <td>${angCell}</td>
                                <td>${offCell}</td>
                                <td>${rowOk ? 'Норма' : 'Брак'}</td>
                             </tr>`;
        });

        html += `</tbody></table>`;
        html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ИТОГ: ${allOk ? 'ГОДНО' : 'ЕСТЬ ДЕФЕКТЫ'}</div>`;
        seamsRes.innerHTML = html;
        saveCompletionState('radialSeams', allOk);

        // Сохраняем данные после расчета
        saveCurrentModuleData('radialSeams');
      };

      document.getElementById('export-seams-excel-button').onclick = () => {
        exportSeamsToExcel();
      };

      function exportSeamsToExcel() {
        const proj = getActiveProject();
        const angTol = parseFloat(document.getElementById('seam-tolerance').value);
        const thickness = parseFloat(document.getElementById('plate-thickness').value);
        const measurementDate = document.getElementById('radial-seams-date').value || proj.date;

        let offsetTol;
        if (thickness <= 10) {
          offsetTol = 1.0;
        } else {
          const calc = thickness * 0.10;
          offsetTol = calc > 3.0 ? 3.0 : calc;
        }

        let excelData = [];

        // Заголовки
        excelData.push(['Протокол измерений: Радиальные швы']);
        excelData.push(['РВС:', proj.name]);
        excelData.push(['Модуль:', 'Днище']);
        excelData.push(['Подмодуль:', SUBMODULE_NAMES_MAP['radialSeams']]);
        excelData.push(['Дата замера:', convertStorageDate(measurementDate)]);
        excelData.push(['Толщина листов:', `${Number(thickness).toString().replace('.', ',')} мм`]);
        excelData.push(['Допуск угловатости:', `±${Number(angTol).toString().replace('.', ',')} мм`]);
        excelData.push(['Допуск смещения:', `${Number(offsetTol).toString().replace('.', ',')} мм`]);
        excelData.push(['ГОСТ:', '31385-2023, таблица 18, пункт 9.3.8']);
        excelData.push([]);

        // Заголовки таблицы
        excelData.push(['№', 'Угловатость (мм)', 'Смещение (мм)', 'Статус', 'Примечание']);

        const cards = document.querySelectorAll('.seam-card');
        let allOk = true;

        cards.forEach((card, idx) => {
          const angInput = card.querySelector('.val-ang');
          const offInput = card.querySelector('.val-off');
          const angVal = parseFloat(angInput.value);
          const offVal = parseFloat(offInput.value);

          let angValue = '', offValue = '', status = '', note = '';

          if (isNaN(angVal) || isNaN(offVal)) {
            status = 'Нет данных';
          } else {
            const angOk = Math.abs(angVal) <= angTol;
            const offOk = Math.abs(offVal) <= offsetTol;
            const rowOk = angOk && offOk;

            if (!rowOk) allOk = false;

            // Форматируем числа: убираем нули, меняем точку на запятую
            // Добавляем звездочку *, если значение вне допуска
            const angClean = Number(angVal).toString().replace('.', ',');
            angValue = angOk ? angClean : `${angClean}*`;

            const offClean = Number(offVal).toString().replace('.', ',');
            offValue = offOk ? offClean : `${offClean}*`;

            status = rowOk ? 'Норма' : 'Брак';

            let notes = [];
            if (!angOk) notes.push(`Угловатость превышает ±${Number(angTol).toString().replace('.', ',')} мм`);
            if (!offOk) notes.push(`Смещение превышает ${Number(offsetTol).toString().replace('.', ',')} мм`);
            note = notes.join('; ');
          }

          excelData.push([idx + 1, angValue, offValue, status, note]);
        });

        // Добавляем ИТОГ и примечание о звездочке
        excelData.push([]);
        if (!allOk) {
            excelData.push(['* - отклонение от допуска']);
        }
        excelData.push(['ИТОГ:', allOk ? 'ГОДНО' : 'ЕСТЬ ДЕФЕКТЫ']);

        const filename = generateExportFilename('radialSeams', measurementDate);
        exportToExcel(excelData, filename);

        // Помечаем модуль как экспортированный (завершенный)
        markModuleAsExported('radialSeams');
      }

      // ===============================================
      // === ЛОГИКА 2: Подъем окраек                 ===
      // ===============================================
      const riseCountIn = document.getElementById('rise-point-count');
      const riseContainer = document.getElementById('rise-inputs-container');
      const riseRes = document.getElementById('rise-results-container');

      document.getElementById('generate-rise-button').onclick = () => {
        const c = parseInt(riseCountIn.value);
        if (!c || c < 1) return alert('Число точек > 0');
        riseContainer.innerHTML = ''; riseRes.innerHTML = '';

        for (let i = 1; i <= c; i++) {
          const div = document.createElement('div');
          div.className = 'rise-input-card';
          div.innerHTML = `
                        <h4>Точка ${i}</h4>
                        <input type="tel" class="val-rise" placeholder="Подъем, мм" step="0.1">
                    `;
          riseContainer.appendChild(div);
        }

        // Настраиваем автосохранение для новых полей
        const allInputs = document.querySelectorAll('#plate-rise-screen input');
        setupAutoSave(allInputs, 'plateRise');

        // Сохраняем текущее состояние
        saveCurrentModuleData('plateRise');
      };

      // Кнопка сброса данных для подъема окраек
      document.getElementById('reset-rise-button').onclick = () => {
        if (confirm('Вы уверены, что хотите сбросить все данные для подъема окраек? Все введенные значения будут удалены.')) {
          riseContainer.innerHTML = '';
          riseRes.innerHTML = '';
          document.getElementById('rise-point-count').value = '8';
          document.getElementById('tank-diameter').value = '20000';
          document.getElementById('edge-length').value = '500';

          // Очищаем сохраненные данные
          clearModuleData('plateRise');
        }
      };

      document.getElementById('calculate-rise-button').onclick = () => {
        const diameter = parseFloat(document.getElementById('tank-diameter').value);
        const edgeLength = parseFloat(document.getElementById('edge-length').value);

        if (isNaN(diameter) || isNaN(edgeLength) || diameter <= 0 || edgeLength <= 0) return alert('Введите корректные данные');

        const inputs = document.querySelectorAll('.val-rise');
        if (inputs.length === 0) return;

        let delta;
        if (diameter <= 25000) delta = 0.03 * edgeLength;
        else delta = 0.04 * edgeLength;

        const lowerLimit = 0;
        const upperLimit = delta;

        riseRes.setAttribute('data-diameter', diameter.toFixed(0));
        riseRes.setAttribute('data-edge-length', edgeLength.toFixed(0));
        riseRes.setAttribute('data-delta', delta.toFixed(2));

        let html = `<h3>Результаты замера</h3>
                            <div style="font-size:0.9em; margin-bottom:10px;">
                                <b>Допуск (Δ):</b> +${delta.toFixed(2)} мм.<br>
                                <b>Критерий (h<sub>факт</sub>):</b> от ${lowerLimit.toFixed(2)} до ${upperLimit.toFixed(2)} мм.
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Точка</th>
                                        <th>Факт, мм</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody>`;
        let allOk = true;

        inputs.forEach((inp, idx) => {
          const val = parseFloat(inp.value);
          const point = idx + 1;
          if (isNaN(val)) {
            html += `<tr><td>${point}</td><td>-</td><td>Нет данных</td></tr>`;
            return;
          }

          // Сравнение идет по чистому значению, введенному пользователем
          const isOk = val >= lowerLimit && val <= upperLimit;
          if (!isOk) allOk = false;

          const status = isOk ? 'Норма' : 'Брак';
          
          // Number(...).toString() убирает только лишние нули в конце: 10.00 -> 10
          const valFormatted = Number(val).toString(); 
          const valCell = isOk ? valFormatted : `<span style="color:red; font-weight:bold">${valFormatted}*</span>`;

          html += `<tr class="${!isOk ? 'out-of-tolerance' : ''}">
                    <td>${point}</td>
                    <td>${valCell}</td>
                    <td>${status}</td>
                   </tr>`;
        });
        html += `</tbody></table>`;
        html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ИТОГ: ${allOk ? 'ГОДНО' : 'ЕСТЬ НЕСООТВЕТСТВИЯ'}</div>`;
        riseRes.innerHTML = html;
        saveCompletionState('plateRise', allOk);

        // Сохраняем данные после расчета
        saveCurrentModuleData('plateRise');
      };

      document.getElementById('export-rise-excel-button').onclick = () => {
        exportRiseToExcel();
      };

      function exportRiseToExcel() {
    const proj = getActiveProject();
    const diameter = parseFloat(document.getElementById('tank-diameter').value);
    const edgeLength = parseFloat(document.getElementById('edge-length').value);
    const measurementDate = document.getElementById('plate-rise-date').value || proj.date;
    const inputs = document.querySelectorAll('.val-rise');

    let delta = (diameter <= 25000) ? (0.03 * edgeLength) : (0.04 * edgeLength);
    const lowerLimit = 0;
    const upperLimit = delta;

    let excelData = [];
    let hasDefects = false;

    // Шапка (без лишних нулей)
    excelData.push(['Протокол измерений: Подъем окраек']);
    excelData.push(['РВС:', proj.name]);
    excelData.push(['Дата замера:', convertStorageDate(measurementDate)]);
    excelData.push(['Диаметр РВС (D):', `${Number(diameter)} мм`]);
    excelData.push(['Длина окрайки (L):', `${Number(edgeLength)} мм`]);
    excelData.push(['Допуск (Δ):', `+${Number(delta.toFixed(2))} мм`]);
    excelData.push(['Критерий:', `от ${Number(lowerLimit.toFixed(2))} до ${Number(upperLimit.toFixed(2))} мм`]);
    excelData.push([]);

    excelData.push(['Точка', 'Подъем, мм', 'Статус']);

    inputs.forEach((inp, idx) => {
        const val = parseFloat(inp.value);
        if (isNaN(val)) return;

        const isOk = val >= lowerLimit && val <= upperLimit;
        if (!isOk) hasDefects = true;

        // Чистое значение без нулей, замена точки на запятую для Excel
        const valStr = Number(val).toString().replace('.', ',');
        const star = isOk ? '' : '*';

        excelData.push([idx + 1, `${valStr}${star}`, isOk ? 'Норма' : 'Брак']);
    });

    excelData.push([]);
    // Сноска пишется ВСЕГДА
    excelData.push(['* - отклонение от допуска']);
    excelData.push(['ИТОГ:', hasDefects ? 'ЕСТЬ НЕСООТВЕТСТВИЯ' : 'ГОДНО']);

    const filename = generateExportFilename('plateRise', measurementDate);
    exportToExcel(excelData, filename);

    // ПОСЛЕ экспорта принудительно ставим ЗЕЛЕНЫЙ статус (true)
    saveCompletionState('plateRise', true);
	renderBottomModuleList(getActiveProject());
    
    // Вызов отрисовки меню, если функция существует в вашем коде
    if (typeof renderProjectTree === 'function') renderProjectTree();
}

      // ===============================================
// === ЛОГИКА 3: Хлопуны                       ===
// ===============================================
const bucklesCountIn = document.getElementById('buckle-count');
const bucklesContainer = document.getElementById('buckles-inputs-container');
const bucklesRes = document.getElementById('buckles-results-container');

document.getElementById('generate-buckles-button').onclick = () => {
    const count = parseInt(bucklesCountIn.value);
    if (!count || count < 1) {
        alert('Пожалуйста, введите количество хлопунов.');
        return;
    }

    bucklesContainer.innerHTML = '';
    bucklesRes.innerHTML = '';

    for (let i = 1; i <= count; i++) {
        const card = document.createElement('div');
        card.className = 'buckle-card';
        card.innerHTML = `
            <h4>Хлопун №${i}</h4>
            <div class="buckle-grid">
                <div class="buckle-input-group">
                    <label>Коорд. отн. оси 1 (мм)</label>
                    <input type="tel" class="b-c1">
                </div>
                <div class="buckle-input-group">
                    <label>Коорд. отн. оси 2 (мм)</label>
                    <input type="tel" class="b-c2">
                </div>
                <div class="buckle-input-group">
                    <label>Коорд. отн. оси 3 (мм)</label>
                    <input type="tel" class="b-c3">
                </div>
                <div class="buckle-input-group">
                    <label>Коорд. отн. оси 4 (мм)</label>
                    <input type="tel" class="b-c4">
                </div>
                
                <div class="buckle-input-group">
                    <label>Длина (l1), мм</label>
                    <input type="tel" class="b-l1">
                </div>
                <div class="buckle-input-group">
                    <label>Ширина (l2), мм</label>
                    <input type="tel" class="b-l2">
                </div>
                 <div class="buckle-input-group">
                    <label>Радиус (R), мм</label>
                    <input type="tel" class="b-rad" placeholder="мин. 500">
                </div>
                <div class="buckle-input-group">
                    <label style="color:#d84315; font-weight:bold;">Высота h (Факт), мм</label>
                    <input type="tel" class="b-h" style="border-color:#d84315;">
                </div>
            </div>
        `;
        bucklesContainer.appendChild(card);
    }

    const allInputs = document.querySelectorAll('#buckles-screen input');
    setupAutoSave(allInputs, 'buckles');
    saveCurrentModuleData('buckles');
};

document.getElementById('reset-buckles-button').onclick = () => {
    if (confirm('Вы уверены, что хотите сбросить все данные для хлопунов? Все введенные значения будут удалены.')) {
        bucklesContainer.innerHTML = '';
        bucklesRes.innerHTML = '';
        document.getElementById('buckle-count').value = '';
        clearModuleData('buckles');
    }
};

document.getElementById('calculate-buckles-button').onclick = () => {
    const cards = document.querySelectorAll('.buckle-card');
    if (cards.length === 0) return;

    let html = `<h3>Результаты расчета хлопунов</h3>
                <div style="font-size:0.9em; margin-bottom:10px;">
                    <b>Допуск высоты:</b> f ≤ 0,03 × R (R ≥ 500 мм)
                </div>
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">№</th>
                            <th colspan="4" class="small-header">Координаты (мм)</th>
                            <th colspan="3" class="small-header">Размеры (мм)</th>
                            <th colspan="2" class="small-header">Высота h (мм)</th>
                            <th rowspan="2">Площадь S (м²)</th>
                            <th rowspan="2">Статус</th>
                        </tr>
                        <tr>
                            <th>1</th><th>2</th><th>3</th><th>4</th>
                            <th>L1</th><th>L2</th><th>R</th>
                            <th>Факт</th><th>Допуск</th>
                        </tr>
                    </thead>
                    <tbody>`;

    let allOk = true;
    const exportData = [];

    cards.forEach((card, idx) => {
        const i = idx + 1;
        // Координаты берем как строки, чтобы сохранить вид, но для логики они не нужны
        const c1 = card.querySelector('.b-c1').value || '0';
        const c2 = card.querySelector('.b-c2').value || '0';
        const c3 = card.querySelector('.b-c3').value || '0';
        const c4 = card.querySelector('.b-c4').value || '0';

        const l1 = parseFloat(card.querySelector('.b-l1').value);
        const l2 = parseFloat(card.querySelector('.b-l2').value);
        const rad = parseFloat(card.querySelector('.b-rad').value);
        const hFact = parseFloat(card.querySelector('.b-h').value);

        if (isNaN(l1) || isNaN(l2) || isNaN(rad) || isNaN(hFact)) {
            html += `<tr><td>${i}</td><td colspan="11" style="font-style:italic;">Неполные данные</td></tr>`;
            return;
        }

        const areaMM = (Math.PI * (l1 * l2)) / 4;
        const areaM2 = areaMM / 1000000;
        const hAllow = 0.03 * rad; // Вычисляем допуск
        const isOk = hFact <= hAllow;

        if (!isOk) allOk = false;

        const status = isOk ? 'Норма' : 'НЕ ДОПУСТИМО';
        
        // Собираем данные для экспорта (чистые числа)
        exportData.push({
            i, c1, c2, c3, c4, l1, l2, rad, hFact, hAllow, areaM2, isOk, status,
            projName: getActiveProject().name
        });

        // ФОРМАТИРОВАНИЕ ДЛЯ ЭКРАНА (с точкой, без лишних нулей)
        // Для координат используем введенные значения.
        // Для размеров и факта: Number(val).toString() убирает нули (10.0 -> 10)
        
        const hFactDisplay = Number(hFact).toString();
        const hFactCell = isOk ? hFactDisplay : `<span style="color:red; font-weight:bold">${hFactDisplay}*</span>`;
        
        // Площадь всегда 3 знака
        const areaDisplay = areaM2.toFixed(3);

        html += `<tr class="${!isOk ? 'out-of-tolerance' : ''}">
                    <td>${i}</td>
                    <td>${c1}</td><td>${c2}</td><td>${c3}</td><td>${c4}</td>
                    <td>${Number(l1).toString()}</td>
                    <td>${Number(l2).toString()}</td>
                    <td>${Number(rad).toString()}</td>
                    <td>${hFactCell}</td>
                    <td>${Number(hAllow.toFixed(2)).toString()}</td>
                    <td>${areaDisplay}</td>
                    <td>${status}</td>
                 </tr>`;
    });

    html += `</tbody></table>`;
    html += `<div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ИТОГ: ${allOk ? 'ГОДНО' : 'ТРЕБУЕТСЯ РЕМОНТ'}</div>`;

    bucklesRes.innerHTML = html;
    bucklesRes.buckleData = exportData;
    
    // Сохраняем состояние расчета (но не красим меню в зеленый пока нет экспорта)
    saveCompletionState('buckles', allOk);
    saveCurrentModuleData('buckles');
};

document.getElementById('export-buckles-excel-button').onclick = () => {
    const data = document.getElementById('buckles-results-container').buckleData;
    exportBucklesToExcel(data);
};

function exportBucklesToExcel(data) {
    if (!data || data.length === 0) return alert('Нет данных для экспорта.');

    let excelData = [];

    // Заголовки
    const measurementDate = document.getElementById('buckles-date').value || getActiveProject().date;
    excelData.push(['Протокол измерений: Местные неровности (хлопуны)']);
    excelData.push(['РВС:', data[0].projName || getActiveProject().name]);
    excelData.push(['Модуль:', 'Днище']);
    excelData.push(['Подмодуль:', 'Местные неровности (хлопуны)']);
    excelData.push(['Дата замера:', convertStorageDate(measurementDate)]);
    excelData.push(['Допуск высоты:', 'f ≤ 0,03 × R (R ≥ 500 мм)']);
    excelData.push([]);

    // Заголовки таблицы
    const headers = [
        "№", "Коорд. отн. оси 1 (мм)", "Коорд. отн. оси 2 (мм)", "Коорд. отн. оси 3 (мм)", "Коорд. отн. оси 4 (мм)",
        "Длина l1 (мм)", "Ширина l2 (мм)", "Радиус R (мм)",
        "Высота h Факт (мм)", "Высота h Допуск (мм)", "Площадь S (м²)", "Статус", "Примечание"
    ];
    excelData.push(headers);

    let hasDefects = false;

    data.forEach(item => {
        if (!item.isOk) hasDefects = true;

        // ФОРМАТИРОВАНИЕ ДЛЯ EXCEL
        // 1. Убираем нули для мм: Number(val).toString()
        // 2. Меняем точку на запятую: .replace('.', ',')
        
        // Вспомогательная функция для форматирования мм
        const fmtMM = (val) => Number(val).toString().replace('.', ',');
        
        // Вспомогательная функция для форматирования метров (строго 3 знака)
        const fmtM2 = (val) => val.toFixed(3).replace('.', ',');

        const hFactVal = fmtMM(item.hFact);
        const hAllowVal = fmtMM(parseFloat(item.hAllow.toFixed(2))); // Округляем допуск до разумного, потом убираем нули

        const note = !item.isOk ? `Превышение допуска (факт: ${hFactVal} мм, допуск: ${hAllowVal} мм)` : '';

        const row = [
            item.i, 
            item.c1, item.c2, item.c3, item.c4, // Координаты оставляем как есть (текст)
            fmtMM(item.l1), 
            fmtMM(item.l2), 
            fmtMM(item.rad),
            hFactVal, 
            hAllowVal, 
            fmtM2(item.areaM2), 
            item.status, 
            note
        ];
        excelData.push(row);
    });

    excelData.push([]);
    excelData.push(['ИТОГ:', !hasDefects ? 'ГОДНО' : 'ТРЕБУЕТСЯ РЕМОНТ']);

    const filename = generateExportFilename('buckles', measurementDate);
    exportToExcel(excelData, filename);

    // --- ЛОГИКА ЗЕЛЕНОГО ЗНАЧКА ---
    // 1. Принудительно ставим "Выполнено"
    saveCompletionState('buckles', true);
    
    // 2. Мгновенно обновляем меню "Днище"
    renderBottomModuleList(getActiveProject());
}

      // ===============================================
// === ЛОГИКА 4: Наружный контур (ФИНАЛ)       ===
// ===============================================

let contourMode = 'before';
let coordSystem = 'mm';
// Инициализация переключения вкладок (Режимов)
function initContourTabs() {
    document.querySelectorAll('.contour-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            // 1. Убираем активный класс у всех и даем нажатой
            document.querySelectorAll('.contour-tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');

            // 2. Меняем режим
            contourMode = e.target.dataset.mode;

            // 3. Обновляем допуски на экране
            updateContourToleranceDisplay();

            // 4. Если таблица уже рассчитана — пересчитываем под новые допуски
            if (document.querySelectorAll('.val-cont').length > 0 && 
                document.getElementById('contour-results-container').innerHTML !== '') {
                document.getElementById('calculate-contour-button').click();
            }
        });
    });
}

function universalFormat(val, isError = false, forceMillimeters = false) {
    if (isNaN(val) || val === null || val === 0) return '0';
    
    let s;
    // Если это отметка в метрах (не принудительные мм и режим 'm')
    if (coordSystem === 'm' && !forceMillimeters) {
        s = Number(val).toFixed(3); 
    } else {
        // Для любых миллиметров (разности или отметки в мм): убираем лишние нули
        s = parseFloat(Number(val).toFixed(1)).toString(); 
    }
    
    s = s.replace('.', ',');
    return isError ? s + '*' : s;
}
// Инициализация выбора системы (мм/м)
function initCoordSelector() {
    document.querySelectorAll('input[name="coord-system"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            coordSystem = e.target.value;
            updateContourToleranceDisplay();
            if (document.querySelectorAll('.val-cont').length > 0 && document.getElementById('contour-results-container').innerHTML !== '') {
                document.getElementById('calculate-contour-button').click();
            }
        });
    });
}

// Помощник для даты ДД.ММ.ГГГГ
function formatToRussianDate(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('-');
    return parts.length === 3 ? `${parts[2]}.${parts[1]}.${parts[0]}` : dateStr;
}

// Форматтеры с очисткой нулей для ММ
function formatValue(val) {
    if (isNaN(val) || val === null || val === 0) return '0';
    if (coordSystem === 'm') {
        return Number(val).toFixed(3).replace('.', ',');
    }
    // Для мм: убираем хвосты (15.000 -> 15)
    return parseFloat(Number(val).toFixed(3)).toString().replace('.', ',');
}

function formatExcelValue(val, isError = false) {
    if (isNaN(val) || val === null || val === 0) return '0';
    
    let s;
    // Если мы в метрах И это сама отметка (v), а не разность (dAdj/dMin)
    // Разности у нас обычно приходят как числа > 0 (после умножения на 1000)
    if (coordSystem === 'm' && Math.abs(val) < 5) { 
        s = Number(val).toFixed(3); // 3 знака для метров
    } else {
        s = parseFloat(Number(val).toFixed(1)).toString(); // без лишних нулей для мм
    }
    
    s = s.replace('.', ',');
    return isError ? s + '*' : s;
}

// Допуски по ГОСТ
function getContourTolerances(diameterMm, mode) {
    if (!diameterMm || diameterMm <= 0) return null;
    const D_m = diameterMm / 1000;
    const isTesting = (mode === 'before' || mode === 'after');
    if (isTesting) {
        if (D_m <= 12) return { adj: 8, max: 15 };
        if (D_m <= 25) return { adj: 10, max: 20 };
        if (D_m <= 40) return { adj: 15, max: 25 };
        return { adj: 20, max: 30 };
    } else {
        if (D_m <= 12) return { adj: 15, max: 25 };
        if (D_m <= 25) return { adj: 20, max: 30 };
        if (D_m <= 40) return { adj: 25, max: 35 };
        return { adj: 30, max: 40 };
    }
}

function updateContourToleranceDisplay() {
    const diameter = parseFloat(document.getElementById('contour-tank-diameter').value);
    const display = document.getElementById('contour-tolerance-display');
    const tols = getContourTolerances(diameter, contourMode);
    if (tols) {
        let modeText = contourMode === 'before' ? 'До испытаний' : (contourMode === 'after' ? 'После испытаний' : 'При наливе воды');
        display.innerHTML = `
            <strong>ГОСТ 31385-2023 таб. 18</strong><br>
            <strong>Режим:</strong> ${modeText}. <strong>Диаметр:</strong> ${parseFloat(diameter)} мм.<br>
            <strong>Допуск соседних точек:</strong> ${tols.adj} мм.<br>
            <strong>Допуск разности любых точек (в т.ч. с мин):</strong> ${tols.max} мм.<br>
            <em>Примечание: разность отметок соседних точек на расстоянии не более 6 м по периметру.</em>
        `;
    } else {
        display.innerHTML = '<em>Введите диаметр для расчета допусков.</em>';
    }
}

// Генерация полей
document.getElementById('generate-contour-button').onclick = () => {
    const c = parseInt(document.getElementById('contour-point-count').value);
    if (!c || c < 4) return alert('Минимум 4 точки');
    const container = document.getElementById('contour-inputs-container');
    container.innerHTML = '';
    for (let i = 1; i <= c; i++) {
        const div = document.createElement('div');
        div.className = 'contour-input-card';
        div.innerHTML = `<span class="contour-point-label">Точка ${i}</span>
            <input type="text" class="val-cont" placeholder="0.0" inputmode="decimal" oninput="this.value = this.value.replace(',', '.').replace(/[^\\d.]/g, '')">`;
        container.appendChild(div);
    }
    setupAutoSave(document.querySelectorAll('#outer-contour-screen input'), 'outerContour');
};

// Расчет в приложении
document.getElementById('calculate-contour-button').onclick = () => {
    const diameter = parseFloat(document.getElementById('contour-tank-diameter').value);
    const tols = getContourTolerances(diameter, contourMode);
    const inputs = document.querySelectorAll('.val-cont');
    const vals = Array.from(inputs).map(i => parseFloat(i.value));
    if (vals.some(isNaN) || !tols) return alert('Заполните данные');

    const minVal = Math.min(...vals);
    let allOk = true;
    let modeText = contourMode === 'before' ? 'До испытаний' : (contourMode === 'after' ? 'После испытаний' : 'При наливе воды');

    let html = `<h3>Результаты нивелировки</h3>
                <div style="font-size:0.9em; margin-bottom:10px; color:#555;">
                    Режим: ${modeText}. Допуски: Соседние ≤ ${tols.adj}, Общие ≤ ${tols.max}.
                </div>
                <table><thead><tr>
                    <th>Точка</th><th>Отметка (${coordSystem === 'mm' ? 'мм' : 'м'})</th>
                    <th>Разность смежных (мм)</th><th>Разность с мин. (мм)</th>
                </tr></thead><tbody>`;

    vals.forEach((v, i) => {
        const prevVal = (i === 0) ? vals[vals.length - 1] : vals[i - 1];
        let dAdj = Math.abs(v - prevVal);
        let dMin = Math.abs(v - minVal);
        if (coordSystem === 'm') { dAdj *= 1000; dMin *= 1000; }
        
        const okA = dAdj <= tols.adj;
        const okM = dMin <= tols.max;
        if (!okA || !okM) allOk = false;

        html += `<tr>
            <td>${i + 1}</td>
            <td>${universalFormat(v)}</td> 
            <td style="${!okA ? 'color:red; font-weight:bold;' : ''}">${universalFormat(dAdj, !okA, true)}</td>
            <td style="${!okM ? 'color:red; font-weight:bold;' : ''}">${universalFormat(dMin, !okM, true)}</td>
        </tr>`;
    });
    
    html += `</tbody></table><div class="tolerance-summary ${allOk ? 'ok' : 'error'}">ИТОГ: ${allOk ? 'СООТВЕТСТВУЕТ' : 'НЕ СООТВЕТСТВУЕТ'}</div>`;
    document.getElementById('contour-results-container').innerHTML = html;
    
    saveCompletionState('outerContour', allOk);
    if (typeof renderBottomModuleList === 'function') renderBottomModuleList(getActiveProject());
};

// Экспорт в Excel
document.getElementById('export-contour-excel-button').onclick = () => {
    const proj = getActiveProject();
    const diameter = parseFloat(document.getElementById('contour-tank-diameter').value);
    const measurementDate = document.getElementById('outer-contour-date').value || proj.date;
    const tols = getContourTolerances(diameter, contourMode);
    const vals = Array.from(document.querySelectorAll('.val-cont')).map(i => parseFloat(i.value));
    
    if (vals.length === 0 || vals.some(isNaN)) return alert('Нет данных');

    const minVal = Math.min(...vals);
    const modeText = document.querySelector('.contour-tab.active').innerText;

    let excelData = [
        ['Протокол измерений: Наружный контур днища'],
        ['РВС:', proj.name],
        ['Дата замера:', formatToRussianDate(measurementDate)],
        ['Режим:', modeText],
        ['Система:', coordSystem === 'mm' ? 'Миллиметры' : 'Метры'],
        ['Диаметр РВС:', `${parseFloat(diameter)} мм`],
        ['Допуск соседних точек:', `≤ ${tols.adj} мм`],
        ['Допуск разности любых точек:', `≤ ${tols.max} мм`],
        ['ГОСТ:', '31385-2023, таблица 18'],
        [],
        ['Точка', `Отметка (${coordSystem})`, 'Разность смежных (мм)', 'Разность с мин. (мм)', 'Статус', 'Примечание']
    ];

    let allOk = true;
    vals.forEach((v, i) => {
        const prevVal = (i === 0) ? vals[vals.length - 1] : vals[i - 1];
        let dAdj = Math.abs(v - prevVal);
        let dMin = Math.abs(v - minVal);
        if (coordSystem === 'm') { dAdj *= 1000; dMin *= 1000; }
        
        const okA = dAdj <= tols.adj;
        const okM = dMin <= tols.max;
        const rowOk = okA && okM;
        if (!rowOk) allOk = false;

        let notes = [];
        if (!okA) notes.push(`Разность с соседней ${parseFloat(dAdj.toFixed(1)).toString().replace('.', ',')} > ${tols.adj} мм`);
        if (!okM) notes.push(`Разность с минимальной ${parseFloat(dMin.toFixed(1)).toString().replace('.', ',')} > ${tols.max} мм`);

        excelData.push([
            i + 1, 
            universalFormat(v),                // Отметка (3 знака для м, чисто для мм)
            universalFormat(dAdj, !okA, true), // Разность смежных (чисто, без нулей)
            universalFormat(dMin, !okM, true), // Разность с мин. (чисто, без нулей)
            rowOk ? 'Норма' : 'Брак',
            notes.join('; ')
        ]);
    });

    // ... здесь идет формирование excelData и расчет allOk ...

    // Добавляем итог в таблицу
    excelData.push([], ['ИТОГ:', allOk ? 'СООТВЕТСТВУЕТ' : 'НЕ СООТВЕТСТВУЕТ']);

    // Создаем и сохраняем файл (как в Хлопунах)
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    XLSX.utils.book_append_sheet(wb, ws, "Контур");
    XLSX.writeFile(wb, generateExportFilename('outerContour', measurementDate));

    // ЗАЖИГАЕМ ЗЕЛЕНЫЙ (копируем логику Хлопунов)
    saveCompletionState('outerContour', true); 
    renderBottomModuleList(getActiveProject());
}; // Конец функции onclick

// Инициализация (вне функции)
initCoordSelector();
initContourTabs();

// Кнопка очистки
const resetBtn = document.getElementById('reset-contour-button');
if (resetBtn) {
    resetBtn.onclick = () => {
        if (!confirm('Очистить все введенные отметки?')) return;
        document.querySelectorAll('.val-cont').forEach(input => input.value = '');
        const contRes = document.getElementById('contour-results-container');
        if (contRes) contRes.innerHTML = '';
        
        // Сбрасываем статус на "не готов"
        saveCompletionState('outerContour', false);
        const p = getActiveProject();
        if (p.moduleData && p.moduleData.outerContour) {
            p.moduleData.outerContour.completed = false;
            saveProject(p);
        }
        
        if (typeof renderBottomModuleList === 'function') renderBottomModuleList(p);
        alert('Данные очищены');
    };
}

// Автосохранение при закрытии/обновлении страницы
window.addEventListener('beforeunload', () => {
    const activeScreen = document.querySelector('.app-screen:not(.hidden)');
    if (activeScreen) {
        const screenId = activeScreen.id;
        switch (screenId) {
            case 'radial-seams-screen':
                saveCurrentModuleData('radialSeams');
                break;
            case 'plate-rise-screen':
                saveCurrentModuleData('plateRise');
                break;
            case 'buckles-screen':
                saveCurrentModuleData('buckles');
                break;
            case 'outer-contour-screen':
                saveCurrentModuleData('outerContour');
                break;
        }
    }
});

      // window.addEventListener('storage', (event) => {
      //     if (event.key === 'moduleStatus' && event.newValue === 'bottom-screen') {
      //         showProjectList();
      //     }
      // });

      // showBottomScreen()
      // showProjectList();
      // ИНИЦИАЛИЗАЦИЯ
      // document.getElementById('app-container').style.visibility = 'visible';
      // if(getAllProjects().length > 0) 
      // showBottomScreen();
      // else showScreen('setup-screen');
    });

  </script>
  <script>

    // ===============================================
    // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И УТИЛИТЫ ===
    // ===============================================

    // Утилиты для даты
    function formatDateToDMY(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }



    function convertStorageDate(dateString) {
      return formatDateToDMY(dateString);
    }

    function getCurrentDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    // Глобальные переменные для модуля вертикальности
    let verticalityNumBelts = 0;
    let verticalityNumGuides = 0;
    let beltHeights = [];
    let isOutsideMode = false;
    let verticalityExcelExportData = [];

    // Глобальные переменные для других модулей
    let angularData = {
      belts: 0,
      seams: 0,
      date: '',
      beltThickness: [],
      measurements: [],
      individualThickness: false
    };

    let dimensionsData = {
      diameter: {},
      height: {}
    };

    let bulgeData = {
      count: 0,
      date: '',
      measurements: []
    };

    // Глобальные константы для хранения данных
    const SUBMODULE_NAMES_MAP = {
      'verticality': 'Стенки_Вертикальность',
      'angularity': 'Стенки_Угловатость',
      'dimensions': 'Стенки_ДиаметрИВысота',
      'localDeviations': 'Стенки_Хлопуны'
    };

    // ===============================================
    // === ГЛОБАЛЬНЫЕ ФУНКЦИИ ЭКСПОРТА ===
    // ===============================================

    // Функция для генерации имени файла
    window.generateExportFilename = function (submoduleId, section = '', measurementDate = null) {
      const activeProjectName = localStorage.getItem('projectActiveName');
      if (!activeProjectName) return 'данные.xlsx';

      const projects = JSON.parse(localStorage.getItem('projectManagerProjects') || '[]');
      const proj = projects.find(p => p.name === activeProjectName);
      if (!proj) return 'данные.xlsx';

      const subName = SUBMODULE_NAMES_MAP[submoduleId] || submoduleId;
      const sanitizeName = (name) => name.trim().replace(/[^a-zA-Zа-яА-ЯёЁ0-9-]+/g, '_');

      // Используем дату замера, если она указана, иначе дату проекта
      let dateForFilename;
      if (measurementDate) {
        dateForFilename = formatDateToDMY(measurementDate).replace(/\./g, '-');
      } else {
        dateForFilename = convertStorageDate(proj.date).replace(/\./g, '-');
      }

      // Специальные имена для диаметра и высоты
      let finalName;
      if (submoduleId === 'dimensions') {
        if (section === 'Диаметр') {
          finalName = `${sanitizeName(proj.name)}_внутренний диаметр_${dateForFilename}.xlsx`;
        } else if (section === 'Высота') {
          finalName = `${sanitizeName(proj.name)}_высота стенки_${dateForFilename}.xlsx`;
        } else {
          finalName = `${sanitizeName(proj.name)}_${sanitizeName(subName)}${section ? `_${section}` : ''}_${dateForFilename}.xlsx`;
        }
      } else {
        finalName = `${sanitizeName(proj.name)}_${sanitizeName(subName)}${section ? `_${section}` : ''}_${dateForFilename}.xlsx`;
      }

      return finalName;
    };

    // Глобальная функция экспорта в Excel
    const exportToExcel1 = function (data, filename) {
      try {
        console.log('Экспорт в Excel:', { dataLength: data.length, filename });

        if (!window.XLSX) {
          throw new Error('Библиотека XLSX не загружена');
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Настраиваем ширину столбцов
        if (data[0]) {
          const colWidths = [];
          for (let i = 0; i < data[0].length; i++) {
            colWidths.push({ wch: 15 });
          }
          ws['!cols'] = colWidths;
        }

        XLSX.utils.book_append_sheet(wb, ws, "Данные");
        XLSX.writeFile(wb, filename);
        console.log('Файл успешно создан:', filename);
        return true;
      } catch (error) {
        console.error('Ошибка экспорта в Excel:', error);
        showModal('Ошибка', `Не удалось создать файл Excel: ${error.message}`);
        return false;
      }
    };

    // ===============================================
    // === ОБЩАЯ ЛОГИКА ПРИЛОЖЕНИЯ ===
    // ===============================================

    document.addEventListener('DOMContentLoaded', () => {


      const STORAGE_KEY_ALL = 'projectManagerProjects';
      const STORAGE_KEY_ACTIVE = 'projectActiveName';

      // --- ЭЛЕМЕНТЫ DOM ---
      const screens = document.querySelectorAll('.app-screen');

      const projectsListContainer = document.getElementById('projects-list-container');
      const wallModuleList = document.getElementById('wall-module-list');
      const wallRvsName = document.getElementById('wall-rvs-name');
      const wallRvsDate = document.getElementById('wall-rvs-date');

      // --- СИСТЕМА ХРАНЕНИЯ ДАННЫХ ---
      function getAllProjects() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_ALL) || '[]');
      }

      function saveAllProjects(projects) {
        localStorage.setItem(STORAGE_KEY_ALL, JSON.stringify(projects));
      }

      function getActiveProject() {
        const activeName = localStorage.getItem(STORAGE_KEY_ACTIVE);
        return getAllProjects().find(p => p.name === activeName);
      }

      function saveActiveProject(updatedProject) {
        let projects = getAllProjects();
        const index = projects.findIndex(p => p.name === updatedProject.name);
        if (index !== -1) {
          projects[index] = updatedProject;
          saveAllProjects(projects);
        }
      }

      function saveCompletionState(submoduleId, isCompleted) {
        const project = getActiveProject();
        if (!project) return null;

        if (!project.data) project.data = {};
        project.data[submoduleId] = isCompleted;

        const statusValue = isCompleted ? 'completed' : 'pending';

        const fundamentSubs = [
          { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', screen: 'annular-elevation-screen', status: 'pending' },
          { id: 'annularWidth', text: 'Ширина кольцевого фундамента', screen: 'annular-width-screen', status: 'pending' },
          { id: 'annularDiameter', text: 'Наружный диаметр фундамента', screen: 'annular-diameter-screen', status: 'pending' },
          { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', screen: 'hydroizol-elevation-screen', status: 'pending' },
          { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', screen: 'hydroizol-thickness-screen', status: 'pending' },
          { id: 'centerElevation', text: 'Отметка центра основания резервуара', screen: 'center-elevation-screen', status: 'pending' },
          { id: 'settlement', text: 'Осадка фундамента после испытаний', screen: 'settlement-screen', status: 'pending' }
        ];

        const bottomSubs = [
          { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', status: 'pending' },
          { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', status: 'pending' },
          { id: 'buckles', text: 'Местные неровности (хлопуны)', status: 'pending' },
          { id: 'outerContour', text: 'Отметки наружного контура днища', status: 'pending' }
        ];

        const wallSubs = [
          { id: 'verticality', text: 'Вертикальность стенки', screen: 'verticality-screen', status: 'pending' },
          { id: 'angularity', text: 'Угловатость стенки', screen: 'angularity-screen', status: 'pending' },
          { id: 'dimensions', text: 'Отклонения диаметра и высоты', screen: 'dimensions-screen', status: 'pending' },
          { id: 'localDeviations', text: 'Местные отклонения (хлопуны)', screen: 'local-deviations-screen', status: 'pending' }
        ];

        const ensureSubs = (key, template) => {
          if (!project.data[key]) {
            project.data[key] = JSON.parse(JSON.stringify(template));
          }
          return project.data[key];
        };

        const fundIds = fundamentSubs.map(s => s.id);
        const bottomIds = bottomSubs.map(s => s.id);
        const wallIds = wallSubs.map(s => s.id);

        if (fundIds.includes(submoduleId)) {
          const subs = ensureSubs('fundamentSubmodules', fundamentSubs);
          const sub = subs.find(sm => sm.id === submoduleId);
          if (sub) sub.status = statusValue;
        }

        if (bottomIds.includes(submoduleId)) {
          const subs = ensureSubs('bottomSubmodules', bottomSubs);
          const sub = subs.find(sm => sm.id === submoduleId);
          if (sub) sub.status = statusValue;
        }

        if (wallIds.includes(submoduleId)) {
          const subs = ensureSubs('wallSubmodules', wallSubs);
          const sub = subs.find(sm => sm.id === submoduleId);
          if (sub) sub.status = statusValue;
        }

        saveActiveProject(project);
        return project;
      }
      // Делаем доступным глобально, чтобы вызывать из функций экспорта
      window.saveCompletionState = saveCompletionState;

      // --- НАВИГАЦИЯ ---
      function showScreen(screenId) {
        screens.forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(screenId);
        if (target) {
          target.classList.remove('hidden');
          target.scrollTop = 0;

          // Автозагрузка данных при открытии модуля
          if (screenId === 'verticality-screen') {
            initVerticalityModule();
          } else if (screenId === 'angularity-screen') {
            initAngularityModule();
          } else if (screenId === 'dimensions-screen') {
            initDimensionsModule();
          } else if (screenId === 'local-deviations-screen') {
            initBulgeModule();
          }
        }
      }

      // Глобальная функция для возврата к выбору модулей
      window.backToWallScreen = function () {
        showScreen('wall-screen');
      };

      document.getElementById('back-to-wall-screen').addEventListener('click', function () {
        showScreen('wall-screen');
      });

      document.querySelectorAll('.btn-back-to-wall-screen').forEach(b => b.onclick = function () {
        showScreen('wall-screen');
      });

      function showProjectList() {
        renderProjectList();
        // showScreen('project-list-screen');
      }

      function showWallScreen() {
        const project = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
        const activeName = localStorage.getItem('projectActiveName');
        const activeProject = project.find(p => p.name === activeName);
        if (project) {
          wallRvsName.textContent = project.name;
          wallRvsDate.textContent = `Дата проекта: ${convertStorageDate(activeProject.createdAt)} | Диаметр: ${activeProject.wallDiameter || 0} мм | Высота: ${activeProject.wallHeight || 0} мм`;
          renderWallModuleList(project);

        } else {
          showProjectList();
        }
      }

      // --- РЕНДЕРИНГ МЕНЮ ---
      function renderWallModuleList(project = null) {
        wallModuleList.innerHTML = '';
        const activeName = localStorage.getItem('projectActiveName');
        const allProjects = JSON.parse(localStorage.getItem('projectManagerProjects') || '[]');
        const activeProject = allProjects.find(p => p.name === activeName);

        const modulesToRender = [
          { id: 'verticality', text: 'Вертикальность стенки', screen: 'verticality-screen' },
          { id: 'angularity', text: 'Угловатость стенки', screen: 'angularity-screen' },
          { id: 'dimensions', text: 'Отклонения диаметра и высоты', screen: 'dimensions-screen' },
          { id: 'localDeviations', text: 'Местные отклонения (хлопуны)', screen: 'local-deviations-screen' }
        ];

        modulesToRender.forEach(module => {
          // Получаем статус из данных проекта, если он существует
          const projectSubmodule = activeProject.data && activeProject.data.wallSubmodules ?
            activeProject.data.wallSubmodules.find(sm => sm.id === module.id) : null;
          const status = projectSubmodule ? projectSubmodule.status : (activeProject.data && activeProject.data[module.id] ? 'completed' : 'pending');

          const wrapper = document.createElement('div');
          wrapper.className = 'module-item-wrapper';

          const btn = document.createElement('button');
          btn.textContent = module.text;
          btn.className = 'list-button';
          if (status === 'completed') {
            btn.classList.add('completed');
            btn.textContent += ' (Завершено)';
          }
          btn.onclick = () => showScreen(module.screen);

          wrapper.appendChild(btn);
          wallModuleList.appendChild(wrapper);
        });
      }

      window.renderWallModuleList = renderWallModuleList;
      function toggleSubmoduleStatus(submoduleId) {
        let project = getActiveProject();
        if (!project) return;

        // Инициализируем структуру данных проекта, если она не существует
        if (!project.data) project.data = {};
        if (!project.data.wallSubmodules) {
          project.data.wallSubmodules = [
            { id: 'verticality', text: 'Вертикальность стенки', screen: 'verticality-screen', status: 'pending' },
            { id: 'angularity', text: 'Угловатость стенки', screen: 'angularity-screen', status: 'pending' },
            { id: 'dimensions', text: 'Отклонения диаметра и высоты', screen: 'dimensions-screen', status: 'pending' },
            { id: 'localDeviations', text: 'Местные отклонения (хлопуны)', screen: 'local-deviations-screen', status: 'pending' }
          ];
        }

        // Находим подмодуль в данных проекта
        let submodule = project.data.wallSubmodules.find(sm => sm.id === submoduleId);
        if (submodule) {
          // Переключаем статус
          submodule.status = submodule.status === 'completed' ? 'pending' : 'completed';
        } else {
          // Если подмодуль не найден, создаем его
          const defaultSubmodules = [
            { id: 'verticality', text: 'Вертикальность стенки', screen: 'verticality-screen', status: 'pending' },
            { id: 'angularity', text: 'Угловатость стенки', screen: 'angularity-screen', status: 'pending' },
            { id: 'dimensions', text: 'Отклонения диаметра и высоты', screen: 'dimensions-screen', status: 'pending' },
            { id: 'localDeviations', text: 'Местные отклонения (хлопуны)', screen: 'local-deviations-screen', status: 'pending' }
          ];
          const template = defaultSubmodules.find(sm => sm.id === submoduleId);
          project.data.wallSubmodules.push({
            ...(template || { id: submoduleId, text: submoduleId, screen: null }),
            status: 'completed'
          });
        }

        // Сохраняем изменения в проекте
        saveActiveProject(project);
        // Обновляем отображение списка
        renderWallModuleList(project);
      }
      // --- УПРАВЛЕНИЕ ПРОЕКТАМИ ---
      function renderProjectList() {
        projectsListContainer.innerHTML = '';
        const projects = getAllProjects();

        if (projects.length === 0) {
          projectsListContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 20px;">📊</div>
                            <h3 style="color: var(--primary-blue); margin-bottom: 10px;">Нет проектов</h3>
                            <p>Создайте первый проект для начала работы</p>
                        </div>`;
          return;
        }

        projects.forEach(p => {
          const row = document.createElement('div');
          row.className = 'project-row';
          row.innerHTML = `
                        <button class="list-button">
                            <div style="text-align: left;">
                                <strong style="color: var(--primary-blue);">${p.name}</strong><br>
                                <small style="color: #666;">Дата: ${convertStorageDate(p.date)} | Диаметр: ${p.diameter || '?'} мм | Высота: ${p.height || '?'} мм</small>
                            </div>
                        </button>
                        <button class="delete-button" title="Удалить проект">🗑️</button>
                    `;

          row.querySelector('.list-button').onclick = () => {
            localStorage.setItem(STORAGE_KEY_ACTIVE, p.name);
            showWallScreen();
          };

          row.querySelector('.delete-button').onclick = () => {
            if (confirm(`Удалить проект "${p.name}"? Все данные будут потеряны.`)) {
              const newProjects = projects.filter(proj => proj.name !== p.name);
              saveAllProjects(newProjects);
              renderProjectList();
            }
          };

          projectsListContainer.appendChild(row);
        });
      }

      // Создание нового проекта
      document.getElementById('create-new-project-button').onclick = () => {
        // const today = new Date();
        // document.getElementById('rvs-name').value = '';
        // document.getElementById('rvs-date').value = today.toISOString().split('T')[0];
        // document.getElementById('rvs-diameter').value = '';
        // document.getElementById('rvs-height').value = '';
        // showScreen('setup-screen-wall');
      };

      document.getElementById('start-button-wall').onclick = () => {
        const diameterElement = document.getElementById('rvs-diameter-wall')
        const heightElement = document.getElementById('rvs-height')
        const activeName = localStorage.getItem("projectActiveName");
        const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');

        const activeProject = projects.find(project => project.name === activeName);

        // Устанавливаем значения из проекта в поля формы, если они существуют и не равны 0
        // if (activeProject) {
        //     if (activeProject.wallDiameter) {
        //         diameterElement.value = activeProject.wallDiameter;
        //     }
        //     if (activeProject.wallHeight) {
        //         heightElement.value = activeProject.wallHeight;
        //     }
        // }

        console.log(diameterElement.value, 'диаметр')
        console.log(heightElement.value, 'высота')
        // Получаем имя активного проекта

        if (!activeName) {
          alert('Нет активного проекта');
          return;
        }

        // Загружаем все проекты


        // Находим индекс активного проекта
        const index = projects.findIndex(p => p.name === activeName);
        if (index === -1) {
          alert('Активный проект не найден в списке');
          return;
        }

        // Обновляем проект
        projects[index] = {
          ...projects[index], // сохраняем все существующие поля (name, createdAt, data и т.д.)
          wallDiameter: parseFloat(diameterElement.value),
          wallHeight: parseFloat(heightElement.value)
        };

        localStorage.setItem("projectManagerProjects", JSON.stringify(projects));
        showWallScreen()
        showScreen('wall-screen');

      };

      const cancelWallBtn = document.getElementById('cancel-setup-button-wall');
      if (cancelWallBtn) {
        cancelWallBtn.addEventListener('click', function () {
          showScreen("projectsSection")
          document.querySelector("header").style.display = 'block';
          document.querySelector(".container-hero").style.display = 'block';
          document.querySelector(".main-content").style.display = 'block';
          document.getElementById("app-wall").style.display = 'none';

        });
      }

      // Навигационные кнопки
      const wallBackToListBtn = document.getElementById('wall-back-to-list-button');
      if (wallBackToListBtn) {
        wallBackToListBtn.addEventListener('click', function () {
          showScreen("projectsSection")
          document.querySelector("header").style.display = 'block';
          document.querySelector(".container-hero").style.display = 'block';
          document.querySelector(".main-content").style.display = 'block';
          document.getElementById("app-wall").style.display = 'none';
        });
      }
      const wallBackToModulesBtn = document.getElementById('wall-back-to-modules-button');
      if (wallBackToModulesBtn) {
        wallBackToModulesBtn.addEventListener('click', function () {
          showScreen("modulesSection");
          document.querySelector("header").style.display = 'block';
          document.querySelector(".container-hero").style.display = 'block';
          document.querySelector(".main-content").style.display = 'block';
          document.getElementById("app-wall").style.display = 'none';
        });
      }
      const wallMenuBackBtn = document.getElementById('wallmenu-back-to-modules-button');
      if (wallMenuBackBtn) {
        wallMenuBackBtn.addEventListener('click', function () {
          showScreen("modulesSection");
          document.querySelector("header").style.display = 'block';
          document.querySelector(".container-hero").style.display = 'block';
          document.querySelector(".main-content").style.display = 'block';
          document.getElementById("app-wall").style.display = 'none';
        });
      }

      // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
      function initApp() {
        // document.getElementById('app-wall').style.visibility = 'visible';

        // Устанавливаем сегодняшнюю дату по умолчанию
        const today = getCurrentDate();
        document.getElementById('angular-measurement-date').value = today;
        document.getElementById('diameter-measurement-date').value = today;
        document.getElementById('height-measurement-date').value = today;
        document.getElementById('bulge-measurement-date').value = today;

        const projects = getAllProjects();
        if (projects.length > 0) {
          showProjectList();
        } else {
          showScreen('setup-screen-wall');
        }
      }


    });

    // ===============================================
    // === МОДУЛЬ 1: ВЕРТИКАЛЬНОСТЬ ===
    // ===============================================
function formatMM(value) {
  if (value === null || value === undefined || isNaN(value)) return '';

  const num = Number(value);

  // если целое — возвращаем как есть
  if (Number.isInteger(num)) {
    return String(num);
  }

  // если дробное — убираем ТОЛЬКО незначащие нули
  return num.toString().replace(/(\.\d*?[1-9])0+$/, '$1');
}


function formatMMExcel(value) {
  if (value === null || value === undefined || isNaN(value)) return '';

  const num = Number(value);

  if (Number.isInteger(num)) {
    return String(num);
  }

  return num
    .toString()
    .replace(/(\.\d*?[1-9])0+$/, '$1')
    .replace('.', ',');
}


    // Инициализация модуля вертикальности
    function initVerticalityModule() {
      console.log('Инициализация модуля вертикальности');

      // Устанавливаем сегодняшнюю дату по умолчанию
      const dateInput = document.getElementById('tank-date');
      if (dateInput) {
        dateInput.value = getCurrentDate();
      }

      // Сбрасываем состояние при открытии
      isOutsideMode = false;
      updateOutsideButtonState();

      // Убедимся, что все блоки в правильном состоянии
      document.getElementById('settings-input').classList.remove('hidden');
document.getElementById('data-input').classList.add('hidden');
document.getElementById('results-block').classList.add('hidden');


      // Устанавливаем режим "Внутри" по умолчанию
      document.getElementById('results-mode').textContent = 'Внутри';

      console.log('Модуль вертикальности инициализирован');
    }

    // --- Управление модальными окнами ---
    function showModal(title, body) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = body;
      document.getElementById('message-modal').classList.add('visible');
    }

    function closeModal() {
      document.getElementById('message-modal').classList.remove('visible');
    }
    // document.getElementById('wall-close-modal').addEventListener('click', closeModal);

    // --- Модальное окно высоты поясов ---
    function setBeltSettingsButtonActive() {
      const btn = document.getElementById('belt-settings-btn');
      if (btn) {
        btn.style.backgroundColor = '#22c55e';
        btn.style.color = 'white';
        btn.style.borderColor = '#16a34a';
      }
    }

    function openBeltHeightModal() {
      const numBeltsInput = parseInt(document.getElementById('num-belts').value) || 0;
      const defaultHeight = parseFloat(document.getElementById('wall-height-mm').value) || 0;
      const container = document.getElementById('belt-height-inputs');
      container.innerHTML = '';

      if (numBeltsInput <= 0) {
        return showModal('Внимание', 'Сначала введите количество поясов');
      }

      for (let k = 1; k <= numBeltsInput; k++) {
        const currentHeight = (beltHeights[k - 1] !== undefined) ? beltHeights[k - 1] : defaultHeight;
        const inputHtml = `
                    <div class="belt-height-input-row">
                        <label>Пояс ${k}:</label>
                        <input type="tel" id="modal-belt-${k}" value="${currentHeight}" placeholder="Высота в мм">
                    </div>
                `;
        container.insertAdjacentHTML('beforeend', inputHtml);
      }
      document.getElementById('belt-height-modal').classList.add('visible');
    }

    document.getElementById("belt-settings-btn").onclick = () => {
      openBeltHeightModal();
    };
    function closeBeltHeightModal() {
      document.getElementById('belt-height-modal').classList.remove('visible');
    }
    this.closeBeltHeightModal = closeBeltHeightModal;

    function saveBeltHeights() {
      const numBeltsInput = parseInt(document.getElementById('num-belts').value);
      beltHeights = [];
      let firstBeltHeight = 0;

      for (let k = 1; k <= numBeltsInput; k++) {
        const val = parseFloat(document.getElementById(`modal-belt-${k}`).value) || 0;
        if (k === 1) firstBeltHeight = val;
        beltHeights.push(val);
      }

      document.getElementById('wall-height-mm').value = firstBeltHeight;

      // Обновляем кнопку настроек
      if (beltHeights.length > 0) {
        setBeltSettingsButtonActive();
      }

      closeBeltHeightModal();
    }
    this.saveBeltHeights = saveBeltHeights;

    // --- Генерация сетки для ввода данных ---
    function setupInputGrid() {
      console.log('setupInputGrid вызван');

      const tankName = document.getElementById('tank-name').value.trim();
      const tankDate = document.getElementById('tank-date').value;

      verticalityNumBelts = parseInt(document.getElementById('num-belts').value);
      verticalityNumGuides = parseInt(document.getElementById('num-guides').value);
      const wallHeight = document.getElementById('wall-height-mm').value.trim();
      const wallHeightVal = parseFloat(wallHeight);

      if (!tankName) {
        return showModal('Ошибка', 'Введите название резервуара');
      }

      if (beltHeights.length === 0) {
        if (!wallHeight || isNaN(wallHeightVal) || wallHeightVal <= 0) {
          return showModal('Ошибка', 'Введите "Высота 1-го пояса" или настройте высоты через кнопку "Настроить все пояса"');
        }
        beltHeights = [];
        for (let k = 0; k < verticalityNumBelts; k++) {
          beltHeights.push(wallHeightVal);
        }
      }

      if (isNaN(verticalityNumBelts) || verticalityNumBelts <= 0 || isNaN(verticalityNumGuides) || verticalityNumGuides <= 0) {
        return showModal('Ошибка', 'Количество поясов и направляющих должно быть больше 0');
      }

      renderGrid(verticalityNumGuides, verticalityNumBelts);

      // Переключаем экраны
document.getElementById('settings-input').classList.add('hidden');
document.getElementById('data-input').classList.remove('hidden');
document.getElementById('results-block').classList.add('hidden');


      // Прокручиваем к началу формы ввода
      setTimeout(() => {
        document.getElementById('data-input').scrollIntoView({ behavior: 'smooth' });
      }, 100);

      // Обновляем отображение текущих настроек
      const display = document.getElementById('current-settings-display');
      const allSameHeight = beltHeights.every(h => h === beltHeights[0]);
      const heightDisplay = allSameHeight
  ? `${formatMM(beltHeights[0])} мм`
  : `(Настроено индивидуально)`;

      display.innerHTML = `
                <strong>${tankName}</strong> (${formatDateToDMY(tankDate)})<br>
                Высота поясов${heightDisplay}<br>
                Сетка: <strong>${verticalityNumBelts}</strong> поясов, <strong>${verticalityNumGuides}</strong> направляющих
            `;

      console.log('Сетка создана успешно');
    }

    document.getElementById('wall-btn-setup-input-grid').addEventListener('click', function () {
      setupInputGrid();
    });

    function renderGrid(guides, belts) {
      console.log(`renderGrid: ${guides} направляющих, ${belts} поясов`);

      const gridContainer = document.getElementById('guide-input-grid');
      gridContainer.innerHTML = '';

      for (let i = 1; i <= guides; i++) {
        const card = document.createElement('div');
        card.className = 'guide-card';

        let titleHtml = `
                    <div class="guide-card-title">
                        <span>
                            Направляющая ${i}
                        </span> 
                        <span style="color: #6b7280; font-size: 0.9em; background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">
                            A + ${belts} т.
                        </span>
                    </div>
                `;

        const inputsContainer = document.createElement('div');
        inputsContainer.className = 'guide-card-inputs';

        for (let j = 0; j <= belts; j++) {
          const input = document.createElement('input');
          input.type = 'number';
          input.inputmode = 'decimal';
          input.id = `guide-${i}-belt-${j}`;
          input.placeholder = j === 0 ? 'A' : `B${j}`;
          input.setAttribute('data-guide', i);

          // Навигация по полям с помощью Enter
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              let nextJ = j + 1;
              let nextI = i;
              if (nextJ > belts) { nextJ = 0; nextI = i + 1; }
              if (nextI > guides) {
                // Переходим к кнопке расчета
                const calcButton = document.querySelector('#data-input .btn.success');
                if (calcButton) calcButton.focus();
                return;
              }
              const nextInput = document.getElementById(`guide-${nextI}-belt-${nextJ}`);
              if (nextInput) {
                nextInput.focus();
                nextInput.select();
              }
            }
          });

          inputsContainer.appendChild(input);
        }
        card.innerHTML = titleHtml;
        card.appendChild(inputsContainer);
        gridContainer.appendChild(card);
      }

      console.log(`Сетка отрисована: ${gridContainer.children.length} карточек`);
    }

    // --- Навигация между экранами ---
    function backToSettingsVertical() {
  console.log('Назад к настройкам');

  document.getElementById('settings-input').classList.remove('hidden');
  document.getElementById('data-input').classList.add('hidden');
  document.getElementById('results-block').classList.add('hidden');

  // Сбрасываем режим "Снаружи"
  isOutsideMode = false;
  updateOutsideButtonState();

  setTimeout(() => {
    document.getElementById('verticality-screen')
      .scrollIntoView({ behavior: 'smooth' });
  }, 100);
}


    function backToInputVertical() {
      console.log('Назад к вводу данных');

      document.getElementById('settings-input').classList.add('hidden');
document.getElementById('results-block').classList.add('hidden');
document.getElementById('data-input').classList.remove('hidden');


      setTimeout(() => {
        const grid = document.getElementById('guide-input-grid');
        if (grid) {
          grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }
	
	// --- Привязка кнопок навигации ---

const backToSettingsBtn = document.getElementById('wall-back-vertical-settings');
if (backToSettingsBtn) {
  backToSettingsBtn.addEventListener('click', backToSettingsVertical);
}



const backToInputBtn = document.getElementById('wall-to-input-vertival');
if (backToInputBtn) {
  backToInputBtn.addEventListener('click', backToInputVertical);
}

    function resetFormVertical() {
  console.log('Сброс данных направляющих');

  const grid = document.getElementById('guide-input-grid');
  if (!grid) return;

  const inputs = grid.querySelectorAll('input');

  inputs.forEach(input => {
    input.value = '';
  });
}


    document.getElementById('wall-reset-vertial').onclick = resetFormVertical;

    // --- Кнопка "Снаружи" ---
    function toggleOutsideMode() {
      isOutsideMode = !isOutsideMode;
      console.log(`Режим "Снаружи": ${isOutsideMode}`);
      updateOutsideButtonState();

      // Обновляем отображение режима
      document.getElementById('results-mode').textContent = isOutsideMode ? 'Снаружи' : 'Внутри';

      // Пересчитываем и перерисовываем таблицу
      if (verticalityExcelExportData.length > 0) {
        calculateAndRenderTable();
      }
    }


    function updateOutsideButtonState() {
      const btn = document.getElementById('btn-outside-mode');
      if (!btn) return;

      if (isOutsideMode) {
        btn.classList.add('active');
        btn.textContent = 'Снаружи ✓';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'Снаружи';
      }
    }

    // --- Основной расчет ---
    function processData() {
      console.log('processData вызван');

      const numGuidesVal = parseInt(document.getElementById('num-guides').value);
      const numBeltsVal = parseInt(document.getElementById('num-belts').value);
      const tankName = document.getElementById('tank-name').value;
      const tankDate = document.getElementById('tank-date').value;

      // Проверка высот
      if (beltHeights.length !== numBeltsVal) {
        const wallHeightInput = parseFloat(document.getElementById('wall-height-mm').value);
        beltHeights = [];
        for (let k = 0; k < numBeltsVal; k++) {
          beltHeights.push(wallHeightInput);
        }
      }

      // Переключаем экраны
      document.getElementById('settings-input').classList.add('hidden');
document.getElementById('data-input').classList.add('hidden');
document.getElementById('results-block').classList.remove('hidden');


      // Обновляем информацию в блоке параметров
      document.getElementById('results-tank-name').textContent = tankName;
      document.getElementById('results-tank-date').textContent = formatDateToDMY(tankDate);
      document.getElementById('results-mode').textContent = isOutsideMode ? 'Снаружи' : 'Внутри';

      // ВЫПОЛНЯЕМ РАСЧЕТ
      calculateAndRenderTable();

      // Помечаем модуль как выполненный
      saveCompletionState('verticality', true);
      renderWallModuleList(getActiveProject());

      // Прокручиваем к результатам
      setTimeout(() => {
        document.getElementById('results-block').scrollIntoView({ behavior: 'smooth' });
      }, 100);

      console.log('Расчет завершен, результаты должны отображаться');
    }
    document.getElementById('wall-process-data').onclick = processData;

    function calculateAndRenderTable() {
      console.log('calculateAndRenderTable вызван');

      const numGuidesVal = parseInt(document.getElementById('num-guides').value);
      const numBeltsVal = parseInt(document.getElementById('num-belts').value);
      const tankName = document.getElementById('tank-name').value;
      const tankDate = document.getElementById('tank-date').value;
      const formattedDate = formatDateToDMY(tankDate);

      // Формируем данные для Excel
      verticalityExcelExportData = [];

      // Заголовок
      verticalityExcelExportData.push(['Резервуар:', tankName, 'Дата:', formattedDate]);
      verticalityExcelExportData.push(['Режим:', isOutsideMode ? 'Снаружи (знаки инвертированы)' : 'Внутри (стандарт)']);
      verticalityExcelExportData.push(['ГОСТ:', '31385-2023, таблица 19']);
      verticalityExcelExportData.push([]);

      // Заголовки столбцов
      const headers = ['Направляющая'];
      for (let k = 1; k <= numBeltsVal; k++) {
        headers.push(`Пояс ${k}`);
      }
      verticalityExcelExportData.push(headers);

      let toleranceValuesNumeric = [];
      let cumulativeHeight = 0;

      // 1. Расчет допусков (ГОСТ: (H-50)/200)
      for (let k = 0; k < numBeltsVal; k++) {
        cumulativeHeight += beltHeights[k];
        const toleranceNumeric = (cumulativeHeight - 50) / 200;
        toleranceValuesNumeric.push(toleranceNumeric);
      }

      // 2. Создаем HTML таблицу
      const allSameHeight = beltHeights.every(h => h === beltHeights[0]);
      const heightDisplay = allSameHeight
  ? `: <strong>${formatMM(beltHeights[0])} мм</strong>`
        : `(Настроено индивидуально)`;

      const modeText = isOutsideMode ?
        '<span style="color:#22c55e; font-weight:600;">Снаружи</span>' :
        '<span style="color:#4b5563;">Внутри</span>';

      let tableHtml = `
                <thead>
                    <tr>
                        <th colspan="${numBeltsVal + 1}" style="background: linear-gradient(135deg, var(--primary-blue) 0%, #0c4a6e 100%); padding: 20px;">
                            <div style="font-size: 1.3em; font-weight: 700; color: white; margin-bottom: 8px; text-align: center;">
                                ${tankName}
                            </div>
                            <div style="font-size: 0.95em; color: rgba(255,255,255,0.9); text-align: center;">
                                Дата: ${formattedDate} | Режим: ${modeText} | Высота поясов: ${heightDisplay}
                            </div>
                        </th>
                    </tr>
                    <tr>
                        <th style="background: linear-gradient(135deg, var(--accent-blue) 0%, #0284c7 100%); color: white; font-weight: 600; padding: 16px 12px; font-size: 1em; border-right: 2px solid white;">
                            Направляющая
                        </th>`;

      for (let k = 1; k <= numBeltsVal; k++) {
        tableHtml += `
                    <th style="background: linear-gradient(135deg, var(--accent-blue) 0%, #0284c7 100%); color: white; font-weight: 600; padding: 16px 8px; font-size: 1em; border-left: ${k === 1 ? '2px solid white' : 'none'};">
                        Пояс ${k}<br>
                        <span style="font-size: 0.85em; font-weight: normal; opacity: 0.9;">±${formatMM(toleranceValuesNumeric[k - 1])} мм</span>
                    </th>`;
      }
      tableHtml += `</tr></thead><tbody>`;

      // 3. Расчет значений для каждой направляющей
      for (let i = 1; i <= numGuidesVal; i++) {
        const baseInput = document.getElementById(`guide-${i}-belt-0`);
        const baseVal = parseFloat(baseInput.value);

        const rowData = [`Напр. ${i}`];

        tableHtml += `
                    <tr>
                        <td style="font-weight: 700; background: #f8f9fa; color: var(--primary-blue); padding: 14px 12px; text-align: center; border-right: 2px solid var(--light-border); font-size: 1.05em; vertical-align: middle;">
                            Напр. ${i}
                        </td>`;

        for (let j = 1; j <= numBeltsVal; j++) {
          const valInput = document.getElementById(`guide-${i}-belt-${j}`);
          const val = parseFloat(valInput.value);

          if (!isNaN(baseVal) && !isNaN(val)) {
            let diff = (val - baseVal);

            // Если включен режим "Снаружи", инвертируем знак
            if (isOutsideMode) {
              diff = -diff;
            }

            const diffFormatted = formatMM(diff);
            const currentTolerance = toleranceValuesNumeric[j - 1];

            let cellClass = '';
let displayValue = diffFormatted;
let exportValue = formatMMExcel(diff);


            let cellStyle = '';

            // Проверка на допуск (берем абсолютное значение отклонения)
            if (Math.abs(diff) > currentTolerance) {
              cellClass = 'out-of-tolerance';
              cellStyle = 'background-color: #fceded !important; color: var(--danger-red); font-weight: 700;';
              displayValue = diffFormatted;
              exportValue = formatMMExcel(diff) + '*'; // добавляем звёздочку для XLSX при недопуске
            } else {
              cellStyle = 'background-color: ' + (i % 2 === 0 ? 'var(--light-blue)' : 'white') + ';';
            }

            tableHtml += `
                            <td class="${cellClass}" style="${cellStyle} padding: 14px 8px; text-align: center; vertical-align: middle; font-size: 1.05em; border: 1px solid var(--light-border); transition: all 0.2s ease;">
                                ${displayValue}
                            </td>`;
            rowData.push(exportValue);
          } else {
            tableHtml += `
                            <td style="background-color: ${i % 2 === 0 ? 'var(--light-blue)' : 'white'}; padding: 14px 8px; text-align: center; vertical-align: middle; color: #999; border: 1px solid var(--light-border);">
                                -
                            </td>`;
            rowData.push('-');
          }
        }
        tableHtml += `</tr>`;
        verticalityExcelExportData.push(rowData);
      }

      // 4. Строка Допусков
      tableHtml += `
                <tr style="background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%) !important; color: white; font-weight: 700; border-top: 3px solid var(--accent-blue);">
                    <td style="font-weight: 700; padding: 16px 12px; text-align: center; border-right: 2px solid white; font-size: 1.05em;">
                        Допуск ГОСТ ±
                    </td>`;

      const toleranceRow = ['Допуск (±)'];
      for (let k = 0; k < toleranceValuesNumeric.length; k++) {
        const tolVal = formatMM(toleranceValuesNumeric[k]);
        tableHtml += `
                    <td style="padding: 16px 8px; text-align: center; vertical-align: middle; font-size: 1.05em; border-left: ${k === 0 ? '2px solid white' : '1px solid rgba(255,255,255,0.3)'};">
                        ${tolVal}
                    </td>`;
        toleranceRow.push(formatMMExcel(toleranceValuesNumeric[k]));
      }
      tableHtml += `</tr></tbody>`;
      verticalityExcelExportData.push(toleranceRow);

      // Добавляем примечание в Excel
      verticalityExcelExportData.push([]);
      verticalityExcelExportData.push(['ПРИМЕЧАНИЕ (ГОСТ 31385-2023, таб. 19):']);
      verticalityExcelExportData.push(['Отклонение по вертикали образующих на высоте каждого пояса: ±1/200 Н (где Н — расстояние от днища до точки измерения)']);
      verticalityExcelExportData.push(['Измерения проводят не реже, чем через каждые 6 м, по всему периметру стенки.']);
      verticalityExcelExportData.push(['Измерения проводят в пределах 50 мм ниже горизонтальных швов.']);
      verticalityExcelExportData.push(['* — значения, превышающие допуск']);

      const resultsTable = document.getElementById('results-table');
      if (resultsTable) {
        resultsTable.innerHTML = tableHtml;
        console.log('Таблица результатов заполнена');
      } else {
        console.error('Элемент results-table не найден!');
      }
    }

    // --- Экспорт в Excel ---
    function exportVerticalityToExcel() {
      console.log('exportVerticalityToExcel вызван');

      console.log('verticalityExcelExportData', verticalityExcelExportData);
      if (!verticalityExcelExportData || verticalityExcelExportData.length === 0) {
        return showModal('Ошибка', 'Нет данных для экспорта. Сначала выполните расчет.');
      }

      try {
        // Получаем данные для имени файла
        const tankName = document.getElementById('tank-name').value;
        const numBeltsVal = parseInt(document.getElementById('num-belts').value);
        const tankDate = document.getElementById('tank-date').value;
        const formattedDate = formatDateToDMY(tankDate);

        // Функция для правильного склонения слова "пояс"
        function getBeltWordForm(count) {
          const lastDigit = count % 10;
          const lastTwoDigits = count % 100;

          if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
            return 'поясов';
          }

          if (lastDigit === 1) {
            return 'пояс';
          } else if (lastDigit >= 2 && lastDigit <= 4) {
            return 'пояса';
          } else {
            return 'поясов';
          }
        }

        const beltWordForm = getBeltWordForm(numBeltsVal);

        // Формируем имя файла
        const cleanTankName = tankName
          .replace(/\s+/g, '_')
          .replace(/[<>:"/\\|?*]/g, '')
          .trim();

        const fileName = `РВС_${cleanTankName}_вертикальность_${numBeltsVal}${beltWordForm}_${formattedDate.replace(/\./g, '-')}.xlsx`;

        // Генерируем файл и скачиваем
        const success = exportToExcel1(verticalityExcelExportData, fileName);

        if (success) {
          showModal('Успех', `Файл Excel успешно создан: ${fileName}`);

          saveCompletionState('verticality', true);
          renderWallModuleList(getActiveProject());
        } else {
          showModal('Ошибка', 'Не удалось создать файл Excel');
        }
      } catch (error) {
        console.error('Ошибка экспорта в Excel:', error);
        showModal('Ошибка', 'Не удалось создать файл Excel. Проверьте подключение библиотеки.');
      }
    }

    this.exportVerticalityToExcel = exportVerticalityToExcel;

    // ===============================================
    // === МОДУЛЬ 2: УГЛОВАТОСТЬ ===
    // ===============================================
function formatNumber(value) {
  return Number.isInteger(value) ? value : parseFloat(value.toString());
}


    function initAngularityModule() {
      // Устанавливаем сегодняшнюю дату по умолчанию
      const dateInput = document.getElementById('angular-measurement-date');
      if (dateInput && !dateInput.value) {
        dateInput.value = getCurrentDate();
      }

      // Обработчики событий
      document.getElementById('setup-angular-button').onclick = setupAngularParameters;
      document.getElementById('reset-all-angular-button').onclick = resetAngularForm;
      document.getElementById('calculate-angular-button').onclick = calculateAngularity;

      // Исправляем обработчик кнопки экспорта
      const exportButton = document.querySelector('#angular-calc-buttons .export-excel');
      if (exportButton) {
        exportButton.onclick = exportAngularToExcel;
      }

      document.getElementById('setup-individual-thickness').onclick = openBeltThicknessModal;

      // Инициализация данных
      angularData = {
        belts: 0,
        seams: 0,
        date: '',
        beltThickness: [],
        measurements: [],
        individualThickness: false
      };
    }

    function openBeltThicknessModal() {
      const belts = parseInt(document.getElementById('angular-belts').value) || 0;
      if (belts <= 0) {
        showModal('Внимание', 'Сначала введите количество поясов');
        return;
      }

      const container = document.getElementById('belt-thickness-modal-inputs');
      container.innerHTML = '';

      // Создаем поля для ввода толщины каждого пояса
      for (let b = 1; b <= belts; b++) {
        const inputHtml = `
                    <div class="belt-height-input-row">
                        <label>Толщина пояса ${b} (мм):</label>
                        <input type="tel" 
                               id="modal-thickness-${b}" 
                               placeholder="Например, 10" 
                               step="0.1"
                               min="5"
                               value="${angularData.beltThickness[b - 1] || ''}">
                    </div>
                `;
        container.insertAdjacentHTML('beforeend', inputHtml);
      }

      document.getElementById('belt-thickness-modal').classList.add('visible');
    }

    function closeBeltThicknessModal() {
      document.getElementById('belt-thickness-modal').classList.remove('visible');
    }
    this.closeBeltThicknessModal = closeBeltThicknessModal;

    function saveBeltThickness() {
      const belts = parseInt(document.getElementById('angular-belts').value);
      angularData.beltThickness = [];
      angularData.individualThickness = true;

      for (let b = 1; b <= belts; b++) {
        const thickness = parseFloat(document.getElementById(`modal-thickness-${b}`).value) || 0;
        if (thickness <= 0) {
          showModal('Ошибка', `Введите толщину для пояса ${b}`);
          return;
        }
        angularData.beltThickness.push(thickness);
      }

      closeBeltThicknessModal();
      generateAngularTable();
    }

    this.saveBeltThickness = saveBeltThickness;
    function setupAngularParameters() {
      const belts = parseInt(document.getElementById('angular-belts').value) || 0;
      const seams = parseInt(document.getElementById('angular-seams').value) || 0;
      const date = document.getElementById('angular-measurement-date').value;
      const commonThickness = parseFloat(document.getElementById('common-thickness').value) || 0;

      if (belts <= 0 || seams <= 0) {
        showModal('Ошибка', 'Введите количество поясов и стыков');
        return;
      }

      if (!date) {
        showModal('Ошибка', 'Введите дату замера');
        return;
      }

      // Если не настроена индивидуальная толщина, используем общую
      if (!angularData.individualThickness) {
        if (commonThickness <= 0) {
          showModal('Ошибка', 'Введите толщину поясов');
          return;
        }
        angularData.beltThickness = [];
        for (let b = 0; b < belts; b++) {
          angularData.beltThickness.push(commonThickness);
        }
      } else if (angularData.beltThickness.length !== belts) {
        // Если количество поясов изменилось, сбрасываем индивидуальную настройку
        angularData.individualThickness = false;
        angularData.beltThickness = [];
        for (let b = 0; b < belts; b++) {
          angularData.beltThickness.push(commonThickness);
        }
      }

      // Сохраняем базовые параметры
      angularData.belts = belts;
      angularData.seams = seams;
      angularData.date = date;

      // Создаем таблицу
      generateAngularTable();
    }

    function generateAngularTable() {
      const belts = angularData.belts;
      const seams = angularData.seams;

      const container = document.getElementById('angular-inputs-container');
      container.innerHTML = '';

      // Создаем заголовок таблицы
      let tableHtml = `
                <table class="bulge-table" id="angular-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Пояс №</th>
                            <th rowspan="2">Толщина, мм</th>
                            <th rowspan="2">Допуск, мм</th>
                            <th colspan="${seams}">Угловатость f (мм) по вертикальным стыкам</th>
                        </tr>
                        <tr>`;

      for (let s = 1; s <= seams; s++) {
        tableHtml += `<th>Стык ${s}</th>`;
      }
      tableHtml += `</tr></thead><tbody>`;

      // Создаем строки для каждого пояса
      for (let b = 1; b <= belts; b++) {
        const thickness = angularData.beltThickness[b - 1];
        let tolerance;

        // Определяем допуск по толщине
        if (thickness >= 5 && thickness <= 10) {
          tolerance = 8;
        } else if (thickness > 10 && thickness <= 15) {
          tolerance = 7;
        } else if (thickness > 15) {
          tolerance = 5;
        } else {
          tolerance = 8; // По умолчанию
        }

        tableHtml += `
                    <tr>
                        <td style="font-weight: bold;">Пояс ${b}</td>
                        <td>${formatNumber(thickness)}</td>
                        <td style="color: var(--primary-blue); font-weight: bold;">±${tolerance}</td>`;

        for (let s = 1; s <= seams; s++) {
          tableHtml += `
                        <td>
                            <input type="tel" 
                                   id="angular-b${b}-s${s}" 
                                   placeholder="0" 
                                   step="0.1"
                                   data-belt="${b}"
                                   data-seam="${s}"
                                   data-tolerance="${tolerance}"
                                   class="angular-input">
                        </td>`;
        }
        tableHtml += `</tr>`;
      }

      tableHtml += `</tbody></table>`;
      container.innerHTML = tableHtml;
      container.style.display = 'block';

      // Показываем кнопки расчета
      document.getElementById('angular-calc-buttons').style.display = 'flex';

      // Помечаем модуль как выполненный
      markModuleAsCompleted('angularity');
    }

    function resetAngularForm() {
      document.getElementById('angular-belts').value = '5';
      document.getElementById('angular-seams').value = '8';
      document.getElementById('angular-measurement-date').value = getCurrentDate();
      document.getElementById('common-thickness').value = '';
      document.getElementById('angular-inputs-container').innerHTML = '';
      document.getElementById('angular-inputs-container').style.display = 'none';
      document.getElementById('angular-calc-buttons').style.display = 'none';
      angularData = {
        belts: 0,
        seams: 0,
        date: '',
        beltThickness: [],
        measurements: [],
        individualThickness: false
      };
    }

    function calculateAngularity() {
      const belts = angularData.belts;
      const seams = angularData.seams;

      if (belts <= 0 || seams <= 0) {
        showModal('Ошибка', 'Нет данных для расчета');
        return;
      }

      const measurements = [];
      let totalOutOfTolerance = 0;

      // Собираем данные и подсвечиваем недопуски
      for (let b = 1; b <= belts; b++) {
        const thickness = angularData.beltThickness[b - 1];
        let tolerance;

        // Определяем допуск по толщине
        if (thickness >= 5 && thickness <= 10) {
          tolerance = 8;
        } else if (thickness > 10 && thickness <= 15) {
          tolerance = 7;
        } else if (thickness > 15) {
          tolerance = 5;
        } else {
          tolerance = 8;
        }

        for (let s = 1; s <= seams; s++) {
          const input = document.getElementById(`angular-b${b}-s${s}`);
          const value = parseFloat(input.value) || 0;

          const isOutOfTolerance = Math.abs(value) > tolerance;
          if (isOutOfTolerance) {
            totalOutOfTolerance++;
            input.classList.add('input-out-of-tolerance');
          } else {
            input.classList.remove('input-out-of-tolerance');
          }

          measurements.push({
            belt: b,
            seam: s,
            thickness: thickness,
            value: value,
            tolerance: tolerance,
            isOutOfTolerance: isOutOfTolerance
          });
        }
      }

      // Сохраняем данные
      angularData.measurements = measurements;

      // Показываем результат расчета
      const resultDiv = document.createElement('div');
      resultDiv.innerHTML = `
                <div style="margin-top: 20px; padding: 15px; background: ${totalOutOfTolerance > 0 ? '#fceded' : '#e8f5e9'}; border-radius: 8px; border-left: 4px solid ${totalOutOfTolerance > 0 ? 'var(--danger-red)' : 'var(--success-green)'};">
                    <strong>${totalOutOfTolerance > 0 ? '⚠️ Обнаружены нарушения:' : '✓ Все значения в пределах допуска'}</strong><br>
                    Нарушений допуска: <strong>${totalOutOfTolerance}</strong> из ${measurements.length} измерений<br>
                    Значения, отмеченные <span style="color: var(--danger-red); font-weight: bold;">красным</span> — превышение допуска
                </div>
            `;

      const container = document.getElementById('angular-inputs-container');
      // Удаляем старый результат, если есть
      const oldResult = container.querySelector('.result-summary');
      if (oldResult) {
        oldResult.remove();
      }
      resultDiv.className = 'result-summary';
      container.appendChild(resultDiv);

      showModal('Расчет завершен', `Нарушений допуска: ${totalOutOfTolerance} из ${measurements.length} измерений`);
    }

    function exportAngularToExcel() {
      if (!angularData.measurements || angularData.measurements.length === 0) {
        showModal('Ошибка', 'Нет данных для экспорта. Сначала выполните расчет.');
        return;
      }

      const excelData = [];

      // Заголовок
      excelData.push(['Результаты проверки угловатости стенки']);
      excelData.push(['Дата замера:', formatDateToDMY(angularData.date)]);
      excelData.push(['Количество поясов:', angularData.belts]);
      excelData.push(['Количество стыков:', angularData.seams]);
      excelData.push([]);

      // Собираем значения в структуру по поясам
      const beltsMap = {};
      angularData.measurements.forEach(m => {
        if (!beltsMap[m.belt]) {
          beltsMap[m.belt] = {
            thickness: m.thickness,
            tolerance: m.tolerance,
            seams: {}
          };
        }
        beltsMap[m.belt].seams[m.seam] = m;
      });

      // Заголовок таблицы как в UI (двухстрочный блок)
      const firstHeader = ['Пояс №', 'Толщина, мм', 'Допуск, мм'];
      if (angularData.seams > 0) {
        firstHeader.push('Угловатость f (мм) по вертикальным стыкам');
        for (let i = 1; i < angularData.seams; i++) firstHeader.push('');
      }
      excelData.push(firstHeader);

      const headerRow = ['', '', ''];
      for (let s = 1; s <= angularData.seams; s++) {
        headerRow.push(`Стык ${s}`);
      }
      excelData.push(headerRow);

      // Строки по поясам
      for (let b = 1; b <= angularData.belts; b++) {
        const belt = beltsMap[b];
        const row = [];
        row.push(`Пояс ${b}`);
        row.push(belt ? formatNumber(belt.thickness) : '');
        row.push(belt ? `±${belt.tolerance}` : '');

        for (let s = 1; s <= angularData.seams; s++) {
          const m = belt && belt.seams[s];
          if (!m) {
            row.push('');
          } else {
            const val = formatNumber(m.value);
row.push(m.isOutOfTolerance ? `${val}*` : val);

          }
        }

        excelData.push(row);
      }

      excelData.push([]);
      excelData.push(['ПРИМЕЧАНИЕ:']);
      excelData.push(['ГОСТ 31385-2023, пункты 10.1.6-10.1.7']);
      excelData.push(['Допустимые значения угловатости (для резервуаров до 50 000 м³, срок службы 40 лет, ≤250 циклов/год):']);
      excelData.push(['• При толщине пояса 5 ≤ t ≤ 10 мм: f ≤ 8 мм']);
      excelData.push(['• При толщине пояса 10 < t ≤ 15 мм: f ≤ 7 мм']);
      excelData.push(['• При толщине пояса t > 15 мм: f ≤ 5 мм']);
      excelData.push(['Для резервуаров свыше 50 000 м³ или режимов нагружения >250 циклов/год требуется расчет усталостной долговечности.']);
      excelData.push(['* — значения, превышающие допуск']);

      const filename = generateExportFilename('angularity', '', angularData.date);
      const success = (function () {
        try {
          const ws = XLSX.utils.aoa_to_sheet(excelData);

          // Объединение ячеек: заголовки первых трех столбцов на две строки, блок стыков в одной строке
          ws['!merges'] = ws['!merges'] || [];
          // строки 5 и 6 (индексация с 0 => 5 и 6) для столбцов A-C
          ws['!merges'].push({ s: { r: 5, c: 0 }, e: { r: 6, c: 0 } });
          ws['!merges'].push({ s: { r: 5, c: 1 }, e: { r: 6, c: 1 } });
          ws['!merges'].push({ s: { r: 5, c: 2 }, e: { r: 6, c: 2 } });
          // Заголовок блока стыков на первой строке таблицы
          if (angularData.seams > 0) {
            ws['!merges'].push({
              s: { r: 5, c: 3 },
              e: { r: 5, c: 3 + angularData.seams - 1 }
            });
          }

          // Добавляем лист и сохраняем
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Данные');
          XLSX.writeFile(wb, filename);
          return true;
        } catch (e) {
          console.error('Ошибка экспорта угловатости:', e);
          return false;
        }
      })();

      if (success) {
        showModal('Успех', `Файл Excel успешно создан: ${filename}`);
        markModuleAsCompleted('angularity');
      } else {
        showModal('Ошибка', 'Не удалось создать файл Excel');
      }
    }

    this.exportAngularToExcel = exportAngularToExcel;
    // ===============================================
    // === МОДУЛЬ 3: ДИАМЕТР И ВЫСОТА ===
    // ===============================================

function formatNumber(value) {
  return Number.isInteger(value) ? value : parseFloat(value);
}

    function initDimensionsModule() {
      // Устанавливаем сегодняшнюю дату по умолчанию
      const today = getCurrentDate();
      if (document.getElementById('diameter-measurement-date') && !document.getElementById('diameter-measurement-date').value) {
        document.getElementById('diameter-measurement-date').value = today;
      }
      if (document.getElementById('height-measurement-date') && !document.getElementById('height-measurement-date').value) {
        document.getElementById('height-measurement-date').value = today;
      }

      // Обработчики для диаметра
      document.getElementById('start-diameter-button').onclick = () => {
        document.getElementById('diameter-section').style.display = 'block';
        document.getElementById('height-section').style.display = 'none';
      };

      document.getElementById('save-diameter-button').onclick = saveDiameterSettings;
      document.getElementById('calculate-diameter-button-1').onclick = calculateDiameter;
      document.getElementById('back-to-diameter-step1').onclick = () => {
        document.getElementById('diameter-step-1').style.display = 'block';
        document.getElementById('diameter-step-2').style.display = 'none';
      };
      document.getElementById('reset-diameter-button').onclick = resetDiameterForm;

      // Обработчики для высоты
      document.getElementById('start-height-button').onclick = () => {
        document.getElementById('height-section').style.display = 'block';
        document.getElementById('diameter-section').style.display = 'none';
      };

      document.getElementById('save-height-button').onclick = saveHeightSettings;
      document.getElementById('calculate-height-button').onclick = calculateHeight;
      document.getElementById('back-to-height-step1').onclick = () => {
        document.getElementById('height-step-1').style.display = 'block';
        document.getElementById('height-step-2').style.display = 'none';
      };
      document.getElementById('reset-height-button').onclick = resetHeightForm;

      // Обработчик для возврата в меню выбора раздела
      window.backToDimensionsMenu = function () {
        document.getElementById('diameter-section').style.display = 'none';
        document.getElementById('height-section').style.display = 'none';
        document.getElementById('diameter-step-1').style.display = 'block';
        document.getElementById('diameter-step-2').style.display = 'none';
        document.getElementById('height-step-1').style.display = 'block';
        document.getElementById('height-step-2').style.display = 'none';
        document.getElementById('diameter-results-container').style.display = 'none';
        document.getElementById('height-results-container').style.display = 'none';
        document.getElementById('diameter-export-buttons').style.display = 'none';
        document.getElementById('height-export-buttons').style.display = 'none';
      };
    }

    function saveDiameterSettings() {
      const projectDiameter = parseFloat(document.getElementById('project-diameter').value) || 0;
      const date = document.getElementById('diameter-measurement-date').value;

      if (projectDiameter <= 0) {
        showModal('Ошибка', 'Введите проектный диаметр');
        return;
      }

      if (!date) {
        showModal('Ошибка', 'Введите дату замера');
        return;
      }

      // Расчет допуска по ГОСТ
      const radiusMeters = projectDiameter / 2000; // Радиус в метрах
      let tolerance = 0;

      if (projectDiameter <= 12000) { // До 12 м
        tolerance = 0.005 * radiusMeters * 1000; // В миллиметры
      } else if (projectDiameter <= 25000) { // До 25 м
        tolerance = 0.003 * radiusMeters * 1000;
      } else if (projectDiameter <= 40000) { // До 40 м
        tolerance = 0.002 * radiusMeters * 1000;
      } else { // Свыше 40 м
        tolerance = 0.0015 * radiusMeters * 1000;
      }

      // Сохраняем данные
      dimensionsData.diameter = {
        projectDiameter: projectDiameter,
        date: date,
        tolerance: tolerance,
        measurements: []
      };

      // Обновляем отображение
      document.getElementById('calculated-tolerance').textContent = formatNumber(tolerance);
      document.getElementById('diameter-tolerance-info').style.display = 'block';

      // Создаем сетку для ввода 8 измерений радиуса
      createRadiusInputsGrid();

      // Переходим к следующему шагу
      document.getElementById('diameter-step-1').style.display = 'none';
      document.getElementById('diameter-step-2').style.display = 'block';
    }

    function createRadiusInputsGrid() {
      const container = document.getElementById('radius-inputs-grid');
      container.innerHTML = '';

      // Создаем 8 точек для ввода радиуса
      for (let i = 1; i <= 8; i++) {
        const card = document.createElement('div');
        card.className = 'input-card';
        card.innerHTML = `
                    <h4>Точка ${i}</h4>
                    <input type="tel" 
                           id="radius-point-${i}" 
                           placeholder="Радиус, мм" 
                           step="0.1">
                `;
        container.appendChild(card);
      }
    }

    function calculateDiameter() {
      console.log("calculateDiameter")
      // Собираем данные из 8 точек
      const radii = [];
      for (let i = 1; i <= 8; i++) {
        const input = document.getElementById(`radius-point-${i}`);
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
          radii.push({ point: i, radius: value });
        }
      }

      if (radii.length !== 8) {
        showModal('Ошибка', 'Введите все 8 значений радиуса');
        return;
      }

      const projectDiameter = dimensionsData.diameter.projectDiameter;
      const tolerance = dimensionsData.diameter.tolerance;

      // Рассчитываем диаметры по осям
      const axisResults = {
        '1-5': { radius1: radii[0].radius, radius2: radii[4].radius, diameter: 0, deviation: 0, isOutOfTolerance: false },
        '2-6': { radius1: radii[1].radius, radius2: radii[5].radius, diameter: 0, deviation: 0, isOutOfTolerance: false },
        '3-7': { radius1: radii[2].radius, radius2: radii[6].radius, diameter: 0, deviation: 0, isOutOfTolerance: false },
        '4-8': { radius1: radii[3].radius, radius2: radii[7].radius, diameter: 0, deviation: 0, isOutOfTolerance: false }
      };

      // Рассчитываем диаметры и отклонения для каждой оси
      Object.keys(axisResults).forEach(axis => {
        const data = axisResults[axis];
        data.diameter = data.radius1 + data.radius2;
        data.deviation = data.diameter - projectDiameter;
        data.isOutOfTolerance = Math.abs(data.deviation) > tolerance;
      });

      // Сохраняем результаты
      dimensionsData.diameter.measurements = radii;
      dimensionsData.diameter.axisResults = axisResults;

      // Отображаем результаты
      displayDiameterResults();

      // Помечаем модуль как выполненный
      markModuleAsCompleted('dimensions');
    }

    function displayDiameterResults() {
      const data = dimensionsData.diameter;
      const container = document.getElementById('diameter-results-container');

      let resultsHtml = `
                <h3 style="color: var(--primary-blue); margin-bottom: 20px;">Результаты замера внутреннего диаметра</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: var(--light-blue); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div><strong>Проектный диаметр:</strong> ${formatNumber(data.projectDiameter)} мм</div>
                        <div><strong>Допуск по ГОСТ:</strong> ±${formatNumber(data.tolerance)} мм</div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th style="background: var(--primary-blue); color: white; padding: 12px;">Номера точек по осям</th>
                            <th style="background: var(--primary-blue); color: white; padding: 12px;">1-5</th>
                            <th style="background: var(--primary-blue); color: white; padding: 12px;">2-6</th>
                            <th style="background: var(--primary-blue); color: white; padding: 12px;">3-7</th>
                            <th style="background: var(--primary-blue); color: white; padding: 12px;">4-8</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">Радиус, мм</td>`;

      // Строка с радиусами
      const axes = ['1-5', '2-6', '3-7', '4-8'];
axes.forEach(axis => {
  const radiusData = data.axisResults[axis];
  resultsHtml += `
    <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center;">
      ${formatNumber(radiusData.radius1)} + ${formatNumber(radiusData.radius2)}
    </td>`;
});


      resultsHtml += `
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">Внутренний диаметр, мм</td>`;

      // Строка с диаметрами
      axes.forEach(axis => {
        const diameterData = data.axisResults[axis];
        resultsHtml += `
                    <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">
                        ${formatNumber(diameterData.diameter)}
                    </td>`;
      });

      resultsHtml += `
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">Отклонение от проектного, мм</td>`;

      // Строка с отклонениями
axes.forEach(axis => {
  const deviationData = data.axisResults[axis];
  resultsHtml += `
    <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; ${deviationData.isOutOfTolerance ? 'color: var(--danger-red); font-weight: bold;' : ''}">
      ${deviationData.isOutOfTolerance
        ? `${formatNumber(deviationData.deviation)}*`
        : formatNumber(deviationData.deviation)
      }
    </td>`;
});



      resultsHtml += `
                        </tr>
                    </tbody>
                </table>
                
                <div style="padding: 15px; background: var(--light-blue); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <strong>Допуск на данный диаметр:</strong> ±${formatNumber(data.tolerance)} мм
                    <small style="color: #666;">ГОСТ 31385-2023, таблица 19</small>
                </div>`;

      container.innerHTML = resultsHtml;
      container.style.display = 'block';
      document.getElementById('diameter-export-buttons').style.display = 'flex';
    }

    function resetDiameterForm() {
      document.getElementById('project-diameter').value = '';
      document.getElementById('diameter-measurement-date').value = getCurrentDate();
      document.getElementById('diameter-tolerance-info').style.display = 'none';
      document.getElementById('radius-inputs-grid').innerHTML = '';
      document.getElementById('diameter-results-container').style.display = 'none';
      document.getElementById('diameter-export-buttons').style.display = 'none';
      dimensionsData.diameter = {};
    }

    function exportDiameterToExcel() {
      if (!dimensionsData.diameter.measurements || dimensionsData.diameter.measurements.length === 0) {
        showModal('Ошибка', 'Нет данных для экспорта');
        return;
      }

      const data = dimensionsData.diameter;
      const excelData = [];

      // Заголовок
      excelData.push(['Результаты замера внутреннего диаметра резервуара']);
      excelData.push(['Дата замера:', formatDateToDMY(data.date)]);
      excelData.push(['Проектный диаметр:', `${formatNumber(data.projectDiameter)} мм`]);
      excelData.push(['Допуск по ГОСТ:', `±${data.tolerance.toFixed(1)} мм`]);
      excelData.push([]);

      // Таблица результатов
      excelData.push(['', 'Ось 1-5', 'Ось 2-6', 'Ось 3-7', 'Ось 4-8']);
      excelData.push(['Номера точек по осям', '1-5', '2-6', '3-7', '4-8']);

      // Радиусы
      const axes = ['1-5', '2-6', '3-7', '4-8'];
      const radiusRow = ['Радиус, мм'];
      axes.forEach(axis => {
        const radiusData = data.axisResults[axis];
        radiusRow.push(`${formatNumber(radiusData.radius1)} + ${formatNumber(radiusData.radius2)}`);
      });
      excelData.push(radiusRow);

      // Диаметры
      const diameterRow = ['Внутренний диаметр, мм'];
      axes.forEach(axis => {
        diameterRow.push(data.axisResults[axis].diameter.toFixed(1));
      });
      excelData.push(diameterRow);

      // Отклонения
      const deviationRow = ['Отклонение от проектного, мм'];
      axes.forEach(axis => {
        const deviation = data.axisResults[axis].deviation;
        const isOut = data.axisResults[axis].isOutOfTolerance;
        deviationRow.push(isOut ? `${deviation.toFixed(1)}*` : deviation.toFixed(1));
      });
      excelData.push(deviationRow);

      excelData.push([]);
      excelData.push(['ПРИМЕЧАНИЕ:']);
      excelData.push(['ГОСТ 31385-2023, таблица 19']);
      excelData.push(['Предельное отклонение внутреннего диаметра:']);
      excelData.push(['• До 12 м: 0,005R мм']);
      excelData.push(['• Свыше 12 до 25 м: 0,003R мм']);
      excelData.push(['• Свыше 25 до 40 м: 0,002R мм']);
      excelData.push(['• Свыше 40 м: 0,0015R мм']);
      excelData.push(['* R — радиус резервуара в метрах']);
      excelData.push(['* — значения, превышающие допуск']);

      const filename = generateExportFilename('dimensions', 'Диаметр', data.date);
      const success = exportToExcel1(excelData, filename);

      if (success) {
        showModal('Успех', `Файл Excel успешно создан: ${filename}`);
        markModuleAsCompleted('dimensions');
      } else {
        showModal('Ошибка', 'Не удалось создать файл Excel');
      }
    }

    // Функции для высоты стенки
    function saveHeightSettings() {
      const projectHeight = parseFloat(document.getElementById('project-height').value) || 0;
      const date = document.getElementById('height-measurement-date').value;

      if (projectHeight <= 0) {
        showModal('Ошибка', 'Введите проектную высоту');
        return;
      }

      if (!date) {
        showModal('Ошибка', 'Введите дату замера');
        return;
      }

      // Расчет допуска по ГОСТ
      let tolerance = 0;
      const heightMeters = projectHeight / 1000; // Высота в метрах

      if (heightMeters <= 12) {
        tolerance = 20; // мм
      } else if (heightMeters <= 18) {
        tolerance = 30; // мм
      } else {
        tolerance = 40; // мм
      }

      // Сохраняем данные
      dimensionsData.height = {
        projectHeight: projectHeight,
        date: date,
        tolerance: tolerance,
        measurements: []
      };

      // Обновляем отображение
      document.getElementById('height-tolerance-value').textContent = tolerance;
      document.getElementById('height-tolerance-info').style.display = 'block';

      // Создаем сетку для ввода 8 измерений
      createHeightInputsGrid();

      // Переходим к следующему шагу
      document.getElementById('height-step-1').style.display = 'none';
      document.getElementById('height-step-2').style.display = 'block';
    }

    function createHeightInputsGrid() {
      const container = document.getElementById('height-inputs-grid');
      container.innerHTML = '';

      // Создаем 8 точек для ввода высоты
      for (let i = 1; i <= 8; i++) {
        const card = document.createElement('div');
        card.className = 'input-card';
        card.innerHTML = `
                    <h4>Точка ${i}</h4>
                    <input type="tel" 
                           id="height-point-${i}" 
                           placeholder="Высота, мм" 
                           step="0.1">
                `;
        container.appendChild(card);
      }
    }

    function calculateHeight() {
      // Собираем данные из 8 точек
      const heights = [];
      for (let i = 1; i <= 8; i++) {
        const input = document.getElementById(`height-point-${i}`);
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
          heights.push({ point: i, height: value });
        }
      }

      if (heights.length !== 8) {
        showModal('Ошибка', 'Введите все 8 значений высоты');
        return;
      }

      const projectHeight = dimensionsData.height.projectHeight;
      const tolerance = dimensionsData.height.tolerance;

      // Рассчитываем отклонения
      const deviations = heights.map(h => {
        const deviation = h.height - projectHeight;
        const isOutOfTolerance = Math.abs(deviation) > tolerance;

        return {
          point: h.point,
          height: h.height,
          deviation: deviation,
          isOutOfTolerance: isOutOfTolerance
        };
      });

      // Сохраняем результаты
      dimensionsData.height.measurements = deviations;

      // Отображаем результаты
      displayHeightResults();

      // Помечаем модуль как выполненный
      markModuleAsCompleted('dimensions');
    }

    function displayHeightResults() {
      const data = dimensionsData.height;
      const container = document.getElementById('height-results-container');

      let resultsHtml = `
                <h3 style="color: var(--primary-blue); margin-bottom: 20px;">Результаты замера высоты стенки</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: var(--light-blue); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div><strong>Проектная высота:</strong> ${data.projectHeight.toFixed(1)} мм</div>
                        <div><strong>Допуск по ГОСТ:</strong> ±${data.tolerance} мм</div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="background: var(--primary-blue); color: white; padding: 12px;">Точки в осях</th>`;

      // Заголовки для точек
      for (let i = 1; i <= 8; i++) {
        resultsHtml += `<th style="background: var(--primary-blue); color: white; padding: 12px;">${i}</th>`;
      }

      resultsHtml += `</tr></thead><tbody>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">Высота стенки, мм</td>`;

      // Строка с высотами
      data.measurements.forEach(m => {
        resultsHtml += `
                    <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center;">
                        ${m.height.toFixed(1)}
                    </td>`;
      });

      resultsHtml += `
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">Отклонение от проекта, мм</td>`;

      // Строка с отклонениями
      data.measurements.forEach(m => {
        resultsHtml += `
                    <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; ${m.isOutOfTolerance ? 'color: var(--danger-red); font-weight: bold;' : ''}">
                        ${m.isOutOfTolerance ? `${m.deviation.toFixed(1)}*` : m.deviation.toFixed(1)}
                    </td>`;
      });

      resultsHtml += `
                        </tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light-blue); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                    <strong>Допуск по ГОСТ 31385-2023, таблица 19:</strong><br>
                    • до 12 м включительно: ±20 мм<br>
                    • свыше 12 до 18 м: ±30 мм<br>
                    • свыше 18 м: ±40 мм<br>
                    <small>Для высоты ${(data.projectHeight / 1000).toFixed(1)} м установлен допуск: ±${data.tolerance} мм</small>
                </div>`;

      container.innerHTML = resultsHtml;
      container.style.display = 'block';
      document.getElementById('height-export-buttons').style.display = 'flex';
    }

    function resetHeightForm() {
      document.getElementById('project-height').value = '';
      document.getElementById('height-measurement-date').value = getCurrentDate();
      document.getElementById('height-tolerance-info').style.display = 'none';
      document.getElementById('height-inputs-grid').innerHTML = '';
      document.getElementById('height-results-container').style.display = 'none';
      document.getElementById('height-export-buttons').style.display = 'none';
      dimensionsData.height = {};
    }

    function exportHeightToExcel() {
      if (!dimensionsData.height.measurements || dimensionsData.height.measurements.length === 0) {
        showModal('Ошибка', 'Нет данных для экспорта');
        return;
      }

      const data = dimensionsData.height;
      const excelData = [];

      // Заголовок
      excelData.push(['Результаты замера высоты стенки резервуара']);
      excelData.push(['Дата замера:', formatDateToDMY(data.date)]);
      excelData.push(['Проектная высота:', `${data.projectHeight.toFixed(1)} мм`]);
      excelData.push(['Допуск по ГОСТ:', `±${data.tolerance} мм`]);
      excelData.push([]);

      // Заголовки таблицы
      const headerRow = ['Точки в осях'];
      for (let i = 1; i <= 8; i++) {
        headerRow.push(i);
      }
      excelData.push(headerRow);

      // Высоты
      const heightRow = ['Высота стенки, мм'];
      data.measurements.forEach(m => {
        heightRow.push(m.height.toFixed(1));
      });
      excelData.push(heightRow);

      // Отклонения
      const deviationRow = ['Отклонение от проекта, мм'];
      data.measurements.forEach(m => {
        deviationRow.push(m.isOutOfTolerance ? `${m.deviation.toFixed(1)}*` : m.deviation.toFixed(1));
      });
      excelData.push(deviationRow);

      excelData.push([]);
      excelData.push(['ПРИМЕЧАНИЕ:']);
      excelData.push(['ГОСТ 31385-2023, таблица 19']);
      excelData.push(['Допустимые отклонения высоты стенки:']);
      excelData.push(['• до 12 м включительно: ±20 мм']);
      excelData.push(['• свыше 12 до 18 м: ±30 мм']);
      excelData.push(['• свыше 18 м: ±40 мм']);
      excelData.push(['* — значения, превышающие допуск']);

      const filename = generateExportFilename('dimensions', 'Высота', data.date);
      const success = exportToExcel1(excelData, filename);

      if (success) {
        showModal('Успех', `Файл Excel успешно создан: ${filename}`);
        markModuleAsCompleted('dimensions');
      } else {
        showModal('Ошибка', 'Не удалось создать файл Excel');
      }
    }

    // ===============================================
    // === МОДУЛЬ 4: ХЛОПУНЫ ===
    // ===============================================

    function initBulgeModule() {
      // Устанавливаем сегодняшнюю дату по умолчанию
      const dateInput = document.getElementById('bulge-measurement-date');
      if (dateInput && !dateInput.value) {
        dateInput.value = getCurrentDate();
      }

      // Обработчики событий
      document.getElementById('generate-bulge-button').onclick = generateBulgeTable;
      document.getElementById('reset-bulge-button').onclick = resetBulgeForm;
      document.getElementById('calculate-bulge-button').onclick = calculateBulges;

      // Исправляем обработчик кнопки экспорта
      const exportButton = document.querySelector('#bulge-calc-buttons .export-excel');
      if (exportButton) {
        exportButton.onclick = exportBulgeToExcel;
      }
    }

    function generateBulgeTable() {
      const count = parseInt(document.getElementById('bulge-count').value) || 0;
      const date = document.getElementById('bulge-measurement-date').value;

      if (count <= 0) {
        showModal('Ошибка', 'Введите количество хлопунов');
        return;
      }

      if (!date) {
        showModal('Ошибка', 'Введите дату замера');
        return;
      }

      // Сохраняем настройки
      bulgeData.count = count;
      bulgeData.date = date;

      const container = document.getElementById('bulge-inputs-container');

      // Создаем таблицу с новыми колонками
      let tableHtml = `
                <table class="bulge-table" id="bulge-table">
                    <thead>
                        <tr>
                            <th rowspan="2">№<br>хлопуна</th>
                            <th rowspan="2">Параметры хлопуна</th>
                            <th colspan="4">Координаты относительно оси, мм</th>
                            <th rowspan="2">Длина<br>хлопуна, мм</th>
                            <th rowspan="2">Ширина<br>хлопуна, мм</th>
                            <th rowspan="2">Высота<br>хлопуна, мм</th>
                            <th rowspan="2">Стрелка хлопуна, <br>наружу +, внутрь -</th>
                        </tr>
                        <tr>
                            <th>оси I</th>
                            <th>оси II</th>
                            <th>оси III</th>
                            <th>оси IV</th>
                        </tr>
                    </thead>
                    <tbody id="bulge-table-body">`;

      // Создаем строки для хлопунов
      for (let i = 1; i <= count; i++) {
        tableHtml += `
                    <tr id="bulge-row-${i}">
                        <td style="font-weight: bold; vertical-align: middle;">${i}</td>
                        <td style="vertical-align: middle;">Хлопун ${i}</td>
                        <td><input type="tel" id="bulge-axis1-${i}" placeholder="0" step="1" class="bulge-input"></td>
                        <td><input type="tel" id="bulge-axis2-${i}" placeholder="0" step="1" class="bulge-input"></td>
                        <td><input type="tel" id="bulge-axis3-${i}" placeholder="0" step="1" class="bulge-input"></td>
                        <td><input type="tel" id="bulge-axis4-${i}" placeholder="0" step="1" class="bulge-input"></td>
                        <td><input type="tel" id="bulge-length-${i}" placeholder="0" step="1" min="0" class="bulge-input"></td>
                        <td><input type="tel" id="bulge-width-${i}" placeholder="0" step="1" min="0" class="bulge-input"></td>
                        <td><input type="tel" id="bulge-height-${i}" placeholder="0" step="1" min="0" class="bulge-input"></td>
                        <td>
  <input type="text"
         id="bulge-arrow-${i}"
         value="+"
         maxlength="1"
         class="bulge-input">
</td>
                    </tr>`;
      }

      tableHtml += `</tbody></table>`;
      container.innerHTML = tableHtml;
      container.style.display = 'block';

      // Показываем кнопки расчета
      document.getElementById('bulge-calc-buttons').style.display = 'flex';

      // Помечаем модуль как выполненный
      markModuleAsCompleted('localDeviations');
    }

    function resetBulgeForm() {
      document.getElementById('bulge-count').value = '3';
      document.getElementById('bulge-measurement-date').value = getCurrentDate();
      document.getElementById('bulge-inputs-container').innerHTML = '';
      document.getElementById('bulge-inputs-container').style.display = 'none';
      document.getElementById('bulge-calc-buttons').style.display = 'none';
      document.getElementById('bulge-results-container').style.display = 'none';
      bulgeData = {
        count: 0,
        date: '',
        measurements: []
      };
    }

    function calculateBulges() {
      const count = bulgeData.count;

      if (count <= 0) {
        showModal('Ошибка', 'Нет данных для расчета');
        return;
      }

      const measurements = [];
      let outOfToleranceCount = 0;
      const heightTolerance = 15; // Допуск по высоте хлопуна, мм

      for (let i = 1; i <= count; i++) {
        const axis1 = parseFloat(document.getElementById(`bulge-axis1-${i}`).value) || 0;
        const axis2 = parseFloat(document.getElementById(`bulge-axis2-${i}`).value) || 0;
        const axis3 = parseFloat(document.getElementById(`bulge-axis3-${i}`).value) || 0;
        const axis4 = parseFloat(document.getElementById(`bulge-axis4-${i}`).value) || 0;
        const length = parseFloat(document.getElementById(`bulge-length-${i}`).value) || 0;
        const width = parseFloat(document.getElementById(`bulge-width-${i}`).value) || 0;
        const height = parseFloat(document.getElementById(`bulge-height-${i}`).value) || 0;
        const arrow = document.getElementById(`bulge-arrow-${i}`).value.trim();
		
		if (arrow !== '+' && arrow !== '-') {
  showModal('Ошибка', `В хлопуне №${i} в поле "Стрелка" нужно указать только + или -`);
  return;
}

        // Проверяем допуск именно по высоте хлопуна
        const isOutOfTolerance = height > heightTolerance;
        if (isOutOfTolerance) {
          outOfToleranceCount++;
          // Подсвечиваем поле ввода высоты
          document.getElementById(`bulge-height-${i}`).classList.add('input-out-of-tolerance');
        } else {
          document.getElementById(`bulge-height-${i}`).classList.remove('input-out-of-tolerance');
        }

        measurements.push({
          number: i,
          axis1: axis1,
          axis2: axis2,
          axis3: axis3,
          axis4: axis4,
          length: length,
          width: width,
          height: height,
          arrow: arrow,
          isOutOfTolerance: isOutOfTolerance
        });
      }

      // Сохраняем данные
      bulgeData.measurements = measurements;

      // Показываем результат
      const resultDiv = document.createElement('div');
      resultDiv.innerHTML = `
                <div style="margin-top: 20px; padding: 15px; background: ${outOfToleranceCount > 0 ? '#fceded' : '#e8f5e9'}; border-radius: 8px; border-left: 4px solid ${outOfToleranceCount > 0 ? 'var(--danger-red)' : 'var(--success-green)'};">
                    <strong>${outOfToleranceCount > 0 ? '⚠️ Обнаружены нарушения:' : '✓ Все значения в пределах допуска'}</strong><br>
                    Нарушений допуска: <strong>${outOfToleranceCount}</strong> из ${measurements.length} хлопунов<br>
                    Допуск по высоте: <strong>≤ ${heightTolerance} мм</strong><br>
                    Значения, отмеченные <span style="color: var(--danger-red); font-weight: bold;">красным</span> — превышение допуска
                </div>
            `;

      const container = document.getElementById('bulge-inputs-container');
      // Удаляем старый результат, если есть
      const oldResult = container.querySelector('.bulge-result-summary');
      if (oldResult) {
        oldResult.remove();
      }
      resultDiv.className = 'bulge-result-summary';
      container.appendChild(resultDiv);

      showModal('Расчет завершен', `Нарушений допуска: ${outOfToleranceCount} из ${measurements.length} хлопунов`);
    }

    function exportBulgeToExcel() {
      if (!bulgeData.measurements || bulgeData.measurements.length === 0) {
        showModal('Ошибка', 'Нет данных для экспорта. Сначала выполните расчет.');
        return;
      }

      const excelData = [];

      // Заголовок
      excelData.push(['Результаты проверки местных отклонений (хлопунов) стенки']);
      excelData.push(['Дата замера:', formatDateToDMY(bulgeData.date)]);
      excelData.push(['Количество хлопунов:', bulgeData.count]);
      excelData.push([]);

      // Заголовки таблицы
      excelData.push(['№ хлопуна', 'Параметры хлопуна', 'Координаты относительно оси I, мм',
        'Координаты относительно оси II, мм', 'Координаты относительно оси III, мм',
        'Координаты относительно оси IV, мм', 'Длина хлопуна, мм', 'Ширина хлопуна, мм',
        'Высота хлопуна, мм', 'Стрелка хлопуна, мм (наружу +, внутрь -)', 'Статус']);

      // Данные
      bulgeData.measurements.forEach(m => {
        excelData.push([
          m.number,
          `Хлопун ${m.number}`,
          m.axis1.toFixed(0),
          m.axis2.toFixed(0),
          m.axis3.toFixed(0),
          m.axis4.toFixed(0),
          m.length.toFixed(0),
          m.width.toFixed(0),
          m.isOutOfTolerance ? `${m.height.toFixed(0)}*` : m.height.toFixed(0),
          m.arrow,
          m.isOutOfTolerance ? 'Превышен' : 'В норме'
        ]);
      });

      excelData.push([]);
      excelData.push(['ПРИМЕЧАНИЕ:']);
      excelData.push(['ГОСТ 31385-2023, таблица 19']);
      excelData.push(['Локальные отклонения от проектной формы (на длине 1 м)']);
      excelData.push(['Допуск: высота хлопуна ≤ 15 мм']);
      excelData.push(['Измерения проводят вертикальной рейкой и горизонтальным шаблоном контроля радиуса.']);
      excelData.push(['* — значения, превышающие допуск']);

      const filename = generateExportFilename('localDeviations', '', bulgeData.date);
      const success = exportToExcel1(excelData, filename);

      if (success) {
        showModal('Успех', `Файл Excel успешно создан: ${filename}`);
        markModuleAsCompleted('localDeviations');
      } else {
        showModal('Ошибка', 'Не удалось создать файл Excel');
      }
    }

   

    document.getElementById('btn-wall-export-excel').onclick = exportBulgeToExcel;
    // Вспомогательная функция для пометки модуля как выполненного
    function markModuleAsCompleted(moduleId) {
      saveCompletionState(moduleId, true);
      renderWallModuleList(getActiveProject());
    }

  </script>
  <script>

    // Ключи для localStorage
    const STORAGE_KEY_PROJECTS = 'projectManagerProjects';
    const STORAGE_KEY_ACTIVE_PROJECT = 'projectActiveName';

    // Данные для модуля радиальных балок
    let radialBeamsData = {
      projectName: '',
      date: '',
      diameter: 0,
      beamCount: 0,
      zoneType: 'wall',
      tolerance: 20,
      beamHeights: [],
      differences: [],
      excelData: []
    };

    // Данные для модуля крыши
    let roofTopData = {
      projectName: '',
      date: '',
      diameter: 0,
      projectHeight: 0,
      bottomSlope: 0,
      distanceToFlange: 0,
      actualHeight: 0,
      tolerance: 0,
      deviation: 0,
      isOutOfTolerance: false,
      excelData: []
    };

    // ================================================
    // УТИЛИТЫ
    // ================================================

    function formatDateToDMY(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    function getCurrentDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    function showModal(title, body) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').innerHTML = body;
      document.getElementById('message-modal').classList.add('visible');
    }

    function closeModal() {
      document.getElementById('message-modal').classList.remove('visible');
    }

    // ================================================
    // УПРАВЛЕНИЕ ПРОЕКТАМИ (ИСПРАВЛЕНО - всегда читаем актуальные данные)
    // ================================================

    /**
     * Получить все проекты из localStorage
     * @returns {Array} Массив проектов
     */
    function getAllProjects() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_PROJECTS) || '[]');
      } catch (e) {
        console.error('Ошибка чтения проектов из localStorage:', e);
        return [];
      }
    }

    /**
     * Сохранить все проекты в localStorage
     * @param {Array} projects Массив проектов
     */
    function saveAllProjects(projects) {
      try {
        localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(projects));
      } catch (e) {
        console.error('Ошибка сохранения проектов в localStorage:', e);
        showModal('Ошибка', 'Не удалось сохранить данные. Проверьте доступное место в хранилище.');
      }
    }

    /**
     * Получить активный проект (ВСЕГДА читает актуальные данные из localStorage)
     * @returns {Object|null} Объект проекта или null
     */
    function getActiveProject() {
      const activeName = localStorage.getItem(STORAGE_KEY_ACTIVE_PROJECT);
      if (!activeName) {
        console.log('Нет активного проекта в localStorage');
        return null;
      }

      const projects = getAllProjects();
      const project = projects.find(p => p.name === activeName);

      if (!project) {
        console.log('Активный проект не найден в списке проектов:', activeName);
        // Очищаем невалидную ссылку
        localStorage.removeItem(STORAGE_KEY_ACTIVE_PROJECT);
        return null;
      }

      console.log('Получен активный проект:', project);
      return project;
    }

    /**
     * Установить активный проект
     * @param {string} projectName Название проекта
     */
    function setActiveProject(projectName) {
      localStorage.setItem(STORAGE_KEY_ACTIVE_PROJECT, projectName);
      console.log('Установлен активный проект:', projectName);
    }

    /**
     * Получить имя активного проекта
     * @returns {string|null} Название проекта или null
     */
    function getActiveProjectName() {
      return localStorage.getItem(STORAGE_KEY_ACTIVE_PROJECT);
    }

    function renderProjectList() {
      const container = document.getElementById('projects-list-container');
      if (!container) {
        console.error('Контейнер projects-list-container не найден');
        return;
      }

      const projects = getAllProjects();

      container.innerHTML = '';

      if (projects.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3em; margin-bottom: 20px;">📊</div>
                <h3 style="color: var(--primary-blue); margin-bottom: 10px;">Нет проектов</h3>
                <p>Создайте первый проект для начала работы</p>
            </div>`;
        return;
      }

      const activeProjectName = getActiveProjectName();

      projects.forEach(project => {
        const row = document.createElement('div');
        row.className = 'project-row';

        // Подсвечиваем активный проект
        const isActive = project.name === activeProjectName;

        row.innerHTML = `
            <button class="list-button ${isActive ? 'active-project' : ''}">
                <div style="text-align: left;">
                    <strong style="color: var(--primary-blue);">${project.name}</strong>
                    ${isActive ? '<span style="color: green; margin-left: 10px;">✓ активный</span>' : ''}
                    <br>
                    <small style="color: #666;">Дата: ${formatDateToDMY(project.date)}</small>
                </div>
            </button>
            <button class="delete-button" title="Удалить проект">🗑️</button>
        `;

        row.querySelector('.list-button').onclick = () => {
          setActiveProject(project.name);
          showMainMenu();
        };

        row.querySelector('.delete-button').onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Удалить проект "${project.name}"? Все данные будут потеряны.`)) {
            const updatedProjects = getAllProjects().filter(p => p.name !== project.name);
            saveAllProjects(updatedProjects);

            // Если удаляем активный проект, сбрасываем его
            if (project.name === getActiveProjectName()) {
              localStorage.removeItem(STORAGE_KEY_ACTIVE_PROJECT);
            }

            renderProjectList();
          }
        };

        container.appendChild(row);
      });
    }

    // ================================================
    // НАВИГАЦИЯ
    // ================================================

    function showScreen(screenId) {
      // Скрываем все экраны
      const screens = document.querySelectorAll('.app-screen');
      screens.forEach(s => s.classList.add('hidden'));

      // Показываем нужный экран
      const target = document.getElementById(screenId);
      if (target) {
        target.classList.remove('hidden');
        target.scrollTop = 0;
      }
    }

    function showProjectList() {
      renderProjectList();
      showScreen('project-list-screen');
    }

    // Экспортируем функцию для внешнего использования
    window.showProjectList = showProjectList;

    // Запоминаем текущий проект крыши, чтобы сбрасывать данные при переключении
    window.__roofCurrentProjectName = window.__roofCurrentProjectName || null;

    function resetRoofModuleState() {
      // Сбрасываем данные, связанные с крышей/балками
      if (typeof resetRadialForm === 'function') resetRadialForm();
      if (typeof resetRoofForm === 'function') resetRoofForm();
    }

    function showMainMenu() {
      // ВСЕГДА получаем актуальные данные из localStorage
      const activeProject = getActiveProject();

      if (activeProject) {
        const projectNameEl = document.getElementById('roof-rvs-name');
        const projectDateEl = document.getElementById('roof-rvs-date');
        if (projectNameEl) {
          projectNameEl.textContent = activeProject.name;
          projectDateEl.textContent = `Дата: ${convertStorageDate(activeProject.createdAt)}`;
        }

        // Если переключили проект — очищаем состояние модулей крыши
        if (window.__roofCurrentProjectName !== activeProject.name) {
          window.__roofCurrentProjectName = activeProject.name;
          resetRoofModuleState();
        }

        showScreen('roof-screen');
        updateRoofModuleStatusUI();
      } else {
        showProjectList();
      }
    }

    // --- Подсветка выполнения подмодулей крыши ---
    const ROOF_SUBMODULES_TEMPLATE = [
      { id: 'radial-beams', text: 'Разность отметок смежных узлов верха радиальных балок', status: 'pending' },
      { id: 'roof-top', text: 'Отметка верха крыши', status: 'pending' }
    ];

    function ensureRoofSubmodules(project) {
      if (!project.data) project.data = {};
      if (!project.data.roofSubmodules) {
        project.data.roofSubmodules = JSON.parse(JSON.stringify(ROOF_SUBMODULES_TEMPLATE));
      }
      return project.data.roofSubmodules;
    }

    function saveRoofSubmodules(project, subs) {
      project.data.roofSubmodules = subs;
      const projects = getAllProjects();
      const idx = projects.findIndex(p => p.name === project.name);
      if (idx !== -1) {
        projects[idx] = project;
        saveAllProjects(projects);
      }
    }

    function updateRoofModuleStatusUI() {
      const proj = getActiveProject();
      if (!proj) return;
      const subs = ensureRoofSubmodules(proj);
      const map = {};
      subs.forEach(sub => map[sub.id] = sub.status);

      const btnRadial = document.getElementById('btn-radial-beams');
      const btnRoofTop = document.getElementById('btn-roof-top');
      if (btnRadial) {
        btnRadial.classList.toggle('completed', map['radial-beams'] === 'completed');
      }
      if (btnRoofTop) {
        btnRoofTop.classList.toggle('completed', map['roof-top'] === 'completed');
      }
    }

    function markRoofModuleCompleted(moduleId) {
      const proj = getActiveProject();
      if (!proj) return;
      const subs = ensureRoofSubmodules(proj);
      const sub = subs.find(s => s.id === moduleId);
      if (sub) {
        sub.status = 'completed';
      }
      saveRoofSubmodules(proj, subs);
      updateRoofModuleStatusUI();
    }

    function showModule(moduleId) {
      // ВСЕГДА получаем актуальные данные из localStorage
      const activeProject = getActiveProject();

      console.log('showModule вызван, moduleId:', moduleId, 'activeProject:', activeProject);

      if (!activeProject) {
        showModal('Ошибка', 'Сначала выберите проект');
        showProjectList();
        return;
      }

      if (moduleId === 'radial-beams') {
        if (window.__roofCurrentProjectName !== activeProject.name) {
          window.__roofCurrentProjectName = activeProject.name;
          resetRoofModuleState();
        }
        initRadialBeamsModule();
        showScreen('radial-beams-screen');
      } else if (moduleId === 'roof-top') {
        if (window.__roofCurrentProjectName !== activeProject.name) {
          window.__roofCurrentProjectName = activeProject.name;
          resetRoofModuleState();
        }
        initRoofTopModule();
        showScreen('roof-top-screen');
      }
    }

    // ================================================
    // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
    // ================================================

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM загружен, инициализация приложения...');

      // Устанавливаем сегодняшнюю дату по умолчанию
      const today = getCurrentDate();

      const dateFields = [
        'project-date',
        'measurement-date-radial',
        'measurement-date-roof'
      ];

      dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = today;
      });

      // Обработчики для кнопок модулей
      const btnRadialBeams = document.getElementById('btn-radial-beams');
      const btnRoofTop = document.getElementById('btn-roof-top');

      if (btnRadialBeams) {
        btnRadialBeams.onclick = () => {
          console.log('Клик по btn-radial-beams');
          showModule('radial-beams');
        };
      }

      if (btnRoofTop) {
        btnRoofTop.onclick = () => {
          console.log('Клик по btn-roof-top');
          showModule('roof-top');
        };
      }

      // Обработчики для создания проекта
      const createNewProjectBtn = document.getElementById('create-new-project-button');
      if (createNewProjectBtn) {
        createNewProjectBtn.onclick = () => {
          // Очищаем поля формы
          const projectNameField = document.getElementById('project-name');
          const projectDateField = document.getElementById('project-date');
          if (projectNameField) projectNameField.value = '';
          if (projectDateField) projectDateField.value = getCurrentDate();

          showScreen('setup-screen');
        };
      }

      const saveProjectBtn = document.getElementById('save-project-button');
      if (saveProjectBtn) {
        saveProjectBtn.onclick = () => {
          const nameField = document.getElementById('project-name');
          const dateField = document.getElementById('project-date');

          const name = nameField ? nameField.value.trim() : '';
          const date = dateField ? dateField.value : '';

          if (!name) {
            showModal('Ошибка', 'Введите название проекта');
            return;
          }

          if (!date) {
            showModal('Ошибка', 'Введите дату проекта');
            return;
          }

          const projects = getAllProjects();

          // Проверяем, есть ли проект с таким именем
          if (projects.some(p => p.name === name)) {
            showModal('Ошибка', 'Проект с таким именем уже существует');
            return;
          }

          // Создаем новый проект
          const newProject = {
            name: name,
            date: date,
            createdAt: new Date().toISOString()
          };

          projects.push(newProject);
          saveAllProjects(projects);
          setActiveProject(name);

          // Очищаем поле ввода
          if (nameField) nameField.value = '';

          console.log('Проект создан:', newProject);
          showMainMenu();
        };
      }

      const cancelSetupBtn = document.getElementById('cancel-setup-button');
      if (cancelSetupBtn) {
        cancelSetupBtn.onclick = showProjectList;
      }

      // Обработчики для ввода диаметра резервуара
      const radialTankDiameter = document.getElementById('radial-tank-diameter');
      const roofTankDiameter = document.getElementById('roof-tank-diameter');

      if (radialTankDiameter) {
        radialTankDiameter.addEventListener('input', updateBeamJointTolerance);
      }

      if (roofTankDiameter) {
        roofTankDiameter.addEventListener('input', updateRoofTolerance);
      }

      // Обработчик для кнопки "Назад" на экране крыши
      const roofToBackBtn = document.getElementById('roof-to-back');
      if (roofToBackBtn) {
        roofToBackBtn.addEventListener('click', function () {
          showScreen("projectsSection");
          const header = document.querySelector("header");
          const containerHero = document.querySelector(".container-hero");
          const mainContent = document.querySelector(".main-content");
          const appRoof = document.getElementById("app-roof");

          if (header) header.style.display = 'block';
          if (containerHero) containerHero.style.display = 'block';
          if (mainContent) mainContent.style.display = 'block';
          if (appRoof) appRoof.style.display = 'none';
        });
      }
      const roofToModulesBtn = document.getElementById('roof-to-modules');
      if (roofToModulesBtn) {
        roofToModulesBtn.addEventListener('click', function () {
          showScreen("modulesSection");
          const header = document.querySelector("header");
          const containerHero = document.querySelector(".container-hero");
          const mainContent = document.querySelector(".main-content");
          const appRoof = document.getElementById("app-roof");

          if (header) header.style.display = 'block';
          if (containerHero) containerHero.style.display = 'block';
          if (mainContent) mainContent.style.display = 'block';
          if (appRoof) appRoof.style.display = 'none';
        });
      }
      const wallMenuBackToModulesBtn = document.getElementById('wallmenu-back-to-modules-button');
      if (wallMenuBackToModulesBtn) {
        wallMenuBackToModulesBtn.addEventListener('click', function () {
          showScreen("modulesSection");
          const header = document.querySelector("header");
          const containerHero = document.querySelector(".container-hero");
          const mainContent = document.querySelector(".main-content");
          const appWall = document.getElementById("app-wall");

          if (header) header.style.display = 'block';
          if (containerHero) containerHero.style.display = 'block';
          if (mainContent) mainContent.style.display = 'block';
          if (appWall) appWall.style.display = 'none';
        });
      }

      // Слушаем изменения в localStorage из других вкладок
      window.addEventListener('storage', (e) => {
        console.log('Изменение в localStorage:', e.key);
        if (e.key === STORAGE_KEY_PROJECTS || e.key === STORAGE_KEY_ACTIVE_PROJECT) {
          // Обновляем UI при изменениях из других вкладок
          const currentScreen = document.querySelector('.app-screen:not(.hidden)');
          if (currentScreen && currentScreen.id === 'project-list-screen') {
            renderProjectList();
          }
        }
      });

      // Определяем начальный экран
      const projects = getAllProjects();
      const activeProject = getActiveProject();

      console.log('Начальное состояние - проектов:', projects.length, 'активный:', activeProject?.name);

      if (projects.length > 0) {
        if (activeProject) {
          showMainMenu();
        } else {
          showProjectList();
        }
      } else {
        showScreen('setup-screen');
      }
    });

    // ================================================
    // МОДУЛЬ 1: РАЗНОСТЬ ОТМЕТОК СМЕЖНЫХ УЗЛОВ ВЕРХА РАДИАЛЬНЫХ БАЛОК
    // ================================================
function formatNumber(value) {
  return Number.isInteger(value)
    ? value
    : parseFloat(value.toString());
}

    function initRadialBeamsModule() {
      // ВСЕГДА получаем актуальные данные из localStorage
      const activeProject = getActiveProject();

      console.log('initRadialBeamsModule, activeProject:', activeProject);

      if (!activeProject) {
        showModal('Ошибка', 'Сначала выберите проект');
        showProjectList();
        return;
      }

      // Обновляем название проекта
      const projectNameEl = document.getElementById('radial-project-name');
      if (projectNameEl) {
        projectNameEl.textContent = activeProject.name;
      }

      // Сбрасываем данные
      radialBeamsData = {
        projectName: activeProject.name,
        date: getCurrentDate(),
        diameter: 0,
        beamCount: 0,
        zoneType: 'wall',
        tolerance: 20,
        beamHeights: [],
        differences: [],
        excelData: []
      };

      // Устанавливаем сегодняшнюю дату
      const dateField = document.getElementById('measurement-date-radial');
      if (dateField) dateField.value = getCurrentDate();

      // Сбрасываем ввод диаметра
      const diameterField = document.getElementById('radial-tank-diameter');
      if (diameterField) diameterField.value = '';

      // Сбрасываем количество балок
      const beamCountField = document.getElementById('beam-count');
      if (beamCountField) beamCountField.value = '8';

      // Сбрасываем выбор зоны
      document.querySelectorAll('.zone-button').forEach(btn => {
        btn.classList.remove('active');
      });
      const wallZoneBtn = document.querySelector('.zone-button[data-zone="wall"]');
      if (wallZoneBtn) wallZoneBtn.classList.add('active');

      const selectedZoneField = document.getElementById('selected-zone');
      if (selectedZoneField) selectedZoneField.value = 'wall';

      // Скрываем информацию о допуске
      const toleranceInfo = document.getElementById('beam-joint-tolerance-info');
      if (toleranceInfo) toleranceInfo.style.display = 'none';

      // Показываем первый шаг
      document.getElementById('radial-step-1')?.classList.remove('hidden');
      document.getElementById('radial-step-2')?.classList.add('hidden');
      document.getElementById('radial-step-3')?.classList.add('hidden');
    }

    function selectZone(zoneType) {
      // Сбрасываем активный класс у всех кнопок
      document.querySelectorAll('.zone-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Устанавливаем активный класс выбранной кнопке
      const selectedBtn = document.querySelector(`.zone-button[data-zone="${zoneType}"]`);
      if (selectedBtn) selectedBtn.classList.add('active');

      // Сохраняем выбранную зону
      const selectedZoneField = document.getElementById('selected-zone');
      if (selectedZoneField) selectedZoneField.value = zoneType;
      radialBeamsData.zoneType = zoneType;

      // Обновляем информацию о допуске
      updateBeamJointTolerance();
    }

    function updateBeamJointTolerance() {
      const selectedZoneEl = document.getElementById('selected-zone');
      const diameterInput = document.getElementById('radial-tank-diameter');
      const infoDiv = document.getElementById('beam-joint-tolerance-info');

      if (!selectedZoneEl || !diameterInput || !infoDiv) return;

      const zoneType = selectedZoneEl.value;
      const diameter = parseFloat(diameterInput.value) || 0;

      if (zoneType === 'joint') {
        if (diameter > 0) {
          const diameterMeters = diameter / 1000;
          const tolerance = (diameterMeters <= 25) ? 20 : 30;

          const toleranceValueEl = document.getElementById('beam-joint-tolerance-value');
          if (toleranceValueEl) toleranceValueEl.textContent = `±${tolerance}`;
          infoDiv.style.display = 'block';

          radialBeamsData.tolerance = tolerance;
        } else {
          infoDiv.style.display = 'none';
        }
      } else {
        infoDiv.style.display = 'none';

        // Устанавливаем допуск для других зон
        if (zoneType === 'wall') {
          radialBeamsData.tolerance = 20;
        } else if (zoneType === 'center') {
          radialBeamsData.tolerance = 10;
        }
      }
    }

    function generateBeamTable() {
      // Получаем актуальный проект
      const activeProject = getActiveProject();
      if (!activeProject) {
        showModal('Ошибка', 'Проект не выбран');
        showProjectList();
        return;
      }

      const date = document.getElementById('measurement-date-radial')?.value;
      const diameter = parseFloat(document.getElementById('radial-tank-diameter')?.value) || 0;
      const beamCount = parseInt(document.getElementById('beam-count')?.value) || 0;
      const zoneType = document.getElementById('selected-zone')?.value || 'wall';

      // Проверки
      if (!date) {
        showModal('Ошибка', 'Введите дату замера');
        return;
      }

      if (diameter <= 0) {
        showModal('Ошибка', 'Введите диаметр резервуара');
        return;
      }

      if (beamCount < 2) {
        showModal('Ошибка', 'Количество радиальных балок должно быть не менее 2');
        return;
      }

      // Обновляем данные
      radialBeamsData.projectName = activeProject.name;
      radialBeamsData.date = date;
      radialBeamsData.diameter = diameter;
      radialBeamsData.beamCount = beamCount;
      radialBeamsData.zoneType = zoneType;

      // Определяем допуск
      if (zoneType === 'wall') {
        radialBeamsData.tolerance = 20;
      } else if (zoneType === 'center') {
        radialBeamsData.tolerance = 10;
      } else if (zoneType === 'joint') {
        const diameterMeters = diameter / 1000;
        radialBeamsData.tolerance = (diameterMeters <= 25) ? 20 : 30;
      }

      // Создаем поля для ввода высот
      const container = document.getElementById('beam-inputs-grid');
      if (!container) return;

      container.innerHTML = '';

      for (let i = 1; i <= beamCount; i++) {
        const card = document.createElement('div');
        card.className = 'input-card';
        card.innerHTML = `
            <h4>Балка ${i}</h4>
            <input type="tel" 
                   id="beam-height-${i}" 
                   placeholder="Высотная отметка, мм" 
                   step="0.1"
                   class="beam-height-input">
        `;
        container.appendChild(card);
      }

      // Обновляем отображение настроек
      let zoneName, toleranceText;
      if (zoneType === 'wall') {
        zoneName = 'в зоне сопряжения со стенкой';
        toleranceText = '±20 мм';
      } else if (zoneType === 'center') {
        zoneName = 'в зоне сопряжения с центральным щитом';
        toleranceText = '±10 мм';
      } else {
        zoneName = 'в зоне стыковки радиальных балок';
        toleranceText = `±${radialBeamsData.tolerance} мм`;
      }

      const summaryEl = document.getElementById('settings-summary');
      if (summaryEl) {
        summaryEl.innerHTML = `
            <strong>${activeProject.name}</strong> (${formatDateToDMY(date)})<br>
            Диаметр: ${diameter} мм | Балок: ${beamCount}<br>
            Зона измерения: ${zoneName}<br>
            Допуск: ${toleranceText}
        `;
      }

      // Переходим ко второму шагу
      document.getElementById('radial-step-1')?.classList.add('hidden');
      document.getElementById('radial-step-2')?.classList.remove('hidden');
    }

    function calculateBeamDifferences() {
      const beamCount = radialBeamsData.beamCount;

      // Собираем высоты балок
      const heights = [];
      for (let i = 1; i <= beamCount; i++) {
        const input = document.getElementById(`beam-height-${i}`);
        if (!input) {
          showModal('Ошибка', `Поле для балки ${i} не найдено`);
          return;
        }
        const height = parseFloat(input.value);
        if (isNaN(height)) {
          showModal('Ошибка', `Введите высотную отметку для балки ${i}`);
          input.focus();
          return;
        }
        heights.push(height);
      }

      // Сохраняем высоты
      radialBeamsData.beamHeights = heights;

      // Рассчитываем разности между смежными балками
      const differences = [];
      for (let i = 0; i < beamCount; i++) {
        const nextIndex = (i + 1) % beamCount;
        const diff = Math.abs(heights[i] - heights[nextIndex]);
        const isOutOfTolerance = diff > radialBeamsData.tolerance;

        differences.push({
          beam1: i + 1,
          beam2: nextIndex + 1,
          height1: heights[i],
          height2: heights[nextIndex],
          difference: diff,
          isOutOfTolerance: isOutOfTolerance
        });
      }

      radialBeamsData.differences = differences;

      // Отображаем результаты
      displayBeamResults();

      // Переходим к третьему шагу
      document.getElementById('radial-step-2')?.classList.add('hidden');
      document.getElementById('radial-step-3')?.classList.remove('hidden');
    }

    function displayBeamResults() {
      // Обновляем информацию о параметрах
      let zoneName, toleranceText, zoneNameForFile;
      if (radialBeamsData.zoneType === 'wall') {
        zoneName = 'в зоне сопряжения со стенкой';
        toleranceText = '±20 мм';
        zoneNameForFile = 'стенка';
      } else if (radialBeamsData.zoneType === 'center') {
        zoneName = 'в зоне сопряжения с центральным щитом';
        toleranceText = '±10 мм';
        zoneNameForFile = 'центральный_щит';
      } else {
        zoneName = 'в зоне стыковки радиальных балок';
        toleranceText = `±${radialBeamsData.tolerance} мм`;
        zoneNameForFile = 'стыковка_балок';
      }

      const resultsProjectNameEl = document.getElementById('results-project-name-beam');
      const resultsDateEl = document.getElementById('results-date-beam');
      const resultsDiameterEl = document.getElementById('results-diameter-beam');
      const resultsToleranceEl = document.getElementById('results-tolerance-beam');

      if (resultsProjectNameEl) resultsProjectNameEl.textContent = radialBeamsData.projectName;
      if (resultsDateEl) resultsDateEl.textContent = formatDateToDMY(radialBeamsData.date);
      if (resultsDiameterEl) resultsDiameterEl.textContent = radialBeamsData.diameter;
      if (resultsToleranceEl) resultsToleranceEl.textContent = toleranceText;

      // Создаем таблицу результатов
      const table = document.getElementById('beam-results-table');
      if (!table) return;

      let html = `
        <thead>
            <tr>
                <th style="background: var(--accent-blue); color: white; padding: 12px;">№ радиальной балки</th>
                <th style="background: var(--accent-blue); color: white; padding: 12px;">Высотная отметка, мм</th>
                <th style="background: var(--accent-blue); color: white; padding: 12px;">Смежные узлы балок</th>
                <th style="background: var(--accent-blue); color: white; padding: 12px;">Разность отметок, мм</th>
                <th style="background: var(--accent-blue); color: white; padding: 12px;">Статус</th>
            </tr>
        </thead>
        <tbody>`;

      // Подготавливаем данные для Excel
      radialBeamsData.excelData = [];
      radialBeamsData.excelData.push(['Результаты расчета разности отметок смежных узлов верха радиальных балок']);
      radialBeamsData.excelData.push(['Проект:', radialBeamsData.projectName]);
      radialBeamsData.excelData.push(['Дата замера:', formatDateToDMY(radialBeamsData.date)]);
      radialBeamsData.excelData.push(['Диаметр резервуара:', `${radialBeamsData.diameter} мм`]);
      radialBeamsData.excelData.push(['Количество балок:', radialBeamsData.beamCount]);
      radialBeamsData.excelData.push(['Тип зоны:', zoneName]);
      radialBeamsData.excelData.push(['Допуск:', toleranceText]);
      radialBeamsData.excelData.push([]);
      radialBeamsData.excelData.push(['№ балки', 'Высотная отметка, мм', 'Смежные узлы', 'Разность отметок, мм', 'Статус']);

      let outOfToleranceCount = 0;

      // Заполняем таблицу
      for (let i = 0; i < radialBeamsData.beamCount; i++) {
        const height = radialBeamsData.beamHeights[i];
        const diffData = radialBeamsData.differences[i];

        const rowClass = diffData.isOutOfTolerance ? 'out-of-tolerance' : '';
        const formattedDiff = formatNumber(diffData.difference);

const diffDisplay = diffData.isOutOfTolerance ?
  `${formattedDiff}*` :
  formattedDiff;



        html += `
            <tr>
                <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; font-weight: bold;">${i + 1}</td>
                <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center;">${formatNumber(height)}</td>
                <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center;">${diffData.beam1}-${diffData.beam2}</td>
                <td class="${rowClass}" style="padding: 10px; border: 1px solid var(--light-border); text-align: center;">${diffDisplay}</td>
                <td style="padding: 10px; border: 1px solid var(--light-border); text-align: center; ${diffData.isOutOfTolerance ? 'color: var(--danger-red); font-weight: bold;' : 'color: var(--success-green);'}">
                    ${diffData.isOutOfTolerance ? 'Превышен' : 'В норме'}
                </td>
            </tr>`;

        // Добавляем в данные для Excel
       radialBeamsData.excelData.push([
  i + 1,
  formatNumber(height),
  `${diffData.beam1}-${diffData.beam2}`,
  diffData.isOutOfTolerance
    ? `${formatNumber(diffData.difference)}*`
    : formatNumber(diffData.difference),
  diffData.isOutOfTolerance ? 'Превышен' : 'В норме'
]);

        if (diffData.isOutOfTolerance) outOfToleranceCount++;
      }

      html += `</tbody>`;
      table.innerHTML = html;

      // Обновляем итоговую информацию
      const summary = document.getElementById('beam-summary');
      if (summary) {
        if (outOfToleranceCount > 0) {
          summary.style.backgroundColor = '#fceded';
          summary.style.borderLeftColor = 'var(--danger-red)';
          summary.innerHTML = `
                <strong>⚠️ Обнаружены нарушения:</strong> ${outOfToleranceCount} из ${radialBeamsData.beamCount} разностей превышают допуск<br>
                Допуск: ${toleranceText}<br>
                Значения, отмеченные <span style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска по ГОСТ 31385-2023
            `;
        } else {
          summary.style.backgroundColor = '';
          summary.style.borderLeftColor = '';
          summary.innerHTML = `
                <strong>✓ Все значения в пределах допуска</strong><br>
                Допуск: ${toleranceText}<br>
                Значения, отмеченные <span style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска по ГОСТ 31385-2023
            `;
        }
      }

      // Сохраняем имя зоны для файла
      radialBeamsData.zoneNameForFile = zoneNameForFile;

      // Добавляем примечание в Excel
      radialBeamsData.excelData.push([]);
      radialBeamsData.excelData.push(['ПРИМЕЧАНИЕ (ГОСТ 31385-2023, таблица 20):']);
      radialBeamsData.excelData.push(['Разность отметок смежных узлов верха радиальных балок и ферм:']);
      radialBeamsData.excelData.push(['• в зоне сопряжения со стенкой: ±20 мм']);
      radialBeamsData.excelData.push(['• в зоне сопряжения с центральным щитом: ±10 мм']);
      radialBeamsData.excelData.push(['• в зоне стыковки радиальных балок:']);
      radialBeamsData.excelData.push(['  - при диаметре резервуара до 25 м включительно: ±20 мм']);
      radialBeamsData.excelData.push(['  - при диаметре резервуара свыше 25 м: ±30 мм']);
      radialBeamsData.excelData.push(['* — значения, превышающие допуск']);
    }

    function exportRadialBeamsToExcel() {
      if (radialBeamsData.excelData.length === 0) {
        showModal('Ошибка', 'Нет данных для экспорта. Сначала выполните расчет.');
        return;
      }

      const cleanProjectName = radialBeamsData.projectName
        .replace(/\s+/g, '_')
        .replace(/[<>:"/\\|?*]/g, '')
        .trim();

      const formattedDate = formatDateToDMY(radialBeamsData.date).replace(/\./g, '-');

      let zoneLabel = 'разность отметок радиальных балок';
      if (radialBeamsData.zoneType === 'wall') {
        zoneLabel = 'разность отметок радиальных балок в зоне сопряжения со стенкой';
      } else if (radialBeamsData.zoneType === 'center') {
        zoneLabel = 'разность отметок радиальных балок в зоне сопряжения с центральным щитом';
      } else if (radialBeamsData.zoneType === 'joint') {
        zoneLabel = 'разность отметок радиальных балок в зоне стыковки радиальных балок';
      }

      const filename = `${cleanProjectName} ${zoneLabel} ${formattedDate}.xlsx`;

      try {
        // Создаем книгу Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(radialBeamsData.excelData);

        // Настраиваем ширину столбцов
        ws['!cols'] = [
          { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Результаты");
        XLSX.writeFile(wb, filename);

        showModal('Успех', `Файл Excel успешно создан: ${filename}`);
        markRoofModuleCompleted('radial-beams');
      } catch (e) {
        console.error('Ошибка экспорта в Excel:', e);
        showModal('Ошибка', 'Не удалось создать файл Excel. Проверьте, подключена ли библиотека XLSX.');
      }
    }

    function backToRadialStep1() {
      document.getElementById('radial-step-1')?.classList.remove('hidden');
      document.getElementById('radial-step-2')?.classList.add('hidden');
    }

    function backToRadialStep2() {
      document.getElementById('radial-step-2')?.classList.remove('hidden');
      document.getElementById('radial-step-3')?.classList.add('hidden');
    }

    function resetRadialForm() {
      // Получаем актуальный проект
      const activeProject = getActiveProject();

      // Сбрасываем данные
      radialBeamsData = {
        projectName: activeProject ? activeProject.name : '',
        date: getCurrentDate(),
        diameter: 0,
        beamCount: 0,
        zoneType: 'wall',
        tolerance: 20,
        beamHeights: [],
        differences: [],
        excelData: []
      };

      // Сбрасываем форму
      const dateField = document.getElementById('measurement-date-radial');
      const diameterField = document.getElementById('radial-tank-diameter');
      const beamCountField = document.getElementById('beam-count');
      const inputsGrid = document.getElementById('beam-inputs-grid');

      if (dateField) dateField.value = getCurrentDate();
      if (diameterField) diameterField.value = '';
      if (beamCountField) beamCountField.value = '8';
      if (inputsGrid) inputsGrid.innerHTML = '';

      // Сбрасываем выбор зоны
      document.querySelectorAll('.zone-button').forEach(btn => {
        btn.classList.remove('active');
      });
      const wallZoneBtn = document.querySelector('.zone-button[data-zone="wall"]');
      if (wallZoneBtn) wallZoneBtn.classList.add('active');

      const selectedZoneField = document.getElementById('selected-zone');
      if (selectedZoneField) selectedZoneField.value = 'wall';

      // Скрываем информацию о допуске
      const toleranceInfo = document.getElementById('beam-joint-tolerance-info');
      if (toleranceInfo) toleranceInfo.style.display = 'none';

      // Показываем первый шаг
      document.getElementById('radial-step-1')?.classList.remove('hidden');
      document.getElementById('radial-step-2')?.classList.add('hidden');
      document.getElementById('radial-step-3')?.classList.add('hidden');
    }

    // ================================================
    // МОДУЛЬ 2: ОТМЕТКА ВЕРХА КРЫШИ
    // ================================================

    function initRoofTopModule() {
      // ВСЕГДА получаем актуальные данные из localStorage
      const activeProject = getActiveProject();

      console.log('initRoofTopModule, activeProject:', activeProject);

      if (!activeProject) {
        showModal('Ошибка', 'Сначала выберите проект');
        showProjectList();
        return;
      }

      // Обновляем название проекта
      const projectNameEl = document.getElementById('roof-project-name');
      if (projectNameEl) {
        projectNameEl.textContent = activeProject.name;
      }

      // Сбрасываем данные
      roofTopData = {
        projectName: activeProject.name,
        date: getCurrentDate(),
        diameter: 0,
        projectHeight: 0,
        bottomSlope: 0,
        distanceToFlange: 0,
        actualHeight: 0,
        tolerance: 0,
        deviation: 0,
        isOutOfTolerance: false,
        excelData: []
      };

      // Устанавливаем сегодняшнюю дату
      const dateField = document.getElementById('measurement-date-roof');
      if (dateField) dateField.value = getCurrentDate();

      // Сбрасываем поля ввода
      const diameterField = document.getElementById('roof-tank-diameter');
      const projectHeightField = document.getElementById('project-roof-height');
      const bottomSlopeField = document.getElementById('bottom-slope');
      const distanceToFlangeField = document.getElementById('distance-to-flange');

      if (diameterField) diameterField.value = '';
      if (projectHeightField) projectHeightField.value = '';
      if (bottomSlopeField) bottomSlopeField.value = '';
      if (distanceToFlangeField) distanceToFlangeField.value = '';

      // Скрываем информацию о допуске
      const toleranceInfo = document.getElementById('roof-tolerance-info');
      if (toleranceInfo) toleranceInfo.style.display = 'none';

      // Показываем первый шаг
      document.getElementById('roof-step-1')?.classList.remove('hidden');
      document.getElementById('roof-step-2')?.classList.add('hidden');
      document.getElementById('roof-step-3')?.classList.add('hidden');
    }

    function updateRoofTolerance() {
      const diameterInput = document.getElementById('roof-tank-diameter');
      const infoDiv = document.getElementById('roof-tolerance-info');

      if (!diameterInput || !infoDiv) return;

      const diameter = parseFloat(diameterInput.value) || 0;

      if (diameter > 0) {
        const diameterMeters = diameter / 1000;
        const tolerance = (diameterMeters <= 25) ? 30 : 50;

        const toleranceValueEl = document.getElementById('roof-tolerance-value');
        if (toleranceValueEl) toleranceValueEl.textContent = `±${tolerance}`;
        infoDiv.style.display = 'block';

        roofTopData.tolerance = tolerance;
      } else {
        infoDiv.style.display = 'none';
      }
    }

    function goToRoofStep2() {
      // Получаем актуальный проект
      const activeProject = getActiveProject();
      if (!activeProject) {
        showModal('Ошибка', 'Проект не выбран');
        showProjectList();
        return;
      }

      const date = document.getElementById('measurement-date-roof')?.value;
      const diameter = parseFloat(document.getElementById('roof-tank-diameter')?.value) || 0;
      const projectHeight = parseFloat(document.getElementById('project-roof-height')?.value) || 0;

      // Проверки
      if (!date) {
        showModal('Ошибка', 'Введите дату замера');
        return;
      }

      if (diameter <= 0) {
        showModal('Ошибка', 'Введите диаметр резервуара');
        return;
      }

      if (projectHeight <= 0) {
        showModal('Ошибка', 'Введите проектную отметку верха крыши');
        return;
      }

      // Обновляем данные
      roofTopData.projectName = activeProject.name;
      roofTopData.date = date;
      roofTopData.diameter = diameter;
      roofTopData.projectHeight = projectHeight;

      // Определяем допуск
      const diameterMeters = diameter / 1000;
      roofTopData.tolerance = (diameterMeters <= 25) ? 30 : 50;

      // Обновляем отображение настроек
      const toleranceText = roofTopData.tolerance === 30 ? '±30 мм' : '±50 мм';

      const summaryEl = document.getElementById('roof-settings-summary');
      if (summaryEl) {
        summaryEl.innerHTML = `
            <strong>${activeProject.name}</strong> (${formatDateToDMY(date)})<br>
            Диаметр резервуара: ${diameter} мм<br>
            Проектная отметка: ${projectHeight} мм<br>
            Допуск: ${toleranceText}
        `;
      }

      // Переходим ко второму шагу
      document.getElementById('roof-step-1')?.classList.add('hidden');
      document.getElementById('roof-step-2')?.classList.remove('hidden');
    }

    function calculateRoofHeight() {
      const bottomSlope = parseFloat(document.getElementById('bottom-slope')?.value);
      const distanceToFlange = parseFloat(document.getElementById('distance-to-flange')?.value);

      // Проверки
      if (isNaN(bottomSlope) || bottomSlope < 0) {
        showModal('Ошибка', 'Введите уклон днища резервуара');
        return;
      }

      if (isNaN(distanceToFlange) || distanceToFlange <= 0) {
        showModal('Ошибка', 'Введите расстояние от центральной части днища до верха фланца центрального патрубка');
        return;
      }

      // Сохраняем данные
      roofTopData.bottomSlope = bottomSlope;
      roofTopData.distanceToFlange = distanceToFlange;

      // Рассчитываем фактическую отметку верха крыши
      roofTopData.actualHeight = bottomSlope + distanceToFlange;

      // Рассчитываем отклонение
      roofTopData.deviation = roofTopData.actualHeight - roofTopData.projectHeight;
      roofTopData.isOutOfTolerance = Math.abs(roofTopData.deviation) > roofTopData.tolerance;

      // Отображаем результаты
      displayRoofResults();

      // Переходим к третьему шагу
      document.getElementById('roof-step-2')?.classList.add('hidden');
      document.getElementById('roof-step-3')?.classList.remove('hidden');
    }

    function displayRoofResults() {
      const diameterMeters = roofTopData.diameter / 1000;
      const toleranceText = diameterMeters <= 25 ? '±30 мм' : '±50 мм';

      const resultsProjectNameEl = document.getElementById('results-project-name-roof');
      const resultsDateEl = document.getElementById('results-date-roof');
      const resultsToleranceEl = document.getElementById('results-tolerance-roof');

      if (resultsProjectNameEl) resultsProjectNameEl.textContent = roofTopData.projectName;
      if (resultsDateEl) resultsDateEl.textContent = formatDateToDMY(roofTopData.date);
      if (resultsToleranceEl) resultsToleranceEl.textContent = toleranceText;

      // Создаем таблицу результатов
      const tableBody = document.getElementById('roof-results-body');
      if (!tableBody) return;

      // Подготавливаем данные для Excel
      roofTopData.excelData = [];
      roofTopData.excelData.push(['Результаты расчета отметки верха крыши']);
      roofTopData.excelData.push(['Проект:', roofTopData.projectName]);
      roofTopData.excelData.push(['Дата замера:', formatDateToDMY(roofTopData.date)]);
      roofTopData.excelData.push(['Диаметр резервуара:', `${roofTopData.diameter} мм`]);
      roofTopData.excelData.push(['Допуск:', toleranceText]);
      roofTopData.excelData.push([]);
      roofTopData.excelData.push(['Параметр', 'Значение, мм']);

      function cleanNumber(value) {
  return Number.isInteger(value) ? value : parseFloat(value.toString());
}

const parameters = [
  { name: 'Проектная отметка верха крыши', value: cleanNumber(roofTopData.projectHeight) },
  { name: 'Уклон днища резервуара', value: cleanNumber(roofTopData.bottomSlope) },
  { name: 'Расстояние от центральной части днища до верха фланца центрального патрубка', value: cleanNumber(roofTopData.distanceToFlange) },
  { name: 'Фактическая отметка верха крыши', value: cleanNumber(roofTopData.actualHeight) },
  { name: 'Отклонение (факт - проект)', value: cleanNumber(roofTopData.deviation), isDeviation: true },
  { name: 'Допуск по ГОСТ', value: `±${roofTopData.tolerance}` }
];


      let html = '';

parameters.forEach(param => {
  let valueDisplay = param.value;
  let cellClass = '';

  if (param.isDeviation && roofTopData.isOutOfTolerance) {
    valueDisplay = `${roofTopData.deviation}*`;
    cellClass = 'out-of-tolerance';
  }

  html += `
    <tr>
        <td style="padding: 10px; border: 1px solid var(--light-border);">
            ${param.name}
        </td>
        <td class="${cellClass}" style="padding: 10px; border: 1px solid var(--light-border); text-align: center;">
            ${valueDisplay}
        </td>
    </tr>`;

  roofTopData.excelData.push([
    param.name,
    valueDisplay
  ]);
});


      tableBody.innerHTML = html;

      // Обновляем итоговую информацию
      const summary = document.getElementById('roof-summary');
      if (summary) {
        if (roofTopData.isOutOfTolerance) {
          summary.style.backgroundColor = '#fceded';
          summary.style.borderLeftColor = 'var(--danger-red)';
          summary.innerHTML = `
                <strong>⚠️ Обнаружено нарушение:</strong> Отклонение превышает допустимое значение<br>
                Допуск: ${toleranceText} | Фактическое отклонение: ${roofTopData.deviation} мм<br>
                Значение, отмеченное <span style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска
            `;
          roofTopData.excelData.push(['Статус', 'Превышен']);
        } else {
          summary.style.backgroundColor = '';
          summary.style.borderLeftColor = '';
          summary.innerHTML = `
                <strong>✓ Отклонение в пределах допуска</strong><br>
                Допуск: ${toleranceText} | Фактическое отклонение: ${roofTopData.deviation} мм<br>
                Значение, отмеченное <span style="color: var(--danger-red); font-weight: bold;">*</span> — превышение допуска
            `;
          roofTopData.excelData.push(['Статус', 'В норме']);
        }
      }

      // Добавляем примечание в Excel
      roofTopData.excelData.push([]);
      roofTopData.excelData.push(['ПРИМЕЧАНИЕ:']);
      roofTopData.excelData.push(['Допустимые отклонения отметки верха конических и сферических крыш:']);
      roofTopData.excelData.push(['• до 25 м включительно: ±30 мм']);
      roofTopData.excelData.push(['• свыше 25 м: ±50 мм']);
      roofTopData.excelData.push(['Формула расчета: Фактическая отметка = Уклон днища + Расстояние от центральной части днища до верха фланца центрального патрубка']);
      roofTopData.excelData.push(['Отклонение = Фактическая отметка - Проектная отметка']);
      roofTopData.excelData.push(['* — значение, превышающее допуск']);
    }

    function exportRoofTopToExcel() {
      if (roofTopData.excelData.length === 0) {
        showModal('Ошибка', 'Нет данных для экспорта. Сначала выполните расчет.');
        return;
      }

      const cleanProjectName = roofTopData.projectName
        .replace(/\s+/g, '_')
        .replace(/[<>:"/\\|?*]/g, '')
        .trim();

      const formattedDate = formatDateToDMY(roofTopData.date).replace(/\./g, '-');
      const filename = `Проект_${cleanProjectName}_отметка_верха_крыши_${formattedDate}.xlsx`;

      try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(roofTopData.excelData);

        ws['!cols'] = [
  { wch: 45 }, { wch: 20 }
];

        XLSX.utils.book_append_sheet(wb, ws, "Результаты");
        XLSX.writeFile(wb, filename);

        showModal('Успех', `Файл Excel успешно создан: ${filename}`);
        markRoofModuleCompleted('roof-top');
      } catch (e) {
        console.error('Ошибка экспорта в Excel:', e);
        showModal('Ошибка', 'Не удалось создать файл Excel. Проверьте, подключена ли библиотека XLSX.');
      }
    }

    function backToRoofStep1() {
      document.getElementById('roof-step-1')?.classList.remove('hidden');
      document.getElementById('roof-step-2')?.classList.add('hidden');
    }

    function backToRoofStep2() {
      document.getElementById('roof-step-2')?.classList.remove('hidden');
      document.getElementById('roof-step-3')?.classList.add('hidden');
    }

    function resetRoofForm() {
      // Получаем актуальный проект
      const activeProject = getActiveProject();

      // Сбрасываем данные
      roofTopData = {
        projectName: activeProject ? activeProject.name : '',
        date: getCurrentDate(),
        diameter: 0,
        projectHeight: 0,
        bottomSlope: 0,
        distanceToFlange: 0,
        actualHeight: 0,
        tolerance: 0,
        deviation: 0,
        isOutOfTolerance: false,
        excelData: []
      };

      // Сбрасываем форму
      const dateField = document.getElementById('measurement-date-roof');
      const diameterField = document.getElementById('roof-tank-diameter');
      const projectHeightField = document.getElementById('project-roof-height');
      const bottomSlopeField = document.getElementById('bottom-slope');
      const distanceToFlangeField = document.getElementById('distance-to-flange');

      if (dateField) dateField.value = getCurrentDate();
      if (diameterField) diameterField.value = '';
      if (projectHeightField) projectHeightField.value = '';
      if (bottomSlopeField) bottomSlopeField.value = '';
      if (distanceToFlangeField) distanceToFlangeField.value = '';

      // Скрываем информацию о допуске
      const toleranceInfo = document.getElementById('roof-tolerance-info');
      if (toleranceInfo) toleranceInfo.style.display = 'none';

      // Показываем первый шаг
      document.getElementById('roof-step-1')?.classList.remove('hidden');
      document.getElementById('roof-step-2')?.classList.add('hidden');
      document.getElementById('roof-step-3')?.classList.add('hidden');
    }

  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let wallResults = [];
      let roofResults = [];
      let wallExcelData = [];
      let roofExcelData = [];
      let currentWallFileName = "";
      let currentRoofFileName = "";
      let currentWallTankName = "";
      let currentRoofTankName = "";
      let calcExpression = "";
      let wallAxesLengths = [0, 0, 0, 0];
      let roofAxesLengths = [0, 0, 0, 0];
      let wallFullCircumference = 0;
      let roofFullCircumference = 0;
      let currentWallDiameter = 0;
      let currentRoofDiameter = 0;
      let wallImportExpanded = false;
      let roofImportExpanded = false;

      // --- Инициализация приложения ---
      function initApp() {
        calculateArcLength();
        // Добавляем плавную прокрутку для всей страницы
        // document.getElementById('main-content').style.scrollBehavior = 'smooth';
      }
      document.addEventListener('DOMContentLoaded', initApp);
      document.getElementById("inst-hat-pipes-back-to-list-button").addEventListener('click', () => {
        showScreen('projectsSection');
        document.getElementById('inst-hat-pipes').style.display = 'none';
        document.querySelector("header").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
        // window.location.reload();
      });
      document.getElementById("inst-hat-pipes-back-to-modules-button").addEventListener('click', () => {
        showScreen('modulesSection');
        document.getElementById('inst-hat-pipes').style.display = 'none';
        document.querySelector("header").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
      });
      // --- Обновление часов ---
      // function updateClock() {
      //     const clockEl = document.getElementById('clock');
      //     if (clockEl) {
      //         const now = new Date();
      //         clockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      //     }
      // }
      // setInterval(updateClock, 1000);
      // updateClock();


     
      // --- Управление вкладками ---
      function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Скрыть все вкладки
        document.getElementById('arc-tab').classList.add('hidden');
        document.getElementById('wall-tab').classList.add('hidden');
        document.getElementById('roof-tab').classList.add('hidden');
        document.getElementById('wall-results-block').classList.add('hidden');
        document.getElementById('roof-results-block').classList.add('hidden');

        // Свернуть все вкладки импорта при переключении
        if (wallImportExpanded) {
          toggleImportTab('wall');
        }
        if (roofImportExpanded) {
          toggleImportTab('roof');
        }

        // Активировать выбранную вкладку
        if (tabName === 'arc') {
          document.querySelector('.tab:nth-child(1)').classList.add('active');
          document.getElementById('arc-tab').classList.remove('hidden');
        } else if (tabName === 'wall') {
          document.querySelector('.tab:nth-child(2)').classList.add('active');
          document.getElementById('wall-tab').classList.remove('hidden');
          updateNozzleRows('wall');
          updateWallAxesInfo();
        } else if (tabName === 'roof') {
          document.querySelector('.tab:nth-child(3)').classList.add('active');
          document.getElementById('roof-tab').classList.remove('hidden');
          updateNozzleRows('roof');
          updateRoofAxesInfo();
        }
      }

      this.switchTab = switchTab;

      // --- Управление вкладками импорта ---
      function toggleImportTab(tabType) {
        const header = document.querySelector(`#${tabType}-tab .import-tab-header`);
        const content = document.getElementById(`${tabType}-import-tab`);

        if (tabType === 'wall') {
          wallImportExpanded = !wallImportExpanded;
          if (wallImportExpanded) {
            header.classList.add('active');
            content.classList.add('expanded');
            // Плавная прокрутка к содержимому
            setTimeout(() => {
              content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          } else {
            header.classList.remove('active');
            content.classList.remove('expanded');
          }
        } else {
          roofImportExpanded = !roofImportExpanded;
          if (roofImportExpanded) {
            header.classList.add('active');
            content.classList.add('expanded');
            // Плавная прокрутка к содержимому
            setTimeout(() => {
              content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          } else {
            header.classList.remove('active');
            content.classList.remove('expanded');
          }
        }
      }

      this.toggleImportTab = toggleImportTab;

      // --- Очистка столбцов импорта ---
      function clearImportColumn(tabType, column) {
        const columnIds = {
          'wall': {
            'names': 'wall-import-names',
            'diameters': 'wall-import-diameters',
            'degrees': 'wall-import-degrees',
            'heights': 'wall-import-heights'
          },
          'roof': {
            'names': 'roof-import-names',
            'diameters': 'roof-import-diameters',
            'degrees': 'roof-import-degrees',
            'distances': 'roof-import-distances'
          }
        };

        const textarea = document.getElementById(columnIds[tabType][column]);
        if (textarea) {
          textarea.value = '';
          textarea.focus();
        }
      }

      this.clearImportColumn = clearImportColumn

      // Нормализация чисел (поддержка запятой)
      function toNumber(val) {
        if (val === undefined || val === null) return NaN;
        const normalized = String(val).replace(',', '.');
        const match = normalized.match(/-?\d+(?:\.\d+)?/);
        return match ? parseFloat(match[0]) : NaN;
      }

      // --- Расчет длин дуг осей и отображение ---
      function updateWallAxesInfo() {
        const diameter = toNumber(document.getElementById('wall-tank-diameter').value);
        if (isNaN(diameter) || diameter <= 0) {
          document.getElementById('wall-axes-info').classList.add('hidden');
          return;
        }

        const { axesLengths, fullCircumference } = calculateAxesLengths(diameter, 'wall');
        wallAxesLengths = axesLengths;
        wallFullCircumference = fullCircumference;

        const axesInfo = document.getElementById('wall-axes-info');
        const axesGrid = document.getElementById('wall-axes-grid');

        if (axesInfo && axesGrid) {
          axesGrid.innerHTML = '';
          const axisDegrees = [0, 90, 180, 270];

          axisDegrees.forEach((deg, idx) => {
            axesGrid.insertAdjacentHTML('beforeend', `
              <div class="axis-item">
                  <div class="axis-number">Ось ${idx + 1}</div>
                  <div class="axis-degrees">${deg}°</div>
                  <div class="axis-length">${axesLengths[idx].toFixed(1)} мм</div>
              </div>
            `);
          });

          axesGrid.insertAdjacentHTML('beforeend', `
            <div style="grid-column: span 2; text-align: center; margin-top: 0.5rem; padding: 0.5rem; background-color: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
              <div style="font-weight: 600; color: #0369a1;">Полная окружность (360°):</div>
              <div style="font-weight: 700; color: #059669; font-size: 0.8rem;">${fullCircumference.toFixed(1)} мм</div>
            </div>
          `);

          axesInfo.classList.remove('hidden');
        }
      }
      this.updateWallAxesInfo = updateWallAxesInfo;

      function updateRoofAxesInfo() {
        const diameter = toNumber(document.getElementById('roof-tank-diameter-1').value);
        if (isNaN(diameter) || diameter <= 0) {
          document.getElementById('roof-axes-info').classList.add('hidden');
          return;
        }

        const { axesLengths, fullCircumference } = calculateAxesLengths(diameter, 'roof');
        roofAxesLengths = axesLengths;
        roofFullCircumference = fullCircumference;

        const axesInfo = document.getElementById('roof-axes-info');
        const axesGrid = document.getElementById('roof-axes-grid');

        if (axesInfo && axesGrid) {
          axesGrid.innerHTML = '';
          const axisDegrees = [0, 90, 180, 270];

          axisDegrees.forEach((deg, idx) => {
            axesGrid.insertAdjacentHTML('beforeend', `
              <div class="axis-item">
                  <div class="axis-number">Ось ${idx + 1}</div>
                  <div class="axis-degrees">${deg}°</div>
                  <div class="axis-length">${axesLengths[idx].toFixed(1)} мм</div>
              </div>
            `);
          });

          axesGrid.insertAdjacentHTML('beforeend', `
            <div style="grid-column: span 2; text-align: center; margin-top: 0.5rem; padding: 0.5rem; background-color: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
              <div style="font-weight: 600; color: #0369a1;">Полная окружность (360°):</div>
              <div style="font-weight: 700; color: #059669; font-size: 0.8rem;">${fullCircumference.toFixed(1)} мм</div>
            </div>
          `);

          axesInfo.classList.remove('hidden');
        }
      }
      this.updateRoofAxesInfo = updateRoofAxesInfo;

      function calculateAxesLengths(diameter, tabType) {
        if (!diameter || diameter <= 0) return { axesLengths: [], fullCircumference: 0 };

        const fullCircumference = diameter * Math.PI;

        const axesLengths = [
          0, // Ось 1 (0°)
          (diameter * Math.PI * 90) / 360, // Ось 2 (90°)
          (diameter * Math.PI * 180) / 360, // Ось 3 (180°)
          (diameter * Math.PI * 270) / 360  // Ось 4 (270°)
        ];

        return { axesLengths, fullCircumference };
      }

      // --- Расчет длины дуги ---
      function calculateArcLength() {
        const diameter = parseFloat(document.getElementById('tank-diameter-arc').value);
        const degrees = parseFloat(document.getElementById('degrees-count').value) || 0;
        console.log('[Arc] diameter:', diameter, 'degrees:', degrees);
        
        if (!isNaN(diameter) && diameter > 0) {
            const oneDegreeLength = (diameter * Math.PI) / 360;
            console.log('[Arc] oneDegreeLength:', oneDegreeLength);
            document.getElementById('one-degree-value').textContent = oneDegreeLength.toFixed(2) + ' мм';
            document.getElementById('one-degree-result').classList.remove('hidden');
            
            if (degrees > 0) {
                const customLength = oneDegreeLength * degrees;
                console.log('[Arc] customLength:', customLength);
                document.getElementById('degrees-display').textContent = degrees;
                document.getElementById('custom-degree-value').textContent = customLength.toFixed(2) + ' мм';
                document.getElementById('custom-degree-result').classList.remove('hidden');
            } else {
                document.getElementById('custom-degree-result').classList.add('hidden');
            }
            
            document.getElementById('arc-to-angle-conversion').classList.remove('hidden');
            
            // Если введена длина дуги, выполнить обратный расчет
            const arcLength = parseFloat(document.getElementById('arc-length-input').value);
            console.log('[Arc] arcLength input:', arcLength);
            if (!isNaN(arcLength) && arcLength > 0) {
                calculateAngleFromArc();
            }
        } else {
            document.getElementById('one-degree-result').classList.add('hidden');
            document.getElementById('custom-degree-result').classList.add('hidden');
            document.getElementById('arc-to-angle-conversion').classList.add('hidden');
            document.getElementById('angle-result').classList.add('hidden');
        }
      }

      window.calculateArcLength = calculateArcLength;

      // --- Обратный расчет: из длины дуги в градусы ---
      function calculateAngleFromArc() {
        const diameter = toNumber(document.getElementById('tank-diameter-arc').value);
        const arcLength = toNumber(document.getElementById('arc-length-input').value);

        if (!isNaN(diameter) && diameter > 0 && !isNaN(arcLength) && arcLength > 0) {
          const angleInDegrees = (arcLength * 360) / (Math.PI * diameter);
          const angleRounded = Math.round(angleInDegrees * 10000) / 10000;

          const degrees = Math.floor(angleRounded);
          const decimalMinutes = (angleRounded - degrees) * 60;
          const minutes = Math.floor(decimalMinutes);
          const seconds = Math.round((decimalMinutes - minutes) * 60);

          let finalSeconds = seconds;
          let finalMinutes = minutes;
          let finalDegrees = degrees;

          if (finalSeconds >= 60) {
            finalMinutes += Math.floor(finalSeconds / 60);
            finalSeconds = finalSeconds % 60;
          }

          if (finalMinutes >= 60) {
            finalDegrees += Math.floor(finalMinutes / 60);
            finalMinutes = finalMinutes % 60;
          }

          document.getElementById('angle-degrees').textContent = finalDegrees + '°';
          document.getElementById('angle-minutes').textContent = finalMinutes + '′';
          document.getElementById('angle-seconds').textContent = finalSeconds + '″';
          document.getElementById('angle-full').textContent = angleRounded.toFixed(4) + '°';

          document.getElementById('angle-result').classList.remove('hidden');
        } else {
          document.getElementById('angle-result').classList.add('hidden');
        }
      }

      window.calculateAngleFromArc = calculateAngleFromArc;

      // --- Управление строками патрубков ---
      function updateNozzleRows(tabType) {
        const countId = tabType === 'wall' ? 'wall-nozzles-count' : 'roof-nozzles-count';
        const containerId = tabType === 'wall' ? 'wall-nozzle-inputs-grid' : 'roof-nozzle-inputs-grid';

        const count = parseInt(document.getElementById(countId).value) || 1;
        const container = document.getElementById(containerId);
        const currentRows = container.querySelectorAll('.nozzle-row-container').length;

        if (count > currentRows) {
          for (let i = currentRows; i < count; i++) {
            const row = document.createElement('div');
            row.className = 'nozzle-row-container';
            row.dataset.index = i;
            row.dataset.tab = tabType;

            if (tabType === 'wall') {
              row.innerHTML = `
                            <div class="nozzle-row-header">
                                <div class="nozzle-row-title">Патрубок #${i + 1}</div>
                                <div style="display: flex; gap: 0.375rem;">
                                    <button class="btn-reset" onclick="resetNozzleRow(this)" title="Сбросить">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                        </svg>
                                    </button>
                                    <button class="btn-delete" onclick="deleteNozzleRow(this)" ${count <= 1 ? 'style="display: none;"' : ''} title="Удалить">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ОСНОВНЫЕ ПОЛЯ -->
                            <div class="nozzle-row">
                                <input type="text" class="nozzle-name" placeholder="Название люка или патрубка" oninput="updateNozzleTitle(this, ${i}, '${tabType}')">
                                <input type="text" class="nozzle-diameter" placeholder="Ду, мм">
                                <input type="text" class="nozzle-degree" placeholder="Градус">
                                <input type="text" class="nozzle-height" placeholder="Высота, мм">
                                <div style="display: flex; gap: 0.375rem;">
                                    <!-- Кнопки уже в заголовке -->
                                </div>
                            </div>
                        `;
            } else {
              row.innerHTML = `
                            <div class="nozzle-row-header">
                                <div class="nozzle-row-title">Патрубок #${i + 1}</div>
                                <div style="display: flex; gap: 0.375rem;">
                                    <button class="btn-reset" onclick="resetNozzleRow(this)" title="Сбросить">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                        </svg>
                                    </button>
                                    <button class="btn-delete" onclick="deleteNozzleRow(this)" ${count <= 1 ? 'style="display: none;"' : ''} title="Удалить">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ОСНОВНЫЕ ПОЛЯ КРЫШИ -->
                            <!-- Градус перед расстоянием -->
                            <div class="nozzle-row-roof">
                                <input type="text" class="nozzle-name" placeholder="Название люка или патрубка" oninput="updateNozzleTitle(this, ${i}, '${tabType}')">
                                <input type="text" class="nozzle-diameter" placeholder="Ду, мм">
                                <input type="text" class="nozzle-degree" placeholder="Градус">
                                <input type="text" class="distance-from-center" placeholder="А, мм">
                                <div style="display: flex; gap: 0.375rem;">
                                    <!-- Кнопки уже в заголовке -->
                                </div>
                            </div>
                        `;
            }
            container.appendChild(row);
          }
        } else if (count < currentRows) {
          const rows = container.querySelectorAll('.nozzle-row-container');
          for (let i = rows.length - 1; i >= count; i--) {
            container.removeChild(rows[i]);
          }
        }

        // Обновить индексы и кнопки удаления
        const containers = container.querySelectorAll('.nozzle-row-container');
        containers.forEach((container, index) => {
          container.dataset.index = index;
          container.querySelector('.nozzle-row-title').textContent = `Патрубок #${index + 1}`;

          // Обновить обработчик названия
          const nameInput = container.querySelector('.nozzle-name');
          if (nameInput) nameInput.oninput = () => updateNozzleTitle(nameInput, index, tabType);
        });

        const deleteButtons = container.querySelectorAll('.btn-delete');
        deleteButtons.forEach(btn => {
          btn.style.display = count > 1 ? 'flex' : 'none';
        });
      }

      function addNozzleRow(tabType) {
        const countId = tabType === 'wall' ? 'wall-nozzles-count' : 'roof-nozzles-count';
        const countInput = document.getElementById(countId);
        let count = parseInt(countInput.value) || 1;
        count++;
        countInput.value = count;
        updateNozzleRows(tabType);
      }

      this.addNozzleRow = addNozzleRow;

      function deleteNozzleRow(button) {
        const container = button.closest('.nozzle-row-container');
        if (container) {
          const tabType = container.dataset.tab;
          const countId = tabType === 'wall' ? 'wall-nozzles-count' : 'roof-nozzles-count';

          container.remove();
          const countInput = document.getElementById(countId);
          let count = parseInt(countInput.value) || 1;
          count--;
          if (count < 1) count = 1;
          countInput.value = count;

          updateNozzleRows(tabType);
        }
      }
      this.deleteNozzleRow = deleteNozzleRow;

      function resetNozzleRow(button) {
        const container = button.closest('.nozzle-row-container');
        if (container) {
          // Сброс основных полей
          container.querySelector('.nozzle-name').value = '';
          container.querySelector('.nozzle-diameter').value = '';

          // Сброс специфичных полей
          const degreeInput = container.querySelector('.nozzle-degree');
          const heightInput = container.querySelector('.nozzle-height');
          const distanceInput = container.querySelector('.distance-from-center');

          if (degreeInput) degreeInput.value = '';
          if (heightInput) heightInput.value = '';
          if (distanceInput) distanceInput.value = '';

          // Обновить заголовок
          const index = parseInt(container.dataset.index);
          container.querySelector('.nozzle-row-title').textContent = `Патрубок #${index + 1}`;
        }
      }
      this.resetNozzleRow = resetNozzleRow;

      function updateNozzleTitle(input, index, tabType) {
        const container = document.querySelector(`.nozzle-row-container[data-index="${index}"][data-tab="${tabType}"]`);
        if (container && input.value.trim()) {
          container.querySelector('.nozzle-row-title').textContent = input.value.trim();
        } else {
          container.querySelector('.nozzle-row-title').textContent = `Патрубок #${index + 1}`;
        }
      }

      // --- ИМПОРТ ДАННЫХ ПО СТОЛБЦАМ ---
      function parseColumnData(text) {
        if (!text || text.trim() === '') return [];

        // Заменяем запятые на точки для десятичных чисел
        text = text.replace(/,/g, '.');

        // Разделяем по переводам строк
        let lines = text.trim().split('\n');

        // Если всего одна строка, пробуем разделить по пробелам/табуляциям
        if (lines.length === 1) {
          lines = text.trim().split(/\s+/);
        }

        // Фильтруем пустые значения и преобразуем
        return lines
          .map(item => item.trim())
          .filter(item => item !== '');
      }

      function importWallDataByColumns() {
        // Получаем данные из каждого текстового поля
        const names = parseColumnData(document.getElementById('wall-import-names').value);
        const diameters = parseColumnData(document.getElementById('wall-import-diameters').value);
        const degrees = parseColumnData(document.getElementById('wall-import-degrees').value);
        const heights = parseColumnData(document.getElementById('wall-import-heights').value);

        // Определяем максимальное количество строк
        const maxRows = Math.max(names.length, diameters.length, degrees.length, heights.length);

        if (maxRows === 0) {
          showModal('Ошибка', 'Введите данные хотя бы в один столбец');
          return;
        }

        // Устанавливаем количество строк
        document.getElementById('wall-nozzles-count').value = maxRows;
        updateNozzleRows('wall');

        // Заполняем данные
        const containers = document.querySelectorAll('.nozzle-row-container[data-tab="wall"]');
        for (let i = 0; i < Math.min(maxRows, containers.length); i++) {
          const container = containers[i];

          if (i < names.length) {
            container.querySelector('.nozzle-name').value = names[i];
          } else {
            container.querySelector('.nozzle-name').value = '';
          }

          if (i < diameters.length) {
            container.querySelector('.nozzle-diameter').value = diameters[i];
          } else {
            container.querySelector('.nozzle-diameter').value = '';
          }

          if (i < degrees.length) {
            container.querySelector('.nozzle-degree').value = degrees[i];
          } else {
            container.querySelector('.nozzle-degree').value = '';
          }

          if (i < heights.length) {
            container.querySelector('.nozzle-height').value = heights[i];
          } else {
            container.querySelector('.nozzle-height').value = '';
          }

          // Обновляем заголовок
          updateNozzleTitle(container.querySelector('.nozzle-name'), i, 'wall');
        }

        showModal('Успех', `Импортировано ${maxRows} люков/патрубков`);
        // Сворачиваем вкладку импорта после успешного импорта
        if (wallImportExpanded) {
          toggleImportTab('wall');
        }
      }

      this.importWallDataByColumns = importWallDataByColumns;
      function importRoofDataByColumns() {
        // Получаем данные из каждого текстового поля
        const names = parseColumnData(document.getElementById('roof-import-names').value);
        const diameters = parseColumnData(document.getElementById('roof-import-diameters').value);
        const degrees = parseColumnData(document.getElementById('roof-import-degrees').value);
        const distances = parseColumnData(document.getElementById('roof-import-distances').value);

        // Определяем максимальное количество строк
        const maxRows = Math.max(names.length, diameters.length, degrees.length, distances.length);

        if (maxRows === 0) {
          showModal('Ошибка', 'Введите данные хотя бы в один столбец');
          return;
        }

        // Устанавливаем количество строк
        document.getElementById('roof-nozzles-count').value = maxRows;
        updateNozzleRows('roof');

        // Заполняем данные
        const containers = document.querySelectorAll('.nozzle-row-container[data-tab="roof"]');
        for (let i = 0; i < Math.min(maxRows, containers.length); i++) {
          const container = containers[i];

          if (i < names.length) {
            container.querySelector('.nozzle-name').value = names[i];
          } else {
            container.querySelector('.nozzle-name').value = '';
          }

          if (i < diameters.length) {
            container.querySelector('.nozzle-diameter').value = diameters[i];
          } else {
            container.querySelector('.nozzle-diameter').value = '';
          }

          if (i < degrees.length) {
            container.querySelector('.nozzle-degree').value = degrees[i];
          } else {
            container.querySelector('.nozzle-degree').value = '';
          }

          if (i < distances.length) {
            container.querySelector('.distance-from-center').value = distances[i];
          } else {
            container.querySelector('.distance-from-center').value = '';
          }

          // Обновляем заголовок
          updateNozzleTitle(container.querySelector('.nozzle-name'), i, 'roof');
        }

        showModal('Успех', `Импортировано ${maxRows} люков/патрубков`);
        // Сворачиваем вкладку импорта после успешного импорта
        if (roofImportExpanded) {
          toggleImportTab('roof');
        }
      }
      this.importRoofDataByColumns = importRoofDataByColumns;
      // --- Определение направления от осей (общая функция) ---
      function getDirectionFromDegree(degree, diameter) {
        // НОРМАЛИЗУЕМ УГОЛ К ДИАПАЗОНУ 0-360
        let normalizedDegree = degree % 360;
        if (normalizedDegree < 0) normalizedDegree += 360;

        // Проверяем, находится ли патрубок на одной из осей (0°, 90°, 180°, 270°)
        if (Math.abs(normalizedDegree - 0) < 0.001 || Math.abs(normalizedDegree - 360) < 0.001) {
          return {
            direction: "1 ось",
            distance: 0,
            fromAxis: 1,
            toAxis: 1
          };
        }
        if (Math.abs(normalizedDegree - 90) < 0.001) {
          return {
            direction: "2 ось",
            distance: 0,
            fromAxis: 2,
            toAxis: 2
          };
        }
        if (Math.abs(normalizedDegree - 180) < 0.001) {
          return {
            direction: "3 ось",
            distance: 0,
            fromAxis: 3,
            toAxis: 3
          };
        }
        if (Math.abs(normalizedDegree - 270) < 0.001) {
          return {
            direction: "4 ось",
            distance: 0,
            fromAxis: 4,
            toAxis: 4
          };
        }

        // Длина дуги для данного градуса
        const nozzleArcLength = (diameter * Math.PI * normalizedDegree) / 360;

        // Расчет длин осей
        const axesData = calculateAxesLengths(diameter, 'wall');
        const axesLengths = axesData.axesLengths;

        let fromAxis = 0;
        let toAxis = 0;
        let directionText = "";
        let distanceFromAxis = 0;

        // ДИАПАЗОНЫ ОСЕЙ:
        if ((normalizedDegree >= 0 && normalizedDegree <= 44) || (normalizedDegree >= 315 && normalizedDegree <= 360)) {
          fromAxis = 1;

          if (normalizedDegree >= 0 && normalizedDegree <= 44) {
            toAxis = 2;
            directionText = "От оси 1 к оси 2";
            distanceFromAxis = nozzleArcLength - axesLengths[0];
          } else {
            toAxis = 4;
            directionText = "От оси 1 к оси 4";
            const degreesFrom360 = 360 - normalizedDegree;
            const arcFrom360 = (diameter * Math.PI * degreesFrom360) / 360;
            distanceFromAxis = arcFrom360;
          }
        }
        else if (normalizedDegree >= 45 && normalizedDegree <= 134) {
          fromAxis = 2;

          if (normalizedDegree <= 90) {
            toAxis = 1;
            directionText = "От оси 2 к оси 1";
            distanceFromAxis = axesLengths[1] - nozzleArcLength;
          } else {
            toAxis = 3;
            directionText = "От оси 2 к оси 3";
            distanceFromAxis = nozzleArcLength - axesLengths[1];
          }
        }
        else if (normalizedDegree >= 135 && normalizedDegree <= 224) {
          fromAxis = 3;

          if (normalizedDegree <= 180) {
            toAxis = 2;
            directionText = "От оси 3 к оси 2";
            distanceFromAxis = axesLengths[2] - nozzleArcLength;
          } else {
            toAxis = 4;
            directionText = "От оси 3 к оси 4";
            distanceFromAxis = nozzleArcLength - axesLengths[2];
          }
        }
        else if (normalizedDegree >= 225 && normalizedDegree <= 314) {
          fromAxis = 4;

          if (normalizedDegree <= 270) {
            toAxis = 3;
            directionText = "От оси 4 к оси 3";
            distanceFromAxis = axesLengths[3] - nozzleArcLength;
          } else {
            toAxis = 1;
            directionText = "От оси 4 к оси 1";
            distanceFromAxis = nozzleArcLength - axesLengths[3];
          }
        }

        // Убедимся, что расстояние положительное
        distanceFromAxis = Math.abs(distanceFromAxis);
        distanceFromAxis = Math.round(distanceFromAxis);

        return {
          direction: directionText,
          distance: distanceFromAxis,
          fromAxis: fromAxis,
          toAxis: toAxis
        };
      }

      // --- Расчет люков в стенке ---
      function calculateWallNozzles() {
        console.log('calculateWallNozzles вызван');
        const tankName = document.getElementById('wall-tank-name').value.trim();
        const diameter = toNumber(document.getElementById('wall-tank-diameter').value);
        currentWallDiameter = diameter;
        currentWallTankName = tankName;

        if (isNaN(diameter) || diameter <= 0) {
          return showModal('Ошибка', 'Введите диаметр резервуара');
        }

        if (!tankName) {
          return showModal('Ошибка', 'Введите название резервуара');
        }

        const containers = document.querySelectorAll('.nozzle-row-container[data-tab="wall"]');
        const results = [];

        for (let i = 0; i < containers.length; i++) {
          const container = containers[i];
          const index = parseInt(container.dataset.index);

          const name = container.querySelector('.nozzle-name').value.trim();
          const nozzleDiameterRaw = (container.querySelector('.nozzle-diameter').value || '').trim();
          const degree = toNumber(container.querySelector('.nozzle-degree').value);
          const height = toNumber(container.querySelector('.nozzle-height').value);

          if (!name) {
            return showModal('Ошибка', `Введите название для люка/патрубка №${i + 1}`);
          }

          if (isNaN(degree) || degree < 0 || degree > 360) {
            return showModal('Ошибка', `Введите корректный градус (0-360) для "${name}"`);
          }

          if (isNaN(height) || height < 0) {
            return showModal('Ошибка', `Введите корректную высоту для "${name}"`);
          }

          // Определяем направление
          const directionData = getDirectionFromDegree(degree, diameter);

          results.push({
            name: name,
            diameter: nozzleDiameterRaw || '-',
            degree: degree + '°',
            degreeValue: degree,
            height: height + ' мм',
            direction: directionData.direction,
            distance: directionData.distance + ' мм',
            distanceValue: directionData.distance,
            fromAxis: directionData.fromAxis,
            toAxis: directionData.toAxis
          });
        }

        wallResults = results;
        renderWallResultsTable(results, diameter, tankName);

        document.getElementById('wall-tab').classList.add('hidden');
        document.getElementById('wall-results-block').classList.remove('hidden');
      }
      this.calculateWallNozzles = calculateWallNozzles;

      // --- Расчет люков в крыше ---
      function calculateRoofNozzles() {
        const tankName = document.getElementById('roof-tank-name').value.trim();
        const diameter = toNumber(document.getElementById('roof-tank-diameter-1').value);
        const commonSlope = toNumber(document.getElementById('common-roof-slope').value);
        currentRoofDiameter = diameter;
        currentRoofTankName = tankName;

        if (isNaN(diameter) || diameter <= 0) {
          return showModal('Ошибка', 'Введите диаметр резервуара');
        }

        if (!tankName) {
          return showModal('Ошибка', 'Введите название резервуара');
        }

        if (isNaN(commonSlope) || commonSlope <= 0) {
          return showModal('Ошибка', 'Введите уклон крыши (1 к N)');
        }

        const containers = document.querySelectorAll('.nozzle-row-container[data-tab="roof"]');
        const results = [];

        for (let i = 0; i < containers.length; i++) {
          const container = containers[i];
          const index = parseInt(container.dataset.index);

          const name = container.querySelector('.nozzle-name').value.trim();
          const nozzleDiameterRaw = (container.querySelector('.nozzle-diameter').value || '').trim();
          const degree = toNumber(container.querySelector('.nozzle-degree').value);
          const distanceFromCenter = toNumber(container.querySelector('.distance-from-center').value);

          if (!name) {
            return showModal('Ошибка', `Введите название для люка/патрубка №${i + 1}`);
          }

          if (isNaN(distanceFromCenter) || distanceFromCenter < 0) {
            return showModal('Ошибка', `Введите корректное расстояние от центрального люка А для "${name}"`);
          }

          if (isNaN(degree) || degree < 0 || degree > 360) {
            return showModal('Ошибка', `Введите корректный градус (0-360) для "${name}"`);
          }

          const radius = diameter / 2;
          let roofDistance = '-';

          // Расчет по общему уклону (1 к N)
          if (!isNaN(commonSlope) && commonSlope > 0 && !isNaN(distanceFromCenter)) {
            // Расчет по уклону (1 к N)
            const localHeight = (radius - distanceFromCenter) / commonSlope;
            roofDistance = Math.sqrt(Math.pow(localHeight, 2) + Math.pow(radius - distanceFromCenter, 2));
            roofDistance = Math.round(roofDistance);
            roofDistance = roofDistance + ' мм';
          }

          // Определяем направление от осей
          const directionData = getDirectionFromDegree(degree, diameter);

          results.push({
            name: name,
            diameter: nozzleDiameterRaw || '-',
            distanceFromCenter: distanceFromCenter + ' мм',
            degree: degree + '°',
            degreeValue: degree,
            direction: directionData.direction,
            distanceFromAxis: directionData.distance + ' мм',
            slope: commonSlope + ':1',
            roofDistance: roofDistance,
            radius: radius
          });
        }

        roofResults = results;
        renderRoofResultsTable(results, diameter, commonSlope, tankName);

        document.getElementById('roof-tab').classList.add('hidden');
        document.getElementById('roof-results-block').classList.remove('hidden');
      }

      this.calculateRoofNozzles = calculateRoofNozzles;
      // --- СОРТИРОВКА РЕЗУЛЬТАТОВ ПО ГРАДУСУ ---
      function sortWallResultsByDegree() {
        if (wallResults.length === 0) return;

        wallResults.sort((a, b) => {
          const degreeA = parseFloat(a.degree);
          const degreeB = parseFloat(b.degree);
          return degreeA - degreeB;
        });

        renderWallResultsTable(wallResults, currentWallDiameter, currentWallTankName);
        showModal('Сортировка', 'Люки/патрубки упорядочены по градусу (по возрастанию)');
      }
      this.sortWallResultsByDegree = sortWallResultsByDegree;

      function sortRoofResultsByDegree() {
        if (roofResults.length === 0) return;

        roofResults.sort((a, b) => {
          const degreeA = parseFloat(a.degree);
          const degreeB = parseFloat(b.degree);
          return degreeA - degreeB;
        });

        const commonSlope = parseFloat(document.getElementById('common-roof-slope').value);
        renderRoofResultsTable(roofResults, currentRoofDiameter, commonSlope, currentRoofTankName);
        showModal('Сортировка', 'Люки/патрубки упорядочены по градусу (по возрастанию)');
      }
      this.sortRoofResultsByDegree = sortRoofResultsByDegree;

      // --- Рендер таблицы результатов (стенка) ---
      function renderWallResultsTable(results, diameter, tankName) {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const dateStr = `${day}.${month}.${year}`;
        const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        // Обновлено имя файла: название резервуара + "расположение люков и патрубков в стенке" + дата (число.месяц.год)
        const safeTankName = tankName.replace(/[<>:"/\\|?*]/g, '_');
        currentWallFileName = `${safeTankName}_расположение_люков_и_патрубков_в_стенке_${day}.${month}.${year}.xlsx`;

        // Подготавливаем данные для Excel
        wallExcelData = [
          // Заголовок документа
          ["Люки и патрубки в стенке"],
          [`Резервуар: ${tankName}`],
          [`Диаметр резервуара: ${diameter} мм`],
          [`Дата расчета: ${dateStr} ${timeStr}`],
          [], // Пустая строка
          // Заголовки таблицы
          ["Название", "Условный проход (Ду), мм", "Градус °", "Высота от днища, мм", "Направление", "Расстояние от оси, мм"]
        ];

        let tableHtml = `<thead>
                <tr>
                    <th colspan="6">
                        <div class="table-title">Люки и патрубки в стенке</div>
                        <div class="table-subtitle">Резервуар: ${tankName} | Диаметр: ${diameter} мм | Дата: ${dateStr} ${timeStr}</div>
                    </th>
                </tr>
                <tr>
                    <th>Название</th>
                    <th>Ду, мм</th>
                    <th>Градус °</th>
                    <th>Высота от днища, мм</th>
                    <th>Направление</th>
                    <th>Расстояние от оси, мм</th>
                </tr>
            </thead>
            <tbody>`;

        results.forEach(item => {
          // Убираем " мм" и "°" из значений для Excel
          const diameterValue = item.diameter.replace(' мм', '');
          const heightValue = item.height.replace(' мм', '');
          const distanceValue = item.distance.replace(' мм', '');
          const degreeValue = item.degree.replace('°', ''); // Убираем символ градуса из значения

          tableHtml += `
                    <tr>
                        <td style="text-align: left; padding-left: 8px;">${item.name}</td>
                        <td>${diameterValue}</td>
                        <td>${degreeValue}</td>
                        <td>${heightValue}</td>
                        <td>${item.direction}</td>
                        <td><strong>${distanceValue}</strong></td>
                    </tr>
                `;

          // Добавляем данные для Excel
          wallExcelData.push([
            item.name,
            diameterValue,
            degreeValue,
            heightValue,
            item.direction,
            distanceValue
          ]);
        });

        tableHtml += `</tbody>`;
        document.getElementById('wall-results-table').innerHTML = tableHtml;
      }

      // --- Рендер таблицы результатов (крыша) ---
      function renderRoofResultsTable(results, diameter, slope, tankName) {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const dateStr = `${day}.${month}.${year}`;
        const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        // Обновлено имя файла: название резервуара + "расположение люков и патрубков в крыше" + дата (число.месяц.год)
        const safeTankName = tankName.replace(/[<>:"/\\|?*]/g, '_');
        currentRoofFileName = `${safeTankName}_расположение_люков_и_патрубков_в_крыше_${day}.${month}.${year}.xlsx`;

        // Подготавливаем данные для Excel
        roofExcelData = [
          // Заголовок документа
          ["Люки и патрубки в крыше"],
          [`Резервуар: ${tankName}`],
          [`Диаметр резервуара: ${diameter} мм`],
          [`Уклон крыши: ${slope}:1`],
          [`Дата расчета: ${dateStr} ${timeStr}`],
          [], // Пустая строка
          // Заголовки таблицы
          ["Название", "Условный проход (Ду), мм", "Градус °", "Расстояние от центра по прямой (А), мм", "Направление", "Расстояние от оси, мм", "Расстояние от стенки (по гипотенузе), мм"]
        ];

        let tableHtml = `<thead>
                <tr>
                    <th colspan="7">
                        <div class="table-title">Люки и патрубки в крыше</div>
                        <div class="table-subtitle">Резервуар: ${tankName} | Диаметр: ${diameter} мм | Уклон: ${slope}:1 | Дата: ${dateStr} ${timeStr}</div>
                    </th>
                </tr>
                <tr>
                    <th>Название</th>
                    <th>Ду, мм</th>
                    <th>Градус °</th>
                    <th>Расстояние от центра (А), мм</th>
                    <th>Направление</th>
                    <th>Расстояние от оси, мм</th>
                    <th>Расстояние от стенки (по гипотенузе), мм</th>
                </tr>
            </thead>
            <tbody>`;

        results.forEach(item => {
          // Убираем " мм" и "°" из значений для Excel
          const diameterValue = item.diameter.replace(' мм', '');
          const distanceFromCenterValue = item.distanceFromCenter.replace(' мм', '');
          const distanceFromAxisValue = item.distanceFromAxis.replace(' мм', '');
          const roofDistanceValue = item.roofDistance.replace(' мм', '');
          const degreeValue = item.degree.replace('°', ''); // Убираем символ градуса из значения

          tableHtml += `
                    <tr>
                        <td style="text-align: left; padding-left: 8px;">${item.name}</td>
                        <td>${diameterValue}</td>
                        <td>${degreeValue}</td>
                        <td>${distanceFromCenterValue}</td>
                        <td>${item.direction}</td>
                        <td>${distanceFromAxisValue}</td>
                        <td><strong>${roofDistanceValue}</strong></td>
                    </tr>
                `;

          // Добавляем данные для Excel
          roofExcelData.push([
            item.name,
            diameterValue,
            degreeValue,
            distanceFromCenterValue,
            item.direction,
            distanceFromAxisValue,
            roofDistanceValue
          ]);
        });

        tableHtml += `</tbody>`;
        document.getElementById('roof-results-table-1').innerHTML = tableHtml;
      }

      // --- Экспорт в Excel ---
      function exportToExcel2(tabType) {
        let data, fileName;

        if (tabType === 'wall') {
          data = wallExcelData;
          fileName = currentWallFileName;
          console.log("wall", data, fileName)
          if (!data || data.length <= 6) { // Проверяем, есть ли данные кроме заголовков
            showModal('Ошибка', 'Нет данных для экспорта');
            return;
          }
        } else {
          data = roofExcelData;
          fileName = currentRoofFileName;
          console.log("roof", data, fileName)
          if (!data || data.length <= 7) { // Проверяем, есть ли данные кроме заголовков
            showModal('Ошибка', 'Нет данных для экспорта');
            return;
          }
        }

        try {
          // Создаем новую книгу
          const wb = XLSX.utils.book_new();

          // Создаем рабочий лист из данных
          const ws = XLSX.utils.aoa_to_sheet(data);

          // Настраиваем ширину столбцов - исправлено объявление переменной
          let colWidths = [];
          if (tabType === 'wall') {
            colWidths = [
              { wch: 30 }, // Название
              { wch: 12 }, // Ду
              { wch: 8 },  // Градус
              { wch: 15 }, // Высота
              { wch: 25 }, // Направление
              { wch: 15 }  // Расстояние
            ];
          } else {
            colWidths = [
              { wch: 30 }, // Название
              { wch: 12 }, // Ду
              { wch: 8 },  // Градус
              { wch: 20 }, // Расстояние от центра
              { wch: 25 }, // Направление
              { wch: 15 }, // Расстояние от оси
              { wch: 25 }  // Расстояние от стенки
            ];
          }
          ws['!cols'] = colWidths;

          // Добавляем рабочий лист в книгу
          XLSX.utils.book_append_sheet(wb, ws, "Результаты");

          // Генерируем файл и скачиваем
          XLSX.writeFile(wb, fileName);

          showModal('Успех', `Файл "${fileName}" успешно создан и будет скачан`);
        } catch (error) {
          console.error('Ошибка при экспорте в Excel:', error);
          showModal('Ошибка', 'Не удалось создать Excel файл. Проверьте консоль для деталей.');
        }
      }
      this.exportToExcel2 = exportToExcel2;
      // --- Управление формами ---
      function resetForm(tabType) {
        if (tabType === 'wall') {
          document.getElementById('wall-results-block').classList.add('hidden');
          document.getElementById('wall-tab').classList.remove('hidden');
          document.querySelector('.tab:nth-child(2)').classList.add('active');

          // Сброс полей
          document.getElementById('wall-tank-name').value = '';
          document.getElementById('wall-tank-diameter').value = '';
          document.getElementById('wall-nozzles-count').value = 1;
          // Сброс полей импорта
          document.getElementById('wall-import-names').value = '';
          document.getElementById('wall-import-diameters').value = '';
          document.getElementById('wall-import-degrees').value = '';
          document.getElementById('wall-import-heights').value = '';
          updateNozzleRows('wall');
          document.getElementById('wall-axes-info').classList.add('hidden');
          // Сворачиваем вкладку импорта
          if (wallImportExpanded) {
            toggleImportTab('wall');
          }
        } else {
          document.getElementById('roof-results-block').classList.add('hidden');
          document.getElementById('roof-tab').classList.remove('hidden');
          document.querySelector('.tab:nth-child(3)').classList.add('active');

          // Сброс полей
          document.getElementById('roof-tank-name').value = '';
          document.getElementById('roof-tank-diameter-1').value = '';
          document.getElementById('common-roof-slope').value = '';
          document.getElementById('roof-nozzles-count').value = 1;
          // Сброс полей импорта
          document.getElementById('roof-import-names').value = '';
          document.getElementById('roof-import-diameters').value = '';
          document.getElementById('roof-import-degrees').value = '';
          document.getElementById('roof-import-distances').value = '';
          updateNozzleRows('roof');
          document.getElementById('roof-axes-info').classList.add('hidden');
          // Сворачиваем вкладку импорта
          if (roofImportExpanded) {
            toggleImportTab('roof');
          }
        }
      }
      this.resetForm = resetForm;

      function backToWallInput() {
        document.getElementById('wall-results-block').classList.add('hidden');
        document.getElementById('wall-tab').classList.remove('hidden');
      }
      this.backToWallInput = backToWallInput;

      function backToRoofInput() {
        document.getElementById('roof-results-block').classList.add('hidden');
        document.getElementById('roof-tab').classList.remove('hidden');
      }
      this.backToRoofInput = backToRoofInput;

      // --- Калькулятор ---
      function openCalculator() {
        calcExpression = "";
        document.getElementById('calc-display').textContent = "0";
        document.getElementById('calculator-modal').classList.add('visible');
      }
      this.openCalculator = openCalculator;

      function closeCalculator() {
        document.getElementById('calculator-modal').classList.remove('visible');
      }
      this.closeCalculator = closeCalculator;

      function clearCalculator() {
        calcExpression = "";
        document.getElementById('calc-display').textContent = "0";
      }
      this.clearCalculator = clearCalculator;

      function calcInput(value) {
        if (calcExpression === "0" && value !== ".") {
          calcExpression = value;
        } else {
          calcExpression += value;
        }
        document.getElementById('calc-display').textContent = calcExpression;
      }
      this.calcInput = calcInput;

      function calculateResult() {
        try {
          const expression = calcExpression.replace(/×/g, '*');
          const result = eval(expression);
          document.getElementById('calc-display').textContent = result.toFixed(2);
          calcExpression = result.toString();
        } catch (e) {
          document.getElementById('calc-display').textContent = "Ошибка";
          calcExpression = "";
        }
      }
      this.calculateResult = calculateResult;

      // --- Управление модальными окнами ---
      function showModal(title, body) {
        document.getElementById('modal-title').innerHTML = title;
        document.getElementById('modal-body').innerHTML = body;
        document.getElementById('message-modal').classList.add('visible');
      }

      function closeModal() {
        document.getElementById('message-modal').classList.remove('visible');
      }
      this.closeModal = closeModal;

    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
      let currentMode = 'wall';
      let wallData = [];
      let roofData = [];

      let currentBulkTab = 'wall';
      let projects = [];
      let currentProjectId = null;
      let controlHistory = {};
      let autosaveTimeout = null;
      let autosaveCooldown = false;
      let lastActiveProjectName = null; // Отслеживаем активный проект для обнаружения переключения

      // ДОПУСТИМЫЕ ОТКЛОНЕНИЯ ПО ГОСТ
      const GOST_DEVIATIONS = {
        'wall': {
          'A': { 'Л': 10, 'П': 6 },
          'B': { 'Л': 10, 'П': 5 },
          'verticalDeviation': { 'Л': 5, 'П': 5 },
          'verticalPositionDeviation': { 'Л': 10, 'П': 6 },
          'horizontalPositionDeviation': { 'Л': 10, 'П': 6 },
          'gap': { 'Л': 5, 'П': 10 }
        },
        'roof': {
          'A': { 'Л': 50, 'П': 10 },
          'B': { 'Л': 10, 'П': 5 },
          'verticalDeviation': { 'Л': 5, 'П': 5 },
          'verticalPositionDeviation': { 'Л': 10, 'П': 6 },
          'horizontalPositionDeviation': { 'Л': 10, 'П': 6 }
        }
      };
      document.getElementById("insp-hat-pipes-back-to-list-button").addEventListener('click', () => {
        showScreen('projectsSection');
        document.getElementById('insp-hat-pipes').style.display = 'none';
        document.querySelector("header").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
        // window.location.reload();
      });
      document.getElementById("insp-hat-pipes-back-to-modules-button").addEventListener('click', () => {
        showScreen('modulesSection');
        document.getElementById('insp-hat-pipes').style.display = 'none';
        document.querySelector("header").style.display = 'block';
        document.querySelector(".main-content").style.display = 'block';
        document.querySelector(".container-hero").style.display = 'block';
      });

      function showScreen(screenId) {
        screens.forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(screenId);
        if (target) target.classList.remove('hidden');
      }
      // ИНИЦИАЛИЗАЦИЯ
      function initApp() {
        // Инициализируем отслеживание активного проекта
        lastActiveProjectName = localStorage.getItem('projectActiveName');

        // Загружаем проекты и историю из localStorage
        loadProjects();
        loadControlHistory();
        // Загружаем автосохраненные данные ДО инициализации любых данных
        loadAutosaveData();

        // Устанавливаем текущую дату только если она не была загружена из автосохранения
        const today = new Date().toISOString().split('T')[0];
        const wallDateInput = document.getElementById('wall-date');
        const roofDateInput = document.getElementById('roof-date');
        if (wallDateInput && !wallDateInput.value) {
          wallDateInput.value = today;
        }
        if (roofDateInput && !roofDateInput.value) {
          roofDateInput.value = today;
        }

        // После загрузки автосохраненных данных проверяем, были ли уже какие-то данные
        // Если массивы остались пустыми после загрузки, значит данных не было - добавляем начальные строки
        // Но только после полной инициализации и проверки, что автосохранение точно не содержало данных
        setTimeout(() => {
          // Проверяем, что DOM готов и данные действительно не были загружены
          const wallTbody = document.getElementById('wall-tbody');
          const roofTbody = document.getElementById('roof-tbody');

          // Проверяем, были ли вообще попытки загрузить автосохранение
          const activeNameProject = localStorage.getItem('projectActiveName');
          const hasAutosave = activeNameProject && localStorage.getItem(`${activeNameProject}tankControlAutosave`);

          // Добавляем строки только если нет автосохранения И массивы пусты
          if (wallTbody && wallData.length === 0 && !hasAutosave) {
            addRow('wall');
          } else if (wallTbody && wallData.length === 0 && hasAutosave) {
            // Если есть автосохранение, но данные пусты - возможно там тоже пустой массив
            // В этом случае все равно рендерим таблицу (она сама добавит строку через renderTable)
            renderTable('wall');
          }

          if (roofTbody && roofData.length === 0 && !hasAutosave) {
            addRow('roof');
          } else if (roofTbody && roofData.length === 0 && hasAutosave) {
            renderTable('roof');
          }
        }, 200); // Увеличиваем задержку для уверенности, что все данные загружены

        console.log('Приложение инициализировано');
      }

      const modeTabs = document.querySelectorAll('.mode-tab');
      modeTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          const tabId = tab.getAttribute('data-tab');
          switchMode(tabId);
        });
      });

      const handleEnterNavigation = (event) => {
        if (event.key !== 'Enter') return;
        const target = event.target;
        if (!target.matches('#wall-tbody input, #roof-tbody input')) return;
        event.preventDefault();
        const name = target.getAttribute('name');
        if (!name) return;
        const table = target.closest('table');
        if (!table) return;
        const inputs = Array.from(table.querySelectorAll(`tbody input[name="${name}"]`));
        const index = inputs.indexOf(target);
        const next = inputs[index + 1];
        if (next) {
          next.focus();
          if (typeof next.select === 'function') next.select();
        }
      };

      const inspContainer = document.getElementById('insp-hat-pipes');
      if (inspContainer) {
        inspContainer.addEventListener('keydown', handleEnterNavigation);
      }

      // АВТОСОХРАНЕНИЕ
      // АВТОСОХРАНЕНИЕ
      // АВТОСОХРАНЕНИЕ
      function autosave() {
        if (autosaveCooldown) return;

        clearTimeout(autosaveTimeout);
        autosaveTimeout = setTimeout(() => {
          saveAutosaveData();
          showAutosaveIndicator();
        }, 1000);
      }

      function saveAutosaveData() {
        const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
        const activeNameProject = localStorage.getItem('projectActiveName');

        // Проверяем, есть ли активный проект, прежде чем сохранять
        if (!activeNameProject) {
          console.log('Нет активного проекта для автосохранения');
          return;
        }

        // Проверяем, что активный проект не изменился с момента последней загрузки
        if (lastActiveProjectName && lastActiveProjectName !== activeNameProject) {
          console.warn(`Попытка сохранить данные для проекта ${activeNameProject}, но последний загруженный проект был ${lastActiveProjectName}. Сначала нужно загрузить данные нового проекта.`);
          // Не сохраняем, если проект изменился - сначала нужно загрузить новые данные
          return;
        }

        const activeProject = projects.find(p => p.name === activeNameProject);
        if (!activeProject) {
          console.log('Активный проект не найден в списке проектов');
          return;
        }

        // Проверяем, существуют ли уже автосохраненные данные
        const existingAutosave = localStorage.getItem(`${activeNameProject}tankControlAutosave`);

        // Если автосохраненные данные еще не созданы, добавляем стандартные строки
        if (!existingAutosave) {
          // Добавляем стандартную строку в wallData, если массив пуст
          if (wallData.length === 0) {
            const wallDefaultRow = {
              id: Date.now() + Math.random(),
              type: 'Л',
              designation: '',
              diameter: '',
              angleProject: '',
              angleFact: '',
              aProject: '',
              aFact: '',
              bProject: '',
              bFact: '',
              cProject: '',
              cFact: '',
              verticalDeviation: '',
              verticalPositionDeviation: '',
              horizontalPositionDeviation: '',
              gap: 'wall' === 'wall' ? '' : undefined
            };
            wallData.push(wallDefaultRow);
          }

          // Добавляем стандартную строку в roofData, если массив пуст
          if (roofData.length === 0) {
            const roofDefaultRow = {
              id: Date.now() + Math.random(),
              type: 'Л',
              designation: '',
              diameter: '',
              angleProject: '',
              angleFact: '',
              aProject: '',
              aFact: '',
              bProject: '',
              bFact: '',
              cProject: '',
              cFact: '',
              verticalDeviation: '',
              verticalPositionDeviation: '',
              horizontalPositionDeviation: '',
              gap: 'roof' === 'wall' ? '' : undefined
            };
            roofData.push(roofDefaultRow);
          }
        }

        const today = new Date().toISOString().split('T')[0];
        const autosaveData = {
          projectName: activeNameProject, // Сохраняем имя проекта в данных
          currentMode: currentMode,
          wallData: wallData,
          roofData: roofData,
          wallTankNumber: activeProject.name,
          roofTankNumber: activeProject.name,
          wallDate: document.getElementById('wall-date')?.value || activeProject.createdAt || today,
          roofDate: document.getElementById('roof-date')?.value || activeProject.createdAt || today,
          timestamp: new Date().getTime()
        };


        console.log(autosaveData, "autosaveData")
        localStorage.setItem(`${activeNameProject}tankControlAutosave`, JSON.stringify(autosaveData));
        console.log('Данные автосохранены для проекта:', activeNameProject, { wallData: wallData.length, roofData: roofData.length });
      }

      // window.saveAutosaveData = saveAutosaveData;

      function loadAutosaveData() {
        const activeNameProject = localStorage.getItem('projectActiveName');
        if (!activeNameProject) {
          console.log('Нет активного проекта для загрузки автосохранения');
          // Очищаем данные, если нет активного проекта
          wallData = [];
          roofData = [];
          lastActiveProjectName = null;
          return;
        }

        // Если проект изменился, сначала сохраняем данные старого проекта
        if (lastActiveProjectName && lastActiveProjectName !== activeNameProject) {
          console.log('Проект изменился с', lastActiveProjectName, 'на', activeNameProject);
          // Сохраняем данные старого проекта перед переключением
          const oldProjectName = lastActiveProjectName;
          const oldAutosaveData = {
            projectName: oldProjectName,
            currentMode: currentMode,
            wallData: [...wallData], // Создаем копию массива
            roofData: [...roofData], // Создаем копию массива
            wallTankNumber: oldProjectName,
            roofTankNumber: oldProjectName,
            wallDate: document.getElementById('wall-date')?.value || '',
            roofDate: document.getElementById('roof-date')?.value || '',
            timestamp: new Date().getTime()
          };
          localStorage.setItem(`${oldProjectName}tankControlAutosave`, JSON.stringify(oldAutosaveData));
          console.log('Данные старого проекта сохранены:', oldProjectName);
        }

        // Очищаем данные перед загрузкой нового проекта
        wallData = [];
        roofData = [];

        const saved = localStorage.getItem(`${activeNameProject}tankControlAutosave`);

        if (saved) {
          try {
            const autosaveData = JSON.parse(saved);

            // Проверяем, что данные принадлежат текущему активному проекту
            if (autosaveData.projectName && autosaveData.projectName !== activeNameProject) {
              console.warn(`Данные автосохранения принадлежат другому проекту (${autosaveData.projectName}), текущий проект: ${activeNameProject}. Данные не загружены.`);
              return;
            }

            // Загружаем данные стенки (даже если массив пустой)
            if (autosaveData.wallData !== undefined && Array.isArray(autosaveData.wallData)) {
              wallData = [...autosaveData.wallData]; // Создаем копию массива
              if (autosaveData.wallTankNumber) {
                const wallTankInput = document.getElementById('wall-tank-number');
                if (wallTankInput) {
                  wallTankInput.value = autosaveData.wallTankNumber;
                }
              }
              if (autosaveData.wallDate) {
                const wallDateInput = document.getElementById('wall-date');
                if (wallDateInput) {
                  wallDateInput.value = autosaveData.wallDate;
                }
              }
              // Рендерим таблицу только если есть элементы DOM
              const wallTbody = document.getElementById('wall-tbody');
              if (wallTbody) {
                renderTable('wall');
              }
            }

            // Загружаем данные крыши (даже если массив пустой)
            if (autosaveData.roofData !== undefined && Array.isArray(autosaveData.roofData)) {
              roofData = [...autosaveData.roofData]; // Создаем копию массива
              if (autosaveData.roofTankNumber) {
                const roofTankInput = document.getElementById('roof-tank-number');
                if (roofTankInput) {
                  roofTankInput.value = autosaveData.roofTankNumber;
                }
              }
              if (autosaveData.roofDate) {
                const roofDateInput = document.getElementById('roof-date');
                if (roofDateInput) {
                  roofDateInput.value = autosaveData.roofDate;
                }
              }
              // Рендерим таблицу только если есть элементы DOM
              const roofTbody = document.getElementById('roof-tbody');
              if (roofTbody) {
                renderTable('roof');
              }
            }

            // Восстанавливаем текущий режим
            if (autosaveData.currentMode) {
              switchMode(autosaveData.currentMode);
            }

            console.log('Данные автовосстановлены для проекта:', activeNameProject, { wallData: wallData.length, roofData: roofData.length });
          } catch (e) {
            console.error('Ошибка загрузки автосохранения:', e);
          }
        } else {
          console.log('Автосохраненные данные не найдены для проекта:', activeNameProject);
          // Если данных нет, инициализируем пустыми массивами
          // и добавляем начальные строки при необходимости
          const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
          const activeProject = projects.find(p => p.name === activeNameProject);

          // Создаем новую запись автосохранения с пустыми массивами для нового проекта
          const today = new Date().toISOString().split('T')[0];
          const newAutosaveData = {
            projectName: activeNameProject,
            currentMode: 'wall',
            wallData: [],
            roofData: [],
            wallTankNumber: activeProject?.name || activeNameProject,
            roofTankNumber: activeProject?.name || activeNameProject,
            wallDate: document.getElementById('wall-date')?.value || activeProject?.createdAt || today,
            roofDate: document.getElementById('roof-date')?.value || activeProject?.createdAt || today,
            timestamp: new Date().getTime()
          };

          localStorage.setItem(`${activeNameProject}tankControlAutosave`, JSON.stringify(newAutosaveData));

          // Добавляем начальные строки только если таблицы существуют в DOM
          const wallTbody = document.getElementById('wall-tbody');
          const roofTbody = document.getElementById('roof-tbody');

          if (wallTbody && wallData.length === 0) {
            addRow('wall');
          }

          if (roofTbody && roofData.length === 0) {
            addRow('roof');
          }
        }

        // Обновляем отслеживание активного проекта только после успешной загрузки
        lastActiveProjectName = activeNameProject;
      }

      function showAutosaveIndicator() {
        const indicator = document.getElementById('autosave-indicator');
        indicator.classList.add('visible');

        setTimeout(() => {
          indicator.classList.remove('visible');
        }, 3000);
      }

      // Обработчики событий для автосохранения
      document.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' &&
          (e.target.type === 'text' || e.target.type === 'number' || e.target.type === 'date')) {
          autosave();
        }
      });

      // Сохраняем данные перед закрытием страницы
      window.addEventListener('beforeunload', (e) => {
        saveAutosaveData();
      });

      // Обработчик изменения активного проекта (если проект меняется в другом окне/вкладке)
      window.addEventListener('storage', (e) => {
        if (e.key === 'projectActiveName') {
          const newActiveProject = e.newValue;
          if (newActiveProject !== lastActiveProjectName) {
            console.log('Активный проект изменился (storage event) с', lastActiveProjectName, 'на', newActiveProject);
            // Перезагружаем данные для нового проекта
            loadAutosaveData();
          }
        }
      });

      // Отслеживаем изменения projectActiveName в текущем окне
      // Проверяем каждую секунду, не изменился ли активный проект
      setInterval(() => {
        const currentActiveProject = localStorage.getItem('projectActiveName');
        if (currentActiveProject !== lastActiveProjectName) {
          console.log('Обнаружено изменение активного проекта с', lastActiveProjectName, 'на', currentActiveProject);
          loadAutosaveData();
        }
      }, 1000);

      // УПРАВЛЕНИЕ ПРОЕКТАМИ
      function loadProjects() {
        const savedProjects = localStorage.getItem('tankControlProjects');
        if (savedProjects) {
          projects = JSON.parse(savedProjects);
          updateProjectSelect();
        }
      }

      function loadControlHistory() {
        const savedHistory = localStorage.getItem('tankControlHistory');
        if (savedHistory) {
          controlHistory = JSON.parse(savedHistory);
        }
      }

      function saveControlHistory() {
        localStorage.setItem('tankControlHistory', JSON.stringify(controlHistory));
      }

      function saveProjects() {
        localStorage.setItem('tankControlProjects', JSON.stringify(projects));
        updateProjectSelect();
      }

      function updateProjectSelect() {
        const select = document.getElementById('project-select');
        select.innerHTML = '<option value="">Выберите проект...</option>';

        projects.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

        projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.id;

          // Форматируем дату для отображения
          const dateObj = new Date(project.date);
          const day = String(dateObj.getDate()).padStart(2, '0');
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const year = dateObj.getFullYear();
          const formattedDate = `${day}.${month}.${year}`;

          option.textContent = `${project.tankNumber || project.name}, ${project.type === 'wall' ? 'Стенка' : 'Крыша'}, ${formattedDate}`;
          select.appendChild(option);
        });
      }

      function saveProject() {
        const tankNumber = document.getElementById(currentMode + '-tank-number').value;
        if (!tankNumber) {
          alert('Введите номер резервуара');
          return;
        }

        const date = document.getElementById(currentMode + '-date').value;
        const dateObj = new Date(date);
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        const formattedDate = `${day}.${month}.${year}`;

        const projectData = {
          id: currentProjectId || Date.now().toString(),
          name: `${tankNumber}, ${currentMode === 'wall' ? 'Стенка' : 'Крыша'}, ${formattedDate}`,
          type: currentMode,
          date: date,
          createdAt: new Date().toISOString(),
          tankNumber: tankNumber,
          tableData: getTableData(currentMode)
        };

        const existingIndex = projects.findIndex(p => p.id === projectData.id);
        if (existingIndex > -1) {
          projects[existingIndex] = projectData;
        } else {
          projects.push(projectData);
        }

        saveProjects();
        currentProjectId = projectData.id;
        document.getElementById('project-select').value = projectData.id;

        alert('Проект сохранен!');
      }

      function loadProject() {
        const select = document.getElementById('project-select');
        const projectId = select.value;

        if (!projectId) return;

        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        switchMode(project.type);

        document.getElementById(project.type + '-tank-number').value = project.tankNumber || '';
        document.getElementById(project.type + '-date').value = project.date || '';

        if (project.type === 'wall') {
          wallData = project.tableData || [];
          renderTable('wall');
        } else {
          roofData = project.tableData || [];
          renderTable('roof');
        }

        currentProjectId = project.id;
      }

      function deleteProject() {
        const select = document.getElementById('project-select');
        const projectId = select.value;

        if (!projectId) {
          alert('Выберите проект для удаления');
          return;
        }

        if (confirm('Удалить выбранный проект?')) {
          const index = projects.findIndex(p => p.id === projectId);
          if (index > -1) {
            projects.splice(index, 1);
            saveProjects();

            currentProjectId = null;
            select.value = '';

            if (currentMode === 'wall') {
              wallData = [];
              addRow('wall');
              document.getElementById('wall-tank-number').value = '';
            } else {
              roofData = [];
              addRow('roof');
              document.getElementById('roof-tank-number').value = '';
            }

            alert('Проект удален');
          }
        }
      }

      function newProject() {
        if (confirm('Создать новый проект? Текущие несохраненные изменения будут потеряны.')) {
          currentProjectId = null;
          document.getElementById('project-select').value = '';

          if (currentMode === 'wall') {
            document.getElementById('wall-tank-number').value = '';
            wallData = [];
            addRow('wall');
          } else {
            document.getElementById('roof-tank-number').value = '';
            roofData = [];
            addRow('roof');
          }

          // Очищаем автосохранение
          const activeNameProject = localStorage.getItem('projectActiveName');
          //   const saved = localStorage.getItem('tankControlAutosave');
          localStorage.removeItem(`${activeNameProject}tankControlAutosave`);
        }
      }
      this.newProject = newProject;

      // УПРАВЛЕНИЕ РЕЖИМАМИ
      function switchMode(modeName) {
        // Скрываем/деактивируем весь контент
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });

        // Деактивируем все вкладки
        document.querySelectorAll('.mode-tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Активируем нужную вкладку по data-tab
        const targetTab = document.querySelector(`.mode-tab[data-tab="${modeName}"]`);
        if (targetTab) {
          targetTab.classList.add('active');
        } else {
          console.warn(`Вкладка с data-tab="${modeName}" не найдена`);
        }

        // Активируем соответствующий контент
        const targetContent = document.getElementById(`${modeName}-content`);
        if (targetContent) {
          targetContent.classList.add('active');
        } else {
          console.warn(`Контент с id="${modeName}-content" не найден`);
        }

        currentMode = modeName;
        autosave();
      }

      // УПРАВЛЕНИЕ ТАБЛИЦЕЙ
      function addRow(modeType) {
        const dataArray = modeType === 'wall' ? wallData : roofData;
      const newRow = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          type: 'Л',
          designation: '',
          diameter: '',
          angleProject: '',
          angleFact: '',
          aProject: '',
          aFact: '',
          bProject: '',
          bFact: '',
          cProject: '',
          cFact: '',
          verticalDeviation: '',
          verticalPositionDeviation: '',
          horizontalPositionDeviation: '',
          gap: modeType === 'wall' ? '' : undefined
        };

        dataArray.push(newRow);

        // Обновляем отображение через renderTable
        renderTable(modeType);

        autosave();
      }

      this.addRow = addRow;

      function deleteRow(modeType, id) {
        const dataArray = modeType === 'wall' ? wallData : roofData;
        const index = dataArray.findIndex(row => row.id == id);
        if (index > -1) {
          dataArray.splice(index, 1);
          renderTable(modeType);
          autosave();
        }
      }
      this.deleteRow = deleteRow;

      function clearTable(modeType) {
        if (confirm('Очистить всю таблицу?')) {
          if (modeType === 'wall') {
            wallData = [];
          } else {
            roofData = [];
          }
          renderTable(modeType);
          autosave();
        }
      }
      this.clearTable = clearTable;

      function updateCell(modeType, id, field, value) {
        const dataArray = modeType === 'wall' ? wallData : roofData;
        const row = dataArray.find(row => row.id == id);
        if (row) {
          row[field] = value;
          // Для поля "диаметр" не требуется валидация, только автосохранение
          if (field !== 'diameter') {
            validateCell(modeType, id, field, value);
          }
          autosave();
        }
      }
      this.updateCell = updateCell;

      function toggleType(modeType, id, type) {
        const dataArray = modeType === 'wall' ? wallData : roofData;
        const row = dataArray.find(row => row.id == id);
        if (row) {
          row.type = type;
          renderTable(modeType);

          setTimeout(() => {
            const fields = modeType === 'wall' ?
              ['aFact', 'bFact', 'cFact', 'verticalDeviation', 'verticalPositionDeviation', 'horizontalPositionDeviation', 'gap'] :
              ['aFact', 'bFact', 'cFact', 'verticalDeviation', 'verticalPositionDeviation', 'horizontalPositionDeviation'];

            fields.forEach(field => {
              validateCell(modeType, id, field, row[field]);
            });
          }, 10);

          autosave();
        }
      }
      this.toggleType = toggleType;
      this.validateCell = validateCell;

      // ВАЛИДАЦИЯ
      function validateCell(modeType, id, field, value) {
        const cell = document.querySelector(`[data-id="${id}"] input[name="${field}"]`);
        if (!cell) return;

        cell.classList.remove('valid', 'invalid');

        if (value === '') return;

        const normalizedValue = typeof value === 'string' ? value.replace(',', '.') : value;
        const numValue = parseFloat(normalizedValue);
        if (isNaN(numValue)) return;

        const row = (modeType === 'wall' ? wallData : roofData).find(row => row.id == id);
        if (!row) return;

        const type = row.type;
        let isValid = true;
        let allowedDeviation = 0;

        switch (field) {
          case 'aFact':
            const aProject = parseFloat(cell.closest('tr').querySelector('input[name="aProject"]').value);
            if (!isNaN(aProject)) {
              allowedDeviation = GOST_DEVIATIONS[modeType]['A'][type];
              const deviation = Math.abs(numValue - aProject);
              isValid = deviation <= allowedDeviation;
            }
            break;

          case 'bFact':
            const bProject = parseFloat(cell.closest('tr').querySelector('input[name="bProject"]').value);
            if (!isNaN(bProject)) {
              allowedDeviation = GOST_DEVIATIONS[modeType]['B'][type];
              const deviation = Math.abs(numValue - bProject);
              isValid = deviation <= allowedDeviation;
            }
            break;

          case 'cFact':
            const cProject = parseFloat(cell.closest('tr').querySelector('input[name="cProject"]').value);
            if (!isNaN(cProject)) {
              allowedDeviation = GOST_DEVIATIONS[modeType]['B'][type];
              const deviation = Math.abs(numValue - cProject);
              isValid = deviation <= allowedDeviation;
            }
            break;

          case 'verticalDeviation':
            allowedDeviation = GOST_DEVIATIONS[modeType]['verticalDeviation'][type];
            isValid = Math.abs(numValue) <= allowedDeviation;
            break;

          case 'verticalPositionDeviation':
            allowedDeviation = GOST_DEVIATIONS[modeType]['verticalPositionDeviation'][type];
            isValid = Math.abs(numValue) <= allowedDeviation;
            break;

          case 'horizontalPositionDeviation':
            allowedDeviation = GOST_DEVIATIONS[modeType]['horizontalPositionDeviation'][type];
            isValid = Math.abs(numValue) <= allowedDeviation;
            break;

          case 'gap':
            if (modeType === 'wall') {
              allowedDeviation = GOST_DEVIATIONS[modeType]['gap'][type];
              isValid = Math.abs(numValue) <= allowedDeviation;
            }
            break;
        }

        cell.classList.add(isValid ? 'valid' : 'invalid');
      }

      // РЕНДЕРИНГ ТАБЛИЦЫ
      // РЕНДЕРИНГ ТАБЛИЦЫ
      // РЕНДЕРИНГ ТАБЛИЦЫ
      function renderTable(modeType) {
        let dataArray = modeType === 'wall' ? wallData : roofData;
        const tbody = document.getElementById(modeType + '-tbody');

        if (!tbody) {
          console.error(`Таблица ${modeType}-tbody не найдена`);
          return;
        }

        // Проверяем, есть ли в dataArray хоть одна строка с непустыми данными
        // Функция проверяет, является ли строка полностью пустой
        const isRowEmpty = (row) => {
          // Проверяем ключевые поля, кроме id
          const keyFields = ['type', 'designation', 'diameter', 'angleProject', 'aProject', 'bProject', 'cProject'];
          return keyFields.every(field => !row[field] || row[field] === '');
        };

        // Проверяем, есть ли хотя бы одна строка с непустыми данными
        const hasNonEmptyRows = dataArray.some(row => !isRowEmpty(row));

        // Если массив пустой или содержит только пустые строки, добавляем новую строку
        if (dataArray.length === 0 || (!hasNonEmptyRows && dataArray.length > 0)) {
          // Создаем новую строку
          const newRow = {
            id: Date.now() + Math.random(),
            type: 'Л',
            designation: '',
            diameter: '',
            angleProject: '',
            angleFact: '',
            aProject: '',
            aFact: '',
            bProject: '',
            bFact: '',
            cProject: '',
            cFact: '',
            verticalDeviation: '',
            verticalPositionDeviation: '',
            horizontalPositionDeviation: '',
            gap: modeType === 'wall' ? '' : undefined
          };

          // Добавляем в соответствующий локальный массив
          if (modeType === 'wall') {
            wallData.push(newRow);
          } else {
            roofData.push(newRow);
          }

          // Обновляем dataArray, чтобы использовать свежие данные
          dataArray = modeType === 'wall' ? [...wallData] : [...roofData];
        }

        let html = '';

        dataArray.forEach((row, index) => {
          const isWall = modeType === 'wall';
          const rowId = String(row.id);

          html += `
                    <tr data-id="${rowId}">
                        <td>
                            <div class="type-selector">
                                <button class="type-btn hatch ${row.type === 'Л' ? 'active' : ''}" 
                                        onclick="toggleType('${modeType}', '${rowId}', 'Л')"
                                        title="Люк">Л</button>
                                <button class="type-btn pipe ${row.type === 'П' ? 'active' : ''}" 
                                        onclick="toggleType('${modeType}', '${rowId}', 'П')"
                                        title="Патрубок">П</button>
                            </div>
                        </td>
                        <td>
                            <input type="text" 
                                   name="designation" 
                                   value="${row.designation || ''}" 
                                   placeholder="${row.type === 'Л' ? 'Л-1' : 'П-1'}" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'designation', this.value)">
                        </td>
                        
                        <!-- Диаметр -->
                        <td>
                            <input type="text" 
                                   name="diameter" 
                                   value="${row.diameter || ''}" 
                                   placeholder="600" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'diameter', this.value)">
                        </td>
                        
                        <td>
                            <input type="text" 
                                   name="angleProject" 
                                   value="${row.angleProject || ''}" 
                                   placeholder="45" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'angleProject', this.value)">
                        </td>
                        <td>
                            <input type="text" 
                                   name="angleFact" 
                                   value="${row.angleFact || ''}" 
                                   placeholder="45.5" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'angleFact', this.value)">
                        </td>
                        
                        <td>
                            <input type="text" 
                                   name="aProject" 
                                   value="${row.aProject || ''}" 
                                   placeholder="1500" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'aProject', this.value)">
                        </td>
                        <td>
                            <input type="text" 
                                   name="aFact" 
                                   value="${row.aFact || ''}" 
                                   placeholder="${isWall ? '1505' : '1505'}" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'aFact', this.value)">
                        </td>
                        
                        <td>
                            <input type="text" 
                                   name="bProject" 
                                   value="${row.bProject || ''}" 
                                   placeholder="100" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'bProject', this.value)">
                        </td>
                        <td>
                            <input type="text" 
                                   name="bFact" 
                                   value="${row.bFact || ''}" 
                                   placeholder="95" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'bFact', this.value)">
                        </td>
                        
                        <td>
                            <input type="text" 
                                   name="cProject" 
                                   value="${row.cProject || ''}" 
                                   placeholder="50" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'cProject', this.value)">
                        </td>
                        <td>
                            <input type="text" 
                                   name="cFact" 
                                   value="${row.cFact || ''}" 
                                   placeholder="48" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'cFact', this.value)">
                        </td>
                        
                        <td>
                            <input type="text" 
                                   name="verticalDeviation" 
                                   value="${row.verticalDeviation || ''}" 
                                   placeholder="2" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'verticalDeviation', this.value)">
                        </td>
                        <td>
                            <input type="text" 
                                   name="verticalPositionDeviation" 
                                   value="${row.verticalPositionDeviation || ''}" 
                                   placeholder="3" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'verticalPositionDeviation', this.value)">
                        </td>
                        <td>
                            <input type="text" 
                                   name="horizontalPositionDeviation" 
                                   value="${row.horizontalPositionDeviation || ''}" 
                                   placeholder="3" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'horizontalPositionDeviation', this.value)">
                        </td>
                        ${isWall ? `
                        <td>
                            <input type="text" 
                                   name="gap" 
                                   value="${row.gap || ''}" 
                                   placeholder="5" 
                                   oninput="updateCell('${modeType}', '${rowId}', 'gap', this.value)">
                        </td>
                        ` : ''}
                        
                        <td>
                            <button class="delete-row" onclick="deleteRow('${modeType}', '${rowId}')" title="Удалить строку">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
      }

      // window.renderTable = renderTable;

      function getTableData(modeType) {
        return modeType === 'wall' ? wallData : roofData;
      }

      // МАССОВЫЙ ВВОД
      function openBulkInput(modeType) {
        currentBulkTab = modeType;
        const modal = document.getElementById('bulk-input-modal');
        const title = document.getElementById('bulk-modal-title');

        title.textContent = `Массовый ввод данных (${modeType === 'wall' ? 'Стенка' : 'Крыша'})`;

        document.getElementById('bulk-types').value = '';
        document.getElementById('bulk-designations').value = '';
        document.getElementById('bulk-diameter').value = '';
        document.getElementById('bulk-angle-project').value = '';
        document.getElementById('bulk-a-project').value = '';
        document.getElementById('bulk-b-project').value = '';
        document.getElementById('bulk-c-project').value = '';

        modal.classList.add('active');
      }
      this.openBulkInput = openBulkInput;

      function closeBulkInput() {
        document.getElementById('bulk-input-modal').classList.remove('active');
      }
      this.closeBulkInput = closeBulkInput;

      function importBulkData() {
        const types = parseBulkText(document.getElementById('bulk-types').value);
        const designations = parseBulkText(document.getElementById('bulk-designations').value);
        const diameters = parseBulkText(document.getElementById('bulk-diameter').value);
        const angles = parseBulkText(document.getElementById('bulk-angle-project').value);
        const aProject = parseBulkText(document.getElementById('bulk-a-project').value);
        const bProject = parseBulkText(document.getElementById('bulk-b-project').value);
        const cProject = parseBulkText(document.getElementById('bulk-c-project').value);

        const maxRows = Math.max(
          types.length,
          designations.length,
          diameters.length,
          angles.length,
          aProject.length,
          bProject.length,
          cProject.length
        );

        if (maxRows === 0) {
          alert('Введите данные хотя бы в одно поле');
          return;
        }

        if (currentBulkTab === 'wall') {
          wallData = [];
        } else {
          roofData = [];
        }

        for (let i = 0; i < maxRows; i++) {
          const type = types[i] || 'Л';
          const newRow = {
            id: Date.now() + Math.random() + i,
            type: type,
            designation: designations[i] || `${type}-${i + 1}`,
            diameter: diameters[i] || '',
            angleProject: angles[i] || '',
            angleFact: '',
            aProject: aProject[i] || '',
            aFact: '',
            bProject: bProject[i] || '',
            bFact: '',
            cProject: cProject[i] || '',
            cFact: '',
            verticalDeviation: '',
            verticalPositionDeviation: '',
            horizontalPositionDeviation: '',
            gap: currentBulkTab === 'wall' ? '' : undefined
          };

          if (currentBulkTab === 'wall') {
            wallData.push(newRow);
          } else {
            roofData.push(newRow);
          }
        }

        renderTable(currentBulkTab);
        closeBulkInput();
        alert(`Импортировано ${maxRows} строк`);
        autosave();
      }
      this.importBulkData = importBulkData;

      function parseBulkText(text) {
        if (!text || text.trim() === '') return [];

        let lines = text.trim().split('\n');

        if (lines.length === 1) {
          lines = text.trim().split(/\s+/);
        }

        return lines
          .map(item => item.trim())
          .filter(item => item !== '');
      }

      // ЭКСПОРТ В EXCEL
      function exportToExcel3(modeType) {
        let dataArray = modeType === 'wall' ? wallData : roofData;
        const isWall = modeType === 'wall';

        if (!dataArray || dataArray.length === 0) {
          alert('Нет данных для экспорта');
          return;
        }

        updateControlHistory(modeType);

        const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
        const activeNameProject = localStorage.getItem('projectActiveName');
        const activeProject = projects.find(p => p.name === activeNameProject);

        const projectName = activeProject?.name || 'Не указан';
        const dateInput = document.getElementById(isWall ? 'wall-date' : 'roof-date');
        const rawDate = (dateInput && dateInput.value) || activeProject?.createdAt || new Date().toISOString().split('T')[0];
        const formatDate = (value) => {
          if (!value) return '';
          if (value.includes('.')) return value;
          const parts = value.split('-');
          if (parts.length === 3) {
            return `${parts[2].padStart(2, '0')}.${parts[1].padStart(2, '0')}.${parts[0]}`;
          }
          return value;
        };
        const formattedDate = formatDate(rawDate);
        const dateForName = formattedDate || rawDate;
        const safeProjectName = projectName.replace(/[<>:"/\\|?*]/g, '_');
        const modeLabel = isWall ? 'Люки и патрубки в стенке' : 'Люки и патрубки в крыше';
        const filename = `${safeProjectName} ${modeLabel} ${dateForName}.xlsx`;

        const escapeCell = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;

        const rows = [];
        rows.push([isWall ? 'Люки и патрубки в стенке' : 'Люки и патрубки в крыше']);
        rows.push([`Резервуар: ${projectName}`]);
        rows.push([`Дата контроля: ${formattedDate || rawDate}`]);
        rows.push([]);

        const headers = [
          'Тип',
          'Обозначение',
          'Ду, мм',
          'ɑ° проект',
          'ɑ° факт',
          'А проект',
          'А факт',
          'В проект',
          'В факт',
          'С проект',
          'С факт',
          'Отклон. оси фланца в вертик. плоскости',
          'Отклон. оси от проект. положения (вертик. плоскость)',
          'Отклон. оси от проект. положения (гориз. плоскость)'
        ];
        if (isWall) headers.push('Зазор');
        rows.push(headers);

        dataArray.forEach(row => {
          const type = row.type === 'Л' ? 'Люк' : row.type === 'П' ? 'Патрубок' : (row.type || '');
          const rowData = [
            type,
            row.designation || row.name || '',
            row.diameter || row.dn || '',
            row.angleProject || row.angle_project || '',
            row.angleFact || row.angle_fact || '',
            row.aProject || row.a_project || '',
            row.aFact || row.a_fact || '',
            row.bProject || row.b_project || '',
            row.bFact || row.b_fact || '',
            row.cProject || row.c_project || '',
            row.cFact || row.c_fact || '',
            row.verticalDeviation || row.vertical_deviation || '',
            row.verticalPositionDeviation || row.vertical_position_deviation || '',
            row.horizontalPositionDeviation || row.horizontal_position_deviation || ''
          ];

          if (isWall) {
            rowData.push(row.gap || row.clearence || '');
          }

          rows.push(rowData);
        });

        // Собираем настоящий XLSX, чтобы избежать проблем с мобильными клиентами
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, 'Данные');
        const safeFilename = filename.replace(/\\.xls$/i, '.xlsx');
        XLSX.writeFile(wb, safeFilename);
      }
      this.exportToExcel3 = exportToExcel3;



      function updateControlHistory(modeType) {
        const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
        const activeNameProject = localStorage.getItem('projectActiveName');
        const activeProject = projects.find(p => p.name === activeNameProject);
        const dateInput = document.getElementById(modeType === 'wall' ? 'wall-date' : 'roof-date');
        const rawDate = (dateInput && dateInput.value) || activeProject?.createdAt;
        if (!rawDate) return;

        const parts = rawDate.includes('-') ? rawDate.split('-') : rawDate.split('.');
        let formattedDate = rawDate;
        if (parts.length === 3) {
          if (rawDate.includes('-')) {
            formattedDate = `${parts[2].padStart(2, '0')}.${parts[1].padStart(2, '0')}.${parts[0]}`;
          } else {
            formattedDate = `${parts[0].padStart(2, '0')}.${parts[1].padStart(2, '0')}.${parts[2]}`;
          }
        }

        const dataArray = modeType === 'wall' ? wallData : roofData;

        if (!controlHistory[formattedDate]) {
          controlHistory[formattedDate] = {};
        }

        if (!controlHistory[formattedDate][modeType]) {
          controlHistory[formattedDate][modeType] = [];
        }

        dataArray.forEach(row => {
          if (row.designation) {
            const existingIndex = controlHistory[formattedDate][modeType].findIndex(
              item => item.designation === row.designation && item.type === row.type
            );

            if (existingIndex === -1) {
              controlHistory[formattedDate][modeType].push({
                type: row.type,
                designation: row.designation,
                diameter: row.diameter || ''
              });
            }
          }
        });

        saveControlHistory();
      }

      // ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ
      // initApp вызывается напрямую, так как весь код уже внутри DOMContentLoaded
      initApp();

    });
  </script>
  <script>

	    const state = {
	      projects: [],
	      currentProjectId: null,
	      modules: [
	        { id: 1, name: "Фундамент", icon: "fas fa-cube", status: "pending", className: "fundament-screen" },
	        { id: 2, name: "Днище", icon: "fas fa-layer-group", status: "pending", className: "bottom-screen" },
	        { id: 3, name: "Стенка", icon: "fas fa-border-all", status: "pending", className: "setup-screen-wall" },
	        { id: 4, name: "Крыша", icon: "fas fa-house", status: "pending", className: "roof-screen" },
	        { id: 5, name: "Установка люков и патрубков", icon: "fas fa-tools", status: "pending", className: "inst-hat-pipes" },
	        { id: 6, name: "Контроль установки люков и патрубков", icon: "fas fa-clipboard-check", status: "pending", className: "insp-hat-pipes" },
	        { id: 7, name: "Геодезия", icon: "fas fa-drafting-compass", status: "pending", className: "geodesy-screen" }
	      ],
      fundamentSubmodules: [
        { id: 'annularElevation', text: 'Отметка поверхности кольцевого фундамента', status: 'pending' },
        { id: 'annularWidth', text: 'Ширина кольцевого фундамента', status: 'pending' },
        { id: 'annularDiameter', text: 'Наружный диаметр фундамента', status: 'pending' },
        { id: 'hydroizolElevation', text: 'Отметка поверхности гидроизолирующего слоя', status: 'pending' },
        { id: 'hydroizolThickness', text: 'Толщина гидроизолирующего слоя', status: 'pending' },
        { id: 'centerElevation', text: 'Отметка центра основания резервуара', status: 'pending' },
        { id: 'settlement', text: 'Осадка фундамента после испытаний', status: 'pending' }
      ],
      bottomSubmodules: [
        { id: 'radialSeams', text: 'Местные отклонения в зонах радиальных швов окраек', status: 'pending' },
        { id: 'plateRise', text: 'Подъем окраек в зоне сопряжения с центральной частью днища', status: 'pending' },
        { id: 'buckles', text: 'Местные неровности (хлопуны)', status: 'pending' },
        { id: 'outerContour', text: 'Отметки наружного контура днища', status: 'pending' }
      ],
      wallSubmodules: [
        { id: 'verticality', text: 'Вертикальность стенки', status: 'pending' },
        { id: 'angularity', text: 'Угловатость стенки', status: 'pending' },
        { id: 'dimensions', text: 'Отклонения диаметра и высоты', status: 'pending' },
        { id: 'localDeviations', text: 'Местные отклонения (хлопуны)', status: 'pending' }
      ],
      wallDiameter: 0,
      wallHeight: 0,
      autoSaveEnabled: true,
      autoSaveInterval: null
    };
	
	/* ======================================
   ЧИСЛОВАЯ КЛАВИАТУРА ТОЛЬКО ДЛЯ ЧИСЕЛ
====================================== */
function applyNumericKeyboard(root = document) {
  const inputs = root.querySelectorAll('input');

  inputs.forEach(input => {
    const id = input.id || '';
    const placeholder = input.placeholder || '';

    // ❌ ТОЛЬКО ТЕКСТ
    if (id === 'tank-name') return;

    // numeric только если явно указан класс num-input
const isNumeric = input.classList.contains('num-input');

if (!isNumeric) {
  input.removeAttribute('inputmode');
  return;
}

input.type = 'text';
input.inputMode = 'decimal';
input.autocomplete = 'off';

  });
}


    // Хелпер: создание дефолтных данных проекта
    function createDefaultProjectData() {
      return {
        fundamentSubmodules: JSON.parse(JSON.stringify(state.fundamentSubmodules)),
        bottomSubmodules: JSON.parse(JSON.stringify(state.bottomSubmodules)),


        wallSubmodules: JSON.parse(JSON.stringify(state.wallSubmodules)),
        modules: JSON.parse(JSON.stringify(state.modules))
      };
    }

    // DOM элементы
    const projectsSection = document.getElementById('projectsSection');
    const modulesSection = document.getElementById('modulesSection');
    const projectsList = document.getElementById('projectsList');
    const modulesList = document.getElementById('modulesList');
    const addProjectForm = document.getElementById('addProjectForm');
    const projectNameInput = document.getElementById('projectName');
    // const addProjectBtn = document.getElementById('addProjectBtn');
    const backToProjectsBtn = document.getElementById('backToProjectsBtn');
    const modulesTitle = document.getElementById('modulesTitle');
    const currentProjectNameSpan = document.getElementById('currentProjectName');
    const autoSaveStatus = document.getElementById('autoSaveStatus');
    const notification = document.getElementById('notification');
    const screens = document.querySelectorAll('.app-screen');
    // Инициализация приложения
    function initApp() {

      loadFromLocalStorage();
      renderProjects();
      setupEventListeners();
      // startAutoSave();
      showScreen('projectsSection');

      // Показываем приветственное сообщение
      // showNotification('Приложение загружено. Данные автосохранены в локальном хранилище.', 'info');
    }

    function showScreen(screenId) {
      screens.forEach(s => s.classList.add('hidden'));
      const target = document.getElementById(screenId);
      if (target) target.classList.remove('hidden');
      console.log(target)
    }

    function loadFromLocalStorage() {
      const savedProjects = localStorage.getItem('projectManagerProjects');

      // Грузим проекты как есть, НИЧЕГО не меняя в структуре/статусах
      if (savedProjects) {
        try {
          const projects = JSON.parse(savedProjects);
          if (Array.isArray(projects)) {
            state.projects = projects;

            // Миграция старых данных: если есть data.fundament, но нет data.fundamentSubmodules,
            // то создаём fundamentSubmodules на основе шаблона и флагов из data.fundament.
            state.projects.forEach(project => {
              if (!project.data) return;

              // const hasFundamentFlags = project.data.fundament && typeof project.data.fundament === 'object';
              // const hasFundamentSubmodulesArray = Array.isArray(project.data.fundamentSubmodules);
              // const hasBottomFlags = project.data.bottom && typeof project.data.bottom === 'object';
              // const hasBottomSubmodulesArray = Array.isArray(project.data.bottomSubmodules);
              // if (!hasFundamentSubmodulesArray && hasFundamentFlags) {
              //     const subs = JSON.parse(JSON.stringify(state.fundamentSubmodules));
              //     subs.forEach(sub => {
              //         if (project.data.fundament[sub.id]) {
              //             sub.status = 'completed';
              //         }
              //     });
              //     project.data.fundamentSubmodules = subs;
              // }
              // if (!hasBottomSubmodulesArray && hasBottomFlags) {
              //     const subs = JSON.parse(JSON.stringify(state.bottomSubmodules));
              //     subs.forEach(sub => {
              //         if (project.data.bottom[sub.id]) {
              //             sub.status = 'completed';
              //         }
              //     });
              //     project.data.bottomSubmodules = subs;
              // }
            });
          } else {
            state.projects = [];
          }
        } catch (e) {
          console.error('Ошибка чтения projectManagerProjects из localStorage', e);
          state.projects = [];
        }
      }
    }

    function saveToLocalStorage() {
      // НИЧЕГО не трансформируем, сохраняем текущее состояние проектов как есть
      const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
      if (Array.isArray(projects)) {
        localStorage.setItem('projectManagerProjects', JSON.stringify(projects));
      }
      // localStorage.setItem('projectManagerProjects', JSON.stringify(state.projects));
    }

    // Настройка обработчиков событий
    function setupEventListeners() {
      // Форма добавления проекта
      addProjectForm.addEventListener('submit', function (e) {
        e.preventDefault();
        addProject();
        // localStorage.setItem(`${}`)
        window.location.reload();
      });

      // Кнопка возврата к проектам
      backToProjectsBtn.addEventListener('click', function () {
        showScreen('projectsSection');
      });

      // Автосохранение
      if (autoSaveStatus) {
        autoSaveStatus.addEventListener('click', function () {
          toggleAutoSave();
        });
      }
    }

    // Добавление проекта
    function addProject() {
      const projectName = projectNameInput.value.trim();

      if (!projectName) {
        showNotification('Введите название проекта', 'error');
        return;
      }

      // Проверяем, существует ли уже проект с таким именем
      if (state.projects.some(project => project.name.toLowerCase() === projectName.toLowerCase())) {
        showNotification('Проект с таким именем уже существует', 'error');
        return;
      }

      // Создаем новый проект
      const newProject = {
        id: Date.now(),
        name: projectName,
        createdAt: new Date().toLocaleDateString('ru-RU'),
        isActive: false,
        wallDiameter: 0,
        wallHeight: 0,
        data: createDefaultProjectData()
      };

      // Добавляем проект в состояние
      state.projects.push(newProject);

      localStorage.setItem("projectManagerProjects", JSON.stringify(state.projects));
      // Очищаем поле ввода
      projectNameInput.value = '';

      // Перерисовываем список проектов
      renderProjects();


      // Показываем уведомление
      showNotification(`Проект "${projectName}" успешно создан`, 'success');
      // Автосохранение
      autoSave();
      //  window.location.reload();
      // window.saveAutosaveData();
    }

    // Открытие проекта (показать модули)



    function openProject(projectId) {

      // Сбрасываем активный статус у всех проектов
      state.projects.forEach(project => {
        project.isActive = project.id === projectId;
      });

      // Устанавливаем текущий проект
      state.currentProjectId = projectId;
	  
      // Находим текущий проект
      const currentProject = state.projects.find(project => project.id === projectId);

      if (!currentProject) return;

      // Инициализируем структуру данных, если она отсутствует
      if (!currentProject.data) currentProject.data = {};

      // Только добавляем fundamentSubmodules, если их совсем нет
      if (!currentProject.data.fundamentSubmodules) {
        currentProject.data.fundamentSubmodules = JSON.parse(JSON.stringify(state.fundamentSubmodules));
      }
	      let modulesChanged = false;
	      // Только добавляем modules, если их совсем нет
	      if (!currentProject.data.modules) {
	        currentProject.data.modules = JSON.parse(JSON.stringify(state.modules));
	        modulesChanged = true;
	      }
	      const modulesBeforeFilter = currentProject.data.modules.length;
	      currentProject.data.modules = currentProject.data.modules.filter(m => String(m.id) !== 'custom-geodesy');
	      if (currentProject.data.modules.length !== modulesBeforeFilter) {
	        modulesChanged = true;
	      }
	      if (!currentProject.data.modules.some(m => String(m.id) === '7')) {
	        const geodesyModule = state.modules.find(m => String(m.id) === '7');
	        if (geodesyModule) {
	          currentProject.data.modules.push(JSON.parse(JSON.stringify(geodesyModule)));
	          modulesChanged = true;
	        }
	      }
	      if (modulesChanged) {
	        localStorage.setItem("projectManagerProjects", JSON.stringify(state.projects));
	      }

      if (!currentProject.data.bottomSubmodules) {
        currentProject.data.bottomSubmodules = JSON.parse(JSON.stringify(state.bottomSubmodules));
      }

      // Синхронизируем глобальный список модулей с данными выбранного проекта
      state.modules = JSON.parse(JSON.stringify(currentProject.data.modules));

      // Обновляем заголовок модулей
      currentProjectNameSpan.textContent = currentProject.name;

      // Показываем секцию модулей
      // showModulesSection();
      showScreen('modulesSection');

      // Рендерим модули
      renderModules();

      // Перерисовываем проекты (для обновления активного статуса)
      renderProjects();

      localStorage.setItem("projectActiveName", currentProject.name);
      // Показываем уведомление

      const projects = JSON.parse(localStorage.getItem("projectManagerProjects") || '[]');
      const activeProject = projects.find(p => p.name === currentProject.name);
      const diameterElement = document.getElementById('rvs-diameter-wall')
      const heightElement = document.getElementById('rvs-height')
      if (activeProject) {
        diameterElement.value = !activeProject.wallDiameter ? '' : activeProject.wallDiameter
        heightElement.value = !activeProject.wallHeight ? '' : activeProject.wallHeight
      } else {
        diameterElement.value = ''
        heightElement.value = ''
      }
            showNotification(`Проект "${currentProject.name}" открыт`, 'info');

      // 🔥 ВОССТАНОВЛЕНИЕ АВТОСЕЙВА И КЛАВИАТУРЫ
      setTimeout(() => {

        if (typeof restoreAutoSavedFields === 'function') {
          restoreAutoSavedFields();
        }

        if (typeof applyNumericKeyboard === 'function') {
          applyNumericKeyboard();
        }

      }, 0);
    }


    // Изменение статуса подмодуля
    // Функция управления подмодулями фундамента находится в файле fundament.js

    // Рендер списка модулей
    function renderModules() {
      modulesList.innerHTML = state.modules.map(module => `
            <div class="module-card" data-module-id="${String(module.id).replace(/"/g, '&quot;')}">
                <div class="module-icon">
                    <i class="${module.icon}"></i>
                </div>
                <div class="module-name">${module.name}</div>
            </div>
        `).join('');

      modulesList.querySelectorAll('.module-card').forEach(card => {
        card.addEventListener('click', () => toggleModuleStatus(card.dataset.moduleId));
      });
    }

    // Удаление проекта
    function deleteProject(projectId) {
      const projectIndex = state.projects.findIndex(project => project.id === projectId);

      if (projectIndex === -1) return;

      const projectName = state.projects[projectIndex].name;

      // Удаляем проект из состояния
      state.projects.splice(projectIndex, 1);

      localStorage.setItem('projectManagerProjects', JSON.stringify(state.projects));


      // Перерисовываем список проектов
      renderProjects();

      // Показываем уведомление
      showNotification(`Проект "${projectName}" удален`, 'success');
      // Автосохранение
      autoSave();
      localStorage.removeItem(`${projectName}tankControlAutosave`);
      window.location.reload();

    }

	    function toggleModuleStatus(moduleId) {
	      // 1. Сначала ищем модуль в списке (ВАШ КОД, ОСТАВЛЯЕМ)
	      const moduleIdStr = String(moduleId);
	      const module = state.modules.find(m => String(m.id) === moduleIdStr);
	      if (!module) return;
	      if (moduleIdStr === '7') {
	        document.querySelectorAll('.container-module').forEach(el => el.style.display = 'none');
	        localStorage.setItem("moduleStatus", "geodesy-screen");
	        showGeodesy();
	        return;
	      }

	      window.renderFundamentModuleList();
	      window.renderWallModuleList();
      window.renderBottomModuleList();

      window.wallData = [];
      window.roofData = [];
      document.querySelectorAll('.container-module').forEach(el => el.style.display = 'none');

      // Показать нужное
      const target = document.querySelector(`.container-module.${module.className}-container`);
      if (target) target.style.display = 'block';
      document.querySelector("header").style.display = 'none';
      document.querySelector(".main-content").style.display = 'none';
      document.querySelector(".container-hero").style.display = 'none';
      console.log(module.className)
      showScreen(module.className);
      localStorage.setItem("moduleStatus", module.className);
    }

    // Рендер списка проектов
    function renderProjects() {
      if (state.projects.length === 0) {
        projectsList.innerHTML = `
                    <div class="empty-list">
                        <i class="fas fa-folder-open"></i>
                        <p>Нет созданных проектов. Добавьте первый проект!</p>
                    </div>
                `;
        return;
      }

      projectsList.innerHTML = state.projects.map(project => `
                <div class="project-card ${project.isActive ? 'active' : ''}">
                    <div class="project-header">
                        <div>
                            <div class="project-name">${project.name}</div>
                            <div class="project-date">Создан: ${project.createdAt}</div>
                        </div>
                        <div class="project-id">#${project.id.toString().slice(-4)}</div>
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-primary" onclick="openProject(${project.id})">
                            <i class="fas fa-folder-open"></i> Открыть
                        </button>
                        <button class="btn btn-danger" onclick="deleteProject(${project.id})">
                            <i class="fas fa-trash-alt"></i> Удалить
                        </button>
                    </div>
                </div>
            `).join('');
    }

    // Показать секцию проектов
    function showProjectsSection() {
      projectsSection.style.display = 'block';
      modulesSection.style.display = 'none';
    }

    // Показать секцию модулей
    function showModulesSection() {
      projectsSection.style.display = 'none';
      modulesSection.style.display = 'block';
    }

    // Включение/выключение автосохранения
    function toggleAutoSave() {
      state.autoSaveEnabled = !state.autoSaveEnabled;

      if (state.autoSaveEnabled) {
        startAutoSave();
        if (autoSaveStatus) {
          autoSaveStatus.innerHTML = '<i class="fas fa-circle"></i>';
          autoSaveStatus.title = 'Автосохранение активно';
          autoSaveStatus.classList.add('active');
        }
        showNotification('Автосохранение включено', 'success');
      } else {
        stopAutoSave();
        if (autoSaveStatus) {
          autoSaveStatus.innerHTML = '<i class="fas fa-circle"></i>';
          autoSaveStatus.title = 'Автосохранение отключено';
          autoSaveStatus.classList.remove('active');
        }
        showNotification('Автосохранение отключено', 'warning');
      }
    }

    // Запуск автосохранения
    function startAutoSave() {
      if (state.autoSaveInterval) {
        clearInterval(state.autoSaveInterval);
      }

      state.autoSaveInterval = setInterval(() => {
        if (state.autoSaveEnabled) {
          autoSave();
        }
      }, 5000);
    }

    // Остановка автосохранения
    function stopAutoSave() {
      if (state.autoSaveInterval) {
        clearInterval(state.autoSaveInterval);
        state.autoSaveInterval = null;
      }
    }

    // Функция автосохранения
    function autoSave() {
      saveToLocalStorage();

      // Визуальная индикация автосохранения
      if (autoSaveStatus) {
        const originalText = autoSaveStatus.innerHTML;
        autoSaveStatus.innerHTML = '<div class="loading"></div>';

        setTimeout(() => {
          if (autoSaveStatus) autoSaveStatus.innerHTML = originalText;
        }, 500);
      }
    }

    // Показать уведомление
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = `notification ${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Инициализация приложения при загрузке страницы
    document.addEventListener('DOMContentLoaded', initApp);

    // Сохраняем данные при закрытии вкладки
    window.addEventListener('beforeunload', () => {
      saveToLocalStorage();
    });


  </script>
<div id="custom-keyboard-container">
  <div class="kb-grid">
    <button class="kb-key" onpointerdown="CustomKeyboard.press('1', event)">1</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('2', event)">2</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('3', event)">3</button>
    <button class="kb-key delete" onpointerdown="CustomKeyboard.backspaceStart(event)" onpointerup="CustomKeyboard.backspaceEnd()" onpointerleave="CustomKeyboard.backspaceEnd()">⌫</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('4', event)">4</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('5', event)">5</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('6', event)">6</button>
    <button class="kb-key action" onpointerdown="CustomKeyboard.press('minus', event)">±</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('7', event)">7</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('8', event)">8</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('9', event)">9</button>
    <button class="kb-key action" onpointerdown="CustomKeyboard.press('dot', event)">.</button>
    <button class="kb-key action" onpointerdown="CustomKeyboard.navigate(-1, event)">‹</button>
    <button class="kb-key" onpointerdown="CustomKeyboard.press('0', event)">0</button>
    <button class="kb-key action" onpointerdown="CustomKeyboard.navigate(1, event)">›</button>
    <button class="kb-key ok-btn" onpointerdown="CustomKeyboard.hide(event)">ОК</button>
  </div>
</div>

<div id="kb-spacer" style="height: 0; transition: height 0.3s ease;"></div>

<style>
  #custom-keyboard-container {
    position: fixed;
    bottom: -100%; left: 0; width: 100%;
    background: #d1d4d9; transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10001; /* Еще выше, чтобы перекрыть всё */
    padding: 10px 5px; box-sizing: border-box;
    box-shadow: 0 -3px 15px rgba(0,0,0,0.3);
    user-select: none; -webkit-user-select: none;
  }
  #custom-keyboard-container.active { bottom: 0; }
  .kb-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
  .kb-key {
    background: #fff; border: none; border-radius: 8px; height: 55px;
    font-size: 24px; font-weight: 600; display: flex; align-items: center;
    justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    touch-action: none; cursor: pointer;
  }
  .kb-key:active { background: #e0e0e0; }
  .kb-key.action { background: #adb4be; }
  .kb-key.delete { background: #adb4be; color: #b71c1c; }
  .kb-key.ok-btn { background: #1e88e5; color: #fff; }

  @media (orientation: landscape) and (max-height: 500px) {
  #custom-keyboard-container {
    padding: 8px 5px; /* Чуть больше отступы */
  }

  .kb-grid {
    display: flex; 
    flex-wrap: nowrap; 
    max-width: 100%;
    gap: 5px; /* Немного увеличили расстояние между кнопками */
    justify-content: center;
  }

  .kb-key {
    flex: 1; 
    height: 52px; /* Увеличено (было 40-45) */
    font-size: 20px; /* Увеличен шрифт для читаемости */
    min-width: 35px;
  }

  /* Явно задаем порядок каждой кнопке */
  .kb-key:nth-child(1)  { order: 1; }  /* 1 */
  .kb-key:nth-child(2)  { order: 2; }  /* 2 */
  .kb-key:nth-child(3)  { order: 3; }  /* 3 */
  .kb-key:nth-child(5)  { order: 4; }  /* 4 */
  .kb-key:nth-child(6)  { order: 5; }  /* 5 */
  .kb-key:nth-child(7)  { order: 6; }  /* 6 */
  .kb-key:nth-child(9)  { order: 7; }  /* 7 */
  .kb-key:nth-child(10) { order: 8; }  /* 8 */
  .kb-key:nth-child(11) { order: 9; }  /* 9 */
  .kb-key:nth-child(14) { order: 10; } /* 0 */
  
  /* Символы и навигация после цифр */
  .kb-key.action:nth-of-type(1) { order: 11; } /* ± */
  .kb-key.action:nth-of-type(2) { order: 12; } /* . */
  .kb-key.action:nth-of-type(3) { order: 13; } /* ‹ */
  .kb-key.action:nth-of-type(4) { order: 14; } /* › */
  .kb-key.delete { order: 15; }               /* ⌫ */
  
  /* Кнопка ОК в самом конце */
  .kb-key.ok-btn { 
    order: 16; 
    min-width: 70px; /* Сделаем ОК чуть шире остальных */
    flex: 1.5; 
  }
}
  .kb-active-field { outline: 2px solid #1e88e5 !important; background-color: #f0f7ff !important; }
  input[readonly] {
    touch-action: pan-y !important; /* Позволяет листать страницу, трогая само поле */
    -webkit-tap-highlight-color: transparent; 
    cursor: default;
  }
</style>

<script>
const CustomKeyboard = {
  activeInput: null,
  container: null,
  spacer: null,

  init() {
  this.container = document.getElementById('custom-keyboard-container');
  this.spacer = document.getElementById('kb-spacer');

  const setup = () => {
    document.querySelectorAll('input').forEach(el => {
      const isNumeric = el.type === 'number' || el.type === 'tel' || el.classList.contains('num-input');
      
      if (isNumeric && !el.readOnlyCustom) {
        // Проверяем устройство
        if (window.innerWidth <= 1024) {
          el.setAttribute('readonly', 'true');
          el.readOnlyCustom = true;

          let isScrolling = false;
          let startY = 0;

          // Слушаем начало касания
          el.addEventListener('touchstart', (e) => {
            isScrolling = false;
            startY = e.touches[0].pageY;
          }, { passive: true });

          // Если палец двинулся больше чем на 10px — это скролл
          el.addEventListener('touchmove', (e) => {
            if (Math.abs(e.touches[0].pageY - startY) > 10) {
              isScrolling = true;
            }
          }, { passive: true });

          // Открываем только если не было скролла
          el.addEventListener('touchend', (e) => {
            if (!isScrolling) {
              e.preventDefault();
              this.show(el);
            }
          });
        } else {
          el.removeAttribute('readonly');
          el.readOnlyCustom = false;
        }
      }
    });
  };

  setup();
  new MutationObserver(setup).observe(document.body, { childList: true, subtree: true });

  // Закрытие при клике мимо
  document.addEventListener('pointerdown', (e) => {
    if (this.container.classList.contains('active') && 
        !this.container.contains(e.target) && 
        !e.target.readOnlyCustom) {
      this.hide(e);
    }
  });
},

  show(input) {
    // ПРОВЕРКА: Если ширина экрана больше 1024px (ПК), ничего не делаем и выходим
    if (window.innerWidth > 1024) {
        return; 
    }

    // 1. ПРИНУДИТЕЛЬНО ПРЯЧЕМ СИСТЕМНУЮ КЛАВИАТУРУ
    if (document.activeElement) {
        document.activeElement.blur(); 
    }

    this.vibrate(40);
    if (this.activeInput) this.activeInput.classList.remove('kb-active-field');
    
    this.activeInput = input;
    this.activeInput.classList.add('kb-active-field');
    
    // 2. ЗАДЕРЖКА ПЕРЕД ОТКРЫТИЕМ
    setTimeout(() => {
        this.container.classList.add('active');
        if (this.spacer) this.spacer.style.height = (window.innerHeight < window.innerWidth) ? '180px' : '320px';
        
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 50);
  },

  hide(event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    if (this.container) this.container.classList.remove('active');
    if (this.spacer) this.spacer.style.height = '0';
    if (this.activeInput) {
      this.activeInput.classList.remove('kb-active-field');
      this.activeInput = null;
    }
	window.lastKeyboardCloseTime = Date.now();
  },

  press(key, event) {
    if (event) { event.preventDefault(); event.stopPropagation(); }
    if (!this.activeInput) return;
    this.vibrate(30);
    let input = this.activeInput;
    let val = input.value.toString();

    if (key === 'backspace') {
      input.value = val.slice(0, -1);
    } else if (key === 'minus') {
      input.value = val.startsWith('-') ? val.substring(1) : '-' + val;
    } else if (key === 'dot') {
      if (!val.includes('.')) input.value = (val === '' || val === '-') ? val + '0.' : val + '.';
    } else {
      input.value = val + key;
    }

    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  },

  vibrate(ms) { if (navigator.vibrate) navigator.vibrate(ms); },
  
  backspaceStart(e) { if(e) e.stopPropagation(); this.press('backspace'); this.bsTimer = setInterval(()=>this.press('backspace'), 150); },
  backspaceEnd() { clearInterval(this.bsTimer); },

  navigate(dir, event) {
    if (event) event.stopPropagation();
    const all = Array.from(document.querySelectorAll('input[readonly]')).filter(i => i.offsetParent !== null);
    const curr = all.indexOf(this.activeInput);
    if (all[curr + dir]) this.show(all[curr + dir]);
    else this.hide();
  }
};

document.addEventListener('DOMContentLoaded', () => CustomKeyboard.init());
const TableManager = {
  init() {
    // MutationObserver нужен, так как таблицы в "Фундаменте" создаются скриптом после нажатия кнопок
    const observer = new MutationObserver(() => this.wrap());
    observer.observe(document.body, { childList: true, subtree: true });
    this.wrap();
  },
  wrap() {
    document.querySelectorAll('table').forEach(table => {
      // Проверяем, не обернута ли уже таблица, чтобы не плодить вложенность
      if (!table.parentElement.classList.contains('table-scroll-container')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'table-scroll-container';
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
      }
    });
  }
};

// Запускаем менеджеры при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
  CustomKeyboard.init();
  TableManager.init();
});
// Глобальный обработчик для замены запятой на точку при вводе
	document.addEventListener('input', function (e) {
	  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
	    const value = e.target.value;
	    if (value.includes(',')) {
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      e.target.value = value.replace(/,/g, '.');
      e.target.setSelectionRange(start, end);
    }
	  }
	}, true);
	</script>
	<script>
	function showGeodesy() {
	  document.querySelector("header").style.display = 'none';
	  const mainContent = document.querySelector(".main-content");
	  if (mainContent) mainContent.style.display = 'none';

	  const screen = document.getElementById('geodesy-screen');
	  if (screen) {
	    screen.style.display = 'flex';
	    screen.scrollTop = 0;
	  }

	  if (typeof loadAutosaveData === "function") loadAutosaveData();
	}

	function closeGeodesy() {
	  if (window.lastKeyboardCloseTime && (Date.now() - window.lastKeyboardCloseTime < 600)) {
	    return;
	  }

	  const screen = document.getElementById('geodesy-screen');
	  if (screen) screen.style.display = 'none';

	  document.querySelector("header").style.display = 'block';
	  const mainContent = document.querySelector(".main-content");
	  if (mainContent) mainContent.style.display = 'block';
	}

	function addGeoRow() {
	  const tbody = document.getElementById('geo-table-body');
	  if (!tbody) return;

	  const tr = document.createElement('tr');

	  const tdNum = document.createElement('td');
	  tdNum.innerText = tbody.rows.length + 1;

	  const tdInput = document.createElement('td');
	  const input = document.createElement('input');
	  input.type = "tel";
	  input.className = "geo-input-style num-input";
	  input.placeholder = "0.000";
	  input.onclick = function() {
	    if (window.CustomKeyboard && typeof CustomKeyboard.show === 'function') {
	      CustomKeyboard.show(this);
	    }
	  };
	  input.oninput = function() {
	    if (typeof saveAutosaveData === "function") saveAutosaveData();
	  };
	  tdInput.appendChild(input);

	  const tdDel = document.createElement('td');
	  tdDel.innerHTML = '<button class="geo-del-btn"><i class="fas fa-times"></i></button>';
	  tdDel.onclick = function() {
	    tr.remove();
	    updateGeoNumbers();
	    if (typeof saveAutosaveData === "function") saveAutosaveData();
	  };

	  tr.setAttribute('data-nr', tbody.rows.length + 1);
	  tr.appendChild(tdNum);
	  tr.appendChild(tdInput);
	  tr.appendChild(tdDel);
	  tbody.appendChild(tr);
	}

	function updateGeoNumbers() {
	  document.querySelectorAll('#geo-table-body tr').forEach((row, index) => {
	    row.cells[0].innerText = index + 1;
	    row.setAttribute('data-nr', index + 1);
	  });
	}

	function exportGeodesyToExcel() {
	  const objName = document.getElementById('geo-obj-name')?.value || "Место не указано";
	  const workName = document.getElementById('geo-work-type')?.value || "Геодезия";

	  const unitEl = document.querySelector('input[name="geo-u"]:checked');
	  const typeEl = document.querySelector('input[name="geo-type"]:checked');
	  const unit = unitEl ? unitEl.value : "ед.";
	  const measureType = typeEl ? typeEl.value : "не указан";

	  const now = new Date();
	  const dateStr = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;

	  const data = [
	    ["Место проведения работ:", objName],
	    ["Наименование работ:", workName],
	    ["Тип измерений:", measureType],
	    ["Дата измерения:", dateStr],
	    [],
	    ["№ точки", `Значение (${unit})`]
	  ];

	  const rows = document.querySelectorAll('#geo-table-body tr');
	  rows.forEach(tr => {
	    const nr = tr.cells[0].innerText;
	    const val = tr.querySelector('input')?.value ?? '';
	    if (val !== "") data.push([nr, val]);
	  });

	  const ws = XLSX.utils.aoa_to_sheet(data);
	  const wb = XLSX.utils.book_new();
	  XLSX.utils.book_append_sheet(wb, ws, "Геодезия");
	  XLSX.writeFile(wb, `${objName}_${workName}_${dateStr}.xlsx`);
	}

	function saveAutosaveData() {
	  const data = [];
	  const rows = document.querySelectorAll('#geo-table-body tr');
	  rows.forEach(row => {
	    const nr = row.cells[0].innerText;
	    const value = row.querySelector('input')?.value ?? '';
	    if (value) {
	      data.push({ nr, value });
	    }
	  });

	  const project = getActiveProject();
	  if (project) {
	    const storageKey = `geodesy_${project.name}`;
	    localStorage.setItem(storageKey, JSON.stringify(data));
	  }
	}

	function loadAutosaveData() {
	  const project = getActiveProject();
	  if (!project) return;
	  const storageKey = `geodesy_${project.name}`;
	  const savedData = localStorage.getItem(storageKey);

	  if (savedData) {
	    const data = JSON.parse(savedData);
	    data.forEach(item => {
	      const row = document.querySelector(`#geo-table-body tr[data-nr="${item.nr}"]`);
	      if (row) {
	        const input = row.querySelector('input');
	        if (input) input.value = item.value;
	      }
	    });
	  }
	}
	</script>
	<script>
	// Функция для анимации букв волной
	function animateWave() {
  const title = document.getElementById('wave-title');
  if (!title) return;

  // Извлекаем только текстовую часть (без иконки)
  const text = " Мастер РВС"; 
  const iconHtml = '<i class="fas fa-project-diagram"></i>';
  
  title.innerHTML = iconHtml; // Сначала вставляем иконку
  
  // Каждую букву оборачиваем в span и добавляем в заголовок
  [...text].forEach((char, i) => {
    const span = document.createElement('span');
    span.textContent = char;
    // Задержка i * 0.1s создает эффект бегущей волны
    span.style.animation = `letterJump 2s ease-in-out ${i * 0.1}s`;
    span.style.display = 'inline-block';
    span.style.whiteSpace = 'pre';
    title.appendChild(span);
  });
}

// Запускаем анимацию сразу и повторяем каждые 10 секунд
animateWave();
setInterval(animateWave, 10000);
</script>

<style>
/* CSS для прыжка букв (добавьте это в блок <style> в начале файла или здесь) */
@keyframes letterJump {
  0%, 20%, 100% { transform: translateY(0); }
  10% { transform: translateY(-10px); }
}
</style>

<script>
/* ==========================================
   ГЛОБАЛЬНЫЙ АВТОСЕЙВ ДЛЯ ВСЕГО ПРИЛОЖЕНИЯ
   ========================================== */

const AUTO_SAVE_KEY = 'rvs_auto_save';

function getAutoSaveProjectKey() {
  if (typeof getActiveProject === 'function') {
    return getActiveProject();
  }
  return null;
}

function autoSaveField(el) {
  if (!el || !el.id) return;

  const project = getAutoSaveProjectKey();
  if (!project) return;

  const allData = JSON.parse(localStorage.getItem(AUTO_SAVE_KEY) || '{}');

  if (!allData[project]) allData[project] = {};

  allData[project][el.id] = el.value;

  localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(allData));
}

function restoreAutoSavedFields() {
  const project = getAutoSaveProjectKey();
  if (!project) return;

  const allData = JSON.parse(localStorage.getItem(AUTO_SAVE_KEY) || '{}');
  if (!allData[project]) return;

  Object.entries(allData[project]).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value;
  });
}

/* ======================================
   АВТОСОХРАНЕНИЕ ПРИ ВВОДЕ (ВСЕ МОДУЛИ)
====================================== */
document.addEventListener('input', (e) => {
  if (!state.currentProjectId) return;
  if (!state.autoSaveEnabled) return;

  if (
    e.target instanceof HTMLInputElement ||
    e.target instanceof HTMLTextAreaElement ||
    e.target instanceof HTMLSelectElement
  ) {
    autoSave();
  }
});

</script>
<script>
  (function () {
    const ACCESS_KEY_STORAGE = 'rvs_access_key';
    const ACCESS_SECRET = 'RVS-ACCESS-2026';
    const ACCESS_PREFIX = 'RVS';

    function checksum(value) {
      let sum = 0;
      for (let i = 0; i < value.length; i++) {
        sum = (sum + value.charCodeAt(i) * (i + 1)) % 997;
      }
      return sum;
    }

    function xorString(value, key) {
      let output = '';
      for (let i = 0; i < value.length; i++) {
        const code = value.charCodeAt(i) ^ key.charCodeAt(i % key.length);
        output += String.fromCharCode(code);
      }
      return output;
    }

    function encodeDate(dateStr) {
      const payload = `${ACCESS_PREFIX}|${dateStr}|${checksum(dateStr)}`;
      return btoa(xorString(payload, ACCESS_SECRET));
    }

    function decodeKey(key) {
      try {
        const raw = atob(key);
        const payload = xorString(raw, ACCESS_SECRET);
        const parts = payload.split('|');
        if (parts.length !== 3 || parts[0] !== ACCESS_PREFIX) return { valid: false };
        const dateStr = parts[1];
        const check = parseInt(parts[2], 10);
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return { valid: false };
        if (checksum(dateStr) !== check) return { valid: false };
        return { valid: true, dateStr };
      } catch (e) {
        return { valid: false };
      }
    }

    function parseExpiry(dateStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      if (!y || !m || !d) return null;
      const expiry = new Date(y, m - 1, d, 23, 59, 59, 999);
      return isNaN(expiry.getTime()) ? null : expiry;
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}.${m}.${y}`;
    }

    function ensureAccessModal() {
      let modal = document.getElementById('access-gate-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'access-gate-modal';
        modal.className = 'access-gate-modal';
        document.body.appendChild(modal);
      }
      if (!modal.querySelector('#access-key-input')) {
        modal.innerHTML = `
          <div class="access-gate-box">
            <div class="access-gate-title">Доступ к приложению</div>
            <div class="access-gate-subtitle">Введите ключ доступа, чтобы продолжить работу.</div>
            <input id="access-key-input" class="access-gate-input" type="text" placeholder="Ключ доступа">
            <div class="access-gate-actions">
              <button id="access-key-submit" class="access-gate-button">Получить доступ</button>
            </div>
            <div id="access-gate-status" class="access-gate-status"></div>
          </div>
        `;
      }
      return modal;
    }

    function showModal(message) {
      const modal = ensureAccessModal();
      modal.classList.remove('hidden');
      const status = modal.querySelector('#access-gate-status');
      if (status) status.textContent = message || '';
    }

    function hideModal() {
      const modal = ensureAccessModal();
      modal.classList.add('hidden');
      const status = modal.querySelector('#access-gate-status');
      if (status) status.textContent = '';
    }

    function checkAccess(key) {
      if (!key) return { allowed: false, reason: 'Введите ключ доступа.' };
      const decoded = decodeKey(key);
      if (!decoded.valid) return { allowed: false, reason: 'Неверный ключ.' };
      const expiry = parseExpiry(decoded.dateStr);
      if (!expiry) return { allowed: false, reason: 'Неверный формат ключа.' };
      const now = new Date();
      if (now > expiry) {
        return { allowed: false, reason: `Срок доступа истек: ${formatDate(decoded.dateStr)}.` };
      }
      return { allowed: true, dateStr: decoded.dateStr };
    }

    function handleSubmit() {
      const modal = ensureAccessModal();
      const input = modal.querySelector('#access-key-input');
      const key = input ? input.value.trim() : '';
      const result = checkAccess(key);
      if (result.allowed) {
        localStorage.setItem(ACCESS_KEY_STORAGE, key);
        hideModal();
      } else {
        localStorage.removeItem(ACCESS_KEY_STORAGE);
        showModal(result.reason);
      }
    }

    function enforceAccess() {
      const modal = ensureAccessModal();
      if (!modal.dataset.bound) {
        const button = modal.querySelector('#access-key-submit');
        const input = modal.querySelector('#access-key-input');
        if (button) button.addEventListener('click', handleSubmit);
        if (input) {
          input.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') handleSubmit();
          });
        }
        modal.dataset.bound = '1';
      }

      const savedKey = localStorage.getItem(ACCESS_KEY_STORAGE);
      const result = checkAccess(savedKey);
      if (result.allowed) {
        hideModal();
      } else {
        if (savedKey) {
          localStorage.removeItem(ACCESS_KEY_STORAGE);
        }
        showModal(result.reason);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      ensureAccessModal();
      enforceAccess();
      setInterval(enforceAccess, 1000);
    });
  })();
</script>
</body>
</html>

